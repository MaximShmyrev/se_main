/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/Device','sap/ui/base/EventProvider','sap/ui/core/InvisibleText','sap/ui/core/ValueStateSupport','sap/m/library','sap/ui/core/library','sap/m/Button','sap/m/ColumnListItem','sap/m/GroupHeaderListItem','sap/m/List',"sap/m/ValueStateHeader","sap/m/inputUtils/scrollToItem","sap/m/inputUtils/SuggestionsPopoverDialogMixin","sap/m/inputUtils/SuggestionsPopoverPopoverMixin"],function(D,E,I,V,l,c,B,C,G,L,a,s,S,b){"use strict";var d=l.ListMode;var e=l.ListType;var f=l.ListSeparators;var g="sapMSuggestionsPopover",h="sapUiNoContentPadding";var i=c.ValueState;var j=E.extend("sap.m.SuggestionsPopover",{constructor:function(o){E.apply(this,arguments);this._oInput=o;this._iPopupListSelectedIndex=-1;this._sPopoverContentWidth=null;this._bIsInputIncrementalType=false;this._sOldValueState=i.None;this._oInput.addEventDelegate({onsapup:function(k){if(!this._oInput.isComposingCharacter()){this._onsaparrowkey(k,"up",1);}},onsapdown:function(k){if(!this._oInput.isComposingCharacter()){this._onsaparrowkey(k,"down",1);}},onsappageup:function(k){this._onsaparrowkey(k,"up",5);},onsappagedown:function(k){this._onsaparrowkey(k,"down",5);},onsaphome:function(k){var m,n=this.getItemsContainer();if(n){m=n.getItems().length?n.getItems().length-1:0;this._onsaparrowkey(k,"up",m);}},onsapend:function(k){var m=this.getItemsContainer();if(m){this._onsaparrowkey(k,"down",m.getItems().length);}},onsaptabnext:this._handleValueStateLinkNav,onsaptabprevious:this._handleValueStateLinkNav},this);if(D.system.phone){S.apply(j.prototype);}else{b.apply(j.prototype);}},destroy:function(){this._destroySuggestionPopup();}});j.M_EVENTS={SELECTION_CHANGE:"selectionChange"};j.prototype.isOpen=function(){var p=this.getPopover();return p&&p.isOpen();};j.prototype.setPopover=function(p){this._oPopover=p;};j.prototype.getPopover=function(){return this._oPopover;};j.prototype.destroyPopover=function(){if(this._oPopover){this._oPopover.destroy();}this._oPopover=null;};j.prototype.setInputLabels=function(k){this._fnInputLabels=k;};j.prototype.createSuggestionPopup=function(o){var p,k=this._oInput,m=this.getItemsContainer();o=o||[];p=this.createPopover(k,this._oPopupInput,o);this.setPopover(p);p.addStyleClass(g);p.addStyleClass(h);p.addAriaLabelledBy(I.getStaticId("sap.m","INPUT_AVALIABLE_VALUES"));if(m){this.addContent(m);}};j.prototype.initContent=function(o){var k=o,m=this._oInput,p=this.getPopover();if(!p){return;}if(!k){k=new L(m.getId()+"-popup-list",{showNoData:false,mode:d.SingleSelectMaster,rememberSelections:false,width:"100%",showSeparators:f.None,busyIndicatorDelay:0});}if(D.system.phone){p.addAggregation("content",k,true);var r=p.$("scrollCont")[0];if(r){var n=sap.ui.getCore().createRenderManager();n.renderControl(k);n.flush(r);n.destroy();}}else{this.addContent(k);}};j.prototype._getValueStateHeader=function(){var p;if(!this._oValueStateHeader){this._oValueStateHeader=new a();p=this.getPopover();if(p.isA("sap.m.Popover")){p.setCustomHeader(this._oValueStateHeader);}else{p.insertContent(this._oValueStateHeader,0);}this._oValueStateHeader.setPopup(p);}return this._oValueStateHeader;};j.prototype._destroySuggestionPopup=function(){this.destroyPopover();this._oValueStateHeader=null;if(this._oPickerValueStateText){this._oPickerValueStateText.destroy();this._oPickerValueStateText=null;}};j.prototype._handleValueStateLinkNav=function(o){this.bMessageValueStateActive=this._oInput.getFormattedTextFocused?this._oInput.getFormattedTextFocused():this.bMessageValueStateActive;if((!this.bMessageValueStateActive||!this.getValueStateLinks().length)||(this.bMessageValueStateActive&&document.activeElement.tagName==="A")){return;}var v=this.getValueStateLinks(),k=v[v.length-1];o.preventDefault();this._iPopupListSelectedIndex=-1;v[0].focus();this._getValueStateHeader().removeStyleClass("sapMPseudoFocus");v.forEach(function(m){m.addDelegate({onsapup:function(o){this._oInput.getFocusDomRef().focus();this._onsaparrowkey(o,"up",1);},onsapdown:function(o){this._oInput.getFocusDomRef().focus();this._onsaparrowkey(o,"down",1);}},this);},this);k.addDelegate({onsaptabnext:function(o){this.bMessageValueStateActive=false;this._oInput.onsapfocusleave(o);this.getPopover().close();setTimeout(function(){this._oInput.closeValueStateMessage();}.bind(this),0);}},this);v[0].addDelegate({onsaptabprevious:function(o){o.preventDefault();this._oInput.getFocusDomRef().focus();this._getValueStateHeader().addStyleClass("sapMPseudoFocus");this._oInput.removeStyleClass("sapMFocus");}},this);};j.prototype._onsaparrowkey=function(o,k,m){var n=this._oInput,p,P=this.getPopover(),q=n.$("inner");if(o.isMarked()){return;}if(!n.getEnabled()||!n.getEditable()){return;}if(k!=="up"&&k!=="down"){return;}if(this._bIsInputIncrementalType){o.setMarked();}if(!P||!P.isOpen()){return;}o.preventDefault();o.stopPropagation();var F=false,r=this.getItemsContainer(),t=r.getItems(),u=r.getSelectedItem(),v=this._iPopupListSelectedIndex,N,w=this._getValueStateHeader(),x=w.getFormattedText(),y=D.browser.msie?x:w,O=v;if(k=="down"&&v===t.length-1){return;}if(this.getValueStateLinks().length&&this.bMessageValueStateActive&&o.type==="sapend"){y.removeStyleClass("sapMPseudoFocus");r.addStyleClass("sapMListFocus");O=0;v=t.length-1;t[v].addStyleClass("sapMLIBFocused");this.bMessageValueStateActive=false;}var z;if(m>1){if(k==="down"&&v+m>=t.length){k="up";m=1;t[v].setSelected(false);t[v].removeStyleClass("sapMLIBFocused");z=v;v=t.length-1;F=true;}else if(k==="up"&&v-m<0&&v>=0){k="down";m=1;t[v].setSelected(false);t[v].removeStyleClass("sapMLIBFocused");z=v;v=0;F=true;}}n.removeStyleClass("sapMFocus");r.addStyleClass("sapMListFocus");if(v===-1){v=0;if(this._isSuggestionItemSelectable(t[v])){O=v;F=true;}else{k="down";}}if(k==="down"){while(v<t.length-1&&(!F||!this._isSuggestionItemSelectable(t[v]))){t[v].setSelected(false);t[v].removeStyleClass("sapMLIBFocused");v=v+m;F=true;m=1;if(z===v){break;}}}else{while(v>0&&(!F||!t[v].getVisible()||!this._isSuggestionItemSelectable(t[v]))){t[v].setSelected(false);t[v].removeStyleClass("sapMLIBFocused");v=v-m;F=true;m=1;if(z===v){break;}}}if((this.getValueStateLinks().length&&!this.bMessageValueStateActive&&o.type!=="sapend")&&((k==="up"&&(!this._isSuggestionItemSelectable(t[v])||O===0))||o.type==="saphome")){y.addStyleClass(("sapMPseudoFocus"));r.removeStyleClass("sapMListFocus");q.attr("aria-activedescendant",x.getId());this.bMessageValueStateActive=true;this._iPopupListSelectedIndex=-1;s(t[0],this.getPopover());return;}if((this.getValueStateLinks().length&&this.bMessageValueStateActive)&&(k==="up"&&v===0||k==="down")){y.removeStyleClass("sapMPseudoFocus");r.addStyleClass("sapMListFocus");this.bMessageValueStateActive=false;}if(!this._isSuggestionItemSelectable(t[v])){if(O>=0){t[O].setSelected(true).updateAccessibilityState();q.attr("aria-activedescendant",t[O].getId());t[O].addStyleClass("sapMLIBFocused");}return;}else{p=t[v];p.setSelected(true).updateAccessibilityState();p.addStyleClass("sapMLIBFocused");q.attr("aria-activedescendant",t[v].getId());}if(D.system.desktop){s(t[v],this.getPopover());}this._oLastSelectedHeader&&this._oLastSelectedHeader.removeStyleClass("sapMInputFocusedHeaderGroup");if(C&&t[v]instanceof C){N=n._getInputValue(n._fnRowResultFilter(t[v]));}else{if(t[v].isA("sap.m.GroupHeaderListItem")){N="";t[v].addStyleClass("sapMInputFocusedHeaderGroup");u&&u.setSelected(false);this._oLastSelectedHeader=t[v];}else{N=n._getInputValue(t[v].getTitle());}}this._iPopupListSelectedIndex=v;this.fireEvent(j.M_EVENTS.SELECTION_CHANGE,{newValue:N});};j.prototype.getValueStateLinks=function(){var H=this._getValueStateHeader(),F=H&&typeof H.getFormattedText==="function"&&H.getFormattedText(),k=F&&typeof F.getControls==="function"&&F.getControls();return k||[];};j.prototype._isSuggestionItemSelectable=function(o){var k=this._oInput._hasTabularSuggestions()||o.getType()!==e.Inactive||o.isA("sap.m.GroupHeaderListItem");return o.getVisible()&&k;};j.prototype.updateValueState=function(v,k,m){var n=m&&v!==i.None;k=k||V.getAdditionalText(v);if(!this.getPopover()){return this;}if(this._oPopupInput){this._oPopupInput.setValueState(v);}this._getValueStateHeader().setValueState(v);if(this._oValueStateHeader&&typeof k==="string"){this._oValueStateHeader.setText(k);}else if(this._oValueStateHeader&&typeof k==="object"){this._oValueStateHeader.setFormattedText(k);}if(this._oValueStateHeader){this._oValueStateHeader.setVisible(n);}this._alignValueStateStyles(v);return this;};j.prototype._alignValueStateStyles=function(v){var p=g+"ValueState",o=g+this._sOldValueState+"State",k=g+v+"State",P=this.getPopover();P.addStyleClass(p);P.removeStyleClass(o);P.addStyleClass(k);this._sOldValueState=v;};j.prototype.addContent=function(o){this.getPopover().addContent(o);};j.prototype.getItemsContainer=function(){var p=this.getPopover(),k=p&&p.getContent();return k&&k.filter(function(o){return(o.isA("sap.m.List")&&o.getId().indexOf("-popup-list")>-1)||o.isA("sap.m.Table");})[0];};j.prototype.getPickerTitle=function(){return null;};j.prototype.getOkButton=function(){return null;};j.prototype.getCancelButton=function(){return null;};j.prototype.getFilterSelectedButton=function(){return null;};j.prototype.setOkPressHandler=function(){return null;};j.prototype.setCancelPressHandler=function(){return null;};j.prototype.setShowSelectedPressHandler=function(){return null;};j.prototype.resizePopup=function(){};return j;});
