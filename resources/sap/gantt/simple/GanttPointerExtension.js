/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","./GanttExtension","../drawer/CursorLine","./CoordinateUtils","./GanttUtils"],function(q,C,G,a,b,c){"use strict";var n=".sapGanttPointer";var d="contextmenu"+n;var m=["mouseenter","mouseleave","click","dblclick","mouseup","mousedown"],M=m.map(function(E){return E+n;});var s="mousemove",e=s+n,f=e+" mouseup"+n;var B=m.reduce(function(i,l){i[l]=l;return i;},{});B[s]=s;var D={Forward:"forward",Backward:"backward",Bottom:"bottom",Top:"top"};var g=200;var h=null;var j={addEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);j.removeEventListeners(o);if(h===null){h=c.adhocLinesPresentAndEnabled(o);}M.forEach(function(l){$.on(l,E.onGanttChartMouseEvent.bind(E));if(h){i.on(l,E.onGanttChartMouseEvent.bind(E));}else{i.off(l,E.onGanttChartMouseEvent.bind(E));}});$.on(f,E.onCrossSvgMouseEvent.bind(E));$.on(e,E.updateGanttCursorLine.bind(E));this.bindBackgroundRowEvent($,E);if(h){this.bindBackgroundRowEventHeader(i,E);}else{this.unbindBackgroundRowEventHeader(i);}i.on(B.mousedown+n,function(l){l.preventDefault();l.stopPropagation();l.stopImmediatePropagation();return false;});q(document.getElementById(o.getId())).on(e,b.updateCursorPosition);},removeEventListeners:function(o){var E=o._getPointerExtension(),$=q(E.getDomRefs().ganttSvg),i=q(E.getDomRefs().headerSvg);$.off(n);if(h===null){h=c.adhocLinesPresentAndEnabled(o);}if(h){i.on(B.mousedown+n);}else{i.off(B.mousedown+n);}this.unbindBackgroundRowEvent($);},doGanttAutoScroll:function(o,i,E,l){var p=o._getPointerExtension();if(p.iTableAutoScrollTimerId){q.sap.clearDelayedCall(p.iTableAutoScrollTimerId);p.iTableAutoScrollTimerId=null;}if(p._bAutoScroll){if(!p.allowAutoScroll()){return;}p._toggleCursorLine(false);var r=o._getResizeExtension();if(r.isResizing()){r.onResizing(E);}var t=o._getConnectExtension();if(t.isShapeConnecting()){t.onShapeConnecting(E);}var P=o._getPopoverExtension();P._updatePopoverWhenAutoScroll(E);var z=o._getZoomExtension();z._handleAutoScroll(E);var R=C.getConfiguration().getRTL();var S=30;if(D.Backward===i||D.Top===i){S=(-1)*S;}if(D.Backward===i||D.Forward===i){p._iStep=S;}else{p._iStep=0;}var $=this.getScrollArea(o,i);var u,H=false;if(i===D.Forward||i===D.Backward){u=R?"scrollLeftRTL":"scrollLeft";H=true;}else{u="scrollTop";H=false;}t.storeScrollDistance(S,H);var T=$[u]()+S;$[u](T);var v=$[u]();if(v!==T){t.storeScrollDistance(v-T,H);}if(!(l!==undefined&&l===v)){p.iTableAutoScrollTimerId=q.sap.delayedCall(g,j,j.doGanttAutoScroll,[o,i,E,v]);}}},getScrollArea:function(o,i){var S;var t=o.getTable();var T=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar));if(i===D.Forward||i===D.Backward){S=q(document.getElementById(o.getId()+"-hsb"));}else{S=T;}return S;},bindBackgroundRowEvent:function($,E){function l(r){q(r).on(B.mouseenter+n+" "+B.mouseleave+n,function(p){var I=E._getRowIndexFromEvent(p);E.onMouseHover(I,p.type===B.mouseenter);});q(r).on(B.click+n+" "+B.dblclick+n,function(p){E.dispatchGanttClick(p);});q(r).on(d,function(p){E.onGanttChartContextMenu(p);});}var o=$.find("rect.sapGanttBackgroundSVGRow");var L=o.length;for(var i=0;i<L;i++){l(o[i]);}},bindBackgroundRowEventHeader:function($,E){q($[0]).on(B.click+n+" "+B.dblclick+n,function(o){E.dispatchGanttClickHeader(o);});},unbindBackgroundRowEvent:function($){var l=$.find("rect.sapGanttBackgroundSVGRow");var L=l.length;for(var i=0;i<L;i++){q(l[i]).off(n);}},unbindBackgroundRowEventHeader:function($){q($[0]).off(n);}};var k=G.extend("sap.gantt.simple.GanttPointerExtension",{_init:function(o,S){this._oCursorLineDrawer=new a();this.bPreventSingleClick=false;this.iTableAutoScrollTimerId=null;this._iStep=0;return"PointerExtension";},_attachEvents:function(){var o=this.getGantt();j.addEventListeners(o);},_detachEvents:function(){var o=this.getGantt();j.removeEventListeners(o);},destroy:function(){if(this._oCursorLineDrawer){this._oCursorLineDrawer.destroy();}delete this.bPreventSingleClick;}});k.prototype.onGanttChartContextMenu=function(E){E.preventDefault();if(E.target===E.currentTarget){var o=this.getGantt();var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];o.fireShapeContextMenu({row:r,pageX:E.pageX,pageY:E.pageY});}};k.prototype.onGanttChartMouseEvent=function(E){this.updateGanttCursorLine(E);if(E.type===B.mousedown){this.oMousedownTargetElement=E.target;}this.onMouseEnterLeaveEvent(E);};k.prototype.onCrossSvgMouseEvent=function(E){var o=this.getGantt();if(E.type===B.mousemove){if(this.needAutoscrollInContainerIfNecessary()){this.updateCursorStyle("move");this.tableAutoScroll(E);}else{var i=o._getDragDropExtension();var l=o._getConnectExtension();var r=o._getResizeExtension();var z=o._getZoomExtension();if((i.isDragging()||r.isResizing()||l.isShapeConnecting()||z.isTimeZooming())){this.tableAutoScroll(E);}}}if(E.type===B.mouseup){this.oMouseupTargetElement=E.target;this._bAutoScroll=false;}};k.prototype.needAutoscrollInContainerIfNecessary=function(){var o=this.getGantt().getParent();if(o&&o.getGanttCharts){var i=o.getGanttCharts();var l=this.getGantt();return i.some(function(p){return p!==l&&p._getDragDropExtension().isDragging();});}return false;};k.prototype.updateCursorStyle=function(S){document.body.style.cursor=S;this.getDomRefs().ganttSvg.style.cursor=S;};k.prototype.isPointerInGanttChart=function(E){return this._bMouseOnSvg;};k.prototype.onMouseEnterLeaveEvent=function(E){this.updateCursorStyle("default");if(E.type===B.mouseenter){this._bMouseOnSvg=true;}else if(E.type===B.mouseleave){this._bMouseOnSvg=false;}};k.prototype.dispatchGanttClick=function(E){if(this.isEventTargetOnGanttRow(E)===false){return;}if(E.type===B.click){if(this.oMousedownTargetElement===this.oMouseupTargetElement){this.onGanttSingleClick(E);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement;}}else if(E.type===B.dblclick){this.onGanttDoubleClick(E);}};k.prototype.dispatchGanttClickHeader=function(E){if(E.type===B.click){this.onGanttSingleClick(E);delete this.oMouseupTargetElement;delete this.oMousedownTargetElement;}};k.prototype.isEventTargetOnGanttRow=function(E){return q(E.target).hasClass("sapGanttBackgroundSVGRow");};k.prototype._getRowIndexFromEvent=function(E){return parseInt(E.target.getAttribute("data-sap-ui-index"),10);};k.prototype._getRowIndexFromElement=function(E){return parseInt(E.getAttribute("data-sap-ui-index"),10);};k.prototype.onGanttSingleClick=function(E){this.getGantt().getSelection().updateShape(null,{selected:false,ctrl:E.ctrlKey||E.metaKey});var o=this.getGantt();c.resetStrokeDasharray(o);var i=this._getRowIndexFromEvent(E);var r=o.getTable().getRows()[i];if(!r){return;}var l=function(){if(this.bPreventSingleClick===false){this._selectTableRow(o,i);o.fireShapePress({shape:null,row:r});}this.bPreventSingleClick=false;}.bind(this);if(o.getDisableShapeDoubleClickEvent()){this.bPreventSingleClick=false;l();return;}this.iSingleClickTimer=q.sap.delayedCall(300,this,l);};k.prototype.onGanttDoubleClick=function(E){var o=this.getGantt(),i=o.getDisableShapeDoubleClickEvent(),I,r;if(!i){q.sap.clearDelayedCall(this.iSingleClickTimer);this.bPreventSingleClick=true;}I=this._getRowIndexFromEvent(E);r=o.getTable().getRows()[I];this._selectTableRow(o,I);if(!i){o.fireShapeDoubleClick({shape:null,row:r});}};k.prototype._selectTableRow=function(o,i){var t=this.getGantt().getTable().getSelectionBehavior();var S=sap.ui.table.SelectionBehavior;if(S.Row===t||S.RowOnly===t){o.getSyncedControl().syncRowSelection(i);}};k.prototype.onMouseHover=function(i,H){this.getGantt().getSyncedControl().syncRowHover(i,H);};k.prototype._getAutoScrollStep=function(){if(this._bAutoScroll){return this._iStep;}return 0;};k.prototype.updateGanttCursorLine=function(E){if(this.getGantt().getEnableCursorLine()===false){return;}if(E.type===B.mousemove){var S=b.getEventSVGPoint(this.getDomRefs().ganttSvg,E);this._toggleCursorLine(true,S);}else if(E.type===B.mouseleave){this._toggleCursorLine(false);}};k.prototype._toggleCursorLine=function(S,p){var i=this._getCursorLineDOMs();if(S){this._oCursorLineDrawer.drawSvg(i.allGanttSvg,i.allHeaderSvg,this.getGantt().getLocale(),p);}else{this._oCursorLineDrawer.destroySvg(i.allGanttSvg,i.allHeaderSvg);}};k.prototype._getCursorLineDOMs=function(){return{allHeaderSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartHeaderSvg"),allGanttSvg:d3.selectAll(".sapGanttChartWithSingleTable .sapGanttChartSvg")};};k.prototype.tableAutoScroll=function(E){this._bAutoScroll=false;if(this.ifAutoScrollToRight()){q.sap.delayedCall(g,this,function(){j.doGanttAutoScroll(this.getGantt(),D.Forward,E);});}else if(this.ifAutoScrollToLeft()){q.sap.delayedCall(g,this,function(){j.doGanttAutoScroll(this.getGantt(),D.Backward,E);});}else if(this.ifAutoScrollToDown()){q.sap.delayedCall(g,this,function(){j.doGanttAutoScroll(this.getGantt(),D.Bottom,E);});}else if(this.ifAutoScrollToUp()){q.sap.delayedCall(g,this,function(){j.doGanttAutoScroll(this.getGantt(),D.Top,E);});}else{this._bAutoScroll=false;}};k.prototype.ifAutoScrollToRight=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX>A.oScrollAreaRect.left+A.iScrollAreaWidth-A.iScrollTriggerAreaWidth&&A.iLocationX<A.oScrollAreaRect.left+A.iScrollAreaWidth&&A.iScrollAreaScrollLeft+A.iScrollAreaWidth<A.oScrollArea.scrollWidth;return this._bAutoScroll;};k.prototype.ifAutoScrollToLeft=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationX<A.oScrollAreaRect.left+A.iScrollTriggerAreaWidth&&A.iLocationX>A.oScrollAreaRect.left&&A.iScrollAreaScrollLeft>0;return this._bAutoScroll;};k.prototype.ifAutoScrollToDown=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY>A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight-A.iScrollTriggerAreaHeight&&A.iLocationY<A.oVisibleScrollAreaRect.top+A.iVisibleScrollAreaHeight&&A.iScrollAreaScrollTop+A.iScrollAreaHeight-A.iBaseRowHeight<=A.iScrollHeight;return this._bAutoScroll;};k.prototype.ifAutoScrollToUp=function(){var A=this.getAutoScrollPosition();this._bAutoScroll=A.iLocationY<A.oVisibleScrollAreaRect.top+A.iScrollTriggerAreaHeight&&A.iLocationY>A.oVisibleScrollAreaRect.top;return this._bAutoScroll;};k.prototype.getAutoScrollPosition=function(){var r=C.getConfiguration().getRTL();var t=this.getGantt().getTable();var i=10,l=10,o=document.getElementById(this.getGantt().getId()+"-gantt"),S=q(o),p=o.getBoundingClientRect(),u=S.outerWidth(),v=S.outerHeight(),w=p,x=v,y=this.getGantt()._oExpandModel.getBaseRowHeight(),z=r?S.scrollLeftRTL():S.scrollLeft();var T=q(t.getDomRef(sap.ui.table.SharedDomRef.VerticalScrollBar)),A=T.scrollTop(),E=T.get(0).scrollHeight;var F=b.getLatestCursorPosition().pageX,H=b.getLatestCursorPosition().pageY;return{iLocationX:F,iLocationY:H,oScrollAreaRect:p,oScrollArea:o,iScrollAreaWidth:u,iScrollTriggerAreaWidth:i,iScrollTriggerAreaHeight:l,iScrollAreaScrollLeft:z,oVisibleScrollAreaRect:w,iVisibleScrollAreaHeight:x,iScrollAreaScrollTop:A,iBaseRowHeight:y,iScrollHeight:E,iScrollAreaHeight:v};};k.prototype.allowAutoScroll=function(){return this.ifAutoScrollToRight()||this.ifAutoScrollToLeft()||this.ifAutoScrollToDown()||this.ifAutoScrollToUp();};return k;});
