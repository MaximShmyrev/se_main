/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["jquery.sap.global","sap/ui/core/Core","sap/gantt/misc/Utility","sap/ui/core/format/DateFormat","sap/ui/core/Locale","sap/m/OverflowToolbar","sap/ui/core/theming/Parameters"],function(q,C,U,D,L,O,P){"use strict";var c={};var G={SHAPE_ID_DATASET_KEY:"data-sap-gantt-shape-id",ROW_ID_DATASET_KEY:"data-sap-gantt-row-id",CONNECTABLE_DATASET_KEY:"data-sap-gantt-connectable",SELECT_FOR_DATASET_KEY:"sap-gantt-select-for",SHAPE_CONNECT_FOR_DATASET_KEY:"sap-gantt-shape-connect-for",SHAPE_CONNECT_INDICATOR_WIDTH:10,shapeElementById:function(s,g){var o=q.sap.domById(g),S=o.querySelector("g.sapGanttChartShapes");var n=S.querySelectorAll("["+G.SHAPE_ID_DATASET_KEY+"='"+s+"']");var e=n[0];if(e){return q(e).control(0);}return null;},getValueX:function(s){var n;var p=s.getMetadata().getProperty("x");if(p){n=s.getProperty(p.name);if(n!==null&&n!==undefined){return n;}}var r=C.getConfiguration().getRTL(),t=r?(s.getEndTime()||s.getTime()):s.getTime();if(t){n=s.getXByTime(t);}if(!q.isNumeric(n)){q.sap.log.warning("couldn't convert timestamp to x with value: "+t);}return n;},getRowInstance:function(e,t){var r=q(e.target).closest("rect.sapGanttBackgroundSVGRow").data("sapUiIndex");if(r!=null){return t.getRows()[r];}},getRowInstancefromShape:function(s){var r=s.getParentRowSettings();if(r!=null){return r.getParentRow();}},_get2dContext:function(f,F){if(!c.context){c.context=document.createElement('canvas').getContext("2d");}if(c.fontSize!==f||c.fontFamily!==F){c.context.font=f+"px "+F;c.fontSize=f;c.fontFamily=F;}return c.context;},getShapeTextWidth:function(t,f,F){return this._get2dContext(f,F).measureText(t).width;},getSelectedTableRowSettings:function(t,s){var a=t.getRows(),f=t.getFirstVisibleRow();if(a.length===0){return null;}var F=a[0].getIndex();var i=s-f;if(F!==f){i+=Math.abs(F-f);}return a[i].getAggregation("_settings");},updateGanttRows:function(d,r,i){var g=d.getParent().getParent();var $=q.sap.byId(g.getId()+"-svg"),a=$.find("rect.sapGanttBackgroundSVGRow");a.eq(i).toggleClass("sapGanttBackgroundSVGRowSelected",!!r[i].selected);a.eq(i).toggleClass("sapGanttBackgroundSVGRowHovered",!!r[i].hovered);},getShapesWithUid:function(s,S){var e=function(a){var p=U.parseUid(a),b=p.shapeId;var d=["[id='",s,"']"," ["+G.SHAPE_ID_DATASET_KEY+"='",b,"']"].join("");return q(d).control().filter(function(E){return E.getShapeUid()===a;})[0];};return S.map(e);},getTimeFormaterBySmallInterval:function(g){var a=g.getAxisTimeStrategy(),s=a.getTimeLineOption().smallInterval,u=s.unit;var o=a.getCalendarType(),b=a.getLocale()?a.getLocale():new L(C.getConfiguration().getLanguage().toLowerCase());var f="yyyyMMMddhhms";if(!(u===sap.gantt.config.TimeUnit.minute||u===sap.gantt.config.TimeUnit.hour)){f="yyyyMMMdd";}return D.getDateTimeInstance({format:f,style:s.style,calendarType:o},s.locale?new L(s.locale):b);},resetStrokeDasharray:function(g){var s=g.getSimpleAdhocLines().find(function(x){return x._getSelected();});if(s){s._setSelected(false);var h=document.getElementById(s._getHeaderLine().sId);var a=document.getElementById(s._getLine().sId);if(a&&h){a.style.strokeDasharray=s.getStrokeDasharray();h.style.strokeDasharray=s.getStrokeDasharray();a.style.strokeWidth=s._getStrokeWidth();h.style.strokeWidth=s._getStrokeWidth();}}var S=g.getDeltaLines().find(function(x){return x._getIsSelected();});if(S){var o=S._getChartDeltaArea();if(o){var $=document.getElementById(o.sId);if(S._getEnableChartDeltaAreaHighlight()===true){$.style.opacity=0.0;}}var b=document.getElementById(S._getStartLine().sId);var e=document.getElementById(S._getEndLine().sId);var H=document.getElementById(S._getHeaderStartLine().sId);var d=document.getElementById(S._getHeaderEndLine().sId);var f=document.getElementById(S._getForwardMarker().sId);var B=document.getElementById(S._getBackwardMarker().sId);var i=document.getElementById(S._getHeaderDeltaArea().sId);var m=P.get("sapUiChartDataPointBorderColor");b.style.strokeDasharray=S.getStrokeDasharray();e.style.strokeDasharray=S.getStrokeDasharray();H.style.strokeDasharray=S.getStrokeDasharray();d.style.strokeDasharray=S.getStrokeDasharray();b.style.strokeWidth=S._getStrokeWidth();e.style.strokeWidth=S._getStrokeWidth();H.style.strokeWidth=S._getStrokeWidth();d.style.strokeWidth=S._getStrokeWidth();f.style.fillOpacity=0;B.style.fillOpacity=0;i.style.opacity=1;f.style.stroke=null;B.style.stroke=null;if(S._getVisibleMarker()===true){f.style.fillOpacity=1;B.style.fillOpacity=1;f.style.stroke=m;B.style.stroke=m;}S._setIsSelected(false);}},adhocLinesPresentAndEnabled:function(g){return g.getSimpleAdhocLines().filter(function(a){return a.MarkerType!=sap.gantt.simple.MarkerType.None;}).length>0&&g.getEnableAdhocLine();},addToolbarToTable:function(s,t,i){if(t.getExtension().length==0){var o=new O();if(i){o.addContent(s.oExportTableToExcelButton);}t.addExtension(o);}else{if(i){t.getExtension()[0].addContent(s.oExportTableToExcelButton);}}},_partitionShapesIntoOverlappingRanges:function(s,d,e){var g="get"+d.charAt(0).toUpperCase()+d.slice(1);var f="get"+e.charAt(0).toUpperCase()+e.slice(1);s.sort(function(a,b){if(a[g]()<b[g]()){return-1;}if(a[g]()>b[g]()){return 1;}return 0;});var h=function(j){if(j.length==0){return false;}j.sort(function(a,b){var m=a[f]();var n=b[f]();if(m<n){return 1;}if(m>n){return-1;}return 0;});return j[0][f]();};var r=[];var I=0;if(s.length>0){r[I]=[s[0]];}for(var i=1,l=s.length;i<l;i++){if(s[i][g]()>=s[i-1][g]()&&s[i][g]()<h(r[I])){r[I].push(s[i]);}else{I++;r[I]=[s[i]];}}return r;},calculateLevelForShapes:function(a,s,e){var f=function(b){return b.reduce(function(d,t){return d.concat(Array.isArray(t)?f(t):t);},[]);};var r=this._partitionShapesIntoOverlappingRanges(a,s,e);var m=0;var R=r.map(function(b){b.map(function(d,i){var l=i+1;if(d._setLevel){d._setLevel(l);}d._level=l;if(m<l){m=l;}return d;});return b;});var S=f(R);var o={shapes:S,maxLevel:m};return o;},_partitionLinesIntoOverlappingRanges:function(d){d.sort(function(a,b){if(a.getTimeStamp()<b.getTimeStamp()){return-1;}if(a.getTimeStamp()>b.getTimeStamp()){return 1;}return 0;});var g=function(e){if(e.length==0){return false;}e.sort(function(a,b){var m;if(a instanceof sap.gantt.simple.AdhocLine){m=a.getTimeStamp();}else{m=a.getEndTimeStamp();}var n;if(b instanceof sap.gantt.simple.AdhocLine){n=b.getTimeStamp();}else{n=b.getEndTimeStamp();}if(m<n){return 1;}if(m>n){return-1;}return 0;});if(e[0]instanceof sap.gantt.simple.AdhocLine){return e[0].getTimeStamp();}else{return e[0].getEndTimeStamp();}};var r=[];var I=0;if(d.length>0){r[I]=[d[0]];}for(var i=1,l=d.length;i<l;i++){if(d[i].getTimeStamp()>=d[i-1].getTimeStamp()&&d[i].getTimeStamp()<g(r[I])){r[I].push(d[i]);}else{I++;r[I]=[d[i]];}}return r;},calculateLevelForMarkers:function(a,d){var f=function(e){return e.reduce(function(g,t){return g.concat(Array.isArray(t)?f(t):t);},[]);};var A=a.concat(d);var r=this._partitionLinesIntoOverlappingRanges(A);var m=0;var R=r.map(function(s){s.map(function(e,i){var l=i+1;e._setLevel(l);if(m<l){m=l;}return e;});return s;});var b=f(R);var o={adhocLines:b.filter(function(l){if(sap.gantt.simple.AdhocLine){return l instanceof sap.gantt.simple.AdhocLine;}}),deltaLines:b.filter(function(l){if(sap.gantt.simple.DeltaLine){return l instanceof sap.gantt.simple.DeltaLine;}}),maxLevel:m};return o;},getShapeSuccessors:function(s,g){var S=[];if(s.getEnableChainSelection()){var v=this._getVisibleRelationships(g);var a=v.filter(function(x){return x.getPredecessor()===s.getShapeId();});a.forEach(function(r){var m=r.getRelatedInRowShapes(g.getId());if(m.successor){S.push(m.successor);}});S=Array.from(new Set(S));}return S;},getShapePredeccessors:function(s,g){var S=[];if(s.getEnableChainSelection()){var v=this._getVisibleRelationships(g);var a=v.filter(function(x){return x.getSuccessor()===s.getShapeId();});a.forEach(function(r){var m=r.getRelatedInRowShapes(g.getId());if(m.predecessor){S.push(m.predecessor);}});S=Array.from(new Set(S));}return S;},selectAssociatedShapes:function(p,g){var s=p.shape;var d=g._getDragDropExtension();var n=!s.getSelected();if(d.shapeSelectedOnMouseDown&&!d.initiallySelected&&!g.getEnableSelectAndDrag()){n=d.shapeSelectedOnMouseDown;}var S=[s];if(s.getEnableChainSelection()){S=this._getShapesToSelect(s,g);}S.forEach(function(a){this.oSelection.updateShape(a.getShapeUid(),{selected:n,ctrl:true,draggable:a.getDraggable(),time:a.getTime(),endTime:a.getEndTime()});}.bind(g));return S;},_getShapesToSelect:function(s,g){var S=[s];var v=this._getVisibleRelationships(g);var a=v.filter(function(x){return x.getPredecessor()===s.getShapeId()||x.getSuccessor()===s.getShapeId();});a.forEach(function(r){var m=r.getRelatedInRowShapes(g.getId());if(m.predecessor&&m.predecessor.getSelectableInChainSelection()){S.push(m.predecessor);}if(m.successor&&m.successor.getSelectableInChainSelection()){S.push(m.successor);}});S=Array.from(new Set(S));return S;},_getVisibleRelationships:function(g){var r=[];g.getTable().getRows().forEach(function(a){var R=a.getAggregation('_settings').getRelationships();r=r.concat(R);});r=Array.from(new Set(r));return r;}};return G;},true);
