//Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/base/Log","sap/ui/core/library","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/core/mvc/XMLView","sap/m/IconTabFilter"],function(U,J,L,c,F,a,X,I){"use strict";var V=c.ValueState;var M={off:"OFF",manual:"MANUAL",auto:"AUTOMATIC"};return U.extend("sap.ushell_abap.transport.Component",{metadata:{manifest:"json",associations:{iconTabBar:{type:" sap.m.IconTabBar",multiple:false}},properties:{showAssignButton:{name:"showAssignButton",type:"Boolean",defaultValue:false}},aggregations:{dependents:{name:"dependents",type:"sap.ui.core.Element",multiple:true}},events:{change:{parameters:{valid:{type:"Boolean"},required:{type:"Boolean"}}},assign:{parameters:{transportId:{type:"string"}}}}},init:function(){U.prototype.init.apply(this,arguments);var t=this.getModel("Transport");this._initModels();this.fnOriginAttachChange=this.attachChange;this.attachChange=function(){this.fnOriginAttachChange.apply(this,arguments);this.fireChange({valid:!this.getModel("TransportInformation").getProperty("/required"),empty:true,required:!!this.getModel("TransportInformation").getProperty("/required")});};this._oMetadataPromise=new Promise(function(r,b){if(t.isMetadataLoadingFailed()){b("Metadata failed to load.");}t.attachMetadataFailed(b);t.metadataLoaded().then(r);});this._setMetaModelData();},_initModels:function(){this.setModel(new J({showAssignButton:this.getShowAssignButton()}),"ViewSettings");this.setModel(new J({mode:null}),"Mode");this.setModel(new J({transportId:null,required:true,valueState:V.None,value:"",transports:[]}),"TransportInformation");},_saveMode:function(){var p;if(this.getModel("Mode").getProperty("/mode")!==null){p=Promise.resolve(this.getModel("Mode").getProperty("/mode"));}else{p=this._getMode().then(function(r){return r&&r.mode?r.mode.transportMode:M.off;}).catch(function(){return M.off;});}return p.then(this._setMode.bind(this));},_setMode:function(m){this.getModel("Mode").setProperty("/mode",m);if(m===M.auto){this.getModel("TransportInformation").setProperty("/required",true);}else{this.getModel("TransportInformation").setProperty("/required",false);}},_getMode:function(){if(this.oModePromise){return this.oModePromise;}this.oModePromise=new Promise(function(r,b){this.getModel("Transport").callFunction("/mode",{method:"POST",success:r,error:b});}.bind(this));return this.oModePromise;},_getTransports:function(o){return new Promise(function(r,b){this.getModel("Transport").read("/transportSet",{success:r,error:b,filters:[new F("objectId",a.EQ,o.toUpperCase())]});}.bind(this));},_setTransportData:function(r,s){var m,t,R;var T=this.getModel("TransportInformation");T.setProperty("/transports",r.results);if(!s){return;}m=this.getModel("Transport").getMessages({sDeepPath:"/transportSet"});t=!m.some(function(b){return b.getCode()==="/UI2/PAGE/072";});R=!m.some(function(b){return b.getCode()==="/UI2/PAGE/055";});T.setProperty("/required",R);T.setProperty("/transportAllowed",t);this.getRootControl().loaded().then(function(v){v.getController().validate();});},_decorateTabBarWithTransportTable:function(o,b){var s=this.getAssociation("iconTabBar");var d=sap.ui.getCore().byId(s);var S=this.showTransport({id:o},b);for(var i=0;i<d.getItems().length;i++){if(d.getItems()[i].getKey()==="iconTabBarTransports"){d.getItems()[i].getContent()[0].getController().bindItems(o,b,d.getItems()[i]);return;}}Promise.all([X.create({id:this.createId("assignedTransport"),viewName:"sap.ushell_abap.transport.view.TransportTable"}),S]).then(function(r){var v=r[0];v.getController().connect(this);this.addDependent(v);v.setModel(this.getModel("Transport"),"Transport");v.setModel(this.getModel("TransportInformation"),"TransportInformation");v.setModel(this.getModel("SupportedOperations"),"SupportedOperations");v.setModel(this.getModel("i18n"),"i18n");v.setModel(this.getModel("ViewSettings"),"ViewSettings");var e=new I({content:v,key:"iconTabBarTransports"});v.byId("assignedTransportTable").addAriaLabelledBy(e);d.addItem(e);v.getController().bindItems(o,b,e);}.bind(this));},setIconTabBar:function(i,o,b){this.setAssociation("iconTabBar",i,true);this._saveMode().then(function(){if(this.getModel("Mode").getProperty("/mode")===M.off){return;}this._decorateTabBarWithTransportTable(o,b);}.bind(this));},reset:function(){var t=this.getModel("TransportInformation");t.setProperty("/transportId",null);t.setProperty("/value","");t.setProperty("/required",true);t.setProperty("/transportAllowed",true);t.setProperty("/assignedToTransport",false);t.setProperty("/valueState",V.None);t.setProperty("/objectType",null);return Promise.resolve();},decorateResultWithTransportInformation:function(s){var t=this.getModel("TransportInformation").getProperty("/transportId");if(!s){s={};}if(t){s.transportId=t;}return s;},_getAssignedTransports:function(o,b){if(!o){return new Promise(function(r,d){r({results:[]});});}var f=[];f.push(new F("objectId",a.EQ,o.toUpperCase()));f.push(new F("objectType",a.EQ,b));return new Promise(function(r,d){this.getModel("Transport").read("/assignedTransportSet",{success:r,error:d,filters:f});}.bind(this));},_storeAssignedTransport:function(i,o){var t=this.getModel("TransportInformation");t.setProperty("/transportId",i);t.setProperty("/transportAllowed",true);t.setProperty("/assignedToTransport",true);t.setProperty("/objectType",o);var T=t.getProperty("/transports");var s=T.find(function(d){return d.id===i;});if(s){var S=T.indexOf(s);var b=this.getRootControl().byId("transportInput").getSuggestionRows()[S];this.getRootControl().byId("transportInput").setSelectionRow(b);}},_unsetTransportAssignment:function(){var t=this.getModel("TransportInformation"),i=this.getRootControl().byId("transportInput");t.setProperty("/assignedToTransport",false);if(i){i.setValue("");}},_isTransportAllowed:function(){var t=this.getModel("TransportInformation").getProperty("/transportAllowed");if(!t){this.getRootControl().byId("transportInput").setValue("");}return t;},_isModeOff:function(){return this.getModel("Mode").getProperty("/mode")===M.off;},_isModeManual:function(){return this.getModel("Mode").getProperty("/mode")===M.manual;},_setMetaModelData:function(){var m=this.getModel("Transport").getMetaModel();m.loaded().then(function(){this.setModel(new J({assignTransportSupported:!!m.getODataFunctionImport("assignTransport")}),"SupportedOperations");}.bind(this));},_resolveToFalse:function(r){this.fireChange({valid:true,empty:true,required:false});r(false);},_resolveToTrue:function(v,r,b){this.fireChange({valid:v,empty:true,required:r});b(true);},showTransport:function(s,o,b){if(typeof o!=="string"){return new Promise(function(r,d){d("No parameter 'objectType' provided");});}var O=s?s.id:"";this.getRootControl().setBusy(true);this.fireChange({valid:false,empty:true,required:true});return new Promise(function(r){Promise.all([this._getAssignedTransports(O,o),this._oMetadataPromise,this._saveMode()]).then(function(d){this._unsetTransportAssignment();if(d[0].results.length){this._storeAssignedTransport(d[0].results[0].id,o);return this._resolveToFalse(r);}if(this._isModeOff()){return this._resolveToFalse(r);}return this._getTransports(O).then(function(t){this._setTransportData(t,s);}.bind(this)).then(function(){var R,v,m;if(!this._isTransportAllowed()){return this._resolveToFalse(r);}if(b&&this._isModeManual()){return this._resolveToFalse(r);}m=this.getModel("TransportInformation");v=!m.getProperty("/required");R=!!m.getProperty("/required");if(b&&!R){return this._resolveToFalse(r);}return this._resolveToTrue(v,R,r);}.bind(this));}.bind(this)).catch(function(e){if(e instanceof Error){L.error(e);}else{L.error(((e&&e.message)?e.message:"Unexpected error"),"ushell_abap/transport/Component.js");}r(false);}).finally(function(){this.getRootControl().setBusy(false);}.bind(this));}.bind(this));},showLockedMessage:function(){return Promise.resolve(false);},setShowAssignButton:function(s){this.getModel("ViewSettings").setProperty("/showAssignButton",!!s);this.setProperty("showAssignButton",s,true);}});});
