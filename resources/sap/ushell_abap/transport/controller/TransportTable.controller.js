// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/SortOrder"],function(C,F,a,b,S,c){"use strict";var A={id:"columnAssignedTransportId",description:"columnAssignedTransportDescription",ownerFullname:"columnAssignedTransportOwner"};return C.extend("sap.ushell_abap.transport.controller.TransportTable.controller",{onInit:function(){this.sObjectId=undefined;this.sObjectType=undefined;},connect:function(d){this.oComponent=d;},updateSortIndicators:function(s,d,e,f){var o=this.byId(e[s]),g=o.getId();for(var i=0;i<f.length;++i){if(f[i].getId()===g){o.setSortIndicator(d?c.Descending:c.Ascending);}else{f[i].setSortIndicator(c.None);}}},handleSortDialogConfirm:function(e){var p=e.getParameters(),s="assignedTransportTable",t=this.byId(s),P=p.sortItem.getKey(),d=p.sortDescending,o;o=new S(P,d);t.getBinding("items").sort(o);this.updateSortIndicators(P,d,A,t.getColumns());},onSort:function(){if(this.oViewSettingsDialog){this.oViewSettingsDialog.open();return;}F.load({name:"sap.ushell_abap.transport.view.SortDialog",controller:this}).then(function(d){this.oViewSettingsDialog=d;d.setModel(this.oComponent.getModel("i18n"),"i18n");d.open();}.bind(this));},onAssign:function(){if(!this.byId("transportAssignDialog--transportDialog")){F.load({id:this.createId("transportAssignDialog"),name:"sap.ushell_abap.transport.view.TransportDialog",type:"XML",controller:this}).then(function(d){this.getView().addDependent(d);this._showTransportDialog(d);}.bind(this));}else{this._showTransportDialog(this.byId("transportAssignDialog--transportDialog"));}},_showTransportDialog:function(d){return this.oComponent.reset().then(function(){return this.oComponent.showTransport(null,this.sObjectType).then(function(){this._filterAssignedTransports();d.open();}.bind(this));}.bind(this));},_filterAssignedTransports:function(){var t=this.getView().getModel("TransportInformation");var d=this.byId("assignedTransportTable").getBinding("items").getContexts().map(function(i){return i.getProperty("id");});var T=t.getProperty("/transports");var f=T.filter(function(e){return d.indexOf(e.id)===-1;});t.setProperty("/transports",f);},onBeforeOpen:function(e){var d=e.getSource(),t=d.getContent()[0];t.setComponent(this.oComponent);},onCancel:function(){this.byId("transportAssignDialog--transportDialog").close();},_saveTransportAssignment:function(t){return new Promise(function(r,d){this.oComponent.getModel("Transport").callFunction("/assignTransport",{method:"POST",urlParameters:{transportId:t,objectId:this.sObjectId,objectType:this.sObjectType},success:r,error:d});}.bind(this));},onSave:function(){var t=this.oComponent.getModel("TransportInformation").getProperty("/transportId");if(t){this._saveTransportAssignment(t).then(function(){this.byId("transportAssignDialog--transportDialog").close();this.byId("assignedTransportTable").getBinding("items").refresh(true);}.bind(this)).catch(function(r){sap.ushell.Container.getServiceAsync("Message").then(function(M){M.show(1,r.message,{details:r.responseText});});});}},bindItems:function(o,d,i){var f=[],t;f.push(new a("objectId",b.EQ,o));f.push(new a("objectType",b.EQ,d));this.sObjectId=o;this.sObjectType=d;this.byId("assignedTransportTable").bindItems({path:"Transport>/assignedTransportSet",filters:f,sorter:new S("id"),template:this.byId("assignedTransportTemplate").clone(),events:{dataReceived:function(e){var D=e.getParameter&&e.getParameter("data"),r=D&&D.results||[];t=this.getView().getModel("i18n").getResourceBundle().getText("IconTabFilterText",[r.length.toString()]);i.setText(t);}.bind(this)}});t=this.getView().getModel("i18n").getResourceBundle().getText("IconTabFilterText",["0"]);i.setText(t);this.byId("columnAssignedTransportId").setSortIndicator("Ascending");}});});
