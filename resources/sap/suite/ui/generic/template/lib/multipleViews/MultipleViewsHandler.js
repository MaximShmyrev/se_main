sap.ui.define(["sap/ui/base/Object","sap/ui/model/Filter","sap/suite/ui/generic/template/lib/multipleViews/MultipleTablesModeHelper","sap/suite/ui/generic/template/lib/multipleViews/SingleTableModeHelper","sap/ui/generic/app/navigation/service/SelectionVariant","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/metadataAnalyser","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/security/encodeURL","sap/ui/comp/util/DateTimeUtil","sap/base/util/isEmptyObject"],function(B,F,M,S,a,c,m,b,t,e,d,D,f){"use strict";var l=new b("lib.multipleViews.MultipleViewsHandler").getLogger();function g(C,T,o){var s=Object.create(null);var h=T.oComponentUtils.getTemplatePrivateModel();var p=o.pathInTemplatePrivateModel+"/items";var P=o.pathInTemplatePrivateModel+"/selectedKey";h.setProperty(o.pathInTemplatePrivateModel,Object.create(null));h.setProperty(p,Object.create(null));var I=new(o.smartControl?S:M)(C,T,o);h.setProperty(o.pathInTemplatePrivateModel+"/mode",I.getMode());var k=T.oServices.oApplication.getBusyHelper().getBusyDelay();var n=C.getOwnerComponent().getModel();var q;var r;var u;function U(){if(r){var i=o.getSearchValue&&o.getSearchValue();var j=i?{search:i}:{};for(var a1 in s){var b1=s[a1];var c1=b1.getPath();b1.numberOfUpdates++;b1.updateStartFunction(b1.numberOfUpdates);n.read(c1+"/$count",{urlParameters:j,filters:b1.getFiltersForCount(),groupId:"updateMultipleViewsItemsCounts",success:b1.updateSuccessFunction.bind(null,b1.numberOfUpdates),error:b1.errorFunction.bind(null,b1.numberOfUpdates)});}}}function R(i,j){var a1="";var b1=j["parameters"];if(!j||!j.entitySetName||!j.navPropertyName||b1.length<1){a1="/"+i.name;return a1;}var c1=o.smartFilterBar&&o.smartFilterBar.getAnalyticalParameters();if(c1&&c1.length>0){var d1=o.smartFilterBar&&o.smartFilterBar.getUiState({allFilters:false});var e1=d1?JSON.stringify(d1.getSelectionVariant()):"{}";var f1=new a(e1);var g1=[];b1.forEach(function(h1){c1.forEach(function(i1){if(i1&&(i1.name===h1)){var j1=i1.name;var k1=f1.getParameter(j1);if(i1.type==='Edm.DateTime'){k1=new Date(k1);k1=D.localToUtc(k1);k1=d(i1.control.getModel().formatValue(k1,i1.type));g1.push(j1+'='+k1);}else{g1.push(j1+'='+"'"+k1+"'");}}});});a1='/'+j.entitySetName+'('+g1.join(',')+')/'+j.navPropertyName;}else{a1="/"+i.name;l.error("SelectionParameters","There are no parameters to resolve");return a1;}return a1;}function G(i){var j;var a1=i.getEntitySet();var b1=C.getOwnerComponent();if(o.smartFilterBar&&o.smartFilterBar.getConsiderAnalyticalParameters&&o.smartFilterBar.getConsiderAnalyticalParameters()){var c1=n.getMetaModel();var d1=c1.getODataEntitySet(a1);var e1=b1.getAppComponent();var f1=m.getParametersByEntitySet(e1.getModel(),a1);j=R(d1,f1);return j;}var g1=i.getTableBindingPath?i.getTableBindingPath():i.getChartBindingPath();j=g1?g1:"/"+a1;var h1=b1.getComponentContainer();var i1=h1.getElementBinding();return i1?i1.getPath()+'/'+j:j;}function v(a1,b1){var c1=n.getMetaModel();var d1=a1.getEntitySet();var e1=c1.getODataEntitySet(d1);var f1=c1.getODataEntityType(e1.entityType);var g1=[],h1;var i1=b1.variantAnnotationPath;if(i1){var j1=f1[i1];if(!j1){return[];}if(!j1.SelectOptions&&j1.SelectionVariant){j1=j1.SelectionVariant;if(j1.Path){i1=j1.Path.split("@")[1];j1=i1&&f1[i1];}}if(j1.AnnotationPath){h1=j1.AnnotationPath.split("@")[1];j1=f1[h1];}for(var i in j1.SelectOptions){if(j1.SelectOptions[i].PropertyName){var k1=j1.SelectOptions[i].PropertyName.PropertyPath;for(var j in j1.SelectOptions[i].Ranges){var l1=j1.SelectOptions[i].Ranges[j].Sign;var m1=j1.SelectOptions[i].Ranges[j].Option;if(l1){m1.EnumMember=w(l1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeSignType/",""),m1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/",""));}else{m1.EnumMember=m1.EnumMember.replace("com.sap.vocabularies.UI.v1.SelectionRangeOptionType/","");}var n1=j1.SelectOptions[i].Ranges[j].Low;var o1=j1.SelectOptions[i].Ranges[j].High;var p1=Object.keys(n1)[0];if(o1){var q1=Object.keys(o1)[0];g1.push(new F(k1,m1.EnumMember,n1[p1],o1[q1]));}else{g1.push(new F(k1,m1.EnumMember,n1[p1]));}}}}}return g1;}function w(i,j){var a1;var b1=new Map([["EQ","NE"],["BT","NB"],["CP","NP"],["LE","GT"],["GE","LT"],["NE","EQ"],["NB","BT"],["NP","CP"],["GT","LE"],["LT","GE"]]);if(i==="I"){a1=j;}else if(i==="E"){if(b1.has(j)){a1=b1.get(j);}else{a1=j;}}return a1;}function H(i){for(var j in s){var a1=s[j];if(a1.smartControl.getEntitySet()===i){return true;}}return false;}function O(i,j){var a1=i.filters.slice(0);var b1=y();i.filters=A(i.filters,b1,j,false);if(r){for(var c1 in s){var d1=s[c1];x(a1,d1,j);}}}function x(i,j,a1){j.getFiltersForCount=function(){return A(i,j,a1,true);};}function A(i,j,a1,b1){if(I.getFiltersAdaptedFromItem){i=I.getFiltersAdaptedFromItem(i,j,a1,b1);}return i.concat(j.selectionVariantFilters);}function y(){return s[u];}function z(i,u){return I.formatMessageStrip(i,u);}function E(){return u;}function J(u){h.setProperty(P,u||q);}function K(){return I.getContentForIappState(u);}function L(i){var j;if(!i){return"";}if(i.state==="error"){return T.oCommonUtils.getText("SEG_BUTTON_ERROR",i.text);}if(i.state===""||i.state==="busy"){var a1=sap.ui.core.format.NumberFormat.getIntegerInstance({groupingEnabled:true});j=a1.format(i.count);}return T.oCommonUtils.getText("SEG_BUTTON_TEXT",[i.text,i.state==="busyLong"?"...":j]);}function N(i){u=I.getSelectedKeyAndRestoreFromIappState(i);if(s[u]){h.setProperty(P,u);}}function Q(){return s[u].templateSortOrder;}function V(i){var j=y();var a1=c.isSmartTable(j.smartControl);if(i!==2){j.smartControl[a1?"rebindTable":"rebindChart"]();}if(i>1){if(a1){if(o.refreshModelOnTableRefresh){T.oCommonUtils.refreshModel(j.smartControl);}T.oCommonUtils.refreshSmartTable(j.smartControl);}else{}}}function W(i,j,a1){var b1=Array.isArray(j);var c1=T.oComponentUtils.isComponentActive();if((b1&&j.length===0)||(a1&&f(a1))){return;}I.refreshOperation(i,j,a1,u,b1,c1,V);}function X(){var i=y();return I.setActiveButtonState(i);}function Y(){var i=y();return I.restoreActiveButtonState&&I.restoreActiveButtonState(i);}function Z(i,j,a1){if(I.setControlVariant){I.setControlVariant(i,j,a1);}}function $(i,j,a1,b1){return T.oCommonUtils.getCustomDataText(i).then(function(c1){a1.text=c1;b1.text=c1;return{modelEntry:a1,pathToTheItem:j};});}function _(i){h.setProperty(i.pathToTheItem,i.modelEntry);}(function(){t.testable(function(){return I;},"getImplementingHelper");t.testable(function(){return r;},"getShowCounts");t.testable(function(){return s[u];},"getCurrentViewMeta");var j=function(d1,j1,k1,l1){if(d1.numberOfUpdates!==k1){return;}var g1=p+"/"+d1.switchingKey;var h1=e({},h.getProperty(g1));if(!h1.state&&j1=="busy"){setTimeout(function(){if(h.getProperty(g1).state==="busy"){h1=e({},h.getProperty(g1));h1.state="busyLong";h.setProperty(g1,h1);}},k);}h1.state=j1;if(!j1){h1.count=l1;}h.setProperty(g1,h1);};var a1=o.switchingControl.getItems();for(var i=0;i<a1.length;i++){var b1=a1[i];var c1=b1.getKey();if(i===0){q=c1;}var d1={smartControl:o.smartControl||o.getSmartControl(c1),switchingKey:c1};var e1=I.getCustomDataHost(d1.smartControl,b1);var f1=T.oCommonUtils.getElementCustomData(e1);var g1=p+"/"+d1.switchingKey;var h1=Object.create(null);h1.text=f1.text;h1.count=0;h1.state="";h1.facetId=o.sectionKey;$(e1,g1,h1,d1).then(_);d1.templateSortOrder=f1.TemplateSortOrder;d1.getPath=G.bind(null,d1.smartControl);d1.selectionVariantFilters=v(d1.smartControl,f1);d1.numberOfUpdates=0;d1.updateStartFunction=j.bind(null,d1,"busy");d1.updateSuccessFunction=j.bind(null,d1,"");d1.errorFunction=j.bind(null,d1,"error");s[c1]=d1;}if(I.init){I.init(s,W,y);}if(o.manifestSettings.showCounts===undefined){r=I.getDefaultShowCounts();}else{r=o.manifestSettings.showCounts;}J();u=h.getProperty(P);var i1=h.bindProperty(P);i1.attachChange(function(j1){var k1=j1.getSource().getValue();if(k1===u){return;}u=k1;if(I.onSelectedKeyChanged){I.onSelectedKeyChanged(k1);}var l1=o.isDataToBeShown();var m1=I.getRefreshMode(u);if(o.adaptRefreshRequestMode){m1=o.adaptRefreshRequestMode(m1);if(l1&&m1>0){V(m1);}else{var n1=y().smartControl;T.oCommonUtils.setEnabledToolbarButtons(n1);}}o.appStateChange();});})();return{updateCounts:U,refreshOperation:W,onRebindContentControl:O,formatMessageStrip:z,getSelectedKey:E,setSelectedKey:J,getContentForIappState:K,restoreFromIappState:N,formatItemTextForMultipleView:L,determineSortOrder:Q,setActiveButtonState:X,restoreActiveButtonState:Y,setControlVariant:Z,hasEntitySet:H};}return B.extend("sap.suite.ui.generic.template.lib.multipleViews.MultipleViewsHandler",{constructor:function(C,T,o){e(this,g(C,T,o));}});});
