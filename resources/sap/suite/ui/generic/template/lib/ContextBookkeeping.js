sap.ui.define(["sap/ui/base/Object","sap/base/util/each","sap/base/util/extend","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper"],function(B,e,a,d){"use strict";function g(t){var p={};var P=[];var A=Object.create(null);function c(i){var E=t.oAppComponent.getTransactionController().getDraftController();var F=E.getDraftContext();var G=i.getObject();var I=F.hasDraft(i);var H=I&&!G.IsActiveEntity;var J=H&&!G.HasActiveEntity;var K=false;var O=G.HasDraftEntity?i.getObject("DraftAdministrativeData/DraftIsCreatedByMe"):false;if(G.DraftEntityCreationDateTime&&G.DraftEntityLastChangeDateTime){K=G.DraftEntityCreationDateTime.getTime()!==G.DraftEntityLastChangeDateTime.getTime();}return{bIsDraft:H,bIsDraftSupported:I,bIsCreate:J,bIsDraftModified:K,bOwnDraftExists:O};}function r(E,V,F,K){var G=E.getPath();var H=c(E);if(V===1&&!H.bIsCreate){P.push(G);}var S=null;var R;if(H.bIsDraftSupported&&!H.bIsCreate&&F){var T=t.mEntityTree[F];if(T&&!T.noOData){if(K){if(H.bIsDraft){var I=[];var J=t.oApplicationProxy.fillSiblingKeyPromise(T,K,I);J.then(function(_){var a1=_.getPath(3,I);if(!p[a1]){p[a1]={oContextInfo:{bIsDraft:false,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:true},aKeysFromIdentity:I};}});}if(T&&!T.noOData){var M=t.oApplicationProxy.getAncestralNode(T,1);var L=A[M.entitySet];if(!L){L={treeNode:M,draftRoots:Object.create(null)};A[M.entitySet]=L;}var N=K[1];R=L[N];if(!R){R={treeNode:M,key:N,childContexts:Object.create(null)};L[N]=R;}}}var O=E.getModel();var Q=O.getMetaModel();var U=Q.getODataEntitySet(F);var W=Q.getODataEntityType(U.entityType);var X=W["com.sap.vocabularies.Common.v1.SemanticKey"];if(X){S=[];for(var i=0;i<X.length;i++){S.push(E.getProperty(X[i].PropertyPath));}}}}var Y=a(p[G]||{},{oContextInfo:H,oContext:E});if(S){Y.aSemanticKeysValues=S;}if(K){Y.aKeysFromIdentity=K;}if(R){Y.oRootContextInfo=R;R.childContexts[G]=Y;}if(H.bIsDraftSupported&&Y.oRootContextInfo){for(var Z in Y.oRootContextInfo.childContexts){var $=Y.oRootContextInfo.childContexts[Z];delete $.oRemovalPromise;}}p[G]=Y;if(H.bIsDraft&&!H.bIsCreate){p[G].bReplaceByActive=false;}else if(H.bOwnDraftExists&&!H.bIsCreate){if(p[G].oEditingPromise){p[G].oEditingPromise.then(function(_){var a1=_.context.getPath();p[a1].bReplaceByActive=true;});}else{u(E).then(function(_){var a1=_.getPath();var b1=p[a1];if(b1){p[a1].bReplaceByActive=true;}});}}return H;}function b(){for(var i=P.length-1;i>=0;i--){var E=p[P[i]].oContext;if(E){return P[i];}}}function f(i){var E=i.getPath();var R=p[E];return R;}function h(i){var R=f(i);return!!R;}function s(i,R,I,E){if(!i.oContextInfo.bIsCreate||!I){i.oRemovalPromise=E?R.then(function(F){return F.context;}):i.oSiblingPromise;}R.then(function(){i.oContext=null;},function(){delete i.oRemovalPromise;});}function j(i,R,I,E){var F=f(i);if(E==="deleteAction"&&!F.oContextInfo.bIsCreate){F.oRemovalPromise=R.then(function(J){F.oContext=null;return J.context;},function(){delete F.oRemovalPromise;});}else if(F.oRootContextInfo){for(var G in F.oRootContextInfo.childContexts){var H=F.oRootContextInfo.childContexts[G];if(H.oContextInfo.bIsDraftSupported){s(H,R,I,F===H);}}}if(!F.oContextInfo.bIsCreate||!I){R.then(function(J){var K=J.context.getPath();var L=p[K];if(L){delete L.oEditingPromise;m(L,false);}});}}function k(i,E){j(i,E,false);}function l(i,E,F){j(i,E,true,F);}function m(i,E){if(i.oRootContextInfo){e(i.oRootContextInfo.childContexts,function(){this.oContextInfo.bOwnDraftExists=E;});}else{i.oContextInfo.bOwnDraftExists=E;}}function n(i,E){var F=f(i);F.oEditingPromise=new Promise(function(R,G){var N=function(){delete F.oEditingPromise;m(F,false);G();};E.then(function(H){if(H.draftAdministrativeData){N();}else{m(F,true);var I=H.context.getPath();p[I]={sActiveContextPath:i.getPath(),oContext:H.context,oContextInfo:{bIsDraft:true,bIsDraftSupported:true,bIsCreate:false,bIsDraftModified:false,bOwnDraftExists:false}};R(H);}},N);});F.oEditingPromise.catch(Function.prototype);}function o(i){var E=p[i];if(E){E.oContext=null;}}function q(M,i){return new Promise(function(R,E){M.read(i+"/SiblingEntity",{success:function(F){if(F){var G=M.getContext("/"+M.getKey(F));R(G);}else{E();}},error:function(F){E(F);}});});}function u(i){var E=f(i);if(E.oContextInfo.bIsCreate){return Promise.resolve();}else if(E.sActiveContextPath){var F=p[E.sActiveContextPath];return Promise.resolve(F.oContext);}var S=E.oSiblingPromise;if(!S){if(E.oContextInfo.bIsDraftSupported&&E.oEditingPromise){S=E.oEditingPromise.then(function(G){var H=G.context.getPath();var I=H&&p[H];if(I&&!I.oRemovalPromise){return Promise.resolve(G.context);}else{return q(i.getModel(),i.getPath());}});}else{S=E.oContextInfo.bIsDraftSupported?q(i.getModel(),i.getPath()):Promise.resolve(i);if(E.oContextInfo.bIsDraft||!E.oContextInfo.bIsDraftSupported){E.oSiblingPromise=S;}}}return S;}function v(i){var E=p[i];return E?u(E.oContext):q(t.oAppComponent.getModel(),i);}function w(i){if(i.treeNode.level===0){return Promise.resolve();}var M=t.oApplicationProxy.getAncestralNode(i.treeNode,1);if(M.noOData||!M.isDraft){return Promise.resolve();}var E=M.getPath(3,i.keys.slice(0,2));return x(E).then(function(F){if(!F){return null;}var G=F.iDisplayMode;var H=false;var T=["",d.analyseContext(F.context).key];var I=function(K){if(!H&&G===2){G=K.isDraft?6:1;}var L={treeNode:K,keys:T};var R={identity:L,displayMode:G};return t.oNavigationControllerProxy.adaptAppStates(i,L).then(function(){return R;});};var J=function(K){if(K===i.treeNode){return I(K);}var L=t.oApplicationProxy.getAncestralNode(i.treeNode,K.level+1);var N=i.keys.slice(0,L.level+1);var O=L.getPath(3,N);return x(O).then(function(Q){if(!Q){return I(K);}T.push(d.analyseContext(Q.context).key);G=Q.iDisplayMode;H=true;return J(L);});};return t.oApplicationProxy.fillSiblingKeyPromise(i.treeNode,i.keys,T).then(J);});}function x(i){var E=p[i];if(!E){return Promise.resolve();}return new Promise(function(R){var F=null;var G=function(){R(F);};var H=function(I){I.then(function(J){var K=J.context.getPath();var L=p[K];if(L&&L.oContext&&!L.bReplaceByActive){F={context:J.context,iDisplayMode:2};}G();},G);};if(E.oRemovalPromise){E.oRemovalPromise.then(function(I){F={context:I,iDisplayMode:1};var J=I.getPath();var K=p[J];var L=K&&K.oEditingPromise;if(L){H(L);}else{G();}},G);}else if(E.bReplaceByActive){u(E.oContext).then(function(I){F={context:I,iDisplayMode:1};G();});}else if(E.oContextInfo&&!E.oContextInfo.bIsDraft&&E.oContextInfo.bOwnDraftExists){if(E.oEditingPromise){H(E.oEditingPromise);}else if(E.oContext){u(E.oContext).then(function(I){var J=I.getPath();var K=p[J];if(!K||!K.bReplaceByActive){F={context:I,iDisplayMode:2};}G();});}else{G();}}else{G();}});}function y(i){var E=f(i);return E&&E.aKeysFromIdentity;}function z(E,F,I,H,N){return new Promise(function(R,G){var M=t.oAppComponent.getModel();var J=E&&d.analyseContextPath(E,M).canonicalPath;var K=F&&d.analyseContextPath(F,M).canonicalPath;if(J===K){R(true);return;}if(!J||!K){R(false);return;}var L=p[J];if(!L||!L.oContextInfo.bIsDraftSupported){R(false);return;}var O=p[K];var Q,S;if((!L||!L.oContextInfo)&&(O&&!O.oContextInfo.bIsDraft)){var T=function(i){return i;};L=T(O,O=L);J=T(K,K=J);H=T(N,N=H);}function U(L,O){if(!L||!O){R(false);return;}if(!L.oContextInfo.bIsDraft&&!O.oContextInfo.bIsDraft){R(false);return;}if(L.oContextInfo.bIsCreate&&O.oContextInfo.bIsCreate){R(false);return;}if(I){x(J).then(function(Z){R(!!Z&&Z.context.getPath()===K);},G);return;}if(L.aSemanticKeysValues){var Y=!!O.aSemanticKeysValues;for(var i=0;Y&&i<L.aSemanticKeysValues.length;i++){Y=L.aSemanticKeysValues[i]===O.aSemanticKeysValues[i];}R(Y);return;}R(false);}if(!L.oContextInfo.bIsDraft&&(!O||!O.oContextInfo)){if(H&&N&&H.treeNode.entitySet===N.treeNode.entitySet){S=N&&N.keys;var V=M.getContext(K)||M.createBindingContext(K);var W=V&&c(V);if(V&&!W.bIsDraft){R(false);}else{var X=u(L.oContext);X.then(function(i){if(i.sPath&&K===i.sPath){Q=i;O=p[K];if(!O){r(Q,N.treeNode.level,N.treeNode.entitySet,S);p[K].sActiveContextPath=L.oContext.getPath();}U(L,p[K]);}else{R(false);}},function(){R(false);});}}else{R(false);return;}}else{U(L,O);}});}function C(i){return p[i].oContextInfo.bIsDraftModified;}function D(i){if(p[i]){p[i].oContextInfo.bIsDraftModified=true;}}return{registerContext:r,adaptAfterObjectDeleted:o,activationStarted:k,cancellationStarted:l,editingStarted:n,getDraftSiblingPromise:u,getSiblingPromise:v,getAlternativeIdentityPromise:w,getPathOfLastShownDraftRoot:b,areTwoKnownPathesIdentical:z,markDraftAsModified:D,getIsDraftModified:C,getIdentityKeyForContext:y,checkmPath2ContextData:h};}return B.extend("sap.suite.ui.generic.template.lib.ContextBookkeeping",{constructor:function(t){a(this,g(t));}});});
