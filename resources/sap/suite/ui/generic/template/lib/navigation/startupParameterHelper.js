sap.ui.define(["sap/base/util/extend","sap/base/util/isEmptyObject","sap/base/util/each","sap/m/MessageBox","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/analytics/odata4analytics","sap/ui/generic/app/util/ModelUtil","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/suite/ui/generic/template/lib/CRUDHelper"],function(e,a,b,M,F,c,o,d,f,D,t,C){"use strict";var s="lib.navigation.startupParameterHelper";var l=new f(s).getLogger();function g(i,I){return{mode:i&&I&&(I!==i)?"inconsistent":I||i||"display",force:!!I};}function p(i){var I=i.oAppComponent.getModel("_templPrivGlobal");I.setProperty("/generic/forceFullscreenCreate",true);}function T(i,I,J){if(a(J)){return;}var K=i.getMetaModel();var L=K.getODataEntitySet(I);var O=L&&L.entityType;var Q=K.getODataEntityType(O);var R=(Q&&Q.property)||[];var S=[];R.forEach(function(U){if(U.type==="Edm.Guid"){S.push(U.name);}});S.forEach(function(U){var V=J[U];if(V){var W=V[0];W=W.toLowerCase().replace(/(guid')([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(')/,"$2");if(!W.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/)){W=W.replace(/([0-9a-f]{8})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{4})([0-9a-f]{12})/,"$1-$2-$3-$4-$5");}V[0]=W;}});}function h(i){var I=i.oAppComponent.getInboundParameters();return I?Object.keys(I).filter(function(J){return I[J].useForCreate;}):[];}function P(I,J){var R;var K=h(I);for(var i=0;i<K.length;i++){var L=K[i];var V=J[L];if(V&&V.length===1){R=R||Object.create(null);R[L]=V[0];}}return R;}function j(i,I,J){var K=i.getODataEntityType(i.getODataEntitySet(I).entityType);K.property.forEach(function(L){if(L["com.sap.vocabularies.Common.v1.EditableFieldFor"]){var O=L["com.sap.vocabularies.Common.v1.EditableFieldFor"].PropertyPath||L["com.sap.vocabularies.Common.v1.EditableFieldFor"].String;var Q=L.name;if(J[O]&&!J[Q]){J[Q]=J[O];}if(J[Q]&&!J[O]){J[O]=J[Q];}}});}function k(i,I){return!(i.page.navigation&&i.page.navigation[I.mode]);}function m(K,i){return!!K&&K.every(function(I){var J=I.name||I.PropertyPath;var L=i[J]||[];return L.length===1;});}function n(i){var S=D.splitCanonicalPath(i);return S.key;}function q(i,I,J,K,L){if(J.noKey){return{treeNode:J,navigationPossible:true,keyValue:""};}var O=I.getODataEntitySet(J.entitySet);if(!O){return null;}var Q=I.getODataEntityType(O.entityType);var S=Q["com.sap.vocabularies.Common.v1.SemanticKey"];if(m(S,K)){return{treeNode:J,key:S,isSemantic:true};}return L&&Q.key.propertyRef&&m(Q.key.propertyRef,K)&&{treeNode:J,navigationPossible:true,keyValue:n(i.createKey(J.entitySet,K))};}function r(i,I,J,K,L,O,Q){K.children.forEach(function(R){var S=J.mEntityTree[R];if(S.page.component.settings&&S.page.component.settings.allowDeepLinking&&k(S,O)){var U=q(i,I,S,L,false);if(U){Q[S.sRouteName]=U;r(i,I,J,S,L,O,Q);}}});}function u(i,I,J,K,L){var R=Object.create(null);R.root={treeNode:I.mRoutingTree.root,navigationPossible:true,keyValue:""};var O=I.mEntityTree[J];if(O&&!(O.page.component.settings&&O.page.component.settings.allowDeepLinking===false)&&k(O,L)){var Q=i.getMetaModel();var S=q(i,Q,O,K,true);if(S){R[O.sRouteName]=S;if(L.mode==="display"){r(i,Q,I,O,K,L,R);}}}return R;}function v(i,I){var J=I.key.map(function(L){var O=L.PropertyPath;var V=i[O][0];return new F(O,c.EQ,V);});if(I.treeNode.isDraft){var K=new F({filters:[new F("IsActiveEntity","EQ",false),new F("SiblingEntity/IsActiveEntity","EQ",null)],and:false});J.push(K);}return new F(J,true);}function w(I,J,K){var L=K.treeNode.entitySet;var R="/"+L;try{var O=new o.Model(o.Model.ReferenceByModel(I));var Q=O.findQueryResultByName(L);var S=new o.QueryResultRequest(Q);var U=Q&&Q.getParameterization();var V=false;if(U){S.setParameterizationRequest(new o.ParameterizationRequest(U));var W=U.getAllParameterNames();b(W,function(){if(J.hasOwnProperty(this)){V=true;S.getParameterizationRequest().setParameterValue(this,J[this][0]);}});for(var i=0;i<W.length;i++){if(W[i].startsWith("P_")){var X=W[i].substr(2);if(J.hasOwnProperty(X)){V=true;S.getParameterizationRequest().setParameterValue(W[i],J[X][0]);}}}if(V){R=S.getURIToQueryResultEntitySet();}}}catch(Y){l.info(Y.name+":"+Y.message);}return R;}function x(R){if(!(R&&R.results)){return null;}var i;R.results.some(function(I){i=I;return I.IsActiveEntity;});return i;}function y(i,I,J){var K=v(I,J);var L=w(i,I,J);return new Promise(function(R){i.read(L,{filters:[K],success:function(O){var Q=x(O);var S=Q&&i.getKey(Q);var U=S&&n(S);R(U);},error:function(){R();}});});}function N(I,J,K,L){var O=Object.keys(K).filter(function(R){return!K[R].navigationPossible;});var Q=O.map(function(R){var i=K[R];return y(J,L,i);});return Promise.all(Q).then(function(R){for(var i=0;i<O.length;i++){var S=K[O[i]];S.keyValue=R[i];}var U=function($){var S=K[$];if(S.navigationPossible===undefined){S.navigationPossible=!!S.keyValue&&U(S.treeNode.parentRoute);}return S.navigationPossible;};var V;b(K,function($){if(U($)){var _=K[$].treeNode;V=(!V||V.level<_.level)?_:V;}});var W=[];for(var X=V;X;X=X.level&&I.mRoutingTree[X.parentRoute]){W[X.level]=K[X.sRouteName].keyValue;}var Y=Object.create(null);if(I.oFlexibleColumnLayoutHandler){I.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(V,Y);}var Z={treeNode:V,keys:W,appStates:Y};return I.oNavigationControllerProxy.navigateToIdentity(Z,true,1).then(Function.prototype);});}function z(I,J){if(J==="create"&&I.mRoutingTree.root.page.component.settings&&I.mRoutingTree.root.page.component.settings.creationEntitySet){return Promise.resolve(I.mRoutingTree.root.page.component.settings.creationEntitySet);}return I.myIntentPromise?I.myIntentPromise.then(function(K){var R=I.mRoutingTree.root.children;for(var i=0;i<R.length;i++){var L=R[i];if(I.mEntityTree[L].semanticObject===K.semanticObject){return L;}}return I.mRoutingTree.root.entitySet;}):Promise.resolve(I.mRoutingTree.root.entitySet);}function A(i,I,J,K){p(i);var L=P(i,I);var O=i.oAppComponent.getTransactionController().getDraftController();var Q=O.getDraftContext().isDraftEnabled(K);if(Q){var R=i.mEntityTree[K]||i.mRoutingTree.root;i.oNavigationControllerProxy.prepareHostView(R);var S=i.oNavigationControllerProxy.oRouter.getTargets();S.display(R.sRouteName);return R.componentCreated.then(function(V){var W=i.componentRegistry[V.getId()];return W.viewRegistered.then(function(){var X=null;var Y=W.oController;var Z=i.oAppComponent.getApplicationController();var $=!!(i.mRoutingTree.root.page.component.settings&&i.mRoutingTree.root.page.component.settings.useNewActionForCreate);var _={sRootExpand:X,oController:Y,oApplicationController:Z,bUseNewActionForCreate:$};var a1=C.create(O,K,"/"+K,J,i.oApplicationProxy,L,_);return a1.then(function(b1){var U=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var R=i.mEntityTree[K];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(R,U);}return i.oNavigationControllerProxy.navigateToSubContext(b1,true,4,null,U).then(Function.prototype);},function(b1){return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:b1.messageText,description:"",icon:"sap-icon://message-error"};});});});}var U=Object.create(null);if(i.oFlexibleColumnLayoutHandler){i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation(i.mEntityTree[K],U);}return i.oNavigationControllerProxy.navigateForNonDraftCreate(K,L,null,U).then(Function.prototype);}function B(I,J,K,L){p(I);return new Promise(function(R){var O=function(Z){R({title:I.getText("ST_ERROR"),text:(Z&&Z.messageText)||I.getText("ST_GENERIC_UNKNOWN_NAVIGATION_TARGET"),icon:"sap-icon://message-error",description:""});};var Q=K.getMetaModel().getODataEntitySet(L);var S=Q["com.sap.vocabularies.Common.v1.DraftRoot"];if(S&&S.NewAction){var U=K.getMetaModel().getODataFunctionImport(S.NewAction.String.split("/")[1]);var V={};if(U){var W=U.parameter?U.parameter.length:0;for(var i=0;i<W;i++){var X=U.parameter[i];var Y=X.mode==="In"&&J[X.name]&&J[X.name][0];if(Y){V[X.name]=Y;}}K.callFunction("/"+U.name,{success:function(Z,$){var _=new d(K);var a1=_.getContextFromResponse(Z);if(a1){I.oNavigationControllerProxy.navigateToSubContext(a1,true,4).then(R.bind(null,null));}else{O();}},error:O,method:"POST",urlParameters:V});return;}}O();});}function E(i,I,J,K,L){var O=e({},I);j(K.getMetaModel(),J,O);var Q=u(K,i,J,O,L);var R;for(var S in Q){if(S!=="root"){R=Q[S];break;}}if(R){var U=i.oAppComponent.getTransactionController();var V=R.isSemantic?"":K.createKey(J,O);var W=R.isSemantic&&R.key;var X=C.edit(U,J,V,K,i,i.oNavigationControllerProxy.fnInitializationResolve,W,O);return X.then(function(Y){var Z=Object.create(null);if(i.oFlexibleColumnLayoutHandler){var $=i.mEntityTree[J];i.oFlexibleColumnLayoutHandler.adaptAppStatesForExternalNavigation($,Z);}return i.oNavigationControllerProxy.navigateToSubContext(Y.context,true,2,null,Z).then(Function.prototype);},function(Y){if(Y.lockedByUser){if(L.force){return{title:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),text:i.getText("LOCKED_OBJECT_POPOVER_TITLE"),description:i.getText("ST_GENERIC_LOCKED_OBJECT_POPOVER_TEXT",[Y.lockedByUser]),icon:"sap-icon://message-error"};}return N(i,K,Q,O);}if(Y.draftAdminReadResponse){return null;}return new Promise(function(Z){var $=i.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");M.warning($,{onClose:function(){N(i,K,Q,O).then(Z);}});});});}return Promise.resolve();}function G(i,I,J,K,L){var O=e({},I);j(K.getMetaModel(),J,O);var Q=u(K,i,J,O,L);return N(i,K,Q,O);}function H(i,I){var R=I&&I.route&&I.route.length===1&&I.route[0];if(R){i.oNavigationControllerProxy.navigate(R,true);return Promise.resolve();}var J=I&&I.preferredMode&&I.preferredMode[0];var K=I&&I.mode&&I.mode[0];var L=g(J,K);var O=z(i,L.mode);return O.then(function(Q){var S=i.oAppComponent.getModel();T(S,Q,I);switch(L.mode){case"create":return A(i,I,S,Q);case"createWithContext":return B(i,I,S,Q);case"edit":return E(i,I,Q,S,L);case"display":return G(i,I,Q,S,L);}return{title:i.getText("ST_GENERIC_ERROR_TITLE"),text:i.getText("ST_GENERIC_ERROR_TITLE"),description:i.getText("PARAMETER_COMBINATION_NOT_SUPPORTED",[K,J]),icon:"sap-icon://message-error",replaceURL:true};});}var T=t.testableStatic(T,"startupParameterHelper_transformGuidParameters");return{parametersToNavigation:H};});
