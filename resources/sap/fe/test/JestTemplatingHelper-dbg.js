sap.ui.define(["sap/fe/macros/internal/Field.metadata", "sap/fe/macros/PhantomUtil", "sap/ui/model/odata/v4/lib/_MetadataRequestor", "sap/ui/model/odata/v4/ODataMetaModel", "sap/ui/core/util/XMLPreprocessor", "sap/base/Log", "xpath", "fs", "@sap/cds-compiler", "prettier", "sap/ui/base/BindingParser", "sap/ui/model/json/JSONModel", "sap/ui/core/InvisibleText", "sap/fe/core/converters/ConverterContext", "sap/base/util/merge"], function (FieldMetadata, PhantomUtil, _MetadataRequestor, ODataMetaModel, XMLPreprocessor, Log, xpath, fs, cds_compiler, prettier, BindingParser, JSONModel, InvisibleText, ConverterContext, merge) {
  "use strict";

  var _exports = {};
  var createConverterContext = ConverterContext.createConverterContext;
  var format = prettier.format;
  var to = cds_compiler.to;
  var compileSources = cds_compiler.compileSources;
  var compactModel = cds_compiler.compactModel;
  PhantomUtil.register(FieldMetadata);
  Log.setLevel(1, "sap.ui.core.util.XMLPreprocessor");
  jest.setTimeout(40000);
  var nameSpaceMap = {
    "control": "sap.fe.core.controls",
    "core": "sap.ui.core",
    "m": "sap.m",
    "mdc": "sap.ui.mdc",
    "mdcField": "sap.ui.mdc.field",
    "u": "sap.ui.unified"
  };
  var select = xpath.useNamespaces(nameSpaceMap);

  var registerMacro = function (macroMetadata) {
    PhantomUtil.register(macroMetadata);
  };

  _exports.registerMacro = registerMacro;

  var runXPathQuery = function (selector, xmldom) {
    return select(selector, xmldom);
  };

  expect.extend({
    toHaveControl: function (xmldom, selector) {
      var nodes = runXPathQuery("/root".concat(selector), xmldom);
      return {
        message: function () {
          var outputXml = serializeXML(xmldom);
          return "did not find controls matching ".concat(selector, " in generated xml:\n ").concat(outputXml);
        },
        pass: nodes && nodes.length >= 1
      };
    },
    toNotHaveControl: function (xmldom, selector) {
      var nodes = runXPathQuery("/root".concat(selector), xmldom);
      return {
        message: function () {
          var outputXml = serializeXML(xmldom);
          return "There is a control matching ".concat(selector, " in generated xml:\n ").concat(outputXml);
        },
        pass: nodes && nodes.length === 0
      };
    }
  });
  _exports.runXPathQuery = runXPathQuery;

  var getControlAttribute = function (controlSelector, attributeName, xmlDom) {
    var selector = "string(/root".concat(controlSelector, "/@").concat(attributeName, ")");
    return runXPathQuery(selector, xmlDom);
  };

  _exports.getControlAttribute = getControlAttribute;

  var serializeXML = function (xmlDom) {
    var serializer = new window.XMLSerializer();
    var xmlString = serializer.serializeToString(xmlDom).replace(/(?:[\t ]*(?:\r?\n|\r))+/g, "\n").replace(/\\"/g, '"');
    return format(xmlString, {
      parser: "html"
    });
  };
  /**
   * Method to compile a cds file into an edmx file that is generated.
   * @param sCDSUrl {string} the path to the file containing the cds definition. this file MUST declare the namespace
   * sap.fe.test and a service JestService
   * @returns {string} edmxUrl the path of the generated edmx
   */


  _exports.serializeXML = serializeXML;

  var compileCDS = function (sCDSUrl) {
    var cdsString = fs.readFileSync(sCDSUrl, "UTF8");
    var csn = compileSources({
      "string.cds": cdsString
    }, {});
    var csnModel = compactModel(csn);
    var edmxContent = to.edmx(csnModel, {
      service: "sap.fe.test.JestService"
    });
    var edmxUrl = sCDSUrl.replace(".cds", ".xml");
    edmxUrl = edmxUrl.replace(/\/([^\/]*)$/, "/gen/" + "$1"); // if the gen folder does not exist build it

    var dir = edmxUrl.slice(0, edmxUrl.lastIndexOf("/"));

    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir);
    }

    fs.writeFileSync(edmxUrl, edmxContent);
    return edmxUrl;
  };

  _exports.compileCDS = compileCDS;

  var getFakeShellService = function () {
    var contentDensities = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "compact";
    return {
      getContentDensity: function () {
        return contentDensities;
      }
    };
  };

  _exports.getFakeShellService = getFakeShellService;

  var getFakeDiagnostics = function () {
    var issues = [];
    return {
      addIssue: function (issueCategory, issueSeverity, details) {
        issues.push({
          issueCategory: issueCategory,
          issueSeverity: issueSeverity,
          details: details
        });
      },
      getIssues: function () {
        return issues;
      },
      checkIfIssueExists: function (issueCategory, issueSeverity, details) {
        return issues.find(function (issue) {
          issue.issueCategory === issueCategory && issue.issueSeverity === issueSeverity && issue.details === details;
        });
      }
    };
  };

  _exports.getFakeDiagnostics = getFakeDiagnostics;

  var getConverterContext = function (convertedTypes, manifestSettings, templateType) {
    var userContentDensities = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : "compact";
    var entitySet = convertedTypes.entitySets.find(function (es) {
      return es.name === manifestSettings.entitySet;
    });
    var dataModelPath = getDataModelObjectPathForProperty(entitySet, entitySet);
    return createConverterContext(convertedTypes, manifestSettings, templateType, getFakeShellService(userContentDensities), getFakeDiagnostics(), merge, dataModelPath);
  };

  _exports.getConverterContext = getConverterContext;

  var getMetaModel = function (sMetadataUrl) {
    try {
      var oRequestor = _MetadataRequestor.create({}, "4.0", {});

      var oMetaModel = new ODataMetaModel(oRequestor, sMetadataUrl, undefined, null);
      return Promise.resolve(oMetaModel.fetchEntityContainer()).then(function () {
        return oMetaModel;
      });
    } catch (e) {
      return Promise.reject(e);
    }
  };

  _exports.getMetaModel = getMetaModel;

  var getDataModelObjectPathForProperty = function (entitySet, property) {
    var targetPath = {
      startingEntitySet: entitySet,
      navigationProperties: [],
      targetObject: property,
      targetEntitySet: entitySet,
      targetEntityType: entitySet.entityType
    };
    targetPath.contextLocation = targetPath;
    return targetPath;
  };

  _exports.getDataModelObjectPathForProperty = getDataModelObjectPathForProperty;

  var evaluateBinding = function (bindingString) {
    var bindingElement = BindingParser.complexParser(bindingString);

    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
      args[_key - 1] = arguments[_key];
    }

    return bindingElement.formatter.apply(undefined, args);
  };

  _exports.evaluateBinding = evaluateBinding;

  var evaluateBindingWithModel = function (bindingString, modelContent) {
    var bindingElement = BindingParser.complexParser(bindingString);
    var jsonModel = new JSONModel(modelContent);
    var text = new InvisibleText();
    text.bindProperty("text", bindingElement);
    text.setModel(jsonModel);
    text.setBindingContext(jsonModel.createBindingContext("/"));
    return text.getText();
  };

  _exports.evaluateBindingWithModel = evaluateBindingWithModel;

  var getTemplatingResult = function (xmlInput, sMetadataUrl, mBindingContexts, mModels) {
    try {
      var templatedXml = "<root>".concat(xmlInput, "</root>");
      var parser = new window.DOMParser();
      var xmlDoc = parser.parseFromString(templatedXml, "text/xml");
      return Promise.resolve(getMetaModel(sMetadataUrl)).then(function (oMetaModel) {
        var oPreprocessorSettings = {
          models: Object.assign({
            metaModel: oMetaModel
          }, mModels),
          bindingContexts: {}
        }; //Inject models and bindingContexts

        Object.keys(mBindingContexts).forEach(function (sKey) {
          /* Assert to make sure the annotations are in the test metadata -> avoid misleading tests */
          expect(typeof oMetaModel.getObject(mBindingContexts[sKey])).toBeDefined();
          var oModel = mModels[sKey] || oMetaModel;
          oPreprocessorSettings.bindingContexts[sKey] = oModel.createBindingContext(mBindingContexts[sKey]); //Value is sPath

          oPreprocessorSettings.models[sKey] = oModel;
        }); //This context for macro testing

        if (oPreprocessorSettings.models["this"]) {
          oPreprocessorSettings.bindingContexts["this"] = oPreprocessorSettings.models["this"].createBindingContext("/");
        }

        return XMLPreprocessor.process(xmlDoc.firstElementChild, {
          name: "Test Fragment"
        }, oPreprocessorSettings);
      });
    } catch (e) {
      return Promise.reject(e);
    }
  };

  _exports.getTemplatingResult = getTemplatingResult;
  return _exports;
}, false);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkplc3RUZW1wbGF0aW5nSGVscGVyLnRzIl0sIm5hbWVzIjpbIlBoYW50b21VdGlsIiwicmVnaXN0ZXIiLCJGaWVsZE1ldGFkYXRhIiwiTG9nIiwic2V0TGV2ZWwiLCJqZXN0Iiwic2V0VGltZW91dCIsIm5hbWVTcGFjZU1hcCIsInNlbGVjdCIsInhwYXRoIiwidXNlTmFtZXNwYWNlcyIsInJlZ2lzdGVyTWFjcm8iLCJtYWNyb01ldGFkYXRhIiwicnVuWFBhdGhRdWVyeSIsInNlbGVjdG9yIiwieG1sZG9tIiwiZXhwZWN0IiwiZXh0ZW5kIiwidG9IYXZlQ29udHJvbCIsIm5vZGVzIiwibWVzc2FnZSIsIm91dHB1dFhtbCIsInNlcmlhbGl6ZVhNTCIsInBhc3MiLCJsZW5ndGgiLCJ0b05vdEhhdmVDb250cm9sIiwiZ2V0Q29udHJvbEF0dHJpYnV0ZSIsImNvbnRyb2xTZWxlY3RvciIsImF0dHJpYnV0ZU5hbWUiLCJ4bWxEb20iLCJzZXJpYWxpemVyIiwid2luZG93IiwiWE1MU2VyaWFsaXplciIsInhtbFN0cmluZyIsInNlcmlhbGl6ZVRvU3RyaW5nIiwicmVwbGFjZSIsImZvcm1hdCIsInBhcnNlciIsImNvbXBpbGVDRFMiLCJzQ0RTVXJsIiwiY2RzU3RyaW5nIiwiZnMiLCJyZWFkRmlsZVN5bmMiLCJjc24iLCJjb21waWxlU291cmNlcyIsImNzbk1vZGVsIiwiY29tcGFjdE1vZGVsIiwiZWRteENvbnRlbnQiLCJ0byIsImVkbXgiLCJzZXJ2aWNlIiwiZWRteFVybCIsImRpciIsInNsaWNlIiwibGFzdEluZGV4T2YiLCJleGlzdHNTeW5jIiwibWtkaXJTeW5jIiwid3JpdGVGaWxlU3luYyIsImdldEZha2VTaGVsbFNlcnZpY2UiLCJjb250ZW50RGVuc2l0aWVzIiwiZ2V0Q29udGVudERlbnNpdHkiLCJnZXRGYWtlRGlhZ25vc3RpY3MiLCJpc3N1ZXMiLCJhZGRJc3N1ZSIsImlzc3VlQ2F0ZWdvcnkiLCJpc3N1ZVNldmVyaXR5IiwiZGV0YWlscyIsInB1c2giLCJnZXRJc3N1ZXMiLCJjaGVja0lmSXNzdWVFeGlzdHMiLCJmaW5kIiwiaXNzdWUiLCJnZXRDb252ZXJ0ZXJDb250ZXh0IiwiY29udmVydGVkVHlwZXMiLCJtYW5pZmVzdFNldHRpbmdzIiwidGVtcGxhdGVUeXBlIiwidXNlckNvbnRlbnREZW5zaXRpZXMiLCJlbnRpdHlTZXQiLCJlbnRpdHlTZXRzIiwiZXMiLCJuYW1lIiwiZGF0YU1vZGVsUGF0aCIsImdldERhdGFNb2RlbE9iamVjdFBhdGhGb3JQcm9wZXJ0eSIsImNyZWF0ZUNvbnZlcnRlckNvbnRleHQiLCJtZXJnZSIsImdldE1ldGFNb2RlbCIsInNNZXRhZGF0YVVybCIsIm9SZXF1ZXN0b3IiLCJfTWV0YWRhdGFSZXF1ZXN0b3IiLCJjcmVhdGUiLCJvTWV0YU1vZGVsIiwiT0RhdGFNZXRhTW9kZWwiLCJ1bmRlZmluZWQiLCJmZXRjaEVudGl0eUNvbnRhaW5lciIsInByb3BlcnR5IiwidGFyZ2V0UGF0aCIsInN0YXJ0aW5nRW50aXR5U2V0IiwibmF2aWdhdGlvblByb3BlcnRpZXMiLCJ0YXJnZXRPYmplY3QiLCJ0YXJnZXRFbnRpdHlTZXQiLCJ0YXJnZXRFbnRpdHlUeXBlIiwiZW50aXR5VHlwZSIsImNvbnRleHRMb2NhdGlvbiIsImV2YWx1YXRlQmluZGluZyIsImJpbmRpbmdTdHJpbmciLCJiaW5kaW5nRWxlbWVudCIsIkJpbmRpbmdQYXJzZXIiLCJjb21wbGV4UGFyc2VyIiwiYXJncyIsImZvcm1hdHRlciIsImFwcGx5IiwiZXZhbHVhdGVCaW5kaW5nV2l0aE1vZGVsIiwibW9kZWxDb250ZW50IiwianNvbk1vZGVsIiwiSlNPTk1vZGVsIiwidGV4dCIsIkludmlzaWJsZVRleHQiLCJiaW5kUHJvcGVydHkiLCJzZXRNb2RlbCIsInNldEJpbmRpbmdDb250ZXh0IiwiY3JlYXRlQmluZGluZ0NvbnRleHQiLCJnZXRUZXh0IiwiZ2V0VGVtcGxhdGluZ1Jlc3VsdCIsInhtbElucHV0IiwibUJpbmRpbmdDb250ZXh0cyIsIm1Nb2RlbHMiLCJ0ZW1wbGF0ZWRYbWwiLCJET01QYXJzZXIiLCJ4bWxEb2MiLCJwYXJzZUZyb21TdHJpbmciLCJvUHJlcHJvY2Vzc29yU2V0dGluZ3MiLCJtb2RlbHMiLCJPYmplY3QiLCJhc3NpZ24iLCJtZXRhTW9kZWwiLCJiaW5kaW5nQ29udGV4dHMiLCJrZXlzIiwiZm9yRWFjaCIsInNLZXkiLCJnZXRPYmplY3QiLCJ0b0JlRGVmaW5lZCIsIm9Nb2RlbCIsIlhNTFByZXByb2Nlc3NvciIsInByb2Nlc3MiLCJmaXJzdEVsZW1lbnRDaGlsZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBc0JBQSxFQUFBQSxXQUFXLENBQUNDLFFBQVosQ0FBcUJDLGFBQXJCO0FBRUFDLEVBQUFBLEdBQUcsQ0FBQ0MsUUFBSixDQUFhLENBQWIsRUFBZ0Isa0NBQWhCO0FBQ0FDLEVBQUFBLElBQUksQ0FBQ0MsVUFBTCxDQUFnQixLQUFoQjtBQUVBLE1BQU1DLFlBQVksR0FBRztBQUNwQixlQUFXLHNCQURTO0FBRXBCLFlBQVEsYUFGWTtBQUdwQixTQUFLLE9BSGU7QUFJcEIsV0FBTyxZQUphO0FBS3BCLGdCQUFZLGtCQUxRO0FBTXBCLFNBQUs7QUFOZSxHQUFyQjtBQVFBLE1BQU1DLE1BQU0sR0FBR0MsS0FBSyxDQUFDQyxhQUFOLENBQW9CSCxZQUFwQixDQUFmOztBQUVPLE1BQU1JLGFBQWEsR0FBRyxVQUFTQyxhQUFULEVBQTZCO0FBQ3pEWixJQUFBQSxXQUFXLENBQUNDLFFBQVosQ0FBcUJXLGFBQXJCO0FBQ0EsR0FGTTs7OztBQUdBLE1BQU1DLGFBQWEsR0FBRyxVQUFTQyxRQUFULEVBQTJCQyxNQUEzQixFQUFxRDtBQUNqRixXQUFPUCxNQUFNLENBQUNNLFFBQUQsRUFBV0MsTUFBWCxDQUFiO0FBQ0EsR0FGTTs7QUFJUEMsRUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWM7QUFDYkMsSUFBQUEsYUFEYSxZQUNDSCxNQURELEVBQ1NELFFBRFQsRUFDbUI7QUFDL0IsVUFBTUssS0FBSyxHQUFHTixhQUFhLGdCQUFTQyxRQUFULEdBQXFCQyxNQUFyQixDQUEzQjtBQUNBLGFBQU87QUFDTkssUUFBQUEsT0FBTyxFQUFFLFlBQU07QUFDZCxjQUFNQyxTQUFTLEdBQUdDLFlBQVksQ0FBQ1AsTUFBRCxDQUE5QjtBQUNBLDBEQUF5Q0QsUUFBekMsa0NBQXlFTyxTQUF6RTtBQUNBLFNBSks7QUFLTkUsUUFBQUEsSUFBSSxFQUFFSixLQUFLLElBQUlBLEtBQUssQ0FBQ0ssTUFBTixJQUFnQjtBQUx6QixPQUFQO0FBT0EsS0FWWTtBQVdiQyxJQUFBQSxnQkFYYSxZQVdJVixNQVhKLEVBV1lELFFBWFosRUFXc0I7QUFDbEMsVUFBTUssS0FBSyxHQUFHTixhQUFhLGdCQUFTQyxRQUFULEdBQXFCQyxNQUFyQixDQUEzQjtBQUNBLGFBQU87QUFDTkssUUFBQUEsT0FBTyxFQUFFLFlBQU07QUFDZCxjQUFNQyxTQUFTLEdBQUdDLFlBQVksQ0FBQ1AsTUFBRCxDQUE5QjtBQUNBLHVEQUFzQ0QsUUFBdEMsa0NBQXNFTyxTQUF0RTtBQUNBLFNBSks7QUFLTkUsUUFBQUEsSUFBSSxFQUFFSixLQUFLLElBQUlBLEtBQUssQ0FBQ0ssTUFBTixLQUFpQjtBQUwxQixPQUFQO0FBT0E7QUFwQlksR0FBZDs7O0FBdUJPLE1BQU1FLG1CQUFtQixHQUFHLFVBQVNDLGVBQVQsRUFBa0NDLGFBQWxDLEVBQXlEQyxNQUF6RCxFQUF1RTtBQUN6RyxRQUFNZixRQUFRLHlCQUFrQmEsZUFBbEIsZUFBc0NDLGFBQXRDLE1BQWQ7QUFDQSxXQUFPZixhQUFhLENBQUNDLFFBQUQsRUFBV2UsTUFBWCxDQUFwQjtBQUNBLEdBSE07Ozs7QUFLQSxNQUFNUCxZQUFZLEdBQUcsVUFBU08sTUFBVCxFQUF1QjtBQUNsRCxRQUFNQyxVQUFVLEdBQUcsSUFBSUMsTUFBTSxDQUFDQyxhQUFYLEVBQW5CO0FBQ0EsUUFBTUMsU0FBUyxHQUFHSCxVQUFVLENBQzFCSSxpQkFEZ0IsQ0FDRUwsTUFERixFQUVoQk0sT0FGZ0IsQ0FFUiwwQkFGUSxFQUVvQixJQUZwQixFQUdoQkEsT0FIZ0IsQ0FHUixNQUhRLEVBR0EsR0FIQSxDQUFsQjtBQUlBLFdBQU9DLE1BQU0sQ0FBQ0gsU0FBRCxFQUFZO0FBQUVJLE1BQUFBLE1BQU0sRUFBRTtBQUFWLEtBQVosQ0FBYjtBQUNBLEdBUE07QUFTUDs7Ozs7Ozs7OztBQU1PLE1BQU1DLFVBQVUsR0FBRyxVQUFTQyxPQUFULEVBQTBCO0FBQ25ELFFBQU1DLFNBQVMsR0FBR0MsRUFBRSxDQUFDQyxZQUFILENBQWdCSCxPQUFoQixFQUF5QixNQUF6QixDQUFsQjtBQUNBLFFBQU1JLEdBQUcsR0FBR0MsY0FBYyxDQUFDO0FBQUUsb0JBQWNKO0FBQWhCLEtBQUQsRUFBOEIsRUFBOUIsQ0FBMUI7QUFDQSxRQUFNSyxRQUFRLEdBQUdDLFlBQVksQ0FBQ0gsR0FBRCxDQUE3QjtBQUNBLFFBQU1JLFdBQVcsR0FBR0MsRUFBRSxDQUFDQyxJQUFILENBQVFKLFFBQVIsRUFBa0I7QUFBRUssTUFBQUEsT0FBTyxFQUFFO0FBQVgsS0FBbEIsQ0FBcEI7QUFDQSxRQUFJQyxPQUFPLEdBQUdaLE9BQU8sQ0FBQ0osT0FBUixDQUFnQixNQUFoQixFQUF3QixNQUF4QixDQUFkO0FBQ0FnQixJQUFBQSxPQUFPLEdBQUdBLE9BQU8sQ0FBQ2hCLE9BQVIsQ0FBZ0IsYUFBaEIsRUFBK0IsVUFBVSxJQUF6QyxDQUFWLENBTm1ELENBT25EOztBQUNBLFFBQU1pQixHQUFHLEdBQUdELE9BQU8sQ0FBQ0UsS0FBUixDQUFjLENBQWQsRUFBaUJGLE9BQU8sQ0FBQ0csV0FBUixDQUFvQixHQUFwQixDQUFqQixDQUFaOztBQUNBLFFBQUksQ0FBQ2IsRUFBRSxDQUFDYyxVQUFILENBQWNILEdBQWQsQ0FBTCxFQUF5QjtBQUN4QlgsTUFBQUEsRUFBRSxDQUFDZSxTQUFILENBQWFKLEdBQWI7QUFDQTs7QUFFRFgsSUFBQUEsRUFBRSxDQUFDZ0IsYUFBSCxDQUFpQk4sT0FBakIsRUFBMEJKLFdBQTFCO0FBQ0EsV0FBT0ksT0FBUDtBQUNBLEdBZk07Ozs7QUFpQkEsTUFBTU8sbUJBQW1CLEdBQUcsWUFBb0U7QUFBQSxRQUEzREMsZ0JBQTJELHVFQUFoQyxTQUFnQztBQUN0RyxXQUFPO0FBQ05DLE1BQUFBLGlCQURNLGNBQ3NCO0FBQzNCLGVBQU9ELGdCQUFQO0FBQ0E7QUFISyxLQUFQO0FBS0EsR0FOTTs7OztBQVFBLE1BQU1FLGtCQUFrQixHQUFHLFlBQXlCO0FBQzFELFFBQU1DLE1BQWEsR0FBRyxFQUF0QjtBQUNBLFdBQU87QUFDTkMsTUFBQUEsUUFETSxZQUNHQyxhQURILEVBQ2lDQyxhQURqQyxFQUMrREMsT0FEL0QsRUFDc0Y7QUFDM0ZKLFFBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZO0FBQ1hILFVBQUFBLGFBQWEsRUFBYkEsYUFEVztBQUVYQyxVQUFBQSxhQUFhLEVBQWJBLGFBRlc7QUFHWEMsVUFBQUEsT0FBTyxFQUFQQTtBQUhXLFNBQVo7QUFLQSxPQVBLO0FBUU5FLE1BQUFBLFNBUk0sY0FRYTtBQUNsQixlQUFPTixNQUFQO0FBQ0EsT0FWSztBQVdOTyxNQUFBQSxrQkFYTSxZQVdhTCxhQVhiLEVBVzJDQyxhQVgzQyxFQVd5RUMsT0FYekUsRUFXaUc7QUFDdEcsZUFBT0osTUFBTSxDQUFDUSxJQUFQLENBQVksVUFBQUMsS0FBSyxFQUFJO0FBQzNCQSxVQUFBQSxLQUFLLENBQUNQLGFBQU4sS0FBd0JBLGFBQXhCLElBQXlDTyxLQUFLLENBQUNOLGFBQU4sS0FBd0JBLGFBQWpFLElBQWtGTSxLQUFLLENBQUNMLE9BQU4sS0FBa0JBLE9BQXBHO0FBQ0EsU0FGTSxDQUFQO0FBR0E7QUFmSyxLQUFQO0FBaUJBLEdBbkJNOzs7O0FBcUJBLE1BQU1NLG1CQUFtQixHQUFHLFVBQ2xDQyxjQURrQyxFQUVsQ0MsZ0JBRmtDLEVBR2xDQyxZQUhrQyxFQUtqQztBQUFBLFFBRERDLG9CQUNDLHVFQUQ4QixTQUM5QjtBQUNELFFBQU1DLFNBQVMsR0FBR0osY0FBYyxDQUFDSyxVQUFmLENBQTBCUixJQUExQixDQUErQixVQUFBUyxFQUFFO0FBQUEsYUFBSUEsRUFBRSxDQUFDQyxJQUFILEtBQVlOLGdCQUFnQixDQUFDRyxTQUFqQztBQUFBLEtBQWpDLENBQWxCO0FBQ0EsUUFBTUksYUFBYSxHQUFHQyxpQ0FBaUMsQ0FBQ0wsU0FBRCxFQUFZQSxTQUFaLENBQXZEO0FBQ0EsV0FBT00sc0JBQXNCLENBQzVCVixjQUQ0QixFQUU1QkMsZ0JBRjRCLEVBRzVCQyxZQUg0QixFQUk1QmpCLG1CQUFtQixDQUFDa0Isb0JBQUQsQ0FKUyxFQUs1QmYsa0JBQWtCLEVBTFUsRUFNNUJ1QixLQU40QixFQU81QkgsYUFQNEIsQ0FBN0I7QUFTQSxHQWpCTTs7OztBQWtCQSxNQUFNSSxZQUFZLGFBQWtCQyxZQUFsQjtBQUFBLFFBQXdDO0FBQ2hFLFVBQU1DLFVBQVUsR0FBR0Msa0JBQWtCLENBQUNDLE1BQW5CLENBQTBCLEVBQTFCLEVBQThCLEtBQTlCLEVBQXFDLEVBQXJDLENBQW5COztBQUNBLFVBQU1DLFVBQVUsR0FBRyxJQUFJQyxjQUFKLENBQW1CSixVQUFuQixFQUErQkQsWUFBL0IsRUFBNkNNLFNBQTdDLEVBQXdELElBQXhELENBQW5CO0FBRmdFLDZCQUcxREYsVUFBVSxDQUFDRyxvQkFBWCxFQUgwRDtBQUloRSxlQUFPSCxVQUFQO0FBSmdFO0FBS2hFLEtBTHdCO0FBQUE7QUFBQTtBQUFBLEdBQWxCOzs7O0FBT0EsTUFBTVIsaUNBQWlDLEdBQUcsVUFBU0wsU0FBVCxFQUErQmlCLFFBQS9CLEVBQXlFO0FBQ3pILFFBQU1DLFVBQStCLEdBQUc7QUFDdkNDLE1BQUFBLGlCQUFpQixFQUFFbkIsU0FEb0I7QUFFdkNvQixNQUFBQSxvQkFBb0IsRUFBRSxFQUZpQjtBQUd2Q0MsTUFBQUEsWUFBWSxFQUFFSixRQUh5QjtBQUl2Q0ssTUFBQUEsZUFBZSxFQUFFdEIsU0FKc0I7QUFLdkN1QixNQUFBQSxnQkFBZ0IsRUFBRXZCLFNBQVMsQ0FBQ3dCO0FBTFcsS0FBeEM7QUFPQU4sSUFBQUEsVUFBVSxDQUFDTyxlQUFYLEdBQTZCUCxVQUE3QjtBQUNBLFdBQU9BLFVBQVA7QUFDQSxHQVZNOzs7O0FBWUEsTUFBTVEsZUFBZSxHQUFHLFVBQVNDLGFBQVQsRUFBZ0Q7QUFDOUUsUUFBTUMsY0FBYyxHQUFHQyxhQUFhLENBQUNDLGFBQWQsQ0FBNEJILGFBQTVCLENBQXZCOztBQUQ4RSxzQ0FBYkksSUFBYTtBQUFiQSxNQUFBQSxJQUFhO0FBQUE7O0FBRTlFLFdBQU9ILGNBQWMsQ0FBQ0ksU0FBZixDQUF5QkMsS0FBekIsQ0FBK0JsQixTQUEvQixFQUEwQ2dCLElBQTFDLENBQVA7QUFDQSxHQUhNOzs7O0FBS0EsTUFBTUcsd0JBQXdCLEdBQUcsVUFBU1AsYUFBVCxFQUE0Q1EsWUFBNUMsRUFBK0Q7QUFDdEcsUUFBTVAsY0FBYyxHQUFHQyxhQUFhLENBQUNDLGFBQWQsQ0FBNEJILGFBQTVCLENBQXZCO0FBQ0EsUUFBTVMsU0FBUyxHQUFHLElBQUlDLFNBQUosQ0FBY0YsWUFBZCxDQUFsQjtBQUNBLFFBQU1HLElBQUksR0FBRyxJQUFJQyxhQUFKLEVBQWI7QUFDQUQsSUFBQUEsSUFBSSxDQUFDRSxZQUFMLENBQWtCLE1BQWxCLEVBQTBCWixjQUExQjtBQUNBVSxJQUFBQSxJQUFJLENBQUNHLFFBQUwsQ0FBY0wsU0FBZDtBQUNBRSxJQUFBQSxJQUFJLENBQUNJLGlCQUFMLENBQXVCTixTQUFTLENBQUNPLG9CQUFWLENBQStCLEdBQS9CLENBQXZCO0FBQ0EsV0FBT0wsSUFBSSxDQUFDTSxPQUFMLEVBQVA7QUFDQSxHQVJNOzs7O0FBVUEsTUFBTUMsbUJBQW1CLGFBQy9CQyxRQUQrQixFQUUvQnJDLFlBRitCLEVBRy9Cc0MsZ0JBSCtCLEVBSS9CQyxPQUorQjtBQUFBLFFBSzlCO0FBQ0QsVUFBTUMsWUFBWSxtQkFBWUgsUUFBWixZQUFsQjtBQUNBLFVBQU10RixNQUFNLEdBQUcsSUFBSU4sTUFBTSxDQUFDZ0csU0FBWCxFQUFmO0FBQ0EsVUFBTUMsTUFBTSxHQUFHM0YsTUFBTSxDQUFDNEYsZUFBUCxDQUF1QkgsWUFBdkIsRUFBcUMsVUFBckMsQ0FBZjtBQUhDLDZCQUt3QnpDLFlBQVksQ0FBQ0MsWUFBRCxDQUxwQyxpQkFLS0ksVUFMTDtBQU1ELFlBQU13QyxxQkFBcUIsR0FBRztBQUM3QkMsVUFBQUEsTUFBTSxFQUFFQyxNQUFNLENBQUNDLE1BQVAsQ0FDUDtBQUNDQyxZQUFBQSxTQUFTLEVBQUU1QztBQURaLFdBRE8sRUFJUG1DLE9BSk8sQ0FEcUI7QUFPN0JVLFVBQUFBLGVBQWUsRUFBRTtBQVBZLFNBQTlCLENBTkMsQ0FnQkQ7O0FBQ0FILFFBQUFBLE1BQU0sQ0FBQ0ksSUFBUCxDQUFZWixnQkFBWixFQUE4QmEsT0FBOUIsQ0FBc0MsVUFBU0MsSUFBVCxFQUFlO0FBQ3BEO0FBQ0ExSCxVQUFBQSxNQUFNLENBQUMsT0FBTzBFLFVBQVUsQ0FBQ2lELFNBQVgsQ0FBcUJmLGdCQUFnQixDQUFDYyxJQUFELENBQXJDLENBQVIsQ0FBTixDQUE0REUsV0FBNUQ7QUFDQSxjQUFNQyxNQUFNLEdBQUdoQixPQUFPLENBQUNhLElBQUQsQ0FBUCxJQUFpQmhELFVBQWhDO0FBQ0F3QyxVQUFBQSxxQkFBcUIsQ0FBQ0ssZUFBdEIsQ0FBc0NHLElBQXRDLElBQThDRyxNQUFNLENBQUNyQixvQkFBUCxDQUE0QkksZ0JBQWdCLENBQUNjLElBQUQsQ0FBNUMsQ0FBOUMsQ0FKb0QsQ0FJK0M7O0FBQ25HUixVQUFBQSxxQkFBcUIsQ0FBQ0MsTUFBdEIsQ0FBNkJPLElBQTdCLElBQXFDRyxNQUFyQztBQUNBLFNBTkQsRUFqQkMsQ0F5QkQ7O0FBQ0EsWUFBSVgscUJBQXFCLENBQUNDLE1BQXRCLENBQTZCLE1BQTdCLENBQUosRUFBMEM7QUFDekNELFVBQUFBLHFCQUFxQixDQUFDSyxlQUF0QixDQUFzQyxNQUF0QyxJQUFnREwscUJBQXFCLENBQUNDLE1BQXRCLENBQTZCLE1BQTdCLEVBQXFDWCxvQkFBckMsQ0FBMEQsR0FBMUQsQ0FBaEQ7QUFDQTs7QUFFRCxlQUFPc0IsZUFBZSxDQUFDQyxPQUFoQixDQUF3QmYsTUFBTSxDQUFDZ0IsaUJBQS9CLEVBQW1EO0FBQUVoRSxVQUFBQSxJQUFJLEVBQUU7QUFBUixTQUFuRCxFQUE4RWtELHFCQUE5RSxDQUFQO0FBOUJDO0FBK0JELEtBcEMrQjtBQUFBO0FBQUE7QUFBQSxHQUF6QiIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEZpZWxkTWV0YWRhdGEgZnJvbSBcInNhcC9mZS9tYWNyb3MvaW50ZXJuYWwvRmllbGQubWV0YWRhdGFcIjtcbmltcG9ydCB7IFBoYW50b21VdGlsIH0gZnJvbSBcInNhcC9mZS9tYWNyb3NcIjtcbmltcG9ydCB7IF9NZXRhZGF0YVJlcXVlc3RvciB9IGZyb20gXCJzYXAvdWkvbW9kZWwvb2RhdGEvdjQvbGliXCI7XG5pbXBvcnQgeyBPRGF0YU1ldGFNb2RlbCB9IGZyb20gXCJzYXAvdWkvbW9kZWwvb2RhdGEvdjRcIjtcbmltcG9ydCB7IFhNTFByZXByb2Nlc3NvciB9IGZyb20gXCJzYXAvdWkvY29yZS91dGlsXCI7XG5pbXBvcnQgeyBMb2cgfSBmcm9tIFwic2FwL2Jhc2VcIjtcbmltcG9ydCB4cGF0aCBmcm9tIFwieHBhdGhcIjtcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IHsgY29tcGFjdE1vZGVsLCBjb21waWxlU291cmNlcywgdG8gfSBmcm9tIFwiQHNhcC9jZHMtY29tcGlsZXJcIjtcbmltcG9ydCB7IGZvcm1hdCB9IGZyb20gXCJwcmV0dGllclwiO1xuaW1wb3J0IHsgQmluZGluZ1BhcnNlciB9IGZyb20gXCJzYXAvdWkvYmFzZVwiO1xuaW1wb3J0IHsgQ29udmVydGVyT3V0cHV0LCBFbnRpdHlTZXQsIFByb3BlcnR5IH0gZnJvbSBcIkBzYXAtdXgvYW5ub3RhdGlvbi1jb252ZXJ0ZXJcIjtcbmltcG9ydCB7IERhdGFNb2RlbE9iamVjdFBhdGggfSBmcm9tIFwic2FwL2ZlL2NvcmUvdGVtcGxhdGluZy9EYXRhTW9kZWxQYXRoSGVscGVyXCI7XG5pbXBvcnQgeyBKU09OTW9kZWwgfSBmcm9tIFwic2FwL3VpL21vZGVsL2pzb25cIjtcbmltcG9ydCB7IEludmlzaWJsZVRleHQgfSBmcm9tIFwic2FwL3VpL2NvcmVcIjtcbmltcG9ydCB7IEJhc2VNYW5pZmVzdFNldHRpbmdzIH0gZnJvbSBcInNhcC9mZS9jb3JlL2NvbnZlcnRlcnMvTWFuaWZlc3RTZXR0aW5nc1wiO1xuaW1wb3J0IHsgSXNzdWVDYXRlZ29yeSwgSXNzdWVTZXZlcml0eSB9IGZyb20gXCJzYXAvZmUvY29yZS9jb252ZXJ0ZXJzL2hlbHBlcnMvSXNzdWVNYW5hZ2VyXCI7XG5pbXBvcnQgeyBJRGlhZ25vc3RpY3MgfSBmcm9tIFwic2FwL2ZlL2NvcmUvY29udmVydGVycy9UZW1wbGF0ZUNvbnZlcnRlclwiO1xuaW1wb3J0IHsgSVNoZWxsU2VydmljZXNQcm94eSwgVGVtcGxhdGVUeXBlIH0gZnJvbSBcInNhcC9mZS9jb3JlL2NvbnZlcnRlcnMvdGVtcGxhdGVzL0Jhc2VDb252ZXJ0ZXJcIjtcbmltcG9ydCB7IGNyZWF0ZUNvbnZlcnRlckNvbnRleHQgfSBmcm9tIFwic2FwL2ZlL2NvcmUvY29udmVydGVycy9Db252ZXJ0ZXJDb250ZXh0XCI7XG5pbXBvcnQgeyBtZXJnZSB9IGZyb20gXCJzYXAvYmFzZS91dGlsXCI7XG5cblBoYW50b21VdGlsLnJlZ2lzdGVyKEZpZWxkTWV0YWRhdGEpO1xuXG5Mb2cuc2V0TGV2ZWwoMSwgXCJzYXAudWkuY29yZS51dGlsLlhNTFByZXByb2Nlc3NvclwiKTtcbmplc3Quc2V0VGltZW91dCg0MDAwMCk7XG5cbmNvbnN0IG5hbWVTcGFjZU1hcCA9IHtcblx0XCJjb250cm9sXCI6IFwic2FwLmZlLmNvcmUuY29udHJvbHNcIixcblx0XCJjb3JlXCI6IFwic2FwLnVpLmNvcmVcIixcblx0XCJtXCI6IFwic2FwLm1cIixcblx0XCJtZGNcIjogXCJzYXAudWkubWRjXCIsXG5cdFwibWRjRmllbGRcIjogXCJzYXAudWkubWRjLmZpZWxkXCIsXG5cdFwidVwiOiBcInNhcC51aS51bmlmaWVkXCJcbn07XG5jb25zdCBzZWxlY3QgPSB4cGF0aC51c2VOYW1lc3BhY2VzKG5hbWVTcGFjZU1hcCk7XG5cbmV4cG9ydCBjb25zdCByZWdpc3Rlck1hY3JvID0gZnVuY3Rpb24obWFjcm9NZXRhZGF0YTogYW55KSB7XG5cdFBoYW50b21VdGlsLnJlZ2lzdGVyKG1hY3JvTWV0YWRhdGEpO1xufTtcbmV4cG9ydCBjb25zdCBydW5YUGF0aFF1ZXJ5ID0gZnVuY3Rpb24oc2VsZWN0b3I6IHN0cmluZywgeG1sZG9tOiBOb2RlIHwgdW5kZWZpbmVkKSB7XG5cdHJldHVybiBzZWxlY3Qoc2VsZWN0b3IsIHhtbGRvbSk7XG59O1xuXG5leHBlY3QuZXh0ZW5kKHtcblx0dG9IYXZlQ29udHJvbCh4bWxkb20sIHNlbGVjdG9yKSB7XG5cdFx0Y29uc3Qgbm9kZXMgPSBydW5YUGF0aFF1ZXJ5KGAvcm9vdCR7c2VsZWN0b3J9YCwgeG1sZG9tKTtcblx0XHRyZXR1cm4ge1xuXHRcdFx0bWVzc2FnZTogKCkgPT4ge1xuXHRcdFx0XHRjb25zdCBvdXRwdXRYbWwgPSBzZXJpYWxpemVYTUwoeG1sZG9tKTtcblx0XHRcdFx0cmV0dXJuIGBkaWQgbm90IGZpbmQgY29udHJvbHMgbWF0Y2hpbmcgJHtzZWxlY3Rvcn0gaW4gZ2VuZXJhdGVkIHhtbDpcXG4gJHtvdXRwdXRYbWx9YDtcblx0XHRcdH0sXG5cdFx0XHRwYXNzOiBub2RlcyAmJiBub2Rlcy5sZW5ndGggPj0gMVxuXHRcdH07XG5cdH0sXG5cdHRvTm90SGF2ZUNvbnRyb2woeG1sZG9tLCBzZWxlY3Rvcikge1xuXHRcdGNvbnN0IG5vZGVzID0gcnVuWFBhdGhRdWVyeShgL3Jvb3Qke3NlbGVjdG9yfWAsIHhtbGRvbSk7XG5cdFx0cmV0dXJuIHtcblx0XHRcdG1lc3NhZ2U6ICgpID0+IHtcblx0XHRcdFx0Y29uc3Qgb3V0cHV0WG1sID0gc2VyaWFsaXplWE1MKHhtbGRvbSk7XG5cdFx0XHRcdHJldHVybiBgVGhlcmUgaXMgYSBjb250cm9sIG1hdGNoaW5nICR7c2VsZWN0b3J9IGluIGdlbmVyYXRlZCB4bWw6XFxuICR7b3V0cHV0WG1sfWA7XG5cdFx0XHR9LFxuXHRcdFx0cGFzczogbm9kZXMgJiYgbm9kZXMubGVuZ3RoID09PSAwXG5cdFx0fTtcblx0fVxufSk7XG5cbmV4cG9ydCBjb25zdCBnZXRDb250cm9sQXR0cmlidXRlID0gZnVuY3Rpb24oY29udHJvbFNlbGVjdG9yOiBzdHJpbmcsIGF0dHJpYnV0ZU5hbWU6IHN0cmluZywgeG1sRG9tOiBOb2RlKSB7XG5cdGNvbnN0IHNlbGVjdG9yID0gYHN0cmluZygvcm9vdCR7Y29udHJvbFNlbGVjdG9yfS9AJHthdHRyaWJ1dGVOYW1lfSlgO1xuXHRyZXR1cm4gcnVuWFBhdGhRdWVyeShzZWxlY3RvciwgeG1sRG9tKTtcbn07XG5cbmV4cG9ydCBjb25zdCBzZXJpYWxpemVYTUwgPSBmdW5jdGlvbih4bWxEb206IE5vZGUpIHtcblx0Y29uc3Qgc2VyaWFsaXplciA9IG5ldyB3aW5kb3cuWE1MU2VyaWFsaXplcigpO1xuXHRjb25zdCB4bWxTdHJpbmcgPSBzZXJpYWxpemVyXG5cdFx0LnNlcmlhbGl6ZVRvU3RyaW5nKHhtbERvbSlcblx0XHQucmVwbGFjZSgvKD86W1xcdCBdKig/Olxccj9cXG58XFxyKSkrL2csIFwiXFxuXCIpXG5cdFx0LnJlcGxhY2UoL1xcXFxcIi9nLCAnXCInKTtcblx0cmV0dXJuIGZvcm1hdCh4bWxTdHJpbmcsIHsgcGFyc2VyOiBcImh0bWxcIiB9KTtcbn07XG5cbi8qKlxuICogTWV0aG9kIHRvIGNvbXBpbGUgYSBjZHMgZmlsZSBpbnRvIGFuIGVkbXggZmlsZSB0aGF0IGlzIGdlbmVyYXRlZC5cbiAqIEBwYXJhbSBzQ0RTVXJsIHtzdHJpbmd9IHRoZSBwYXRoIHRvIHRoZSBmaWxlIGNvbnRhaW5pbmcgdGhlIGNkcyBkZWZpbml0aW9uLiB0aGlzIGZpbGUgTVVTVCBkZWNsYXJlIHRoZSBuYW1lc3BhY2VcbiAqIHNhcC5mZS50ZXN0IGFuZCBhIHNlcnZpY2UgSmVzdFNlcnZpY2VcbiAqIEByZXR1cm5zIHtzdHJpbmd9IGVkbXhVcmwgdGhlIHBhdGggb2YgdGhlIGdlbmVyYXRlZCBlZG14XG4gKi9cbmV4cG9ydCBjb25zdCBjb21waWxlQ0RTID0gZnVuY3Rpb24oc0NEU1VybDogc3RyaW5nKSB7XG5cdGNvbnN0IGNkc1N0cmluZyA9IGZzLnJlYWRGaWxlU3luYyhzQ0RTVXJsLCBcIlVURjhcIik7XG5cdGNvbnN0IGNzbiA9IGNvbXBpbGVTb3VyY2VzKHsgXCJzdHJpbmcuY2RzXCI6IGNkc1N0cmluZyB9LCB7fSk7XG5cdGNvbnN0IGNzbk1vZGVsID0gY29tcGFjdE1vZGVsKGNzbik7XG5cdGNvbnN0IGVkbXhDb250ZW50ID0gdG8uZWRteChjc25Nb2RlbCwgeyBzZXJ2aWNlOiBcInNhcC5mZS50ZXN0Lkplc3RTZXJ2aWNlXCIgfSk7XG5cdGxldCBlZG14VXJsID0gc0NEU1VybC5yZXBsYWNlKFwiLmNkc1wiLCBcIi54bWxcIik7XG5cdGVkbXhVcmwgPSBlZG14VXJsLnJlcGxhY2UoL1xcLyhbXlxcL10qKSQvLCBcIi9nZW4vXCIgKyBcIiQxXCIpO1xuXHQvLyBpZiB0aGUgZ2VuIGZvbGRlciBkb2VzIG5vdCBleGlzdCBidWlsZCBpdFxuXHRjb25zdCBkaXIgPSBlZG14VXJsLnNsaWNlKDAsIGVkbXhVcmwubGFzdEluZGV4T2YoXCIvXCIpKTtcblx0aWYgKCFmcy5leGlzdHNTeW5jKGRpcikpIHtcblx0XHRmcy5ta2RpclN5bmMoZGlyKTtcblx0fVxuXG5cdGZzLndyaXRlRmlsZVN5bmMoZWRteFVybCwgZWRteENvbnRlbnQpO1xuXHRyZXR1cm4gZWRteFVybDtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRGYWtlU2hlbGxTZXJ2aWNlID0gZnVuY3Rpb24oY29udGVudERlbnNpdGllczogc3RyaW5nID0gXCJjb21wYWN0XCIpOiBJU2hlbGxTZXJ2aWNlc1Byb3h5IHtcblx0cmV0dXJuIHtcblx0XHRnZXRDb250ZW50RGVuc2l0eSgpOiBzdHJpbmcge1xuXHRcdFx0cmV0dXJuIGNvbnRlbnREZW5zaXRpZXM7XG5cdFx0fVxuXHR9O1xufTtcblxuZXhwb3J0IGNvbnN0IGdldEZha2VEaWFnbm9zdGljcyA9IGZ1bmN0aW9uKCk6IElEaWFnbm9zdGljcyB7XG5cdGNvbnN0IGlzc3VlczogYW55W10gPSBbXTtcblx0cmV0dXJuIHtcblx0XHRhZGRJc3N1ZShpc3N1ZUNhdGVnb3J5OiBJc3N1ZUNhdGVnb3J5LCBpc3N1ZVNldmVyaXR5OiBJc3N1ZVNldmVyaXR5LCBkZXRhaWxzOiBzdHJpbmcpOiB2b2lkIHtcblx0XHRcdGlzc3Vlcy5wdXNoKHtcblx0XHRcdFx0aXNzdWVDYXRlZ29yeSxcblx0XHRcdFx0aXNzdWVTZXZlcml0eSxcblx0XHRcdFx0ZGV0YWlsc1xuXHRcdFx0fSk7XG5cdFx0fSxcblx0XHRnZXRJc3N1ZXMoKTogYW55W10ge1xuXHRcdFx0cmV0dXJuIGlzc3Vlcztcblx0XHR9LFxuXHRcdGNoZWNrSWZJc3N1ZUV4aXN0cyhpc3N1ZUNhdGVnb3J5OiBJc3N1ZUNhdGVnb3J5LCBpc3N1ZVNldmVyaXR5OiBJc3N1ZVNldmVyaXR5LCBkZXRhaWxzOiBzdHJpbmcpOiBhbnlbXSB7XG5cdFx0XHRyZXR1cm4gaXNzdWVzLmZpbmQoaXNzdWUgPT4ge1xuXHRcdFx0XHRpc3N1ZS5pc3N1ZUNhdGVnb3J5ID09PSBpc3N1ZUNhdGVnb3J5ICYmIGlzc3VlLmlzc3VlU2V2ZXJpdHkgPT09IGlzc3VlU2V2ZXJpdHkgJiYgaXNzdWUuZGV0YWlscyA9PT0gZGV0YWlscztcblx0XHRcdH0pO1xuXHRcdH1cblx0fTtcbn07XG5cbmV4cG9ydCBjb25zdCBnZXRDb252ZXJ0ZXJDb250ZXh0ID0gZnVuY3Rpb24oXG5cdGNvbnZlcnRlZFR5cGVzOiBDb252ZXJ0ZXJPdXRwdXQsXG5cdG1hbmlmZXN0U2V0dGluZ3M6IEJhc2VNYW5pZmVzdFNldHRpbmdzLFxuXHR0ZW1wbGF0ZVR5cGU6IFRlbXBsYXRlVHlwZSxcblx0dXNlckNvbnRlbnREZW5zaXRpZXM6IHN0cmluZyA9IFwiY29tcGFjdFwiXG4pIHtcblx0Y29uc3QgZW50aXR5U2V0ID0gY29udmVydGVkVHlwZXMuZW50aXR5U2V0cy5maW5kKGVzID0+IGVzLm5hbWUgPT09IG1hbmlmZXN0U2V0dGluZ3MuZW50aXR5U2V0KTtcblx0Y29uc3QgZGF0YU1vZGVsUGF0aCA9IGdldERhdGFNb2RlbE9iamVjdFBhdGhGb3JQcm9wZXJ0eShlbnRpdHlTZXQsIGVudGl0eVNldCk7XG5cdHJldHVybiBjcmVhdGVDb252ZXJ0ZXJDb250ZXh0KFxuXHRcdGNvbnZlcnRlZFR5cGVzLFxuXHRcdG1hbmlmZXN0U2V0dGluZ3MsXG5cdFx0dGVtcGxhdGVUeXBlLFxuXHRcdGdldEZha2VTaGVsbFNlcnZpY2UodXNlckNvbnRlbnREZW5zaXRpZXMpLFxuXHRcdGdldEZha2VEaWFnbm9zdGljcygpLFxuXHRcdG1lcmdlLFxuXHRcdGRhdGFNb2RlbFBhdGhcblx0KTtcbn07XG5leHBvcnQgY29uc3QgZ2V0TWV0YU1vZGVsID0gYXN5bmMgZnVuY3Rpb24oc01ldGFkYXRhVXJsOiBzdHJpbmcpIHtcblx0Y29uc3Qgb1JlcXVlc3RvciA9IF9NZXRhZGF0YVJlcXVlc3Rvci5jcmVhdGUoe30sIFwiNC4wXCIsIHt9KTtcblx0Y29uc3Qgb01ldGFNb2RlbCA9IG5ldyBPRGF0YU1ldGFNb2RlbChvUmVxdWVzdG9yLCBzTWV0YWRhdGFVcmwsIHVuZGVmaW5lZCwgbnVsbCk7XG5cdGF3YWl0IG9NZXRhTW9kZWwuZmV0Y2hFbnRpdHlDb250YWluZXIoKTtcblx0cmV0dXJuIG9NZXRhTW9kZWw7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0RGF0YU1vZGVsT2JqZWN0UGF0aEZvclByb3BlcnR5ID0gZnVuY3Rpb24oZW50aXR5U2V0OiBFbnRpdHlTZXQsIHByb3BlcnR5PzogUHJvcGVydHkpOiBEYXRhTW9kZWxPYmplY3RQYXRoIHtcblx0Y29uc3QgdGFyZ2V0UGF0aDogRGF0YU1vZGVsT2JqZWN0UGF0aCA9IHtcblx0XHRzdGFydGluZ0VudGl0eVNldDogZW50aXR5U2V0LFxuXHRcdG5hdmlnYXRpb25Qcm9wZXJ0aWVzOiBbXSxcblx0XHR0YXJnZXRPYmplY3Q6IHByb3BlcnR5LFxuXHRcdHRhcmdldEVudGl0eVNldDogZW50aXR5U2V0LFxuXHRcdHRhcmdldEVudGl0eVR5cGU6IGVudGl0eVNldC5lbnRpdHlUeXBlXG5cdH07XG5cdHRhcmdldFBhdGguY29udGV4dExvY2F0aW9uID0gdGFyZ2V0UGF0aDtcblx0cmV0dXJuIHRhcmdldFBhdGg7XG59O1xuXG5leHBvcnQgY29uc3QgZXZhbHVhdGVCaW5kaW5nID0gZnVuY3Rpb24oYmluZGluZ1N0cmluZzogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xuXHRjb25zdCBiaW5kaW5nRWxlbWVudCA9IEJpbmRpbmdQYXJzZXIuY29tcGxleFBhcnNlcihiaW5kaW5nU3RyaW5nKTtcblx0cmV0dXJuIGJpbmRpbmdFbGVtZW50LmZvcm1hdHRlci5hcHBseSh1bmRlZmluZWQsIGFyZ3MpO1xufTtcblxuZXhwb3J0IGNvbnN0IGV2YWx1YXRlQmluZGluZ1dpdGhNb2RlbCA9IGZ1bmN0aW9uKGJpbmRpbmdTdHJpbmc6IHN0cmluZyB8IHVuZGVmaW5lZCwgbW9kZWxDb250ZW50OiBhbnkpIHtcblx0Y29uc3QgYmluZGluZ0VsZW1lbnQgPSBCaW5kaW5nUGFyc2VyLmNvbXBsZXhQYXJzZXIoYmluZGluZ1N0cmluZyk7XG5cdGNvbnN0IGpzb25Nb2RlbCA9IG5ldyBKU09OTW9kZWwobW9kZWxDb250ZW50KTtcblx0Y29uc3QgdGV4dCA9IG5ldyBJbnZpc2libGVUZXh0KCk7XG5cdHRleHQuYmluZFByb3BlcnR5KFwidGV4dFwiLCBiaW5kaW5nRWxlbWVudCk7XG5cdHRleHQuc2V0TW9kZWwoanNvbk1vZGVsKTtcblx0dGV4dC5zZXRCaW5kaW5nQ29udGV4dChqc29uTW9kZWwuY3JlYXRlQmluZGluZ0NvbnRleHQoXCIvXCIpKTtcblx0cmV0dXJuIHRleHQuZ2V0VGV4dCgpO1xufTtcblxuZXhwb3J0IGNvbnN0IGdldFRlbXBsYXRpbmdSZXN1bHQgPSBhc3luYyBmdW5jdGlvbihcblx0eG1sSW5wdXQ6IHN0cmluZyxcblx0c01ldGFkYXRhVXJsOiBzdHJpbmcsXG5cdG1CaW5kaW5nQ29udGV4dHM6IHsgW3g6IHN0cmluZ106IGFueTsgZW50aXR5U2V0Pzogc3RyaW5nIH0sXG5cdG1Nb2RlbHM6IHsgW3g6IHN0cmluZ106IE9EYXRhTWV0YU1vZGVsIH1cbikge1xuXHRjb25zdCB0ZW1wbGF0ZWRYbWwgPSBgPHJvb3Q+JHt4bWxJbnB1dH08L3Jvb3Q+YDtcblx0Y29uc3QgcGFyc2VyID0gbmV3IHdpbmRvdy5ET01QYXJzZXIoKTtcblx0Y29uc3QgeG1sRG9jID0gcGFyc2VyLnBhcnNlRnJvbVN0cmluZyh0ZW1wbGF0ZWRYbWwsIFwidGV4dC94bWxcIik7XG5cblx0Y29uc3Qgb01ldGFNb2RlbCA9IGF3YWl0IGdldE1ldGFNb2RlbChzTWV0YWRhdGFVcmwpO1xuXHRjb25zdCBvUHJlcHJvY2Vzc29yU2V0dGluZ3MgPSB7XG5cdFx0bW9kZWxzOiBPYmplY3QuYXNzaWduKFxuXHRcdFx0e1xuXHRcdFx0XHRtZXRhTW9kZWw6IG9NZXRhTW9kZWxcblx0XHRcdH0sXG5cdFx0XHRtTW9kZWxzXG5cdFx0KSxcblx0XHRiaW5kaW5nQ29udGV4dHM6IHt9XG5cdH07XG5cblx0Ly9JbmplY3QgbW9kZWxzIGFuZCBiaW5kaW5nQ29udGV4dHNcblx0T2JqZWN0LmtleXMobUJpbmRpbmdDb250ZXh0cykuZm9yRWFjaChmdW5jdGlvbihzS2V5KSB7XG5cdFx0LyogQXNzZXJ0IHRvIG1ha2Ugc3VyZSB0aGUgYW5ub3RhdGlvbnMgYXJlIGluIHRoZSB0ZXN0IG1ldGFkYXRhIC0+IGF2b2lkIG1pc2xlYWRpbmcgdGVzdHMgKi9cblx0XHRleHBlY3QodHlwZW9mIG9NZXRhTW9kZWwuZ2V0T2JqZWN0KG1CaW5kaW5nQ29udGV4dHNbc0tleV0pKS50b0JlRGVmaW5lZCgpO1xuXHRcdGNvbnN0IG9Nb2RlbCA9IG1Nb2RlbHNbc0tleV0gfHwgb01ldGFNb2RlbDtcblx0XHRvUHJlcHJvY2Vzc29yU2V0dGluZ3MuYmluZGluZ0NvbnRleHRzW3NLZXldID0gb01vZGVsLmNyZWF0ZUJpbmRpbmdDb250ZXh0KG1CaW5kaW5nQ29udGV4dHNbc0tleV0pOyAvL1ZhbHVlIGlzIHNQYXRoXG5cdFx0b1ByZXByb2Nlc3NvclNldHRpbmdzLm1vZGVsc1tzS2V5XSA9IG9Nb2RlbDtcblx0fSk7XG5cblx0Ly9UaGlzIGNvbnRleHQgZm9yIG1hY3JvIHRlc3Rpbmdcblx0aWYgKG9QcmVwcm9jZXNzb3JTZXR0aW5ncy5tb2RlbHNbXCJ0aGlzXCJdKSB7XG5cdFx0b1ByZXByb2Nlc3NvclNldHRpbmdzLmJpbmRpbmdDb250ZXh0c1tcInRoaXNcIl0gPSBvUHJlcHJvY2Vzc29yU2V0dGluZ3MubW9kZWxzW1widGhpc1wiXS5jcmVhdGVCaW5kaW5nQ29udGV4dChcIi9cIik7XG5cdH1cblxuXHRyZXR1cm4gWE1MUHJlcHJvY2Vzc29yLnByb2Nlc3MoeG1sRG9jLmZpcnN0RWxlbWVudENoaWxkISwgeyBuYW1lOiBcIlRlc3QgRnJhZ21lbnRcIiB9LCBvUHJlcHJvY2Vzc29yU2V0dGluZ3MpO1xufTtcbiJdfQ==