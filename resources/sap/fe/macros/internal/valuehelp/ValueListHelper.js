/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/thirdparty/jquery","sap/ui/core/XMLTemplateProcessor","sap/ui/model/json/JSONModel","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/ui/mdc/field/InParameter","sap/ui/mdc/field/OutParameter","sap/base/Log","sap/ui/dom/units/Rem","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling"],function(q,X,J,a,F,I,O,L,R,B,m){"use strict";var w={};var c=[];function _(v){return v.Parameters.some(function(p){return(p["@com.sap.vocabularies.UI.v1.Importance"]&&p["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High");});}function b(v){var C=v.valueListInfo.$model.getMetaModel().getObject("/"+v.valueListInfo.CollectionPath+"@")||{},s=C["@Org.OData.Capabilities.V1.SearchRestrictions"]&&C["@Org.OData.Capabilities.V1.SearchRestrictions"].Searchable;return s===undefined?true:s;}function d(v){return c.find(function(o){return o.sVLQualifier===v;});}var V={getColumnVisibility:function(v,o){if(!_(v)){return undefined;}else if(o&&o["@com.sap.vocabularies.UI.v1.Importance"]&&o["@com.sap.vocabularies.UI.v1.Importance"].$EnumMember==="com.sap.vocabularies.UI.v1.ImportanceType/High"){return undefined;}else{return"{_VHUI>/showAllColumns}";}},hasImportance:function(v){return _(v.getObject())?"Importance/High":"None";},getMinScreenWidth:function(v){return _(v)?"{= ${_VHUI>/minScreenWidth}}":"416px";},getTableItemsParameters:function(v,r,s){var S,p="",e=v.$model.getMetaModel();v.Parameters.find(function(E){if(e.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement/$EnumMember")==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){S=e.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.Common.v1.Text/$Path");}else{S=E.ValueListProperty;}return!(e.getObject("/"+v.CollectionPath+"/"+E.ValueListProperty+"@com.sap.vocabularies.UI.v1.Hidden")===true);});var f=v.Parameters.some(function(P){return s||P.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterIn";});if(r){p=", parameters: { $$groupId: '"+r+"' }";}return("{path: '/"+v.CollectionPath+"'"+p+", suspended : "+f+", sorter: {path: '"+S+"', ascending: true}}");},getPropertyPath:function(p){return!p.UnboundAction?"/"+p.EntitySet+"/"+p.Action+"/"+p.Property:"/"+p.Action.substring(p.Action.lastIndexOf(".")+1)+"/"+p.Property;},getWaitForPromise:function(){return w;},getValueListCollectionEntitySet:function(v){var e=v.getObject();return e.$model.getMetaModel().createBindingContext("/"+e.CollectionPath);},getValueListProperty:function(p){var v=p.getModel();var e=v.getObject("/");return e.$model.getMetaModel().createBindingContext("/"+e.CollectionPath+"/"+p.getObject());},getValueListInfo:function(f,M,p,C){var k,D,s="",P=M.getObject(p+"@sapui.name"),e,i=[],o=[],g="";return M.requestValueListInfo(p,true,f.getBindingContext()).then(function(v){var h=f.getInParameters().length+f.getOutParameters().length===0,Q=Object.keys(v)[1]?Object.keys(v)[1]:Object.keys(v)[0],j;if(f.getBindingContext()&&(f.getParent().getId().indexOf("APD_")<0||f.getParent().getId().indexOf("CreateDialog")<0)&&f.getModel().getMetaModel().getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers"]){j=Q===""?"DefaultValueHelp::"+f.getId():f.getId()+"::qualifier::"+Q;f.getModel("_VHUI").setProperty("/contextDependentValueHelpId",j);f.getModel("_VHUI").setProperty("/noValidValueHelp",false);}if(Q===undefined){return f.getModel("_VHUI").setProperty("/noValidValueHelp",true);}v=v[j?Q:""];v.Parameters.forEach(function(l){e="/"+v.CollectionPath+"/"+l.ValueListProperty;var n=v.$model.getMetaModel().getObject(e),r=v.$model.getMetaModel().getObject(e+"@")||{};if(n){if(!k&&l.$Type.indexOf("Out")>48&&l.LocalDataProperty.$PropertyPath===P){g=e;k=l.ValueListProperty;D=r["@com.sap.vocabularies.Common.v1.Text"]&&r["@com.sap.vocabularies.Common.v1.Text"].$Path;}if(!s&&n.$Type==="Edm.String"&&!r["@com.sap.vocabularies.UI.v1.HiddenFilter"]&&!r["@com.sap.vocabularies.UI.v1.Hidden"]){s=s.length>0?s+","+l.ValueListProperty:l.ValueListProperty;}if(h&&l.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterDisplayOnly"&&l.$Type!=="com.sap.vocabularies.Common.v1.ValueListParameterConstant"&&l.LocalDataProperty&&l.LocalDataProperty.$PropertyPath!==P){var t="";if(C&&C.length>0){t=C+">/conditions/";}t="{"+t+l.LocalDataProperty.$PropertyPath+"}";if(l.$Type.indexOf("Out")>48){o.push(new O({value:t,helpPath:l.ValueListProperty}));}if(l.$Type.indexOf("In")>48){i.push(new I({value:t,helpPath:l.ValueListProperty,initialValueFilterEmpty:l.InitialValueIsSignificant}));}}if(l.$Type==="com.sap.vocabularies.Common.v1.ValueListParameterConstant"){i.push(new I({value:l.Constant,helpPath:l.ValueListProperty}));}}});return{keyValue:k,descriptionValue:D,fieldPropertyPath:g,filters:s,inParameters:i,outParameters:o,valueListInfo:v};}).catch(function(h){var j=h.status&&h.status===404?"Metadata not found ("+h.status+") for value help of property "+p:h.message;L.error(j);f.destroyContent();});},createValueHelpDialog:function(p,f,t,o,v,s){var e=f.getMetadata().getName(),W=f.getContent&&f.getContent(),g=W&&W.getId(),h=v&&v.filters,i=v&&v.inParameters,j=v&&v.outParameters,k=f.getModel("_VHUI").getProperty("/contextDependentValueHelpId"),l=this;if((!t||k!==undefined)&&e.indexOf("FieldValueHelp")>-1){f.setTitle(v.valueListInfo.Label);f.setKeyPath(v.keyValue);f.setDescriptionPath(v.descriptionValue);f.setFilterFields(b(v)?"$search":"");}function n(r){var u=X.loadTemplate(r,"fragment"),x=v.valueListInfo,y=new J(x),z=x.$model.getMetaModel(),k=f.getModel("_VHUI").getProperty("/contextDependentValueHelpId"),S=new J({id:k?k:f.getId(),groupId:f.data("requestGroupId")||undefined,bSuggestion:s,valueHelpWithFixedValues:f.getModel().getMetaModel().getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListWithFixedValues"]});return Promise.resolve(a.process(u,{name:r},{bindingContexts:{valueList:y.createBindingContext("/"),entitySet:z.createBindingContext("/"+x.CollectionPath),source:S.createBindingContext("/")},models:{valueList:y,entitySet:z,source:S,metaModel:z}})).then(function(u){var A={path:p,fragmentName:r,fragment:u};if(L.getLevel()===L.Level.DEBUG){V.ALLFRAGMENTS=V.ALLFRAGMENTS||[];V.ALLFRAGMENTS.push(A);}if(V.logFragment){setTimeout(function(){V.logFragment(A);},0);}return F.load({definition:u});});}t=t||n("sap.fe.macros.internal.valuehelp.ValueListTable");if(h.length){o=o||(!s&&n("sap.fe.macros.internal.valuehelp.ValueListFilterBar"));}else{o=Promise.resolve();}return Promise.all([t,o]).then(function(C){var k=f.getModel("_VHUI").getProperty("/contextDependentValueHelpId"),t=C[0],o=C[1],r=o?o.getFilterItems():[];if(t){t.setModel(v.valueListInfo.$model);var u=t.getBinding("items");u.attachEventOnce("dataRequested",function(){B.lock(t);});u.attachEvent("dataReceived",function(E){if(B.isLocked(t)){B.unlock(t);}if(E.getParameter("error")){setTimeout(m.showUnboundMessages,0);}});L.info("Value List XML content created ["+p+"]",t.getMetadata().getName(),"MDC Templating");}if(o&&r.length){o.setModel(v.valueListInfo.$model);L.info("Value List XML content created ["+p+"]",o.getMetadata().getName(),"MDC Templating");}if(t!==W.getTable()||k!==undefined){W.setTable(t);delete w[g];}t.setWidth(l.getTableWidth(t,l._getWidthInRem(f._getField())));W._sTableWidth=t.getWidth();var x=s?"416px":"Auto";t.setContextualWidth(x);if((o&&o!==f.getFilterBar()&&r.length)||(o&&k!==undefined)){f.setFilterBar(o);}else{f.addDependent(o);}j.forEach(function(y){f.addOutParameter(y);});i.forEach(function(y){f.addInParameter(y);});f.attachEventOnce("afterClose",function(E){var f=E.oSource;var y=f&&f.getConditions();if(y&&y[0]&&y[0].inParameters){delete y[0].inParameters;f.fireSelect({conditions:y,add:false,close:true});}});if(k!==undefined){var S=d(k);if(!S){c.push({sVLQualifier:k,oVLTable:t,oVLFilterBar:o});}}});},_getWidthInRem:function(C){var $=C.$().width(),W=$?parseFloat(R.fromPx($)):0;return isNaN(W)?0:W;},getTableWidth:function(t,M){var W,C=t.getColumns(),v=(C&&C.filter(function(o){return o&&o.getVisible();}))||[],s=v.reduce(function(S,o){W=o.getWidth();if(W&&W.endsWith("px")){W=R.fromPx(W);}var f=parseFloat(W);return S+(isNaN(f)?9:f);},v.length);return Math.max(s,M)+"em";},showValueListInfo:function(p,f,s,C){var M=f.getModel(),o=M.getMetaModel(),W=f.getContent&&f.getContent(),e=W&&W.getId(),t=W&&W.getTable&&W.getTable(),g=f&&f.getFilterBar&&f.getFilterBar(),E=t&&g,v,h;v=f.getModel("_VHUI");if(!v){v=new J({});f.setModel(v,"_VHUI");}v.setProperty("/showAllColumns",!s);v.setProperty("/minScreenWidth",!s?"418px":undefined);h=f.getModel("_VHUI").getProperty("/contextDependentValueHelpId");if(h!==undefined&&f.getBindingContext()){t=undefined;g=undefined;E=undefined;delete w[e];}if(!g&&f.getDependents().length>0){var P=f.getDependents()[0];if(P.isA("sap.ui.mdc.filterbar.vh.FilterBar")){g=P;}}if(w[e]||E){return w["promise"+e];}else{if(!t){w[e]=true;}var i=V.getValueListInfo(f,o,p,C).then(function(j){var h=f.getModel("_VHUI").getProperty("/contextDependentValueHelpId");var S=d(h);if(f.getModel("_VHUI").getProperty("/noValidValueHelp")){L.error("Context dependent value help not found");return f.close();}if(S){t=S.oVLTable;g=S.oVLFilterBar;}return(j&&V.createValueHelpDialog(p,f,t,g,j,s));}).catch(function(j){var k=j.status&&j.status===404?"Metadata not found ("+j.status+") for value help of property "+p:j.message;L.error(k);f.destroyContent();});w["promise"+e]=i;return i;}},setValueListFilterFields:function(p,f,s,C){var M=f.getModel(),o=M.getMetaModel();if(f.getBindingContext()&&f.getModel().getMetaModel().getObject(p+"@")["@com.sap.vocabularies.Common.v1.ValueListRelevantQualifiers"]){return;}return V.getValueListInfo(f,o,p,C).then(function(v){v&&f.setFilterFields(b(v)?"$search":"");});},getColumnWidth:function(D,v){if(v&&v.Parameters&&v.Parameters.length===1){return"auto";}switch(D){case"Edm.Stream":return"7em";case"Edm.Boolean":return"8em";case"Edm.Date":case"Edm.TimeOfDay":return"9em";case"Edm.DateTimeOffset":return"12em";default:return"auto";}}};return V;},true);
