/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/util/FilterUtil","sap/ui/fl/Utils","sap/ui/core/Core","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/ui/model/Filter","sap/fe/macros/DelegateUtil","sap/fe/core/converters/templates/ListReportConverter","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/templates/BaseConverter","sap/base/util/merge","sap/ui/model/json/JSONModel","sap/ui/mdc/field/ConditionsType","sap/ui/mdc/p13n/StateUtil"],function(F,a,C,b,c,d,D,L,e,B,m,J,f,S){"use strict";var o={getFilter:function(i){var g=o.getFilterInfo(i).filters;return g.length?new d(o.getFilterInfo(i).filters,false):undefined;},getConvertedFilterFields:function(g,E){var s=D.getCustomData(g,"entitySet"),t=E||s,T=t?t.slice(1):t,h="selectionFields"+(!t||s===t?"":"For"+T),i=D.getCustomData(g,h);if(!i&&(!t||!g.data instanceof Function)){return[];}else if(!i){var v=a.getViewForControl(g);var M=g.getModel().getMetaModel();var A=c.getAppComponent(v);var j=e.createConverterContextForMacro(T,M.createBindingContext(t),B.TemplateType.ListReport,A&&A.getShellServices(),A&&A.getDiagnostics(),m);i=L.getSelectionFields(j.getEntitySet(),[],j);D.setCustomData(g,h,i);}return b.parseCustomData(i);},getFilterInfo:function(I,p,t){var g=I,s,h=[],j=[];if(typeof I==="string"){g=C.byId(I);}if(g){s=g.getSearch?g.getSearch():null;var k=g.getConditions(),l=g.getPropertyInfoSet?g.getPropertyInfoSet():null;if(k){if(t&&g.data("entitySet")!==t){var M=g.getModel().getMetaModel();var T=g.getControlDelegate().fetchPropertiesForEntity(t,M,g);p=T;var E={};for(var i=0;i<T.length;i++){var n=T[i];E[n.name]=true;}l.forEach(function(r){var u=r.name;if(!E[u]){j.push(u);}});}else if(!p){p=l;}var q=F.getFilterInfo(g,k,p,j).filters;h=q?[q]:[];}}return{filters:h,search:s||undefined};},getNotApplicableFiltersForEntity:function(g,t){var n=[],h=g.getConditions(),M=g.getModel().getMetaModel(),s=g.data("entitySet");if(h&&s!==t){var T=g.getControlDelegate().fetchPropertiesForEntity(t,M,g),i=T.reduce(function(P,k){P[k.name]=k;return P;},{});for(var p in h){var j=h[p];if(!i[p]&&Array.isArray(j)&&j.length>0){n.push(p);}}}return n;},attachConditionHandling:function(g){var h=new J(),E={filterControl:g,filterModel:h},t=this;g.setModel(h,"filterValues");return g.initialized().then(function(){var i=g._getConditionModel();i.attachPropertyChange(E,t._handleConditionModelChange,t);h.attachPropertyChange(E,t._handleFilterModelChange,t);});},detachConditionHandling:function(g){var h=g.getModel("filterValues"),i=g._getConditionModel();i.detachPropertyChange(this._handleConditionModelChange,this);h.detachPropertyChange(this._handleFilterModelChange,this);h.destroy();},setFilterValues:function(g,s,O,v){var h={};if(v===undefined){v=O;}else{h.operators=[O];}var i=new f(h),j={},k={};v=Array.isArray(v)?v:[v];j[s]=[];k[s]=v.filter(function(V){return V!==undefined&&V!==null;}).reduce(function(A,V){return A.concat(i.parseValue(V.toString(),"any"));},[]);return S.applyExternalState(g,{filter:j}).then(S.applyExternalState.bind(S,g,{filter:k}));},conditionToModelPath:function(s){return s.replace(/\//g,"\\");},modelToConditionPath:function(s){return s.replace(/\\/g,"/");},_handleConditionModelChange:function(E,g){var s=this.modelToConditionPath(E.getParameter("path").substring(12)),h=new f({maxConditions:-1}),i=g.filterModel,v=E.getParameter("value"),V=h.formatValue(v,"any");i.setProperty("/"+this.conditionToModelPath(s),V);},_handleFilterModelChange:function(E,g){var p=E.getParameter("context").getPath().substring(1).replace(/\\/g,"/"),v=E.getParameter("value");this.setFilterValues(g.filterControl,p,v);}};return o;});
