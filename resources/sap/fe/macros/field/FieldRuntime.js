/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/macros/ResourceModel","sap/fe/core/helpers/SideEffectsUtil","sap/base/Log","sap/fe/core/CommonUtils","sap/fe/macros/DelegateUtil","sap/ui/util/openWindow"],function(R,S,L,C,D,o){"use strict";function _(s,a){var b=s.getBindingContext(),m=b.getModel().getMetaModel(),M=m.getMetaPath(b.getPath()),e=m.getObject(M)["$Type"],c=b;if(a!==e){c=b.getBinding().getContext();if(c){M=m.getMetaPath(c.getPath());e=m.getObject(M)["$Type"];if(a!==e){c=c.getBinding().getContext();if(c){M=m.getMetaPath(c.getPath());e=m.getObject(M)["$Type"];if(a!==e){return undefined;}}}}}return c||undefined;}var F={formatDraftOwnerTextInPopover:function(h,d,s,a,b){if(h){var u=a||d||b||s;if(!u){return R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_UNKNOWN");}else{return d?R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_LOCKED_BY_KNOWN",u):R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_UNSAVED_CHANGES_BY_KNOWN",u);}}else{return R.getText("M_FIELD_RUNTIME_DRAFT_POPOVER_NO_DATA_TEXT");}},onDataFieldWithNavigationPath:function(s,c,a){var b=s.getBindingContext();if(c.routing){c._routing.navigateToTarget(b,a);}else{L.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath");}},_initSideEffectsQueue:function(c,a){this.sideEffectsRequestsQueue=this.sideEffectsRequestsQueue||{};this.sideEffectsRequestsQueue[c]=this.sideEffectsRequestsQueue[c]||{};this.sideEffectsRequestsQueue[c]["context"]=this.sideEffectsRequestsQueue[c]["context"]||a;this.sideEffectsRequestsQueue[c]["pathExpressions"]=this.sideEffectsRequestsQueue[c]["pathExpressions"]||[];if(this.aFailedSideEffects&&this.aFailedSideEffects[c]){this.sideEffectsRequestsQueue[c]["pathExpressions"]=this.sideEffectsRequestsQueue[c]["pathExpressions"].concat(this.aFailedSideEffects[c]["pathExpressions"]);delete this.aFailedSideEffects[c];}},_feedSideEffectsQueue:function(s,a,b){var t=this,B=b.getBindingContext(),m=B.getModel().getMetaModel(),c,p=[],P,q,e,Q,g=function(f){return f["$PropertyPath"];},G=function(f){return f["$NavigationPropertyPath"];},d=_(b,a);if(!d){return Promise.resolve();}c=d.getPath();p=p.concat(s.TargetProperties).concat(s.TargetEntities);p=S.replaceEmptyNavigationPaths(p);p=S.addTextProperties(p,m,a);if(p.length){t._initSideEffectsQueue(c,d);q=t.sideEffectsRequestsQueue[c]["pathExpressions"].filter(g).map(g);Q=t.sideEffectsRequestsQueue[c]["pathExpressions"].filter(G).map(G);P=p.map(g).filter(function(f){return f&&q.indexOf(f)<0;}).map(function(f){return{"$PropertyPath":f};});e=p.map(G).filter(function(f){return(f||f==="")&&Q.indexOf(f)<0;}).map(function(f){return{"$NavigationPropertyPath":f};});p=P.concat(e);t.sideEffectsRequestsQueue[c]["pathExpressions"]=t.sideEffectsRequestsQueue[c]["pathExpressions"].concat(p);t.sideEffectsRequestsQueue[c]["triggerAction"]=s.TriggerAction;}return Promise.resolve();},prepareForSideEffects:function(f,s){var t=this,w=f.indexOf("#")>-1,a=(w&&f.split("#")[0])||f,q=(w&&f.split("#")[1])||"",b="/"+a+"@com.sap.vocabularies.Common.v1.SideEffects",B=s.getBindingContext(),m=B.getModel().getMetaModel(),c,b=(w&&b+"#"+q)||b;c=S.convertSideEffect(m.getObject(b));if(c&&t.aPendingSideEffects.indexOf(f)>-1){this._feedSideEffectsQueue(c,a,s);t.aPendingSideEffects.splice(t.aPendingSideEffects.indexOf(f),1);}return Promise.resolve();},prepareForAppSideEffects:function(s){var a,v=C.getTargetView(s);if(v){var c=v.getController(),e="/"+v.getViewData().entitySet+"/",b=v.getModel().getMetaModel().getObject(e+"$Type"),f=D.getCustomData(s,"sourcePath").replace(e,"");a=c.sideEffects.getEntitySideEffects(b)[f];if(a){this._feedSideEffectsQueue(a,b,s);}}return Promise.resolve(a);},requestSideEffects:function(){if(!this.sideEffectsRequestsQueue){return;}var t=this,s=this.sideEffectsRequestsQueue,a=this.oSideEffectQueuePromise||Promise.resolve(),T;this.sideEffectsRequestsQueue=null;return a.then(function(){var m=Object.keys(s).map(function(p){var b=s[p];S.logRequest(b);if(b.triggerAction){T=b.context.getModel().bindContext(b.triggerAction+"(...)",b.context);T.execute(b.context.getBinding().getUpdateGroupId());}return b["context"].requestSideEffects(b["pathExpressions"]).then(function(){},function(){L.info("FieldRuntime: Failed to request side effect - "+p,"sap.fe.macros.field.FieldRuntime","requestSideEffects");t.aFailedSideEffects[p]=b;});});t.oSideEffectQueuePromise=Promise.all(m);});},requestTextIfRequired:function(s){var a=s.getBindingInfo("additionalValue");if(!a){return;}if(s.getBinding("value").getPath()){var m=s.getModel().getMetaModel(),p=s.getBindingContext().getPath()+"/"+s.getBinding("value").getPath(),v=m.getValueListType(p);if(v==="Standard"||v==="Fixed"){return;}}var P=a.parts.map(function(b){return S.determinePathOrNavigationPath(b.path);}),c=s.getBindingContext();if(P.length){c.requestSideEffects(P).then(function(){}).catch(function(){L.info("FieldRuntime: Failed to request Text association - "+(P[0]&&P[0]["$PropertyPath"]),"sap.fe.macros.field.FieldRuntime","requestTextIfRequired");});}},hasTargets:function(s){return s?s:false;},handleChange:function(c,e){var t=this,s=e.getSource(),i=s&&s.getBindingContext().isTransient(),p=e.getParameter("promise")||Promise.resolve(),a=p,A=false,f=s.getFieldGroupIds()||[];c.editFlow.syncTask(p);if(i){return;}this.aPendingSideEffects=this.aPendingSideEffects||[];this.mFieldGroupResolves=this.mFieldGroupResolves||{};this.aFailedSideEffects=this.aFailedSideEffects||{};f.forEach(function(b){var I=b.indexOf("$$ImmediateRequest")>-1;if(I){A=true;b=b.substr(0,b.indexOf("$$ImmediateRequest"));}else if(t.mFieldGroupResolves.hasOwnProperty(b)){t.mFieldGroupResolves[b].push(p);}else{t.mFieldGroupResolves[b]=[p];}if(t.aPendingSideEffects.indexOf(b)===-1){t.aPendingSideEffects.push(b);}if(I){a=a.then(function(){return t.prepareForSideEffects(b,s);});}});a=a.then(function(){return t.prepareForAppSideEffects(s);}).then(function(b){if(b){A=true;}});a.then(function(){if(A){t.requestSideEffects();}}).catch(function(E){L.error("Error while processing side effects",E);});},handleSideEffect:function(e){if(!this.aPendingSideEffects||this.aPendingSideEffects.length===0){return;}var t=this,f=e.getParameter("fieldGroupIds"),s=e.getSource(),p=Promise.resolve();f=f||[];f.forEach(function(a){var b=[Promise.resolve()];if(t.mFieldGroupResolves&&t.mFieldGroupResolves[a]){b=t.mFieldGroupResolves[a];delete(t.mFieldGroupResolves&&t.mFieldGroupResolves[a]);}p=p.then(function(){return Promise.all(b);}).then(t.prepareForSideEffects.bind(t,a,s));});p.then(this.requestSideEffects.bind(this)).catch(function(E){L.error("Error while requesting side effects",E);});},handlePatchEvents:function(b){if(!b){return;}var t=this;b=(b.getBinding&&b.getBinding())||b;b.attachEvent("patchCompleted",function(e){if(e.getParameter("success")!==false&&t.aFailedSideEffects){Object.keys(t.aFailedSideEffects).forEach(function(c){t._initSideEffectsQueue(c,t.aFailedSideEffects[c]["context"]);});t.requestSideEffects();}});},formatWithBrackets:function(t,T){if(T){return t?t+" ("+T+")":T;}else{return t?t:"";}},formatWithPercentage:function(v){return v!==null&&v!==undefined?v+" %":"";},pressLink:function(e){var l=e.getSource();if(l.getDependents()&&l.getDependents().length>0){var f=l.getDependents()[0];if(f&&f.isA("sap.ui.mdc.Link")){f.getTriggerHref().then(function(h){if(!h){f.open(l);}else{var v=sap.ui.fl.Utils.getViewForControl(l);var a=C.getAppComponent(v);var s=a.getShellServices();var b=s.parseShellHash(h);var n={target:{semanticObject:b.semanticObject,action:b.action},params:b.params};if(C.isStickyEditMode(l)!==true){s.toExternal(n,a);}else{var N=s.hrefForExternal(n,a,false);o(N);}}}).catch(function(E){L.error("Error triggering link Href",E);});}}}};return F;},true);
