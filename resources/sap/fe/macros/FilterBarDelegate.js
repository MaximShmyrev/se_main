/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/FilterBarDelegate","sap/ui/model/json/JSONModel","sap/fe/core/TemplateModel","sap/fe/macros/CommonHelper","sap/fe/core/CommonUtils","sap/fe/core/helpers/StableIdHelper","sap/fe/macros/field/FieldHelper","sap/fe/macros/filter/FilterUtils","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/ResourceModel","sap/base/util/merge","sap/fe/macros/DelegateUtil","sap/fe/macros/FilterBarHelper","sap/base/Log","sap/base/util/JSTokenizer","sap/fe/core/templating/PropertyFormatters"],function(F,J,T,C,a,S,b,c,d,R,m,D,e,L,f,P){"use strict";var O=Object.assign({},F),E="$editState",g="$search",V="FilterFieldValueHelp",h="sap_fe_FilterBarDelegate_propertyInfoMap",i=/\+|\*/g;function _(){return{name:g,path:g,typeConfig:d.getTypeConfig("sap.ui.model.odata.type.String"),maxConditions:1};}function j(){return{name:E,path:E,groupLabel:"",group:"",label:R.getText("M_COMMON_FILTERBAR_EDITING_STATUS"),tooltip:null,hiddenFilter:false,typeConfig:d.getTypeConfig("sap.ui.model.odata.type.String"),defaultFilterConditions:[{fieldPath:"$editState",operator:"DRAFT_EDIT_STATE",values:["0"]}]};}function k(w,M){var x=new J({id:D.getCustomData(w,"localId")}),y={bindingContexts:{"this":x.createBindingContext("/")},models:{"this.i18n":R.getModel(),"this":x}};return D.templateControlFragment("sap.fe.macros.filter.DraftEditState",y,undefined,M).finally(function(){x.destroy();});}function l(w,I,x,M,y){var z=new J({id:q(D.getCustomData(w,"localId"),I)}),A=new T(x,M),B={bindingContexts:{"this":z.createBindingContext("/"),"item":A.createBindingContext("/")},models:{"this":z,"item":A}};return D.templateControlFragment("sap.fe.macros.filter.CustomFilter",B,undefined,y).finally(function(){z.destroy();A.destroy();});}function n(w){return w.replace(i,"");}function o(w,x){return w.find(function(y){return y.conditionPath===x&&y.availability!=="Hidden";});}function p(M,w,x){var A=x.annotationPath,y=A.substr(0,A.lastIndexOf("/")),z=M.getObject(A),B=M.getObject(A+"@"),G=M.getObject(y+"/@"),H,I,K,N=x.label,Q=M.createBindingContext(A),U=B["@com.sap.vocabularies.PersonalData.v1.IsPotentiallySensitive"]||B["@com.sap.vocabularies.UI.v1.ExcludeFromNavigationContext"]||B["@com.sap.vocabularies.Analytics.v1.Measure"];if(!a.isPropertyFilterable(M,w,n(x.conditionPath),true)){return null;}I=B["@com.sap.vocabularies.Common.v1.FilterDefaultValue"];if(I){H=I["$"+D.getModelType(z.$Type)];}K={name:x.conditionPath,path:x.conditionPath,groupLabel:x.groupLabel,group:x.group,label:N,tooltip:B["@com.sap.vocabularies.Common.v1.QuickInfo"]||null,hiddenFilter:x.availability==="Hidden",removeFromAppState:U,hasValueHelp:P.hasValueHelp(Q.getObject(),{context:Q})};if(H){K.defaultFilterConditions=[{fieldPath:x.conditionPath,operator:"EQ",values:[H]}];}K.formatOptions=f.parseJS(b.formatOptions(z,{context:Q})||"{}");K.constraints=f.parseJS(b.constraints(z,{context:Q})||"{}");K.typeConfig=d.getTypeConfig(z.$Type,K.formatOptions,K.constraints);K.display=b.displayMode(B,G);return K;}function q(w,x,N){return N?S.generate([w,x,N]):S.generate([w,x]);}function r(w,x){return Promise.resolve().then(function(){var y=new J({idPrefix:x.sVhIdPrefix,conditionModel:"$filters",navigationPrefix:x.sNavigationPrefix?"/"+x.sNavigationPrefix:"",filterFieldValueHelp:true,requestGroupId:x.sValueHelpGroupId,useSemanticDateRange:x.bUseSemanticDateRange}),z=m({},w,{bindingContexts:{"this":y.createBindingContext("/")},models:{"this":y}});return D.templateControlFragment("sap.fe.macros.internal.valuehelp.ValueHelp",z,{isXML:w.isXML}).then(function(A){if(A){var B="dependents";if(x.oModifier){x.oModifier.insertAggregation(x.oControl,B,A,0);}else{x.oControl.insertAggregation(B,A,0,false);}}}).finally(function(){y.destroy();});}).catch(function(y){L.error("Error while evaluating DelegateUtil.isValueHelpRequired",y);});}function s(w,x){var y=new J({idPrefix:x.sIdPrefix,vhIdPrefix:x.sVhIdPrefix,propertyPath:x.sPropertyName,navigationPrefix:x.sNavigationPrefix?"/"+x.sNavigationPrefix:"",useSemanticDateRange:x.bUseSemanticDateRange,settings:x.oSettings}),z=m({},w,{bindingContexts:{"this":y.createBindingContext("/")},models:{"this":y}});return D.templateControlFragment("sap.fe.macros.FilterField",z,{isXML:w.isXML}).finally(function(){y.destroy();});}O.addItem=function(w,x,y){if(!y){return O._addP13nItem(w,x);}var M=y.appComponent&&y.appComponent.getModel().getMetaModel();if(!M){return Promise.resolve(null);}return O._addFlexItem(w,x,M,y.modifier);};O._addP13nItem=function(w,x){return D.fetchModel(x).then(function(M){return O._addFlexItem(w,x,M.getMetaModel(),undefined);}).catch(function(){L.error("Model could not be resolved");return null;});};O.fetchPropertiesForEntity=function(w,M,x){var y=M.getObject(w+"/");if(!x||!y){return[];}var z=M.getObject(w+"@"),A=c.getConvertedFilterFields(x,w),B,G=[],H=(z&&D.getRequiredProperties(z))||[],N=(z&&D.getNonFilterableProperties(z))||[],I=(z&&D.getFilterAllowedExpressions(z))||{};Object.keys(A).forEach(function(K){var Q=A[K];var U=n(Q.conditionPath);if(N.indexOf(U)===-1){B=p(M,w,Q);if(B){if(I[U]){B.filterExpression=I[U];}else{B.filterExpression="auto";}B.maxConditions=D.isMultiValue(B)?-1:1;B.required=H.indexOf(U)>=0;B.visible=Q.availability==="Default";B.label=D.getLocalizedText(Q.label,x);G.push(B);}}});if(x.data("showDraftEditState")){G.push(j());}if(e.checkIfBasicSearchIsVisible(x.data("hideBasicSearch")==="true",M.getObject(w+"@Org.OData.Capabilities.V1.SearchRestrictions"))){G.push(_());}return G;};O._addFlexItem=function(w,x,M,y){var I=y?"":"Adaptation",z=c.getConvertedFilterFields(x),A=o(z,w),B=n(w),G=!!y&&y.targets==="xmlTree";if(w===E){return k(x,y);}else if(w===g){return Promise.resolve(null);}else if(A&&A.template){return l(x,I,A,M,y);}var N=C.getNavigationPath(B),H=D.getCustomData(x,"entitySet",y)||D.getCustomData(x,"targetCollectionName",y),K=M.createBindingContext(H+"/"+B),Q=e.getTargetEntityContext(K),U=y?y.getId(x):x.getId(),W={bindingContexts:{"entitySet":Q,"property":K},models:{"entitySet":M,"property":M},isXML:G},X={sPropertyName:B,sBindingPath:H,sValueHelpType:V,oControl:x,oMetaModel:M,oModifier:y,sIdPrefix:q(U,I+"FilterField",N),sVhIdPrefix:q(U,I+V,N),sNavigationPrefix:N,sValueHelpGroupId:D.getCustomData(x,"valueHelpRequestGroupId",y),bUseSemanticDateRange:D.getCustomData(x,"useSemanticDateRange",y),oSettings:A?A.settings:{}};return D.doesValueHelpExist(X).then(function(Y){if(!Y){return r(W,X);}return Promise.resolve();}).then(s.bind(undefined,W,X));};function t(w){if(w instanceof window.Element){return null;}return D.getCustomData(w,h);}function u(w,x){if(w instanceof window.Element){return;}D.setCustomData(w,h,x);}function v(w,M,x){var y=t(x);if(!y){y=O.fetchPropertiesForEntity(w,M,x);u(x,y);}return y;}O.fetchProperties=function(w){var x=D.getCustomData(w,"entitySet");return D.fetchModel(w).then(function(M){if(!M){return[];}return v(x,M.getMetaModel(),w);});};O.getTypeUtil=function(w){return d;};return O;},false);
