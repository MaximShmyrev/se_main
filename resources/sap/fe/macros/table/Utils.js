/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/model/Filter","sap/ui/core/format/NumberFormat","sap/fe/core/CommonUtils","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils","sap/base/Log","sap/fe/macros/DelegateUtil"],function(F,N,C,a,b,L,D){"use strict";function g(T,s){var E=T.data("targetCollectionName"),M=C.getAppComponent(T).getMetaModel(),S=M.getObject(E+"/@"+s),q=[],P=[],r="";if(S){r=S.Text;for(var i in S.SelectOptions){var v=S.SelectOptions[i];if(v&&v.PropertyName){var x=v.PropertyName.$PropertyPath;var R=[];for(var j in v.Ranges){var y=v.Ranges[j];R.push(new F(x,y.Option.$EnumMember.split("/").pop(),y.Low,y.High));}if(R.length>0){if(!P.includes(x)){P.push(x);}q.push(new F({filters:R,and:false}));}}}}return{properties:P,filters:q,text:r};}function c(T){var i=[],j=T.data("hiddenFilters");if(j&&Array.isArray(j.paths)){j.paths.forEach(function(P){var s=g(T,P.annotationPath);i=i.concat(s.filters);});}return i;}function d(T){var i=[],q=D.getCustomData(T,"quickFilterKey");if(q){i=i.concat(g(T,q).filters);}return i;}function e(T){return d(T).concat(c(T));}function f(T,E,H){var B=T.getRowsBindingInfo();if(B){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var O=B.events[E];B.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}}}function h(T,P,i){var B=T.getRowsBindingInfo(),j=T.getModel(),q,r,s=i.batchGroupId||"",v=l(T),x=Array.isArray(i.additionalFilters)?i.additionalFilters:[];x=x.concat(v.filters).concat(m(T));r=new F({filters:x,and:true});q=j.bindList((P?P.getPath()+"/":"")+B.path,T.getBindingContext(),null,r,{$count:true,$$groupId:s||"$auto",$search:v.search});return q.requestContexts(0,1).then(function(y){var z=y&&y.length?y[0].getBinding().getLength():0;q.destroy();return z;});}function k(i){var j=N.getIntegerInstance({groupingEnabled:true});return j.format(i);}function l(T){return a.getFilterInfo(T.getFilter(),undefined,T.data("targetCollectionName"));}function m(T){var P=T.getP13nMode();if(P&&P.indexOf("Filter")>-1){var i=D.getCustomData(T,"sap_fe_TableDelegate_propertyInfoMap"),j=a.getFilterInfo(T,i);if(j&&j.filters){return j.filters;}}return[];}function n(T){var i=l(T);return{filters:i.filters.concat(e(T),m(T)),search:i.search};}function w(T){return _(T).promise;}function o(T){var B=_(T);if(B.resolve){B.resolve(T);T.data("boundPromiseResolve",null);}}function _(T){if(!T.data("boundPromise")){var r;T.data("boundPromise",new Promise(function(i){r=i;}));if(T.isBound()){r(T);}else{T.data("boundPromiseResolve",r);}}return{promise:T.data("boundPromise"),resolve:T.data("boundPromiseResolve")};}function u(B,i,j){B.filters=j;if(i.search){B.parameters.$search=i.search;}else{delete B.parameters.$search;}}function G(j,T){var v=j.getView();var I=v.getBindingContext("internal");if(I){var E=D.getCustomData(T,"targetCollectionName");if(E){var q=j.getOwnerComponent();var A=sap.ui.core.Component.getOwnerComponentFor(q);var M=A.getMetaModel();var s=C.getShellServices(A);var r=s.hrefForExternal();var x=D.getCustomData(T,"columns");var S=[];var y=[];var z=[];var P,B,H;var J;if(r&&r.indexOf("?")!==-1){r=r.split("?")[0];}for(var i=0;i<x.customData.length;i++){B=x.customData[i].annotationPath;H=M.getObject(B);if(H&&H.$kind==="Property"){P=x.customData[i].annotationPath;}else if(H&&H.$Type==="com.sap.vocabularies.UI.v1.DataField"){P=E+"/"+M.getObject(B+"/Value/$Path");}if(P){J=C.getSemanticObjectsFromPath(M,P);if(J.semanticObject){S.push(J.semanticObjectForGetLinks);y.push({semanticObject:J.semanticObject.semanticObject,unavailableActions:J.unavailableActions,path:P?P:B});}}P=undefined;}s.getLinksWithCache(S).then(function(K){if(K&&K.length>0&&K[0]!==undefined){var O={};var Q={};var R;var U=function(V){if(!(r===V.intent)){if(y[i].unavailableActions&&y[i].unavailableActions.find(function(W){if(W===V.intent.split("-")[1]){return true;}})){return false;}else{z[i].push(V);}}};for(var i=0;i<K.length;i++){z.push([]);K[i][0].forEach(U);Q={semanticObject:y[i].semanticObject,path:y[i].path,HasTargets:z[i].length>0?true:false,HasTargetsNotFiltered:K[i].length>0?true:false};if(O[y[i].semanticObject]===undefined){O[y[i].semanticObject]={};}R=y[i].path.replace(/\//g,"_");if(O[y[i].semanticObject][R]===undefined){O[y[i].semanticObject][R]={};}O[y[i].semanticObject][R]=Object.assign(O[y[i].semanticObject][R],Q);}I.setProperty("semanticsTargets",O);}}).catch(function(K){L.error("fnGetSemanticTargets: Cannot read links",K);});}}}function p(T){T.clearSelection();var i=T.getBindingContext("internal");i.setProperty("deleteEnabled",false);i.setProperty("numberOfSelectedContexts",0);i.setProperty("selectedContexts",[]);i.setProperty("deletableContexts",[]);}var t={addEventToBindingInfo:f,getCountFormatted:k,getHiddenFilters:c,getFiltersInfoforSV:g,getTableFilters:e,getListBindingForCount:h,getFilterInfo:l,getP13nFilters:m,getAllFilterInfo:n,whenBound:w,onTableBound:o,getSemanticTargetsFromTable:G,updateBindingInfo:u,clearSelection:p};return t;});
