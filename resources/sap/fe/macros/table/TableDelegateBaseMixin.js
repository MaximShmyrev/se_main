/*
 * ! SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2017 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/mdc/TableDelegate","sap/ui/model/json/JSONModel","sap/fe/macros/CommonHelper","sap/fe/macros/table/Utils","sap/fe/core/CommonUtils","sap/fe/macros/DelegateUtil","sap/ui/model/Filter","sap/base/Log","sap/ui/mdc/odata/v4/TypeUtil","sap/fe/macros/FilterBarDelegate","sap/fe/core/helpers/ExcelFormatHelper","sap/fe/macros/table/TableHelper","sap/fe/macros/ResourceModel"],function(T,J,C,a,b,D,F,L,c,d,E,e,R){"use strict";var f="sap_fe_TableDelegate_propertyInfoMap";function _(t){return C.parseCustomData(D.getCustomData(t,"columns"));}function g(p){return p&&p.metadataPath.includes("@com.sap.vocabularies.UI.v1.LineItem");}function h(t,k){if(t instanceof window.Element){return;}D.setCustomData(t,f,k);}function i(t){if(t instanceof window.Element){return null;}return D.getCustomData(t,f);}var j={_fetchPropertyInfo:function(B,o){var A=o.annotationPath,m=B.getModel(),k=m.getObject(o.annotationPath),n=m.createBindingContext(A),t=b.getPropertyDataType(n),l=o.propertyInfos!==undefined,s=this._getExportDataType(t,l),p=t&&t==="Edm.Date"?E.getExcelDatefromJSDate():undefined,q=t&&t==="Edm.DateTimeOffset"?E.getExcelDateTimefromJSDateTime():undefined,r=t&&t==="Edm.TimeOfDay"?E.getExcelTimefromJSTime():undefined,u=p?"YYYY-MM-DD":undefined,v=null,w=C.isPropertyFilterable(o.relativePath,{context:n},k),x=t&&t.indexOf("Edm.")!==0,y=D.isTypeFilterable(t)?c.getTypeConfig(t):undefined,z={label:(o.exportSettings&&o.exportSettings.label)||o.label,type:s,inputFormat:u,format:p||q||r,scale:n.getProperty("$Scale")||n.getProperty("Value/$Path/$Scale"),delimiter:t&&t==="Edm.Int64"?true:false,trueValue:t&&t==="Edm.Boolean"?"Yes":undefined,falseValue:t&&t==="Edm.Boolean"?"No":undefined};if(o.exportSettings&&o.exportSettings.template){z.template=o.exportSettings.template;}var P={name:o.name,metadataPath:A,groupLabel:o.groupLabel,group:o.group,label:o.label,description:v||o.label,maxLength:n.$MaxLength,precision:n.$Precision,scale:n.$Scale,type:t,typeConfig:y,visible:o.availability!=="Hidden"&&!x,exportSettings:z};if(o.propertyInfos&&o.propertyInfos.length){P.propertyInfos=o.propertyInfos;}else{P.path=o.relativePath;P.sortable=o.sortable&&!o.relativePath.includes("/");P.filterable=w;P.key=o.isKey;P.groupable=o.isGroupable;}return P;},_getExportDataType:function(s,k){var l;if(k){l="String";}else if(s){switch(s){case"Edm.Decimal":case"Edm.Int32":case"Edm.Int64":case"Edm.Double":case"Edm.Byte":l="Number";break;case"Edm.DateOfTime":case"Edm.Date":l="Date";break;case"Edm.DateTimeOffset":l="DateTime";break;case"Edm.TimeOfDay":l="Time";break;case"Edm.Boolean":l="Boolean";break;default:l="String";}}return l;},_fetchCustomPropertyInfo:function(o,t){var l=D.getLocalizedText(o.header,t);var p={name:o.name,groupLabel:null,group:null,label:l,description:l,maxLength:undefined,precision:undefined,scale:undefined,type:"Edm.String",visible:o.availability!=="Hidden",exportSettings:undefined};if(o.propertyInfos&&o.propertyInfos.length){p.propertyInfos=o.propertyInfos;}else{p.path=o.name;p.sortable=false;p.filterable=false;}return p;},_fetchPropertiesForEntity:function(t,B,m){var o=m.createBindingContext(B),k=[],l=m.getObject(B+"@"),n=(l&&D.getNonFilterableProperties(l))||[],A=(l&&D.getFilterAllowedExpressions(l))||{},p=this;return Promise.resolve(_(t)).then(function(q){if(!q){return Promise.resolve([]);}var P;q.forEach(function(r){switch(r.type){case"Annotation":P=p._fetchPropertyInfo(o,r);if(P&&n.indexOf(P.name)===-1){if(A[P.name]){P.filterExpression=A[P.name];}else{P.filterExpression="auto";}P.maxConditions=D.isMultiValue(P)?-1:1;}break;case"Default":P=p._fetchCustomPropertyInfo(r,t);break;default:throw new Error("unhandled switch case "+r.type);}k.push(P);});k.forEach(function(P){var u=P.path&&P.exportSettings?P.exportSettings.unitProperty:undefined;if(u){var U=k.find(function(r){return r.path===u;});if(U){P.unit=U.name;}}});return k;});},_getCachedOrFetchPropertiesForEntity:function(t,s,m){var k=i(t);if(k){return Promise.resolve(k);}return this._fetchPropertiesForEntity(t,s,m).then(function(k){h(t,k);return k;});},_setTableNoDataText:function(t,B){var n="",o=a.getAllFilterInfo(t),s=B.path.substr(1);var k=function(){if(t.data("hiddenFilters")||t.data("quickFilterKey")){return"M_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER_MULTI_VIEW";}else{return"T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER";}};if(t.getFilter()){if(o.search||(o.filters&&o.filters.length)){n=k();}else{n="M_OP_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT";}}else{if(o.search||(o.filters&&o.filters.length)){n=k();}else{n="M_OP_TABLE_AND_CHART_OP_NO_FILTERS_NO_DATA_TEXT";}}if(n==="T_OP_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"){return t.getModel("sap.fe.i18n").getResourceBundle().then(function(r){t.setNoDataText(b.getTranslatedText(n,r,null,s));}).catch(function(l){L.error(l);});}else{if(R){t.setNoDataText(R.getText(n));}}},handleTableDataReceived:function(t,I){var B=t&&t.getRowBinding(),k=I.getProperty("dataReceivedAttached");if(!k){B.attachDataReceived(function(){e.handleTableDeleteEnablementForSideEffects(t,I);});I.setProperty("dataReceivedAttached",true);}},rebindTable:function(t,B){if(!t.data("tableHidden")){a.clearSelection(t);T.rebindTable(t,B);a.onTableBound(t);this._setTableNoDataText(t,B);a.whenBound(t).then(this.handleTableDataReceived(t,t.getBindingContext("internal"))).catch(function(o){L.error("Error while waiting for the table to be bound",o);});}},fetchProperties:function(t){var k=this;return D.fetchModel(t).then(function(m){if(!m){return[];}return k._getCachedOrFetchPropertiesForEntity(t,D.getCustomData(t,"targetCollectionName"),m.getMetaModel());});},updateBindingInfo:function(t,m,B){if(t.getRowBinding()){B.suspended=false;}var o;var k=a.getAllFilterInfo(t);if(k.filters.length>0){o=new F({filters:k.filters,and:true});}a.updateBindingInfo(B,k,o);},_templateCustomColumnFragment:function(o,v,m){var k=new J(o),p={bindingContexts:{"column":k.createBindingContext("/")},models:{"column":k}};return D.templateControlFragment("sap.fe.macros.table.CustomColumn",p,{view:v},m).then(function(I){k.destroy();return I;});},_getVHRelevantFields:function(m,M,B){var k=[];switch(m.getObject(M+"/$Type")){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":if(m.getObject(M+"/Target/$AnnotationPath").includes("com.sap.vocabularies.UI.v1.FieldGroup")){m.getObject(M+"/Target/$AnnotationPath/Data").forEach(function(v,I){k=k.concat(j._getVHRelevantFields(m,M+"/Target/$AnnotationPath/Data/"+I));});}break;case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataField":k.push(m.getObject(M+"/Value/$Path"));break;case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":break;default:if(M.indexOf(B)===0){k.push(M.substring(B.length+1));break;}k.push(C.getNavigationPath(M,true));break;}return k;},addItem:function(p,t,P){var m=P.appComponent&&P.appComponent.getModel().getMetaModel(),M=P.modifier,s=M.getId(t),k,G,l,o,n,q,r,u,v,w=_(t);n=w.find(function(x){return x.name===p;});if(!n){L.error(p+" not found while adding column");return Promise.resolve(null);}if(n.type==="Default"){return this._templateCustomColumnFragment(n,P.view,M);}if(!m){return Promise.resolve(null);}k=D.getCustomData(t,"metaPath",M);G=D.getCustomData(t,"requestGroupId",M)||undefined;o=m.createBindingContext(k);return this._getCachedOrFetchPropertiesForEntity(t,k,m).then(function(x){r=x.find(function(I){return I.name===p;});q=m.createBindingContext(r.metadataPath);v=j._getVHRelevantFields(m,r.metadataPath,k);u={sBindingPath:k,sValueHelpType:"TableValueHelp",oControl:t,oMetaModel:m,oModifier:M,oPropertyInfo:r};l=Promise.all(v.map(function(A){var B=Object.assign({},u,{sPropertyName:A});return Promise.all([D.isValueHelpRequired(B),D.doesValueHelpExist(B)]).then(function(H){var V=H[0],I=H[1];if(V&&!I){return y("sap.fe.macros.table.ValueHelp");}return Promise.resolve();});}));function y(A){var B=new J({id:s,requestGroupId:G}),H={bindingContexts:{"this":B.createBindingContext("/"),"dataField":q},models:{"this":B,"dataField":m,metaModel:m}};return D.templateControlFragment(A,H,{},M).then(function(V){if(V){M.insertAggregation(t,"dependents",V,0);}}).catch(function(I){L.error("ValueHelp not loaded : "+I.message);return Promise.resolve(null);}).finally(function(){B.destroy();});}function z(r,V){var A=g(r)?"sap.fe.macros.table.Column":"sap.fe.macros.table.ColumnProperty",B=D.getCustomData(t,"displayModePropertyBinding",M);B=typeof B==="boolean"?B:B==="true";var H=new J({displayMode:B,tableType:D.getCustomData(t,"tableType",M),onChange:D.getCustomData(t,"onChange",M),id:s,navigationPropertyPath:p,columnInfo:n,collection:{sPath:k,oModel:m},creationMode:D.getCustomData(t,"creationMode",M)}),I={bindingContexts:{"entitySet":o,"collection":o,"dataField":q,"this":H.createBindingContext("/"),"column":H.createBindingContext("/columnInfo")},models:{"this":H,"entitySet":m,"collection":m,"dataField":m,metaModel:m,"column":H}};return D.templateControlFragment(A,I,{view:V},M).finally(function(){H.destroy();});}return l.then(z.bind(this,r,P.view));});},getFilterDelegate:function(){return Object.assign({},d,{addItem:function(p,P){if(p.indexOf("Property::")===0){p=p.replace("Property::","");}return d.addItem(p,P);}});},getTypeUtil:function(p){return c;}};return j;},false);
