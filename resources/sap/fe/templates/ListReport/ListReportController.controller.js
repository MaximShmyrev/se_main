/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/FEController","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/core/controllerextensions/PageReady","sap/fe/macros/field/FieldRuntime","sap/fe/core/actions/messageHandling","sap/base/Log","sap/base/util/ObjectPath","sap/fe/navigation/SelectionVariant","sap/fe/core/CommonUtils","sap/ui/mdc/p13n/StateUtil","sap/fe/macros/table/Utils","sap/fe/macros/ResourceModel","sap/fe/core/controllerextensions/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/base/util/merge","sap/fe/templates/ListReport/ExtensionAPI","sap/fe/macros/filter/FilterUtils","sap/fe/macros/chart/ChartUtils","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/EditState","sap/ui/model/json/JSONModel","sap/fe/core/library","sap/fe/core/helpers/SemanticDateOperators","sap/fe/core/controllerextensions/Routing"],function(F,S,E,P,a,m,L,O,b,C,c,T,R,I,D,d,e,f,g,h,j,l,n,o,p,V,q,r,s,J,t,u,v){"use strict";var w=t.TemplateContentView,x=t.InitialLoadMode;return F.extend("sap.fe.templates.ListReport.ListReportController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":false,"final":false,overrideExecution:p.After}}},_routing:I.override({onAfterBinding:function(i,k){this.getView().getController()._onAfterBinding(i,k);}}),pageReady:P,_intentBasedNavigation:f.override({getEntitySet:function(){return this.base.getCurrentEntitySet();}}),sideEffects:S,routing:v,intentBasedNavigation:d.override(e),editFlow:E.override(r),viewState:V.override(q),getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new l(this);}return this.extensionAPI;},messageHandling:m,onInit:function(){F.prototype.onInit.apply(this);var i=this;var k=this._getTables();var y=this.getView().getBindingContext("internal");k.forEach(function(A){if(i._isMultiMode()){var U=function(){i._updateCounts();};T.addEventToBindingInfo(A,"dataRequested",U);}});y.setProperty("hasPendingFilters",true);y.setProperty("appliedFilters","");if(this._isAlp()){var z=w.Hybrid;if(!D.system.desktop){z=w.Chart;}y.setProperty("alpContentView",z);}this.filterBarConditions={};this.getAppComponent().getRouterProxy().waitForRouteMatchBeforeNavigation();this._updateMultiTableHiddenStatus();n.attachConditionHandling(this._getFilterBarControl());},onExit:function(){n.detachConditionHandling(this._getFilterBarControl());delete this._sEntitySet;delete this.filterBarConditions;delete this._oListReportControl;delete this._bMultiMode;},_onAfterBinding:function(B,i){var k=this._getTables();var y=this;if(s.isEditStateDirty()){var z=this._getTableBinding();if(z){z.refresh();k.forEach(function(G){T.clearSelection(G);});}s.setEditStateProcessed();}var A=[];k.forEach(function(G){A=C.getIBNActions(G,A);T.getSemanticTargetsFromTable(y,G);});C.updateDataFieldForIBNButtonsVisibility(A,this.getView());this.getAppComponent().getAppStateHandler().applyAppState();},onAfterRendering:function(i){var k=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(y){k.oResourceBundle=y;}).catch(function(y){L.error("Error while retrieving the resource bundle",y);});},onPageReady:function(i){var k=i.lastFocusedControl;var y=this.getView();if(k&&k.controlId&&k.focusInfo){var z=y.byId(k.controlId);if(z){z.applyFocusInfo(k.focusInfo);}}},getCurrentEntitySet:function(){if(!this._sEntitySet){var i=this._getCurrentTable();this._sEntitySet=i.data("targetCollectionName").slice(1);}return this._sEntitySet;},_scrollTablesToRow:function(k){var y,z,A,B;if(this._getTables&&this._getTables().length>0){y=this._getTables();for(var i=0;i<y.length;i++){z=y[i];B=z.getRowBinding();if(B){var G;switch(z.data().tableType){case"GridTable":G=B.getContexts(0);break;case"ResponsiveTable":G=B.getCurrentContexts();break;default:}A=G.find(function(K){return K&&K.getPath().indexOf(k)!==-1;});}if(A){var H=A.iIndex;z.scrollToIndex(H);}}}},_getPageTitleInformation:function(){var i=this;return new Promise(function(k,y){var z={title:"",subtitle:"",intent:"",icon:""};z.title=i.getView().getContent()[0].data().ListReportTitle;z.subtitle=i.getView().getContent()[0].data().ListReportSubtitle;k(z);});},_getFilterBarControl:function(){return this.getView().byId(this._getFilterBarControlId());},_getSegmentedButton:function(i){return this.getView().byId(this._getSegmentedButtonId(i));},_getSegmentedButtonId:function(i){if(i==="Chart"){return this.getChartControl().data("segmentedButtonId");}else{return this._getCurrentTable().data("segmentedButtonId");}},_getFilterBarControlId:function(){return this.getView().getContent()[0].data("filterBarId");},_getChartControlId:function(){return this.getView().getContent()[0].data("singleChartId");},getChartControl:function(){return this.getView().byId(this._getChartControlId());},_getMultiModeControl:function(){return this.getView().byId("fe::TabMultipleMode");},_getTableControlId:function(){return this.getView().getContent()[0].data("singleTableId");},_getCurrentTable:function(){if(!this._oListReportControl){var M=this._getMultiModeControl();if(M){this._oListReportControl=this.getView().byId(M.getSelectedKey()||M.getItems()[0].getKey());}else{this._oListReportControl=this.getView().byId(this._getTableControlId());}}return this._oListReportControl;},_getTableBinding:function(i){var k=i?this.getView().byId(i):this._getCurrentTable(),B=k&&k._getRowBinding();return B;},_getTables:function(){var i=this;if(this._isMultiMode()){var k=[];var y=this._getMultiModeControl();y.getItems().forEach(function(z){var A=i.getView().byId(z.getKey());if(A){k.push(A);}});return k;}return[this._getCurrentTable()];},_getMergedContext:function(i,k){var y,A;y=C.addExternalStateFiltersToSelectionVariant(new b(),k);if(i&&i.length){var M=this.getView().getModel().getMetaModel();A=i.map(function(z){return{contextData:z.getObject(),entitySet:M.getMetaPath(z.getPath()).replace(/^\/*/,"")};});A=C.removeSensitiveData(A,M);}return{selectionVariant:y,attributes:A};},_isMultiMode:function(){if(!this._oListReportControl){this._bMultiMode=!!this._getMultiModeControl();}return this._bMultiMode;},_isMultiEntitySets:function(){return(this.getView().getContent()[0].data("isMultiEntitySets")==="true");},_isAlp:function(){return(this.getView().getContent()[0].data("isAlp")==="true");},_setShareModel:function(){var G=O.get("sap.ushell.Container.getUser");var i={bookmarkTitle:document.title,bookmarkCustomUrl:function(){var H=window.hasher.getHash();return H?"#"+H:window.location.href;},isShareInJamActive:!!G&&G().isJamActive()};var k=this.getOwnerComponent().getModel("_templPriv");k.setProperty("/listReport/share",i);},_updateMultiTableHiddenStatus:function(){var i=this._getCurrentTable();if(this._isMultiMode()&&i){var k=i.getId();var y=this._getTables();y.forEach(function(z){var A=z.getId();z.data("tableHidden",A!==k);});}},_updateMultiNotApplicableFields:function(i,k){var y={ignoredFields:{}},z=this._getTables();z.forEach(function(A){var B=A.data("targetCollectionName"),G=B.slice(1);if(!y.ignoredFields[G]){y.ignoredFields[G]=n.getNotApplicableFiltersForEntity(k,B);}});i.setProperty("tabs",y);},_updateTableControl:function(){this._sEntitySet=undefined;this._oListReportControl=undefined;this._getCurrentTable();},_updateCounts:function(){this._updateMutliModeCounts();},_updateMutliModeCounts:function(){var i=this;var B=[];var M=this._getMultiModeControl();if(M&&M.data("showCounts")==="true"){var y=this._getCurrentTable();var z=y.getId();var A=[];var G=M.getItems();G.forEach(function(k){var H=i.getView().byId(k.getKey());if(H&&(k.data("outdatedCounts")||H.getId()===z)){A.push({table:H,item:k});}});B=A.map(function(k){k.item.setCount("...");var H=k.table;var K=T.getFiltersInfoforSV(H,k.item.data("selectionVariant"));return T.getListBindingForCount(H,i.getView().getBindingContext(),{batchGroupId:H.getId()===z?H.data("batchGroupId"):"$auto",additionalFilters:K.filters});});Promise.all(B).then(function(H){for(var k in H){var K=A[k].item;K.setCount(T.getCountFormatted(H[k]));K.data("outdatedCounts",false);}}).catch(function(k){L.error("Error while retrieving the values for the icon tab bar",k);});}},_shouldAutoTriggerSearch:function(i){if(this.getView().getViewData().initialLoad===x.Auto&&(!i||i.getStandardVariantKey()===i.getCurrentVariantKey())){var k=this._getFilterBarControl(),y=k.getConditions();for(var K in y){if(!K.startsWith("$")&&Array.isArray(y[K])&&y[K].length){return true;}}}return false;},_updateTable:function(i){if(!i.isTableBound()||this.hasPendingChartChanges){i.rebindTable();this.hasPendingChartChanges=false;}},_updateChart:function(i){if(!i.isInnerChartBound()||this.hasPendingTableChanges){i.getControlDelegate().rebindChart(i,i.getBindingInfo("data"));this.hasPendingTableChanges=false;}},handlers:{handleErrorOfTable:function(i){if(i.getParameter("error")){setTimeout(m.showUnboundMessages,0);}},onShareListReportActionButtonPress:function(i,k,U){var y=k.getView().byId("fe::Share");var z=k.getView().byId(k.getView().getContent()[0].data("filterBarId"));var A=z.getFilterConditions();var B=U&&u.hasSemanticDateOperations(A);if(y&&(y.getVisible()||(y.getEnabled&&y.getEnabled()))){h.onShareActionButtonPressImpl(y,k,null,B);}},onTabMultiModeChange:function(i){this._updateTableControl();this._updateMultiTableHiddenStatus();var k=this._getFilterBarControl();var y=this.getView().getBindingContext("internal");var z=this._getCurrentTable();if(k&&y.getProperty("hasPendingFilters")!==true&&(!z.getRowBinding()||z.data("outdatedRows")===true)){z.rebindTable();z.data("outdatedRows",false);}this.getExtensionAPI().updateAppState();},onFiltersChanged:function(i){var k=i.getSource(),y=this.getView().getBindingContext("internal");y.setProperty("appliedFilters",k.getAssignedFiltersText().filtersText);y.setProperty("hasPendingFilters",true);if(i.getParameter("conditionsBased")){this.getExtensionAPI().updateAppState();}},onVariantSelected:function(i){var k=this,y=i.getSource();setTimeout(function(){if(k._shouldAutoTriggerSearch(y)){return k._getFilterBarControl().triggerSearch();}else{k.getExtensionAPI().updateAppState();}},0);},onVariantSaved:function(i){var k=this;setTimeout(function(){k.getExtensionAPI().updateAppState();},500);},onSearch:function(i){var k=this;var y=this._getCurrentTable().getId();var z=i.getSource();var A=this.getView().getBindingContext("internal");var M=this.getChartControl();A.setProperty("hasPendingFilters",false);if(this._isMultiEntitySets()){this._updateMultiNotApplicableFields(A,z);}if(this._isMultiMode()){var B=this._getTables();var G=this._getMultiModeControl();if(G&&G.data("showCounts")==="true"){var H=G.getItems();H.forEach(function(Q){Q.data("outdatedCounts",true);});}B.forEach(function(Q){Q.data("outdatedRows",Q.getId()!==y);});}if(M){M.getBindingContext("internal").setProperty("",{});var K=M.getBindingContext("pageInternal");var N=K.getProperty(K.getPath()+"/alpContentView");if(N===w.Chart){this.hasPendingChartChanges=true;}if(N===w.Table){this.hasPendingTableChanges=true;}}c.retrieveExternalState(z).then(function(Q){k.filterBarConditions=Q.filter;}).catch(function(Q){L.error("Error while retrieving the external state",Q);});if(this.getView().getViewData().liveMode===false){this.getExtensionAPI().updateAppState();}},onChevronPressNavigateOutBound:function(i,k,y){var z=i.getAppComponent().getRoutingService().getOutbounds(),A=z[k];if(A&&A.semanticObject&&A.action){y=y&&y.isA&&y.isA("sap.ui.model.odata.v4.Context")?[y]:y;i._intentBasedNavigation.navigate(A.semanticObject,A.action,{navigationContexts:y});return Promise.resolve();}else{throw new Error("outbound target "+k+" not found in cross navigation definition of manifest");}},onChartSelectionChanged:function(i){var M=i.getSource(),k=this._getCurrentTable(),y=i.getParameter("dataContext"),z=this.getView().getBindingContext("internal");if(y&&y.data){g.fnUpdateChart(i);o.setChartFilters(M);}var A=z.getProperty(z.getPath()+"/alpContentView");if(A===w.Chart){this.hasPendingChartChanges=true;}else{k&&k.rebindTable();this.hasPendingChartChanges=false;}},onSegmentedButtonPressed:function(i){var k=i.mParameters.key?i.mParameters.key:null;var y=this.getView().getBindingContext("internal");y.setProperty("alpContentView",k);var z=this.getChartControl();var A=this._getCurrentTable();switch(k){case w.Table:this._updateTable(A);break;case w.Chart:this._updateChart(z);break;case w.Hybrid:this._updateTable(A);this._updateChart(z);break;default:break;}this.getExtensionAPI().updateAppState();}},formatters:{setTabMessageStrip:function(i,k){var y="";if(Array.isArray(i)&&i.length>0&&k){var z=this._getFilterBarControl(),A=z.data("entitySet"),M=this.getView().getModel().getMetaModel(),B=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates"),G=i.map(function(K){return M.getObject(A+"/"+K+"@com.sap.vocabularies.Common.v1.Label");});if(B){var H="C_LR_MULTIENTITYSET_"+(G.length===1?"SINGLE":"MULTI")+"_IGNORED_FILTER_"+(D.system.desktop?"LARGE":"SMALL");y=B.getText(H,[G.join(", "),k]);}}return y;}}});});
