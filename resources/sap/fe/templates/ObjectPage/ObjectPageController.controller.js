/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/fe/core/FEController","sap/ui/model/json/JSONModel","sap/fe/core/controllerextensions/InternalRouting","./overrides/Routing","./overrides/InternalRouting","sap/ui/Device","sap/fe/core/controllerextensions/SideEffects","sap/fe/core/controllerextensions/EditFlow","sap/fe/core/controllerextensions/PageReady","sap/fe/core/controllerextensions/InternalIntentBasedNavigation","sap/fe/core/controllerextensions/IntentBasedNavigation","./overrides/IntentBasedNavigation","sap/fe/macros/field/FieldRuntime","sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/navigation/SelectionVariant","sap/fe/macros/table/Utils","sap/m/MessageBox","sap/fe/core/BusyLocker","sap/fe/core/actions/messageHandling","sap/fe/macros/ResourceModel","sap/m/Link","sap/fe/macros/chart/ChartRuntime","sap/fe/templates/controls/Share/ShareUtils","sap/fe/templates/ObjectPage/ExtensionAPI","sap/fe/core/helpers/PasteHelper","sap/fe/core/library","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ViewState","./overrides/ViewState","sap/fe/templates/RootContainer/overrides/EditFlow","sap/fe/core/helpers/ModelHelper","sap/fe/core/controllerextensions/Routing"],function(F,J,I,R,a,D,S,E,P,b,c,d,e,L,m,C,f,T,M,B,g,h,j,k,l,n,o,p,O,V,q,r,s,t){"use strict";var u;return F.extend("sap.fe.templates.ObjectPage.ObjectPageController",{metadata:{methods:{getExtensionAPI:{"public":true,"final":true},onPageReady:{"public":true,"final":false,overrideExecution:O.After}}},sideEffects:S,editFlow:E.override(r),_routing:I.override(a),intentBasedNavigation:c.override(d),_intentBasedNavigation:b,routing:t.override(R),viewState:V.override(q),pageReady:P.override({isContextExpected:function(){return true;}}),getExtensionAPI:function(){if(!this.extensionAPI){this.extensionAPI=new n(this);}return this.extensionAPI;},onInit:function(){F.prototype.onInit.apply(this);var i=this.byId("fe::ObjectPage");var v=this.getView().getBindingContext("internal");v.setProperty("externalNavigationContext",{"page":true});v.setProperty("relatedApps",{visibility:false,items:null});v.setProperty("batchGroups",this._getBatchGroupsForView());if(i.getEnableLazyLoading()){i.attachEvent("subSectionEnteredViewPort",this._handleSubSectionEnteredViewPort.bind(this));}},_getTableBinding:function(i){return i&&i.getRowBinding();},onAfterRendering:function(i){var v=this;this.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(w){v.oResourceBundle=w;}).catch(function(w){L.error("Error while retrieving the resource bundle",w);});},_onBeforeBinding:function(v,w){var x=this,y=this._findTables(),z,A=this.byId("fe::ObjectPage"),G=w.listBinding,H=x.getView().getBindingContext("internal"),K=H.getProperty("batchGroups");K.push("$auto");if(A.getBindingContext()&&A.getBindingContext().hasPendingChanges()&&!K.some(A.getBindingContext().getModel().hasPendingChanges.bind(A.getBindingContext().getModel()))){A.getBindingContext().getBinding().resetChanges();}for(var i=0;i<y.length;i++){z=y[i].getCreationRow();if(z){z.setBindingContext(null);}}var N=function(c1){if(!w.bPersistOPScroll){A.setSelectedSection(null);}};A.attachEventOnce("modelContextChange",N);var Q={onBeforeRendering:N};A.addEventDelegate(Q,x);this.pageReady.attachEventOnce("pageReady",function(c1){A.removeEventDelegate(Q);});if(G&&G.isA("sap.ui.model.odata.v4.ODataListBinding")){var U=x.byId("fe::Paginator");if(U){U.setListBinding(G);}}if(A.getEnableLazyLoading()){var W=A.getSections(),X=A.getUseIconTabBar(),Y=2;for(var Z=0;Z<W.length;Z++){var $=W[Z];var _=$.getSubSections();for(var a1=0;a1<_.length;a1++,Y--){if(Y<1||(X&&Z>0)){var b1=_[a1];b1.setBindingContext(null);}}}}},_handleSubSectionEnteredViewPort:function(i){var v=i.getParameter("subSection");v.setBindingContext(undefined);},_onAfterBinding:function(i,v){var w=this.byId("fe::ObjectPage"),x=this,y=this._findTables();i=w.getBindingContext();var z=[];w.getSections().forEach(function(X){X.getSubSections().forEach(function(Y){z=C.getIBNActions(Y,z);});});y.forEach(function(X){var Y=X.getBindingContext("internal");Y.setProperty("creationRowFieldValidity",{});z=C.getIBNActions(X,z);var Z=X.getRowBinding();if(Z){if(s.isStickySessionSupported(Z.getModel().getMetaModel())){Z.removeCachesAndMessages("");}}T.getSemanticTargetsFromTable(x,X);});C.getSemanticTargetsFromPageModel(x,"_pageModel");var A=w.getHeaderTitle();var G=[];G=C.getIBNActions(A,G);z=z.concat(G);C.updateDataFieldForIBNButtonsVisibility(z,this.getView());var H,K;function N(X,Y){var Z=X.getCreationRow(),$,_;if(Z){K.then(function(){if(Z.getVisible()){$=H.bindList(Y.getPath(),Y.getContext(),[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});$.refreshInternal=function(){};_=$.create();Z.setBindingContext(_);_.created().catch(function(){L.trace("transient fast creation context deleted");});}}).catch(function(a1){L.error("Error while computing the final UI state",a1);});}}function Q(X){var W=x._getTableBinding(X),Y=function(){N(X,W);};if(!W){L.error("Expected binding missing for table: "+X.getId());return;}if(W.oContext){Y();}else{var Z=function(){if(W.oContext){Y();W.detachChange(Z);}};W.attachChange(Z);}}if(i){H=i.getModel();K=this.editFlow.computeEditMode(i);if(i.getBinding().oCache){x._updateRelatedApps();}else{var U=function(){x._updateRelatedApps();i.getBinding().detachDataReceived(U);};i.getBinding().attachDataReceived(U);}var W=(i.getBinding&&i.getBinding())||i;W.attachEvent("patchSent",this.handlers.handlePatchSent,this);W.attachEvent("patchCompleted",this.handlers.handlePatchCompleted,this);y.forEach(function(X){T.whenBound(X).then(Q).catch(function(Y){L.error("Error while waiting for the table to be bound",Y);});});w._triggerVisibleSubSectionsEvents();this.getAppComponent().getAppStateHandler().applyAppState();}},onPageReady:function(i){this._clearTableSelection();var v=i.lastFocusedControl;if(v&&v.controlId&&v.focusInfo){var w=this.getView();var x=w.byId(v.controlId);if(x){x.applyFocusInfo(v.focusInfo);return;}}var y=this.byId("fe::ObjectPage");var z=y.getModel("ui").getProperty("/editMode")==="Display";var A;if(z){var G=y.getHeaderTitle()&&y.getHeaderTitle().getActions();if(G&&G.length){A=G.find(function(K){return K.mProperties["visible"];});if(A){A.focus();}}}else{var H=y._getFirstEditableInput();if(H){H.focus();}}this._checkDataPointTitleForExternalNavigation();},_getPageTitleInformation:function(){var i=this.byId("fe::ObjectPage");var v=i.getCustomData().find(function(x){return x.getKey()==="ObjectPageSubtitle";});var w={title:i.data("ObjectPageTitle")||"",subtitle:v&&v.getValue(),intent:"",icon:""};return Promise.resolve(w);},_executeHeaderShortcut:function(i){var v=this.getView().getId()+"--"+i,w=this.byId("fe::ObjectPage").getHeaderTitle().getActions().find(function(x){return x.getId()===v;});C.fireButtonPress(w);},_executeFooterShortcut:function(i){var v=this.getView().getId()+"--"+i,w=this.byId("fe::ObjectPage").getFooter().getContent().find(function(x){return x.getMetadata().getName()==="sap.m.Button"&&x.getId()===v;});C.fireButtonPress(w);},_executeTabShortCut:function(i){var v=this.byId("fe::ObjectPage"),w=v.indexOfSection(this.byId(v.getSelectedSection())),x=v.getSections(),y=x.length-1,z=i.oSource.getCommand(),A;if(w!==-1&&y>0){if(z==="NextTab"){if(w<=y-1){A=x[++w];}}else{if(w!==0){A=x[--w];}}if(A){v.setSelectedSection(A);A.focus();}}},_getFooterVisibility:function(i){var v=this.getView().getBindingContext("internal");var w=this.getView().getId();u=i.getParameter("iMessageLength");u>0&&!v.getProperty("bIsCreateDialogOpen")?v.setProperty("showMessageFooter",true):v.setProperty("showMessageFooter",false);v.setProperty("messageFooterContainsErrors",false);sap.ui.getCore().getMessageManager().getMessageModel().getData().forEach(function(x){if(x.validation&&x.type==="Error"&&x.target.indexOf(w)>-1){v.setProperty("messageFooterContainsErrors",true);}});},_showMessagePopover:function(i){var v=i.oMessagePopover,w=v.getBinding("items");if(w.getLength()>0){setTimeout(function(){v.openBy(i);},0);}},_editDocument:function(i){var v=this;var w=this.getView().getModel("ui");B.lock(w);return this.editFlow.editDocument.apply(this.editFlow,[i,this.getView().getViewData().prepareOnEdit]).finally(function(){v._clearTableSelection();B.unlock(w);});},_saveDocument:function(i){var v=this,w=this.getView().getModel("ui"),W=[];var x=false;B.lock(w);this._findTables().forEach(function(y){var z=v._getTableBinding(y);var A={creationMode:y.data("creationMode"),creationRow:y.getCreationRow(),createAtEnd:y.data("createAtEnd")==="true"};var G=A.creationRow&&A.creationRow.getBindingContext()&&Object.keys(A.creationRow.getBindingContext().getObject()).length>1;if(G){A.bSkipSideEffects=true;x=true;W.push(v.editFlow.createDocument(z,A).then(function(){return z;}));}});return Promise.all(W).then(function(y){return v.editFlow.saveDocument(i,x,y).then(function(){var z=v.getView().byId("fe::FooterBar::MessageButton");var A={onAfterRendering:function(G){v._showMessagePopover(z);z.removeEventDelegate(v._oDelegateOnAfter);delete v._oDelegateOnAfter;}};v._oDelegateOnAfter=A;z.addEventDelegate(A,v);}).catch(function(z){var A=v.getView().byId("fe::FooterBar::MessageButton");if(A){v._showMessagePopover(A);}}).finally(function(){B.unlock(w);});});},_cancelDocument:function(i,v){var w=this;v.cancelButton=this.getView().byId(v.cancelButton);return this.editFlow.cancelDocument(i,v).finally(function(){w._clearTableSelection();});},_applyDocument:function(i){var v=this;return this.editFlow.applyDocument(i).catch(function(w){L.error(w);var x=v.getView().byId("fe::FooterBar::MessageButton");if(x){v._showMessagePopover(x);}});},_updateRelatedApps:function(){var i=this.byId("fe::ObjectPage");if(C.resolveStringtoBoolean(i.data("showRelatedApps"))){C.updateRelatedAppsDetails(i);}},_findTableInSubSection:function(i,v,w){var x=[];for(var y=0;y<i.length;y++){var z=i[y].getContent instanceof Function&&i[y].getContent();if(z&&z.isA&&z.isA("sap.ui.mdc.Table")){w.push(z);x.push({"table":z,"gridTable":z.getType().isA("sap.ui.mdc.table.GridTableType")});}}if(x.length===1&&i.length===1&&x[0].gridTable&&!v.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){v.addStyleClass("sapUxAPObjectPageSubSectionFitContainer");}else{if(x&&!v.hasStyleClass("sapUxAPObjectPageSubSectionFitContainer")){x.forEach(function(A){if(A.gridTable){A.table.getType().setRowCount(null);}});}}},_findTables:function(){var i=this.byId("fe::ObjectPage"),v=[];var w=i.getSections();for(var x=0;x<w.length;x++){var y=w[x].getSubSections();for(var z=0;z<y.length;z++){this._findTableInSubSection(y[z].getBlocks(),y[z],v);this._findTableInSubSection(y[z].getMoreBlocks(),y[z],v);}}return v;},_getChartContextData:function(i,v){var w=i.getObject(),x=[w];if(i&&v){if(w[v]){x=w[v];delete w[v];x.push(w);}}return x;},_getTableRow:function(i,v){if(i.filter(function(x){return x!==undefined;}).length>0){var w=i.find(function(x){return x.getPath().indexOf(v)!==-1;});return w;}else{return undefined;}},_scrollTableToRow:function(i,v){var w=i.getRowBinding();var x=this;var y=new Promise(function(z,A){if(w){var G;switch(i.data().tableType){case"GridTable":G=w.getContexts(0);break;case"ResponsiveTable":G=w.getCurrentContexts();break;default:}if(G.filter(function(H){return H===undefined;}).length>0||G.length===0){w.attachChange(function K(H){var G=x._getTableRow(H.getSource().getCurrentContexts(),v);if(G){w.detachChange(K);z(G);}});}else{z(x._getTableRow(G,v));}}else{A();}});y.then(function(z){if(z){var A=z.iIndex;i.scrollToIndex(A);}}).catch(function(){L.warning("Could not find any matched row");});},_scrollTablesToRow:function(v){if(this._findTables&&this._findTables().length>0){var w=this._findTables();for(var i=0;i<w.length;i++){this._scrollTableToRow(w[i],v);}}},_mergeMultipleContexts:function(i,v,w){var x=this;var A=[],y=[],z,G,H,K,N,Q,U;U=i.getPath();z=i&&i.getModel()&&i.getModel().getMetaModel();K=z&&z.getMetaPath(U).replace(/^\/*/,"");if(v&&v.length){G=v[0];N=G.getPath();H=z&&z.getMetaPath(N).replace(/^\/*/,"");v.map(function(W){if(w){var X=x._getChartContextData(W,w);if(X){A=X.map(function(X){return{contextData:X,entitySet:K+"/"+w};});}}else{A.push({contextData:W.getObject(),entitySet:H});}});}y.push({contextData:i.getObject(),entitySet:K});y=C.removeSensitiveData(y,z);Q=C.addPageContextToSelectionVariant(new f(),y,x.getView());A=C.removeSensitiveData(A,z);return{selectionVariant:Q,attributes:A};},_getBatchGroupsForView:function(){var i=this,v=i.getView().getViewData(),w=v.controlConfiguration,x=w&&Object.keys(w),y=["$auto.Heroes","$auto.Decoration","$auto.Workers"];if(x&&x.length>0){x.forEach(function(K){var z=w[K];if(z.requestGroupId==="LongRunners"){y.push("$auto.LongRunners");}});}return y;},_setBreadcrumbLinks:function(v){var w=v.getBindingContext();var A=this.getAppComponent();if(w){var N=w.getPath(),x=N.split("/"),y="";x.shift();x.splice(-1,1);x.forEach(function(z,i){y+="/"+z;var G=A.getRootViewController();var H=G.getTitleHierarchyCache();var K;if(!H[y]){K=G.addNewEntryInCacheTitle(y,A);}else{K=Promise.resolve(H[y]);}K.then(function(Q){var U=v.getLinks()[i]?v.getLinks()[i]:new j();U.setText(Q.subtitle||Q.title);U.setHref(Q.intent);if(!v.getLinks()[i]){v.addLink(U);}}).catch(function(Q){L.error("Error while computing the title hierarchy",Q);});});}},_checkDataPointTitleForExternalNavigation:function(){var v=this.getView();var i=v.getBindingContext("internal");var w=C.getHeaderFacetItemConfigForExternalNavigation(v.getViewData(),this.getAppComponent().getRoutingService().getOutbounds());var x=this.getAppComponent().getShellServices();var y=v&&v.getBindingContext();i.setProperty("isHeaderDPLinkVisible",{});if(y){y.requestObject().then(function(H){G(w,H);}).catch(function(H){L.error("Cannot retrieve the links from the shell service",H);});}function z(H){L.error(H);}function A(H){var K=this.id;if(H&&H.length===1&&H[0].supported){i.setProperty("isHeaderDPLinkVisible/"+K,true);}}function G(w,H){for(var K in w){var N=w[K];var Q={};var U=v.byId(K);if(!U){continue;}var W=U.getBindingContext();var X=W&&W.getObject();var Y=m({},H,X);if(N.semanticObjectMapping){var Z=N.semanticObjectMapping;for(var $ in Z){var _=Z[$];var a1=_["LocalProperty"]["$PropertyPath"];var b1=_["SemanticObjectProperty"];if(a1!==b1){if(Y.hasOwnProperty(a1)){var c1={};c1[b1]=Y[a1];Y=m({},Y,c1);delete Y[a1];}}}}if(Y){for(var d1 in Y){if(d1.indexOf("_")!==0&&d1.indexOf("odata.context")===-1){Q[d1]=Y[d1];}}}x.isNavigationSupported([{target:{semanticObject:N.semanticObject,action:N.action},params:Q}]).then(A.bind({id:K})).catch(z);}}},_clearTableSelection:function(){var i=this._findTables();i.forEach(function(v){T.clearSelection(v);});},_onPasteInTable:function(i,v){if(this.getView().getModel("ui").getProperty("/editMode")!=="Editable"){return;}var w=i.getParameter("data"),x=i.getSource(),y=x.data()["pasteEnabled"],z=this,A;if(y===true||y==="true"){o.parseDataForTablePaste(w,x).then(function(G){if(G&&G.length>0){return z.editFlow.createMultipleDocuments(x.getRowBinding(),G,v);}}).catch(function(G){L.error("Error while pasting data",G);});}else{A=sap.ui.getCore().getLibraryResourceBundle("sap.fe.core");M.error(A.getText("T_OP_CONTROLLER_SAPFE_PASTE_DISABLED_MESSAGE"),{title:A.getText("C_COMMON_SAPFE_ERROR")});}},_onPasteTableButtonPressed:function(i){var v=sap.ui.getCore().getLibraryResourceBundle("sap.fe.templates"),w=D.os.name,x=D.browser,y=D.system,z;if(x.mobile){z=v.getText("T_OP_CONTROLLER_TABLE_PASTE_BUTTON_ACTION_MESSAGE_TOUCH_DEVICE");}else if(y.desktop){switch(w){case"win":z=v.getText("T_OP_CONTROLLER_TABLE_PASTE_BUTTON_ACTION_MESSAGE_WINDOWS_DESKTOP");break;case"mac":z=v.getText("T_OP_CONTROLLER_TABLE_PASTE_BUTTON_ACTION_MESSAGE_IOS_DESKTOP");break;}}M.information(z,{onClose:function(A){if(i){i.getAggregation("_content").applyFocusInfo({preventScroll:true});}}});},handlers:{onTableContextChange:function(v){var w=this;var x=v.getSource();var y;this._findTables().some(function(_){if(_.getRowBinding()===x){y=_;return true;}return false;});var z=this.editFlow.getCurrentActionPromise();if(z){var A;if(y.getType().getMetadata().isA("sap.ui.mdc.table.GridTableType")){A=x.getContexts(0);}else{A=x.getCurrentContexts();}if(!A[0]){return;}z.then(function(G){if(!G||G.controlId!==y.sId){return;}var H=G.oData;var K=G.keys;var N=-1;A.find(function(Q,i){var U=Q.getObject();var W=K.every(function(X){return U[X]===H[X];});if(W){N=i;}return W;});if(N!==-1){y.scrollToIndex(N);w.editFlow.deleteCurrentActionPromise();}}).catch(function(i){L.error("An error occurs while scrolling to the newly created Item: "+i);});}},onShareObjectPageActionButtonPress:function(i,v){var w=v.getView().byId("fe::Share");v._getPageTitleInformation().then(function(x){if(w&&(w.getVisible()||(w.getEnabled&&w.getEnabled()))){l.onShareActionButtonPressImpl(w,v,x);}}).catch(function(x){L.error("Error while retrieving the page title information",x);});},onCallActionFromFooter:function(v,A,i){var w=v.getController();var x=w;return w.editFlow.invokeAction(A,i).then(function(){var y=x.getView().byId("fe::FooterBar::MessageButton");if(y.isActive()){x._showMessagePopover(y);}else if(u){x._oDelegateOnAfter={onAfterRendering:function(z){x._showMessagePopover(y);y.removeEventDelegate(x._oDelegateOnAfter);delete x._oDelegateOnAfter;}};y.addEventDelegate(x._oDelegateOnAfter,x);}}).catch(function(y){var z=x.getView().byId("fe::FooterBar::MessageButton");if(z){x._showMessagePopover(z);}});},onDataPointTitlePressed:function(i,v,w,x,y){w=typeof w==="string"?JSON.parse(w):w;var z=w[x],A=C.getSemanticObjectMapping(z),G=v.getBindingContext(),H=G.getModel().getMetaModel().getMetaPath(G.getPath()),N=i._getChartContextData(G,y);N=N.map(function(K){return{data:K,metaPath:H+(y?"/"+y:"")};});if(z&&z.semanticObject&&z.action){i._intentBasedNavigation.navigate(z.semanticObject,z.action,{navigationContexts:N,semanticObjectMapping:A});}},onChevronPressNavigateOutBound:function(i,v,w){var x=i.getAppComponent().getRoutingService().getOutbounds(),y=x[v];if(y&&y.semanticObject&&y.action){w=w&&w.isA&&w.isA("sap.ui.model.odata.v4.Context")?[w]:w;i._intentBasedNavigation.navigate(y.semanticObject,y.action,{navigationContexts:w});return Promise.resolve();}else{throw new Error("outbound target "+v+" not found in cross navigation definition of manifest");}},onNavigateChange:function(i){this.getExtensionAPI().updateAppState();this.bSectionNavigated=true;},onVariantSelected:function(i){this.getExtensionAPI().updateAppState();},onVariantSaved:function(i){var v=this;setTimeout(function(){v.getExtensionAPI().updateAppState();},500);},navigateToSubSection:function(i,v){var w=typeof v==="string"?JSON.parse(v):v,x=i.getView().byId("fe::ObjectPage"),y,z;if(w.sectionId){y=i.getView().byId(w.sectionId);z=w.subSectionId?i.getView().byId(w.subSectionId):y&&y.getSubSections()&&y.getSubSections()[0];}else if(w.subSectionId){z=i.getView().byId(w.subSectionId);y=z&&z.getParent();}if(!y||!z||!y.getVisible()||!z.getVisible()){i.getView().getModel("sap.fe.i18n").getResourceBundle().then(function(A){var G=C.getTranslatedText("C_ROUTING_NAVIGATION_DISABLED_TITLE",A,null,i.getView().getViewData().entitySet);L.error(G);M.error(G);}).catch(function(A){L.error(A);});}else{x.scrollToSection(z.getId());x.fireNavigate({section:y,subSection:z});}},onChartSelectionChanged:function(i){k.fnUpdateChart(i);},handlePatchSent:function(i){var v=this;var w=new Promise(function(x,y){v.resolvePatchPromise=x;v.rejectPatchPromise=y;});this.editFlow.updateDocument(w,i.getSource());},handlePatchCompleted:function(i){var v=i.getParameter("success");if(v){this.resolvePatchPromise();}else{this.rejectPatchPromise();}},handleErrorOfTable:function(i){if(i.getParameter("error")){setTimeout(g.showUnboundMessages,0);}}}});});
