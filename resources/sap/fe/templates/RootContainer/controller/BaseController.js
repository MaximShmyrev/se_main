sap.ui.define(["sap/ui/model/json/JSONModel","sap/fe/core/FEController","sap/ui/core/Component","sap/ui/core/routing/HashChanger","sap/fe/core/CommonUtils","sap/fe/macros/SizeHelper","sap/ui/model/odata/v4/AnnotationHelper","sap/ui/base/BindingParser","sap/base/Log","sap/fe/core/controllerextensions/Placeholder"],function(J,F,C,H,a,S,A,B,L,P){"use strict";return F.extend("sap.fe.templates.RootContainer.controller.BaseController",{oPlaceholder:P,onInit:function(){S.init();this._aHelperModels=[];},attachRouteMatchers:function(){this.oPlaceholder.attachRouteMatchers();this.getAppComponent().getRoutingService().attachAfterRouteMatched(this.shellTitleHandler,this);},onExit:function(){this.getAppComponent().getRoutingService().detachAfterRouteMatched(this.shellTitleHandler,this);this.oRouter=null;S.exit();this._aHelperModels.forEach(function(m){m.destroy();});},getModel:function(n){return this.getView().getModel(n);},setModel:function(m,n){return this.getView().setModel(m,n);},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getRouter:function(){if(!this.oRouter){this.oRouter=this.getAppComponent().getRouter();}return this.oRouter;},_createHelperModel:function(){var m=new J();this._aHelperModels.push(m);return m;},waitForRightMostViewReady:function(e){return new Promise(function(r){var c=e.getParameter("views"),f=[];c.forEach(function(o){var v=o;if(o&&o.getComponentInstance){var b=o.getComponentInstance();v=b.getRootControl();}if(v&&v.getController()&&v.getController().pageReady){f.push(v);}});var R=f[f.length-1];if(R&&R.getController().pageReady.isPageReady()){r(R);}else{R&&R.getController().pageReady.attachEventOnce("pageReady",function(){r(R);});}});},shellTitleHandler:function(e){var t=this;if(!t.oShellTitlePromise){t.oShellTitlePromise=t.waitForRightMostViewReady(e).then(function(v){var o=t.getAppComponent();var d={oView:v,oAppComponent:o};t._scrollTablesToLastNavigatedItems();if(o.getEnvironmentCapabilities().getCapabilities().UShell){t.computeTitleHierarchy(d);}var l=o.getRouterProxy().getFocusControlForCurrentHash();if(v.getController()&&v.getController().onPageReady){if(l){v.getParent().onPageReady({lastFocusedControl:l});}else{var c=sap.ui.getCore().getCurrentFocusedControlId();var b={controlId:c,focusInfo:{id:c}};v.getParent().onPageReady({lastFocusedControl:b});}}t.oShellTitlePromise=null;}).catch(function(E){L.error("An error occurs while computing the title hierarchy and calling focus method",E);t.oShellTitlePromise=null;});}},getTitleHierarchyCache:function(){if(!this.oTitleHierarchyCache){this.oTitleHierarchyCache={};}return this.oTitleHierarchyCache;},_computeTitleInfo:function(t,s,i){var p=i.split("/");if(p[p.length-1].indexOf("?")===-1){i+="?restoreHistory=true";}else{i+="&restoreHistory=true";}return{title:t,subtitle:s,intent:i,icon:""};},addNewEntryInCacheTitle:function(p,o){var t=this.getView().getModel();var b=this;var e=p.replace(/ *\([^)]*\) */g,"");var T=A.format(o.getMetaModel().getProperty(e+"/@com.sap.vocabularies.UI.v1.HeaderInfo/Title/Value"),{context:o.getMetaModel().createBindingContext("/")});var c=B.complexParser(T);var s=o.getMetaModel().getProperty(e+"/@com.sap.vocabularies.UI.v1.HeaderInfo/TypeName");var d=t.createBindingContext(p);if(c){var f=c.parts?c.parts[0].path:c.path;var g=c.formatter;var h=t.bindProperty(f,d);h.initialize();}return new Promise(function(r,i){var j=H.getInstance().hrefForAppSpecificHash("");var I=j+p.slice(1);var k=b.getTitleHierarchyCache();var l=function(E){var m=g?g(E.getSource().getValue()):E.getSource().getValue();k[p]=b._computeTitleInfo(s,m,I);r(k[p]);h.detachChange(l);};if(h){h.attachChange(l);}else{k[p]=b._computeTitleInfo(s,"",I);r(k[p]);}});},ensureHierarchyElementsAreStrings:function(h){var b=[];for(var l in h){var o=h[l];var s={};for(var k in o){s[k]=typeof o[k]!=="string"?String(o[k]):o[k];}b.push(s);}return b;},computeTitleHierarchy:function(d){var t=this,v=d.oView,o=d.oAppComponent,c=v.getBindingContext(),b=v.getParent(),T=[],s=H.getInstance().hrefForAppSpecificHash(""),e=o.getMetadata().getManifestEntry("sap.app").title||"",f=o.getMetadata().getManifestEntry("sap.app").appSubTitle||"",g=s,p,n;if(this.bIsComputingTitleHierachy===true){L.warning("computeTitleHierarchy already running ... this call is canceled");return;}this.bIsComputingTitleHierachy=true;if(b&&b._getPageTitleInformation){if(c){n=c.getPath();var h=n.split("/"),l,m="",N=h.length;h.splice(-1,1);h.forEach(function(q,i){if(i===0){var r=o.getManifestEntry("/sap.ui5/routing/routes"),u=o.getManifestEntry("/sap.ui5/routing/targets");var w=function(x){if(typeof r[this.index].target==="string"){return x===r[this.index].target;}else if(typeof r[this.index].target==="object"){for(var k=0;k<r[this.index].target.length;k++){return x===r[this.index].target[k];}}};for(var j=0;j<r.length;j++){var R=o.getRouter().getRoute(r[j].name);if(R.match(h[i])){var x=Object.keys(u).find(w,{index:j});l=o.getRouter().getTarget(x)._oOptions.name;break;}}if(l==="sap.fe.templates.ListReport"){T.push(Promise.resolve(t._computeTitleInfo(e,f,g)));}}else if(i<N){m+="/"+q;if(!t.getTitleHierarchyCache()[m]){T.push(t.addNewEntryInCacheTitle(m,o));}else{T.push(Promise.resolve(t.getTitleHierarchyCache()[m]));}}});}p=b._getPageTitleInformation().then(function(i){var j=H.getInstance().getHash();var k=j.split("/");if(k[k.length-1].indexOf("?")===-1){j+="?restoreHistory=true";}else{j+="&restoreHistory=true";}i.intent=s+j;if(c){t.getTitleHierarchyCache()[n]=i;}else{t.getTitleHierarchyCache()[g]=i;}return i;});T.push(p);}else{T.push(Promise.reject("Title information missing in HeaderInfo"));}Promise.all(T).then(function(i){var j=t.ensureHierarchyElementsAreStrings(i);var k=j[i.length-1].title;o.getShellServices().setHierarchy(j.reverse());o.getShellServices().setTitle(k);}).catch(function(E){L.error(E);}).finally(function(){t.bIsComputingTitleHierachy=false;}).catch(function(E){L.error(E);});},calculateLayout:function(n,p,s){return null;},onContextBoundToView:function(c){if(c){var d=this.getView().getModel("internal").getProperty("/deepestPath"),v=c.getPath();if(!d||d.indexOf(v)!==0){this.getView().getModel("internal").setProperty("/deepestPath",v);}}},displayMessagePage:function(e,p){},updateUIStateForView:function(v,b){}});});
