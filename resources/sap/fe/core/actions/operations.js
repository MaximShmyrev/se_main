/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
        (c) Copyright 2009-2020 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/MessageBox","sap/m/Dialog","sap/ui/model/json/JSONModel","sap/ui/core/XMLTemplateProcessor","sap/ui/core/util/XMLPreprocessor","sap/ui/core/Fragment","sap/fe/core/actions/messageHandling","sap/fe/core/BusyLocker","sap/fe/core/helpers/SideEffectsUtil","sap/fe/core/helpers/StableIdHelper","sap/fe/core/CommonUtils","sap/base/Log","sap/fe/core/library","sap/ui/core/ValueState"],function(M,D,J,X,a,F,m,B,S,b,C,L,c,V){"use strict";var d=c.Constants;function e(A,i,j,P){if(!i||i.length===0){return Promise.reject("Bound actions always requires at least one context");}P=P||{};if(Array.isArray(i)){P.bReturnAsArray=true;}else{i=[i];}var q=j.getMetaModel(),r=q.getMetaPath(i[0].getPath())+"/"+A,t=q.createBindingContext(r+"/@$ui5.overload/0");var t=q.createBindingContext(r+"/@$ui5.overload/0");P.aContexts=i;P.isCriticalAction=l(q,r,i,t);return g(A,j,t,P);}function f(A,i,P){if(!i){return Promise.reject("Action expects a model/context for execution");}var j=i.getMetaModel(),q=i.bindContext("/"+A).getPath(),r=j.createBindingContext("/"+j.createBindingContext(q).getObject("$Action")+"/0");P.isCriticalAction=l(j,q+"/@$ui5.overload");return g(A,i,r,P);}function g(A,i,j,P){return new Promise(function(r,q){P=P||{};var t=P.actionParameters||[],u={},v,w,x=P.label,y=P.showActionParameterDialog,z=P.aContexts,I=P.bIsCreateAction,E=P.isCriticalAction,G,H,K,N;if(!j||!j.getObject()){return q(new Error("Action"+A+" not found"));}if(y||t.length>0){t=p(j,t);if(!t||t.length===0){y=false;}}if(y){v=s;}else if(E){v=h;}u={fnOnSubmitted:P.onSubmitted,fnOnResponse:P.onResponse,actionName:A,model:i,aActionParameters:t,ownerComponent:P.ownerComponent,bGetBoundContext:P.bGetBoundContext};if(j.getObject("$IsBound")){if(P.additionalSideEffect&&P.additionalSideEffect.pathExpressions){G=i.getMetaModel();H=G.getMetaPath(z[0].getPath());K=G.getObject(H+"/@com.sap.vocabularies.Common.v1.Messages/$Path");if(K){N=P.additionalSideEffect.pathExpressions.findIndex(function(O){return O.$PropertyPath===K;});if(N>-1){P.mBindingParameters=P.mBindingParameters||{};if(j.getObject("$ReturnType/$Type/"+K)&&(!P.mBindingParameters.$select||P.mBindingParameters.$select.split(",").indexOf(K)===-1)){P.mBindingParameters.$select=P.mBindingParameters.$select?P.mBindingParameters.$select+","+K:K;if(P.additionalSideEffect.triggerActions.length===0){P.additionalSideEffect.pathExpressions.splice(N,1);}}}}}u.aContexts=z;u.mBindingParameters=P.mBindingParameters;u.additionalSideEffect=P.additionalSideEffect;u.bGrouped=P.invocationGrouping==="ChangeSet";u.bReturnAsArray=P.bReturnAsArray;u.internalModelContext=P.internalModelContext;u.operationAvailableMap=P.operationAvailableMap;}if(I){u.bIsCreateAction=I;}if(v){w=v(A,x,u,t,j,P.parentControl,P.entitySetName);}else{w=_(u);}return w.then(function(O){r(O);}).catch(function(O){q(O);});});}function h(A,i,P,j,q,r,t){return new Promise(function(u,v){var w=A?A:null;w=w.indexOf(".")>=0?w.split(".")[w.split(".").length-1]:w;var x=w&&t?t+"|"+w:"";var R=r.getController().oResourceBundle;var y=C.getTranslatedText("C_OPERATIONS_ACTION_CONFIRM_MESSAGE",R,null,x);M.confirm(y,{onClose:function(z){if(z===M.Action.OK){return _(P).then(function(O){u(O);}).catch(function(E){m.showUnboundMessages().then(function(){v(E);}).catch(function(){v(E);});});}else{u();}}});});}function s(A,j,P,q,r,t,u){var v=n(r,A),w=r.getModel().oModel.getMetaModel(),x=w.createBindingContext(v),y=r.getObject("$IsBound")?r.getPath().split("/@$ui5.overload/0")[0]:r.getPath().split("/0")[0],z=w.createBindingContext(y),E="sap/fe/core/controls/ActionParameterDialog";return new Promise(function(G,H){var I=X.loadTemplate(E,"fragment"),K=new J({$displayMode:{}}),N=[],O={},Q={handleChange:function(i){m.removeBoundTransitionMessages();var R=i.getSource();var T=i.getParameter("id");var U=i.getParameter("promise");if(U){O[T]=U.then(function(){return R.getValue();});}}};return Promise.resolve(a.process(I,{name:E},{bindingContexts:{action:r,actionName:z,entitySet:x},models:{action:r.getModel(),actionName:z.getModel(),entitySet:x.getModel(),metaModel:x.getModel()}})).then(function(I){return C.setUserDefaults(P.ownerComponent,q,K,true).then(function(){return F.load({definition:I,controller:Q}).then(function(R){var T;var U=t.getController().oResourceBundle;var W=new D({title:j||C.getTranslatedText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_TITLE",U),content:[R],escapeHandler:function(i){W.close();m.removeUnboundTransitionMessages();H();},beginButton:{text:j||C.getTranslatedText("C_COMMON_DIALOG_OK",U),type:"Emphasized",press:function($){var a1=sap.ui.getCore().getMessageManager().getMessageModel().getData();N=[];q.forEach(function(i){var b1=i.$Name;a1.forEach(function(c1){var d1=b1.replace("-inner","");if(c1.controlIds.length>0&&(c1.getControlId().includes("APD_::"+b1)||(c1.getControlId().includes("APD_::"+b1+"inner")&&N.indexOf("APD_::"+d1)<0))){N.push("APD_::"+d1);}});});if(N.length>0){return;}B.lock(W);return Promise.all(Object.keys(O).map(function(i){return O[i];})).then(function(){m.removeUnboundTransitionMessages();var b1,c1=T&&T.getParameterContext();for(var i in P.aActionParameters){b1=c1.getProperty(P.aActionParameters[i].$Name);P.aActionParameters[i].value=b1;b1=undefined;}return _(P).then(function(d1){W.close();G(d1);}).catch(function(d1){throw d1;});}).catch(function(){return m.showUnboundMessages();}).finally(function(){B.unlock(W);});}},endButton:{text:C.getTranslatedText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL",U),press:function(){W.close();m.removeUnboundTransitionMessages();H(d.CancelActionDialog);}},beforeOpen:function(){m.removeUnboundTransitionMessages();m.removeBoundTransitionMessages();var $=function(b1){var c1=function(f1,h1){return new Promise(function(G,H){if(h1){if(Z.length>0&&h1.$Path){T.getParameterContext().requestProperty(h1.$Path).then(function(i1){if(Z.length>1){var j1=h1.$Path;if(j1.indexOf(b1+"/")===0){j1=j1.replace(b1+"/","");}for(var i=1;i<Z.length;i++){if(Z[i].getProperty(j1)!==i1){G({});}}}G({value:i1});}).catch(function(){L.error("Error while reading default action parameter",f1,P.actionName);G({value:undefined,bLatePropertyError:true});});}else{G({value:h1});}}else{if(K&&K.oData[f1]){G({value:K.oData[f1]});}else{G({value:undefined});}}});};var d1=function(f1){var h1=W.getModel().getMetaModel(),Y=r.sPath&&r.sPath.split("/@")[0],i1=Y+"/"+f1+"@",j1=h1.getObject(i1),k1=j1&&j1["@com.sap.vocabularies.UI.v1.ParameterDefaultValue"];return k1;};var e1=[];var f1,g1;for(var i in P.aActionParameters){f1=P.aActionParameters[i].$Name;g1=d1(f1);e1.push(c1(f1,g1));}Promise.all(e1).then(function(h1){for(var i=0;i<h1.length;i++){if(h1[i]&&h1[i].value){T.setParameter(q[i].$Name,h1[i].value);}}var i1=h1.some(function(k1){return k1.bLatePropertyError;});if(i1){var j1=U.getText("C_APP_COMPONENT_SAPFE_ETAG_LATE_PROPERTY");M.warning(j1,{contentWidth:"25em"});}}).catch();};if(r.getObject("$IsBound")&&Z.length>0){var a1=r.getObject("$Parameter"),b1=a1[0]&&a1[0].$Name;Z[0].requestObject().then(function(i){if(i){T.setParameter(b1,i);}$(b1);}).catch(function(i){L.error("Error while retrieving the parameter",i);});}else{$();}},afterClose:function(){W.destroy();}});W.setModel(r.getModel().oModel);W.setModel(K,"paramsModel");W.bindElement({path:"/",model:"paramsModel"});var Y=A+"(...)";var Z=P.aContexts||[];if(!Z.length){Y="/"+Y;}W.bindElement({path:Y});if(t){t.addDependent(W);}if(Z.length>0){W.setBindingContext(Z[0]);}T=W.getObjectBinding();W.open();});});}).catch(H);});}function p(A,P){var i=k(A);P=P||[];if(P.length>0){}return i;}function k(A){var P=A.getObject("$Parameter")||[];if(P&&P.length){if(A.getObject("$IsBound")){return P.slice(1,P.length)||[];}}return P;}function l(i,P,j,q){var A=i.getObject(P+"@com.sap.vocabularies.Common.v1.IsActionCritical"),r=A&&A.$Path;if(!r){return!!A;}var t=q&&q.getObject("$Parameter"),u=r&&r.split("/"),v=t&&t.length&&typeof t==="object"&&r&&j&&j.length;if(v){t.filter(function(w){var x=u&&u.indexOf(w.$Name);if(x>-1){u.splice(x,1);}});r=u.join("/");return j[0].getObject(r);}else if(r){return j[0].getObject(r);}}function _(P){var q=P.aContexts||[],r=P.model,E=m.getMessages().length||0,A=P.aActionParameters||[],t=P.actionName,O=P.fnOnSubmitted,u=P.fnOnResponse,I=P.bIsCreateAction,v=false,w;function x(i){return i.then(function(j){var G=m.getMessages();if(G.length>E&&G[G.length-1].type==="Error"){return{response:j,status:"rejected"};}return{response:j,status:"resolved"};},function(j){return{response:j,status:"rejected"};});}function y(){if(A&&A.length){v=true;for(var j=0;j<A.length;j++){if(!A[j].value){switch(A[j].$Type){case"Edm.String":A[j].value="";break;case"Edm.Boolean":A[j].value=false;break;case"Edm.Byte":case"Edm.Int16":case"Edm.Int32":case"Edm.Int64":A[j].value=0;break;default:break;}}w.setParameter(A[j].$Name,A[j].value);}}}if(q.length){return new Promise(function(j,G){var H=P.mBindingParameters,K=P.bGrouped,R=P.bReturnAsArray,N=P.bGetBoundContext,Q=[],z,i,T,U=function(w,W,Y){y();T=!K?"actionGroup":w.getUpdateGroupId();z=N?w.execute(T).then(function(){return w.getBoundContext();}):w.execute(T);Q.push(z);if(!K){r.submitBatch(T);}if(Y&&Y.triggerActions&&Y.triggerActions.length){Y.triggerActions.forEach(function(Z){if(Z){var $=Y.context.getModel().bindContext(Z+"(...)",Y.context);$.execute(T);}});}if(Y&&Y.pathExpressions&&Y.pathExpressions.length>0){S.logRequest(Y);Y.context.requestSideEffects(Y.pathExpressions,T).then(function(){if(P.operationAvailableMap&&P.internalModelContext){C.setActionEnablement(P.internalModelContext,JSON.parse(P.operationAvailableMap),P.aContexts);}}).catch(function(Z){L.error("Error while requesting side effects",Z);});}};for(i=0;i<q.length;i++){w=r.bindContext(t+"(...)",q[i],H);U(w,q.length<=1?null:i,{context:q[i],pathExpressions:P.additionalSideEffect&&P.additionalSideEffect.pathExpressions,triggerActions:P.additionalSideEffect&&P.additionalSideEffect.triggerActions});}(O||jQuery.noop)(Q);Promise.all(Q.map(x)).then(function(W){var Y=[],Z=[],$;for($=0;$<W.length;$++){if(W[$].status==="rejected"){Y.push(W[$].response);}if(W[$].status==="resolved"){if(I&&v){W[$].bConsiderDocumentModified=true;Z.push(W[$]);}else{Z.push(W[$].response);}}}if(!W||(W&&W.length===0)){G(true);}if(Y.length===0){if(R){j(Z);}else{j(Z[0]);}}else{G({resolvedItems:Z,rejectedItems:Y});}}).catch(G);}).finally(function(){(u||jQuery.noop)();});}else{var z;w=r.bindContext("/"+t+"(...)");y();z=w.execute("actionImport");r.submitBatch("actionImport");(O||jQuery.noop)(z);return z.finally(function(){(u||jQuery.noop)();});}}function n(A,i){var P=A.getPath();P=A.getObject("$IsBound")?P.split("@$ui5.overload")[0]:P.split("/0")[0];return P.split("/"+i)[0];}var o={callBoundAction:e,callActionImport:f};return o;});
