sap.ui.define(["sap/ui/core/service/Service","sap/ui/core/service/ServiceFactory","sap/ui/core/service/ServiceFactoryRegistry","sap/ui/model/base/ManagedObjectModel","sap/ui/model/resource/ResourceModel","sap/ui/core/mvc/View","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/base/Log","sap/fe/core/TemplateModel","sap/fe/core/helpers/DynamicAnnotationPathHelper","sap/ui/core/cache/CacheManager","sap/base/strings/hash","sap/ui/VersionInfo"],function(S,a,b,M,R,V,C,J,L,T,D,c,h,d){"use strict";var e=S.extend("sap.fe.core.services.TemplatedViewService",{initPromise:null,init:function(){var t=this;var s=[];var o=this.getContext();var f=o.scopeObject;var A=C.getOwnerComponentFor(f);var m=A.getMetaModel();var g=A.getMetadata().getComponentName()+"::"+A.getLocalId(f.getId());var E=f.getEnhanceI18n()||[];var j;if(E){j=A.getMetadata().getComponentName();for(var i=0;i<E.length;i++){var r=A.getModel(E[i]);if(r&&r.isA("sap.ui.model.resource.ResourceModel")){E[i]=r;}else{E[i]=j+"."+E[i].replace(".properties","");}}}var k=A.getMetadata().getName()+"_"+g+"_"+sap.ui.getCore().getConfiguration().getLanguageTag();s.push(b.get("sap.fe.core.services.ResourceModelService").createInstance({scopeType:"component",scopeObject:f,settings:{bundles:["sap.fe.core.messagebundle","sap.fe.templates.messagebundle"],enhanceI18n:E,modelName:"sap.fe.i18n"}}).then(function(l){return l.getResourceModel();}));s.push(b.get("sap.fe.core.services.CacheHandlerService").createInstance({settings:{metaModel:m}}).then(function(l){return l.validateCacheKey(k);}));s.push(d.load().then(function(I){var l="";if(!I.libraries){l=sap.ui.buildinfo.buildtime;}else{I.libraries.forEach(function(n){l+=n.buildTimestamp;});}return l;}).catch(function(){return"<NOVALUE>";}));var p="";this.initPromise=Promise.all(s).then(function(l){var n=l[1];var v=l[2];var q=A.getManifest();var u=A.getShellServices();var w=h(JSON.stringify({sapApp:q["sap.app"],viewData:f.getViewData()}));p=n+"-"+w+"-"+v+"-"+g+"-"+u.instanceType+"-pageModel";return Promise.all(l.concat([t._getCachedModel(p)]));}).then(function(l){var r=l[0];var n=l[1];var P=l[3];return new Promise(function(q){sap.ui.require(["sap/fe/core/converters/TemplateConverter"],function(u){q(t.createView(r,g,n,p,P,u));});});}).then(function(l){var n=b.get("sap.fe.core.services.CacheHandlerService").getInstance(m);n.invalidateIfNeeded(l,k);});},_getCachedModel:function(s){if(sap.ui.getCore().getConfiguration().getViewCache()){return c.get(s);}return undefined;},_setCachedModel:function(s,o){if(sap.ui.getCore().getConfiguration().getViewCache()){c.set(s,o);}return undefined;},createView:function(r,s,f,p,P,g){var t=this;var o=this.getContext(),m=o.settings,i=m.converterType,j=o.scopeObject,A=C.getOwnerComponentFor(j),F=A.getRoutingService().getTargetInformationFor(j).options.settings.fullContextPath,k=A.getMetaModel(),l=A.getManifest(),n=new J(sap.ui.Device).setDefaultBindingMode("OneWay"),q=new J(l),E=false,u,v,w,x;this.oFactory=o.factory;function y(){var B=F.split("/");var G=B.reduce(function(H,N){if(N===""){return H;}if(H===""){H="/"+N;}else{var I=k.getObject(H+"/$NavigationPropertyBinding/"+N);if(I&&Object.keys(I).length>0){H+="/$NavigationPropertyBinding";}H+="/"+N;}return H;},"");var w={type:"XML",preprocessors:{xml:{bindingContexts:{entitySet:G?k.createBindingContext(G):null,fullContextPath:F?k.createBindingContext(F):null,converterContext:u.createBindingContext("/",null,{noResolve:true}),viewData:x?v.createBindingContext("/"):null},models:{entitySet:k,fullContextPath:k,"sap.fe.i18n":r,metaModel:k,"sap.fe.deviceModel":n,manifest:q,converterContext:u,viewData:v},appComponent:A}},id:s,viewName:m.viewName||j.getViewName(),viewData:x,cache:{keys:[f]},models:{"sap.fe.i18n":r},height:"100%"};return w;}function z(B){L.error(B.message,B);w.viewName=m.errorViewName||"sap.fe.core.services.view.TemplatingErrorPage";w.preprocessors.xml.models["error"]=new J(B);return j.runAsOwner(function(){return V.create(w).then(function(G){t.oView=G;t.oView.setModel(new M(t.oView),"$view");j.setAggregation("rootControl",t.oView);return f;});});}return A.getService("routingService").then(function(B){var G=B.getTargetInformationFor(j);var O=l["sap.app"]&&l["sap.app"].crossNavigation&&l["sap.app"].crossNavigation.outbounds;var N=j.getNavigation()||{};Object.keys(N).forEach(function(I){var K=N[I];var Q;if(K.detail&&K.detail.outbound&&O[K.detail.outbound]){Q=O[K.detail.outbound];K.detail.outboundDetail={semanticObject:Q.semanticObject,action:Q.action,parameters:Q.parameters};}if(K.create&&K.create.outbound&&O[K.create.outbound]){Q=O[K.create.outbound];K.create.outboundDetail={semanticObject:Q.semanticObject,action:Q.action,parameters:Q.parameters};}});x={navigation:N,viewLevel:G.viewLevel,stableId:s,contentDensities:l["sap.ui5"].contentDensities,resourceBundle:r.__bundle,fullContextPath:F};if(j.getViewData){Object.assign(x,j.getViewData());}x.converterType=i;v=new J(x);if(x&&x.controlConfiguration){Object.keys(x.controlConfiguration).forEach(function(I){if(I.indexOf("[")!==-1){var K=D.resolveDynamicExpression(I,k);x.controlConfiguration[K]=x.controlConfiguration[I];}});}var H=A.getShellServices();u=new T(function(){try{if(!!P){return P;}else{var I=A.getDiagnostics();var K=I.getIssues().length;var Q=g.convertPage(i,k,x,H,I,F,A.getEnvironmentCapabilities().getCapabilities());var U=I.getIssues();var W=U.slice(K);if(W.length>0){L.warning("Some issues have been detected in your project, please check the UI5 support assistant rule for sap.fe.core");}t._setCachedModel(p,Q);return Q;}}catch(X){L.error(X,X);return{};}},k);if(!E){w=y();j.setModel(u,"_pageModel");return j.runAsOwner(function(){return V.create(w).catch(z).then(function(I){t.oView=I;t.oView.setModel(new M(t.oView),"$view");j.setAggregation("rootControl",t.oView);return f;}).catch(L.error);});}}).catch(function(B){L.error(B.message,B);throw new Error("Error while creating view : "+B);});},getView:function(){return this.oView;},exit:function(){this.oFactory.removeGlobalInstance();}});return a.extend("sap.fe.core.services.TemplatedViewServiceFactory",{_oInstanceRegistry:{},createInstance:function(s){var t=new e(Object.assign({factory:this},s));return t.initPromise.then(function(){return t;});},removeGlobalInstance:function(){this._oInstanceRegistry={};}});},true);
