sap.ui.define(["../ManifestSettings","./BaseConverter","../controls/Common/DataVisualization","../helpers/ID","sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/BindingExpression","sap/fe/core/converters/controls/Common/Filter","sap/fe/core/converters/helpers/IssueManager"],function(M,B,D,I,T,A,C,K,a,F,b){"use strict";var _={};var c=b.IssueCategory;var d=b.IssueSeverity;var e=b.IssueType;var g=F.getFilterConditions;var f=a.compileBinding;var h=a.annotationExpression;var j=K.KeyHelper;var P=C.Placement;var k=C.insertCustomElements;var l=A.getActionsFromManifest;var m=T.getSelectionVariantConfiguration;var n=I.TableID;var o=I.FilterVariantManagementID;var p=I.FilterBarID;var q=D.isSelectionPresentationCompliant;var r=D.getSelectionVariant;var s=D.isPresentationCompliant;var t=D.getSelectionPresentationVariant;var u=D.getDefaultPresentationVariant;var v=D.getDefaultLineItem;var w=D.getDefaultChart;var x=D.getDataVisualizationConfiguration;var y=B.TemplateType;var V=M.VisualizationType;var z=M.AvailabilityType;function E(i,c1){var d1=Object.keys(i);if(Object.getOwnPropertySymbols){var e1=Object.getOwnPropertySymbols(i);if(c1)e1=e1.filter(function(f1){return Object.getOwnPropertyDescriptor(i,f1).enumerable;});d1.push.apply(d1,e1);}return d1;}function G(c1){for(var i=1;i<arguments.length;i++){var d1=arguments[i]!=null?arguments[i]:{};if(i%2){E(Object(d1),true).forEach(function(e1){H(c1,e1,d1[e1]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(c1,Object.getOwnPropertyDescriptors(d1));}else{E(Object(d1)).forEach(function(e1){Object.defineProperty(c1,e1,Object.getOwnPropertyDescriptor(d1,e1));});}}return c1;}function H(i,c1,d1){if(c1 in i){Object.defineProperty(i,c1,{value:d1,enumerable:true,configurable:true,writable:true});}else{i[c1]=d1;}return i;}var J=function(i,c1){var d1=c1.split("/");var e1;var f1="";while(d1.length){var g1=d1.shift();e1=e1?e1+"/"+g1:g1;var h1=i.resolvePath(e1);if(h1._type==="NavigationProperty"&&h1.isCollection){g1+="*";}f1=f1?f1+"/"+g1:g1;}return f1;};var L=function(i,c1,d1,e1,f1){var g1,h1;if(c1!==undefined&&c1.targetType===undefined&&(e1||((g1=c1.annotations)===null||g1===void 0?void 0:(h1=g1.UI)===null||h1===void 0?void 0:h1.Hidden)!==true)){var i1,j1,k1,l1,m1;var n1=f1.getAnnotationEntityType(c1);return{key:j.getSelectionFieldKeyFromPath(d1),annotationPath:"/"+i.name+"/"+d1,conditionPath:J(i.entityType,d1),availability:((i1=c1.annotations)===null||i1===void 0?void 0:(j1=i1.UI)===null||j1===void 0?void 0:j1.HiddenFilter)===true?z.Hidden:z.Adaptation,label:f(h(((k1=c1.annotations.Common)===null||k1===void 0?void 0:k1.Label)||c1.name)),group:n1.name,groupLabel:f(h((n1===null||n1===void 0?void 0:(l1=n1.annotations)===null||l1===void 0?void 0:(m1=l1.Common)===null||m1===void 0?void 0:m1.Label)||n1.name))};}return undefined;};var N=function(i,c1,d1,e1,f1){var g1={};if(d1){d1.forEach(function(h1){var i1=h1.name;var j1=(c1?c1+"/":"")+i1;var k1=L(i,h1,j1,e1,f1);if(k1){g1[j1]=k1;}});}return g1;};var O=function(i,c1,d1,e1){var f1={};if(c1){c1.forEach(function(g1){var h1;var i1=i.entityType.resolvePath(g1);if(i1===undefined){return;}if(i1._type==="NavigationProperty"){h1=N(i,g1,i1.targetType.entityProperties,d1,e1);}else if(i1.targetType!==undefined){h1=N(i,g1,i1.targetType.properties,d1,e1);}else{var j1=g1.includes("/")?g1.split("/").splice(0,1).join("/"):"";h1=N(i,j1,[i1],d1,e1);}f1=G({},f1,{},h1);});}return f1;};function Q(i){var c1={};i.Data.forEach(function(d1){if(d1.$Type==="com.sap.vocabularies.UI.v1.DataField"){var e1,f1;c1[d1.Value.path]={group:i.fullyQualifiedName,groupLabel:f(h(i.Label||((e1=i.annotations)===null||e1===void 0?void 0:(f1=e1.Common)===null||f1===void 0?void 0:f1.Label)||i.qualifier))||i.qualifier};}});return c1;}var R=function(c1,d1,e1){var f1,g1,h1,i1;var j1=d1.reduce(function(r1,o1){o1.propertyNames.forEach(function(s1){r1[s1]=true;});return r1;},{});var k1=(f1=e1.getAnnotationEntityType().annotations.UI)===null||f1===void 0?void 0:f1.FilterFacets;var l1={};var m1=e1.getAnnotationByType("UI","com.sap.vocabularies.UI.v1.FieldGroup")||[];if(k1===undefined||k1.length<0){for(var i in m1){l1=G({},l1,{},Q(m1[i]));}}else{l1=k1.reduce(function(r1,s1){for(var _i=0;_i<s1.Target.$target.Data.length;_i++){r1[s1.Target.$target.Data[_i].Value.path]={group:s1.ID,groupLabel:s1.Label};}return r1;},{});}var n1=[];var o1=r(c1.entityType,e1);if(o1){n1=o1.SelectOptions;}var p1=G({},N(c1,"",c1.entityType.entityProperties,false,e1),{},O(c1,e1.getManifestWrapper().getFilterConfiguration().navigationProperties,false,e1));var q1=S(p1,n1,c1,e1,j1);return(((g1=c1.entityType.annotations)===null||g1===void 0?void 0:(h1=g1.UI)===null||h1===void 0?void 0:(i1=h1.SelectionFields)===null||i1===void 0?void 0:i1.reduce(function(r1,s1){var t1=s1.value;if(!(t1 in j1)){var u1=U(p1,t1,e1,c1);if(u1){u1.group="";u1.groupLabel="";r1.push(u1);}}return r1;},[]))||[]).concat(q1||[]).concat(Object.keys(p1).filter(function(r1){return!(r1 in j1);}).map(function(r1){return Object.assign(p1[r1],l1[r1]);}));};_.getSelectionFields=R;var S=function(i,c1,d1,e1,f1){var g1,h1,i1;var j1=[];var k1={};var l1=d1.entityType.entityProperties;(g1=d1.entityType.annotations)===null||g1===void 0?void 0:(h1=g1.UI)===null||h1===void 0?void 0:(i1=h1.SelectionFields)===null||i1===void 0?void 0:i1.forEach(function(m1){k1[m1.value]=true;});if(c1&&c1.length>0){c1===null||c1===void 0?void 0:c1.forEach(function(m1){var n1,o1,p1;var q1=m1.PropertyName;var r1=q1.value;var k1={};(n1=d1.entityType.annotations)===null||n1===void 0?void 0:(o1=n1.UI)===null||o1===void 0?void 0:(p1=o1.SelectionFields)===null||p1===void 0?void 0:p1.forEach(function(t1){k1[t1.value]=true;});if(!(r1 in f1)){if(!(r1 in k1)){var s1=U(i,r1,e1,d1);if(s1){j1.push(s1);}}}});}else if(l1){l1.forEach(function(m1){var n1,o1;var p1=(n1=m1.annotations)===null||n1===void 0?void 0:(o1=n1.Common)===null||o1===void 0?void 0:o1.FilterDefaultValue;var q1=m1.name;if(!(q1 in f1)){if(p1&&!(q1 in k1)){var r1=U(i,q1,e1,d1);if(r1){j1.push(r1);}}}});}return j1;};var U=function(i,c1,d1,e1){var f1=i[c1];if(f1){delete i[c1];}else{f1=L(e1,e1.entityType.resolvePath(c1),c1,true,d1);}if(!f1){d1.getDiagnostics().addIssue(c.Annotation,d.High,e.MISSING_SELECTIONFIELD);}if(f1){f1.availability=z.Default;}return f1;};var W=function(i,c1){var d1=c1.getManifestWrapper().getFilterConfiguration();var e1=(d1===null||d1===void 0?void 0:d1.filterFields)||{};var f1=O(i,Object.keys(e1).map(function(l1){return e1[l1].property||j.getPathFromSelectionFieldKey(l1);}),true,c1);var g1={};for(var h1 in e1){var i1=e1[h1];var j1=i1.property||j.getPathFromSelectionFieldKey(h1);var k1=f1[j1];g1[h1]={key:h1,annotationPath:k1.annotationPath,conditionPath:k1.conditionPath,template:i1.template,label:i1.label,position:i1.position||{placement:P.After},availability:i1.availability||z.Default,settings:i1.settings};}return g1;};function X(i,c1,d1){var e1=c1.getManifestWrapper().getDefaultTemplateAnnotationPath();var f1=t(i,e1,c1);if(e1&&f1){var g1=f1.PresentationVariant;if(!g1){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest");}var h1=s(f1.PresentationVariant);if(!h1){return undefined;}if(q(f1,d1)){return f1;}}if(f1){if(q(f1,d1)){return f1;}}var i1=u(i);if(i1){if(s(i1,d1)){return i1;}}if(!d1){var j1=v(i);if(j1){return j1;}}return undefined;}var Y=function(i){var c1=i;var d1=c1.converterContext;var e1=x(c1.annotation?d1.getRelativeAnnotationPath(c1.annotation.fullyQualifiedName,d1.getEntityType()):"",true,d1);var f1="";var g1="";var h1="";var i1="";var j1=function(c1){return c1.key!==undefined;};if(j1(c1)){var k1=d1.getEntityTypeAnnotation(c1.annotationPath);var l1=k1.annotation;d1=k1.converterContext;h1=f(h(l1.Text));e1.visualizations.forEach(function(m1,n1){switch(m1.type){case V.Table:var o1=e1.visualizations[n1];var p1=o1.control.filters||{};p1.hiddenFilters=p1.hiddenFilters||{paths:[]};if(!c1.keepPreviousPresonalization){o1.annotation.id=n(c1.key,"LineItem");}if(c1&&c1.annotation&&c1.annotation.term==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){i1=c1.annotation.SelectionVariant.fullyQualifiedName.split("@")[1];}else{i1=c1.annotationPath;}p1.hiddenFilters.paths.push({annotationPath:i1});o1.control.filters=p1;break;case V.Chart:break;default:break;}});}e1.visualizations.forEach(function(m1){if(m1.type===V.Table){f1=m1.annotation.id;}else if(m1.type===V.Chart){g1=m1.id;}});return{presentation:e1,tableControlId:f1,chartControlId:g1,entitySet:"/"+i.entitySet.name,title:h1,selectionVariantPath:i1};};var Z=function(i,c1,d1){var e1=[];if(d1){d1.paths.forEach(function(g1){var h1=c1.findEntitySet(g1.entitySet);var i1=c1.getManifestWrapper().getDefaultTemplateAnnotationPath();var j1;if(h1){var k1=c1.getConverterContextFor(h1);var l1=k1.getEntityTypeAnnotation(g1.annotationPath);var m1=l1.annotation;c1=l1.converterContext;if(m1){if(m1.term==="com.sap.vocabularies.UI.v1.SelectionVariant"){if(i1){j1=t(h1.entityType,i1,c1);}else{j1=v(h1.entityType);}}else{j1=m1;}e1.push({converterContext:k1,entitySet:h1,annotation:j1,annotationPath:g1.annotationPath,keepPreviousPresonalization:g1.keepPreviousPresonalization,key:g1.key});}}else{}});}else{var f1=c1.getEntityType();if(c1.getTemplateType()===y.AnalyticalListPage){e1=$(i,c1,e1);}else{e1.push({annotation:X(f1,c1,false),entitySet:i,converterContext:c1});}}return e1.map(function(g1){return Y(g1);});};function $(i,c1,d1){var e1=X(i.entityType,c1,true);var f1,g1;if(e1){d1.push({entitySet:i,annotation:e1,converterContext:c1});}else{f1=w(i.entityType);g1=v(i.entityType);if(f1){d1.push({entitySet:i,annotation:f1,converterContext:c1});}if(g1){d1.push({entitySet:i,annotation:g1,converterContext:c1});}}return d1;}var a1=function(i){var c1=i.getTemplateType();var d1=i.getEntitySet();if(!d1){throw new Error("An Entityset is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.");}var e1=i.getManifestWrapper();var f1=e1.getViewConfiguration();var g1=e1.hasMultipleEntitySets();var h1=Z(d1,i,f1);var i1=f1?(f1===null||f1===void 0?void 0:f1.showCounts)||g1:undefined;var j1="";var k1="";var l1=false;var m1=[];var n1=[];var o1=p(d1.name);var p1=o(o1);var q1=[o1];var r1=e1.getFilterConfiguration();var s1=r1.useSemanticDateRange!==undefined?r1.useSemanticDateRange:true;h1.forEach(function(y1){y1.presentation.visualizations.forEach(function(z1){if(z1.type===V.Table){var A1=z1.control.filters;for(var B1 in A1){if(Array.isArray(A1[B1].paths)){var C1=A1[B1].paths;C1.forEach(function(D1){if(D1&&D1.annotationPath&&n1.indexOf(D1.annotationPath)===-1){n1.push(D1.annotationPath);var E1=m(D1.annotationPath,i);if(E1){m1.push(E1);}}});}}q1.push(z1.annotation.id);if(z1.control.type==="GridTable"){l1=true;}}});});var t1=b1(c1,h1);if(t1){k1=t1.chartId;j1=t1.tableId;}var u1=R(d1,m1,i);var v1=k(u1,W(d1,i),{"availability":"overwrite",label:"overwrite",position:"overwrite",template:"overwrite",settings:"overwrite"});var w1=JSON.stringify(g(d1.entityType,i));var x1=k([],l(e1.getHeaderActions(),i));return{mainEntitySet:"/"+d1.name,singleTableId:j1,singleChartId:k1,showTabCounts:i1,headerActions:x1,selectionFields:v1,views:h1,filterBarId:o1,filterConditions:w1,variantManagement:{id:p1,targetControlIds:q1.join(",")},fitContent:l1,isMultiEntitySets:g1,isAlp:i.getTemplateType()===y.AnalyticalListPage,useSemanticDateRange:s1};};_.convertPage=a1;function b1(i,c1){var d1="",e1="";if(c1.length===1){d1=c1[0].tableControlId;e1=c1[0].chartControlId;}else if(i===y.AnalyticalListPage&&c1.length===2){c1.map(function(f1){if(f1.chartControlId){e1=f1.chartControlId;}else if(f1.tableControlId){d1=f1.tableControlId;}});}if(d1||e1){return{chartId:e1,tableId:d1};}return undefined;}return _;},false);
