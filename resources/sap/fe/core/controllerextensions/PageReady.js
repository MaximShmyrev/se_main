sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/fe/core/controllerextensions/ControllerExtensionMetadata","sap/ui/core/Component","sap/fe/core/CommonUtils","sap/ui/base/EventProvider","sap/base/Log","../helpers/ClassSupport"],function(C,O,a,b,c,E,L,d){"use strict";var _,f,g,h,j,k,l,m;var P=d.Private;var n=d.Extensible;var F=d.Final;var q=d.Public;var r=d.Override;var U=d.UI5Class;function s(i,e){if(!(i instanceof e)){throw new TypeError("Cannot call a class as a function");}}function t(e,p){for(var i=0;i<p.length;i++){var o=p[i];o.enumerable=o.enumerable||false;o.configurable=true;if("value"in o)o.writable=true;Object.defineProperty(e,o.key,o);}}function u(e,p,i){if(p)t(e.prototype,p);if(i)t(e,i);return e;}function v(e,i){if(typeof i!=="function"&&i!==null){throw new TypeError("Super expression must either be null or a function");}e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,writable:true,configurable:true}});if(i)w(e,i);}function w(o,p){w=Object.setPrototypeOf||function w(o,p){o.__proto__=p;return o;};return w(o,p);}function x(e){return function(){var S=B(e),i;if(A()){var N=B(this).constructor;i=Reflect.construct(S,arguments,N);}else{i=S.apply(this,arguments);}return y(this,i);};}function y(e,i){if(i&&(typeof i==="object"||typeof i==="function")){return i;}return z(e);}function z(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return e;}function A(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Date.prototype.toString.call(Reflect.construct(Date,[],function(){}));return true;}catch(e){return false;}}function B(o){B=Object.setPrototypeOf?Object.getPrototypeOf:function B(o){return o.__proto__||Object.getPrototypeOf(o);};return B(o);}function D(e,p,i,o,H){var I={};Object.keys(o).forEach(function(J){I[J]=o[J];});I.enumerable=!!I.enumerable;I.configurable=!!I.configurable;if('value'in I||I.initializer){I.writable=true;}I=i.slice().reverse().reduce(function(I,J){return J(e,p,I)||I;},I);if(H&&I.initializer!==void 0){I.value=I.initializer?I.initializer.call(H):void 0;I.initializer=undefined;}if(I.initializer===void 0){Object.defineProperty(e,p,I);I=null;}return I;}var G=(_=U("sap.fe.core.controllerextensions.PageReady",a),f=r(),g=r("_routing"),h=r("_routing"),j=r("_routing"),k=n(O.Instead),_(l=(m=function(e){v(G,e);var i=x(G);function G(){s(this,G);return i.apply(this,arguments);}u(G,[{key:"onInit",value:function p(){var o=this;this._oEventProvider=new E();this._oView=this.base.getView();this._oAppComponent=c.getAppComponent(this._oView);this._oPageComponent=b.getOwnerComponentFor(this._oView);if(this._oPageComponent&&this._oPageComponent.attachContainerDefined){this._oPageComponent.attachContainerDefined(function(H){return o.registerContainer(H.getParameter("container"));});}else{this.registerContainer(this._oView);}}},{key:"onRouteMatched",value:function o(){this._bIsPageReady=false;}},{key:"onRouteMatchedFinished",value:function o(){this.checkPageReadyDebounced();}},{key:"onAfterBinding",value:function Q(o){var p=this;if(!this._bAfterBindingAlreadyApplied){this._bAfterBindingAlreadyApplied=true;var H=[];var N=[];var R=0;var I=0;var J=function(V){V.getSource().detachDataRequested(J);R++;p.bDataReceived=false;};var K=function(V){switch(V.getSource().sGroupId){case"$auto.Workers":p._oEventProvider.fireEvent("workersBatchReceived");break;case"$auto.Heroes":p._oEventProvider.fireEvent("heroesBatchReceived");break;default:}V.getSource().detachDataReceived(K);I++;if(I===R&&R!==0){R=0;I=0;p.bDataReceived=true;p.checkPageReadyDebounced();}};var S=function(V){var W=N.filter(function(X){if(V.getSource().sId===X.getFilter()){return true;}return false;});W.forEach(function(X){var Y=X.getRowBinding();var Z=function(){Y.attachDataRequested(J);Y.attachDataReceived(K);H.push(Y);};if(Y){Z();}else{setTimeout(function(){Y=X.getRowBinding();if(Y){Z();}else{L.error("Cannot attach events to unbound table",null);}},0);}});};if(this.isContextExpected()&&o===undefined){this.bHasContext=false;return;}else{this.bHasContext=true;}this.attachEventOnce("pageReady",null,function(){H.forEach(function(V){V.detachEvent("dataRequested",J);V.detachEvent("dataReceived",K);V.detachEvent("search",S);});p._bAfterBindingAlreadyApplied=false;H=[];},null);if(o){var M=o.getBinding();M.attachDataRequested(J);M.attachDataReceived(K);H.push(M);}var T=[];this._oView.findAggregatedObjects(true,function(V){var W=V.getObjectBinding();if(W){W.attachDataRequested(J);W.attachDataReceived(K);H.push(W);}else{var X=Object.keys(V.mBindingInfos);if(X.length>0){X.forEach(function(Y){var Z=V.mBindingInfos[Y].binding;if(Z&&Z.isA("sap.ui.model.odata.v4.ODataListBinding")){Z.attachDataRequested(J);Z.attachDataReceived(K);H.push(Z);}});}}if(V.isA("sap.ui.mdc.Table")){p.bTablesLoaded=false;T.push(V.initialized().then(function(){var Y=V.getRowBinding();if(Y){Y.attachDataRequested(J);Y.attachDataReceived(K);H.push(Y);}else{N.push(V);}}).catch(function(Y){L.error("Cannot find a bound table",Y);}));}else if(V.isA("sap.ui.mdc.FilterBar")){V.attachEvent("search",S);H.push(V);}});if(T.length>0){Promise.all(T).then(function(){p.bTablesLoaded=true;p.checkPageReadyDebounced();}).catch(function(V){L.info("There was an error with one or multiple table",V);p.bTablesLoaded=true;p.checkPageReadyDebounced();});}}}},{key:"isPageReady",value:function o(){return this._bIsPageReady;}},{key:"attachEventOnce",value:function J(o,p,H,I){return this._oEventProvider.attachEventOnce(o,p,H,I);}},{key:"attachEvent",value:function J(o,p,H,I){return this._oEventProvider.attachEvent(o,p,H,I);}},{key:"detachEvent",value:function H(o,p){return this._oEventProvider.detachEvent(o,p);}},{key:"registerContainer",value:function H(o){var p=this;this._oContainer=o;this._oContainer.addEventDelegate({onBeforeShow:function(){p.bShown=false;p._bIsPageReady=false;},onBeforeHide:function(){p.bShown=false;p._bIsPageReady=false;},onAfterShow:function(){p.bShown=true;p._checkPageReady(true);}});}},{key:"isContextExpected",value:function o(){return false;}},{key:"checkPageReadyDebounced",value:function p(){var o=this;if(this.pageReadyTimer){clearTimeout(this.pageReadyTimer);}this.pageReadyTimer=setTimeout(function(){o._checkPageReady();},200);}},{key:"_checkPageReady",value:function J(){var o=this;var p=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var H=function(){if(!sap.ui.getCore().getUIDirty()){sap.ui.getCore().detachEvent("UIUpdated",H);o._bWaitingForRefresh=false;setTimeout(function(){o._checkPageReady();},20);}};var I=function(){if(sap.ui.getCore().getUIDirty()){setTimeout(I,500);}else if(o._bWaitingForRefresh){o._bWaitingForRefresh=false;sap.ui.getCore().detachEvent("UIUpdated",H);o._checkPageReady();}};if(this.bShown&&this.bDataReceived!==false&&this.bTablesLoaded!==false&&(!this.isContextExpected()||this.bHasContext)){if(this.bDataReceived===true&&!p&&!this._bWaitingForRefresh&&sap.ui.getCore().getUIDirty()){this.bDataReceived=undefined;this._bWaitingForRefresh=true;sap.ui.getCore().attachEvent("UIUpdated",H);setTimeout(I,500);}else if(!this._bWaitingForRefresh&&sap.ui.getCore().getUIDirty()){this._bWaitingForRefresh=true;sap.ui.getCore().attachEvent("UIUpdated",H);setTimeout(I,500);}else if(!this._bWaitingForRefresh){this._bIsPageReady=true;this._oEventProvider.fireEvent("pageReady");}}}}]);return G;}(C),(D(m.prototype,"onInit",[f],Object.getOwnPropertyDescriptor(m.prototype,"onInit"),m.prototype),D(m.prototype,"onRouteMatched",[g],Object.getOwnPropertyDescriptor(m.prototype,"onRouteMatched"),m.prototype),D(m.prototype,"onRouteMatchedFinished",[h],Object.getOwnPropertyDescriptor(m.prototype,"onRouteMatchedFinished"),m.prototype),D(m.prototype,"onAfterBinding",[j],Object.getOwnPropertyDescriptor(m.prototype,"onAfterBinding"),m.prototype),D(m.prototype,"isPageReady",[q,F],Object.getOwnPropertyDescriptor(m.prototype,"isPageReady"),m.prototype),D(m.prototype,"attachEventOnce",[q,F],Object.getOwnPropertyDescriptor(m.prototype,"attachEventOnce"),m.prototype),D(m.prototype,"attachEvent",[q,F],Object.getOwnPropertyDescriptor(m.prototype,"attachEvent"),m.prototype),D(m.prototype,"detachEvent",[q,F],Object.getOwnPropertyDescriptor(m.prototype,"detachEvent"),m.prototype),D(m.prototype,"isContextExpected",[P,k],Object.getOwnPropertyDescriptor(m.prototype,"isContextExpected"),m.prototype)),m))||l);return G;},false);
