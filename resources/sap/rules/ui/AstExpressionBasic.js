sap.ui.define(["sap/ui/thirdparty/jquery","./library","sap/ui/core/Control","sap/m/ResponsivePopover","sap/m/List","sap/ui/model/json/JSONModel","sap/m/ListMode","sap/m/PlacementType","sap/m/StandardListItem","sap/ui/core/CustomData","sap/ui/model/Sorter","sap/rules/ui/parser/infrastructure/util/utilsBase","sap/rules/ui/services/AstExpressionLanguage","sap/rules/ui/ExpressionAdvanced","sap/rules/ui/AutoCompleteSuggestionContent","sap/rules/ui/ExpressionBase","sap/rules/ui/ast/constants/Constants","sap/rules/ui/ast/util/AggregateFunctionDialog","sap/rules/ui/ast/util/SelectFunctionDialog","sap/rules/ui/ast/provider/TermsProvider","sap/rules/ui/ast/parser/bundlelibrary","sap/ui/core/LocaleData","sap/rules/ui/ast/util/LoopFunctionDialog"],function(q,l,C,R,L,J,a,P,S,b,c,d,A,E,f,g,h,j,k,T,m,n,o){"use strict";var p=g.extend("sap.rules.ui.AstExpressionBasic",{metadata:{properties:{library:"sap.rules.ui",value:{type:"string",defaultValue:""},dataObjectInfo:{type:"string",bindable:"bindable",defaultValue:""},resultDataObjectId:{type:"string",defaultValue:""},conditionContext:{type:"boolean",defaultValue:false},operationsContext:{type:"boolean",defaultValue:false},jsonData:{type:"array",bindable:"bindable",defaultValue:[]},enableAggregateFunctionVocabulary:{type:"boolean",defaultValue:false},enableAggregateFunctionWhereClause:{type:"boolean",defaultValue:false},isAttributeContext:{type:"boolean",defaultValue:false},placeholder:{type:"string",defaultValue:""},isAssociationContext:{type:"boolean",defaultValue:false},enableAggregateFunctionAttribute:{type:"boolean",defaultValue:false}},aggregations:{},associations:{ariaLabelledBy:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaLabelledBy"},ariaHasPopup:{type:"sap.ui.core.Control",multiple:true,singularName:"ariaHasPopup"}},events:{"change":{},"liveChange":{}}},init:function(){this.infraUtils=new sap.rules.ui.parser.infrastructure.util.utilsBase.lib.utilsBaseLib();this.oBundle=sap.ui.getCore().getLibraryResourceBundle("sap.rules.ui.i18n");this.aggregateFunctionCallBack=q.proxy(this._updateAggregateFunction,this);this.functionCallBack=q.proxy(this._updateSelectFunction,this);this.loopFunctionCallBack=q.proxy(this._updateLoopFunction,this);this._reference=q.proxy(this.callback,this);this._isDialogOpenedCallbackReference=q.proxy(this.isDialogOpenedCallback,this);this._uiModel=[];this._cursorPostion=0;this._selectedSpans=null;this._hasTextContent=false;this._createPopver();this._attributeContext=false;this._bCtrlSpacePressed=false;this.bShiftPressed=false;this.shiftKey="";this.isDialogOpen=false;this._focusedOut=false;this._jsonArray=[];this.functionClicked=false;this.isAutoSuggestionRequired=true;this.isDotRequired=true;this.aggregateFunctionDialog=j.getInstance();this.selectFunctionDialog=k.getInstance();this.loopFunctionDialog=o.getInstance();this.astLibInstance=m.getInstance();this.bTypingFlow=false;this.bEditInBetween=false;this.nIndexOfToken=0;this.tempRelString="";this.filterText="";this.filterTextLength=0;var e=sap.ui.getCore().getEventBus();e.subscribeOnce("sap.ui.rules","_onHiddenSelected",this._hiddenAccessModeSelected,this);},onBeforeRendering:function(){this._enableAggregateFunctionVocabulary=this.getEnableAggregateFunctionVocabulary();this._enableAggregateFunctionWhereClause=this.getEnableAggregateFunctionWhereClause();this._ariaLabelledById=this.getAriaLabelledBy();this._enableAggregateFunctionAttribute=this.getEnableAggregateFunctionAttribute();},callback:function(e,i){this._setTextOnCursorPosition(e);},isDialogOpenedCallback:function(i){this.isDialogOpen=i;if(!i){this.functionClicked=false;}},onAfterRendering:function(){this.referenceId="";this.isAutoSuggestionRequired=true;this.dotInOperationsContext=false;this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());this._input=this.$("input");this._validateControl();this._input[0].contentEditable=this.getEditable();this._input[0].classList.add("sapAstExpressionInput");if(!this.getEditable()){this._input[0].classList.add("sapAstExpressionInputNotEditable");}else{this._input[0].classList.remove("sapAstExpressionInputNotEditable");}if(this.aCustomStyleClasses&&this.aCustomStyleClasses.length>0){this._input[0].classList.add(this.aCustomStyleClasses[0]);}if(this.getJsonData()){this._jsonArray=this.getJsonData();}if(this.getValue()&&this.getValue().trim()){var e=this.markerString?this.markerString.trim():"";if(e===this.getValue()){this.setValue("");}this._uiModel=this._convertInputToUiModel(this.getValue());this._uiModelToSpan(this._uiModel);this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);if(!this.bTypingFlow&&this._selectedSpans[0]&&!this._selectedSpans[0].textContent.endsWith(h.DOT)&&this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)!==h.WS&&this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)!==h.UNDEFINED&&!this.dotInOperationsContext&&!(this._enableAggregateFunctionVocabulary&&this._jsonArray.length===0)&&!this._isFirstTokenUpdateOrAppendOperation()){this._createSpaceSpanItem();}this.bTypingFlow=false;if(!this.dataObjectInfo&&this.getIsAttributeContext()){this.dataObjectInfo=this.getDataObjectInfo()+(this.relString?this.relString.replace(".",""):"");}if(!this.dataObjectInfo){this.dataObjectInfo=this.getDataObjectInfo()+this.relString;}this._hasTextContent=true;}else{this.relString="";this._uiModel=[];this._uiModelToSpan(this._uiModel);this.dataObjectInfo="";}this._cursorPostion=this._getCaretPosition();this._setCurrentCursorPosition(this._cursorPostion);this._setUpEventHandlers();if(this._ariaLabelledById){this._input[0].setAttribute("aria-labelledby",this._ariaLabelledById+" "+this._input[0].id);}this._input[0].setAttribute("aria-haspopup","list");this._input[0].setAttribute("aria-label",this._input[0].textContent);},_convertInputToUiModel:function(i){if(i){this.astNodesString=this._oAstExpressionLanguage.getAstNodesString(i);this.relString=this._oAstExpressionLanguage.getRelStringForGivenAstString(this.astNodesString).relString;this._tokens=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);try{this.astresponseNodes=JSON.parse(this.astNodesString);}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}if(this.astresponseNodes&&this.astresponseNodes[0]&&(this.astresponseNodes[0].Function||(this.astresponseNodes[0].Type&&this.astresponseNodes[0].Type!=="I"))){this.displayString=this._oAstExpressionLanguage._astBunldeInstance.ASTUtil.toAstExpressionString(astNodes);this._jsonArray=this.displayString.JSON;}return this._oAstExpressionLanguage.convertTokensToUiModel(this._tokens,this._jsonArray);}return[];},_generateIDStringFromUIModel:function(){var i="";for(var t in this._uiModel){if(this._uiModel[t].reference!==null){if(this._uiModel[t].text.length>0){i=i+this._uiModel[t].reference;}}else{i=i+this._uiModel[t].text;}}return i;},_getSuggestionsForTheGivenInput:function(i){var _=this._attributeContext;var e=false;var r=false;var s=this.getIsAssociationContext();if(this.getDataObjectInfo()&&!this.functionClicked&&!this.bEditInBetween){i=this.dataObjectInfo;}if(this.getHeaderInfo()&&this.getHeaderInfo().headerValue){i=this.getHeaderInfo().headerValue+" "+i;}if(this.getAttributeInfo()&&i===""){i=this.getAttributeInfo()+" "+h.EQUAL+" ";}if(!this._oAstExpressionLanguage){this._oAstExpressionLanguage=sap.ui.getCore().byId(this.getAstExpressionLanguage());}if(this.getDataObjectInfo()&&this.getIsAttributeContext()){_=this.getIsAttributeContext();i=i.replace(/\./g,"");}if(this._enableAggregateFunctionVocabulary){_=false;s=true;}if(this.getOperationsContext()&&!this._enableAggregateFunctionVocabulary){e=true;}if(this.getOperationsContext()&&i!==""){if(this.dotInOperationsContext&&this._selectedSpans[0]&&this._selectedSpans[0].textContent.endsWith(h.DOT)){_=true;}else if(this._isFirstTokenUpdateOrAppendOperation()&&this._selectedSpans[0].textContent===" "+h.DOT){_=true;i=i.trim();}else if(!_){_=false;r=this._addDotToMiscellaneousSuggestions();}}var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(i);var u=this._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(t);var v={};v.AttributeContext=_;v.OperationsContext=e;v.AssociationContext=s;var w=this._filterSuggestionBasedOnCardinality(u,v);if(r){var x={name:h.DOT,label:this.oBundle.getText("DOTLABEL")};w.autoComplete.categories.operators=w.autoComplete.categories.operators?w.autoComplete.categories.operators:{};var y=w.autoComplete.categories.operators;if(!("miscellaneous"in y)){y.miscellaneous=[];}y.miscellaneous.push(x);}w.autoComplete.businessDataTypeList=w.businessDataTypeList;if(this._enableAggregateFunctionVocabulary&&w&&w.autoComplete&&w.autoComplete.categories&&w.autoComplete.categories.terms&&w.autoComplete.categories.terms.length===0){this._oAutoSuggestionPopUp.close();}return w;},_filterSuggestionBasedOnCardinality:function(u,s){var e=this._oAstExpressionLanguage.getSuggesstions(u,s);if((this._enableAggregateFunctionAttribute||this._enableAggregateFunctionWhereClause)&&e&&e.autoComplete&&e.autoComplete.categories&&e.autoComplete.categories.terms){for(var i=0;i<e.autoComplete.categories.terms.length;i++){if(e.autoComplete.categories.terms[i].cardinality&&e.autoComplete.categories.terms[i].cardinality===h.ONE_TO_N){e.autoComplete.categories.terms.splice(i,1);}}}return e;},_getSuggestionsForEditedInput:function(F){this.tempRelString=this._cursorPostion===0?"":this._calculateStringAndIndexOfNewToken();if(this._enableAggregateFunctionWhereClause){this.tempRelString=this.getDataObjectInfo()+this.tempRelString;}var t=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString);var e=this._getStringForFilterAndTempRelString(t);this._suggestionsList=this._getSuggestionsForTheGivenInput(e.tempRelString);if(F){var s=e.filterText;var i=this._filterSuggestionList(s);if(i.hasSuggestions){this._suggestionsList=i;}}if(!F&&e.filterText){var r=this._getTermIdForTheGivenText(e.filterText);var u=e.tempRelString+r;this._suggestionsList=this._getSuggestionsForTheGivenInput(u);}},_addDotToMiscellaneousSuggestions:function(){if(this.relString&&this.relString.trim().toUpperCase().indexOf(h.UPDATE)===0){var u=this._uiModel.length;var e=this._uiModel[u-1];if(this.bEditInBetween&&this.nIndexOfToken){e=this._uiModel[this.nIndexOfToken];}var i=e.dataObjectType;var r=e.getReference();var s=r?r.split("/"):[];if(!r){return false;}if(i===h.ASSOCIATIONDOTYPE){return true;}else if(s&&s.length>2){return false;}else{r=s[1];r=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r);if(r&&r._isDataObjectElement){return false;}else{return true;}}}return false;},_constructExpandedRelString:function(e){var i="";if(e.function===h.AVG||e.function===h.SUM||e.function===h.MIN||e.function===h.MAX){i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+i+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===h.COUNTDISTINCT||e.function===h.DISTINCT){i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.attribute:this._fetchAttributesSelectFunction(e);return e.function+"("+this.getTable(e)+","+i+")";}else if(e.function===h.COUNT){return e.function+"("+this.getTable(e)+this.getGroupByAttributes(e.groupBy)+")";}else if(e.function===h.TOP||e.function===h.BOTTOM||e.function===h.SELECT||e.function===h.FIRST){return this._constructExpandedRelStringForSelect(e);}else if(e.function===h.FOREACH){return e.function+"("+this.getTable(e)+" , "+this._fetchForEachOperations(e.actions)+")";}},_fetchForEachOperations:function(O){var s="";for(var i=0;i<O.length-1;i++){if(O[i]!==""){s=s+O[i]+" , ";}}s=s+O[i];return s;},_fetchAttributesSelectFunction:function(e){if(this._hasAssociationId(e.vocabulary,e.function)){return this._returnAttributeBasedOnCardinality(e.vocabulary)}else if(e.vocabulary.attributes&&Object.keys(e.vocabulary.attributes).length===1){for(var i in e.vocabulary.attributes){return i;}}},_getAttributesSelectQuery:function(e){var s=",";var i="";if(e&&!q.isEmptyObject(e.attributes)){for(var r in e.attributes){i+=s+r;}}return i;},_constructSelectQuery:function(e){var i="";if(e.doVocabId){i=e.doVocabId;}else{i=e.dataObject;}if(this._getAttributesSelectQuery(e)){return h.SELECT+"("+this._constructSortQuery(e)+this._getAttributesSelectQuery(e)+")";}else if(e.filter){return h.FILTER+"("+i+","+e.filter+")"}else{return i;}},_constructSortQuery:function(e){var i="";var r="";if(e.doVocabId){r=e.doVocabId;}else{r=e.dataObject;}if(!e.filter){i=r;}else{i=h.FILTER+"("+r+","+e.filter+")";}if(!q.isEmptyObject(e.attributes)){for(var s in e.attributes){if(e.attributes[s]!==h.NOSORT){i=e.attributes[s]+"("+i+","+s+")";}}}return i;},_constructExpandedRelStringForSelect:function(e){if(e.function===h.TOP||e.function===h.BOTTOM){return e.function+"("+this._constructSelectQuery(e)+","+e.count+")";}else if(e.function===h.SELECT){return this._constructSelectQuery(e);}else if(e.function===h.FIRST){return e.function+"("+this._constructSelectQuery(e)+")";}},getTable:function(e){var i=(typeof e.vocabulary==="string"||e.vocabulary instanceof String)?e.vocabulary:this._getDataObjectInfoBaseOnVocaulary(e);if(!e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return this._constructExpandedRelStringForSelect(e.vocabulary);}else if(e.filter&&(typeof e.vocabulary==="object"||e.vocabulary instanceof Object)){return h.FILTER+"("+this._constructExpandedRelStringForSelect(e.vocabulary)+","+e.filter+")";}else if(!e.filter){return i;}else{return h.FILTER+"("+i+","+e.filter+")";}},_getDataObjectInfoBaseOnVocaulary:function(e){var i=e.dataObject;if(this._hasAssociationId(e.vocabulary,e.function)){i=this._returnDataObjectBasedOnCardinality(e.vocabulary);}return i;},_hasAssociationId:function(v,e){var i="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var r in v.attributes){i=v.doVocabId+r.replace(h.DOT,"");break;}}}if(i){var s=i.split("/");var t=s[1];if(s.length>3){for(var u=2;u<s.length-1;u++){t+=h.DOT+s[u];}}if(this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(t)&&this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(t)._dataObjectType==="AO"){return true;}}return false;},_returnAttributeBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(h.DOT,"");break;}}}if(e){var s=e.split("/");var r=s[1];var t=0;var u;var w="";if(s.length>2){for(var x=2;x<s.length;x++){r+=h.DOT+s[x];u=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r);if(u&&u._dataObjectType==="AO"&&u._cardinality==="1..n"){t=x;}}if(t>0){for(var x=t+1;x<s.length;x++){w+="/"+s[x];}}if(t===0){for(var x=2;x<s.length;x++){w+="/"+s[x];}}}if(w){return h.DOT+w;}else{return"./"+s[s.length-1];}}},_returnDataObjectBasedOnCardinality:function(v){var e="";if((typeof v==="object"||v instanceof Object)){if(v&&v.attributes){for(var i in v.attributes){e=v.doVocabId+i.replace(h.DOT,"");break;}}}else{e=v;}if(e){var s=e.split("/");var r=s[1];var t=0;var u;var w="";if(s.length>2){for(var x=2;x<s.length;x++){r+=h.DOT+s[x];u=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider.getTermByTermId(r);if(u&&u._dataObjectType==="AO"&&u._cardinality==="1..n"){t=x;}}if(t>0){for(var x=1;x<=t;x++){w+="/"+s[x];}}}if(w){return w;}else{return"/"+s[1];}}},getGroupByAttributes:function(e){var s=",";var r="";if(e&&e.length>0){for(var i=0;i<e.length;i++){r+=(s+e[i]);}}return r;},_fetchAttributes:function(v){if(typeof v==="string"||v instanceof String){var s=v.split("/");var e="";if(s.length>3){for(var i=2;i<s.length;i++){e+="/"+s[i];}return h.DOT+e;}else{return"./"+s[2];}}else if(Object.keys(v.attributes).length===1){for(var r in v.attributes){return r;}}else{}},_createUUID:function(){return this.infraUtils.createUUID();},_createSpanItem:function(i){var e=this.getId();this.ruleWithElementDO=false;if(i.tokenType===h.TERM){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var t=i.reference.split("/")[1];var r=this.termsProvider.getTermByTermId(t);if(r&&r.Type==="Rule"&&r.ResultDataObjectId!==""&&r.ResultDataObjectId!==undefined){var s=this.termsProvider.getTermByTermId(r.ResultDataObjectId);if(s&&s.getIsDataObjectElement()){r=s;this.ruleWithElementDO=true;}}if(r&&i&&(r._isDataObjectElement||i.dataObjectType==="ruleWithElementDO")){t="/"+t;}else{t=i.reference;}var u=this.termsProvider.getTermNameFromASTNodeReference(t);if(u){if("dataObjectType"in i&&i.dataObjectType!=h.Element&&!this._enableAggregateFunctionVocabulary&&!this.ruleWithElementDO){i.text=u;if(this._addDotToReferenceText(i)){i.text=u+h.DOT;}}else if((i.resultDataObjectId!==""&&i.resultDataObjectId!==undefined&&!this.ruleWithElementDO)||(i.tokenType===h.TERM&&i.dataObjectType!=h.Element&&!this.ruleWithElementDO&&!this._enableAggregateFunctionVocabulary)){i.text=u;if(this._addDotToReferenceText(i)){i.text=u+h.DOT;}}else{i.text=u;}}}if(i.tokenType===h.FUNCTION&&i.json){this.termsProvider=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var u=this.termsProvider.getTermNameFromASTNodeReference(i.json.dataObject);i.text=i.text.replace(i.json.dataObject,u)}if(i.tokenType===h.DATEBUSINESSDATATYPE||i.tokenType===h.TIMEBUSINESSDATATYPE){var v=this._getDateTimeFormatter(i.tokenType);var w=i.text.replace(/\'/g,"");var D=v.format(v.parse(w));if(D!==""){i.text="'"+D+"'";}}var x=i.id.replace("/","");var N=q('<span>',{id:e+"-"+x,class:i.cssClass,reference:i.reference,resultDataObjectId:i.resultDataObjectId,json:JSON.stringify(i.json),tokenType:i.tokenType})["text"](i.text);return N;},_getDateTimeFormatter:function(t){var e=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var i=n.getInstance(e);if(t===h.DATEBUSINESSDATATYPE){var r=i.getDatePattern('medium');var s=sap.ui.core.format.DateFormat.getDateInstance({pattern:r});return s;}else if(t===h.TIMEBUSINESSDATATYPE){var r=i.getDatePattern('medium');var u=i.getTimePattern('medium');var v=sap.ui.core.format.DateFormat.getDateTimeInstance({pattern:r+" "+u});return v;}},_isFirstTokenUpdateOrAppendOperation:function(){var O=false;if(this.relString&&(this.relString.trim().toUpperCase().indexOf(h.UPDATE)===0||this.relString.trim().toUpperCase().indexOf(h.APPEND)===0)){O=true;}return O;},_addDotToReferenceText:function(i){if(this._uiModel&&this.nIndexOfToken&&this._uiModel[this.nIndexOfToken]&&i&&'startIndex'in i&&this._uiModel[this.nIndexOfToken].startIndex!==i.startIndex){return false;}var O=this._isFirstTokenUpdateOrAppendOperation()&&this.dotInOperationsContext;if(O||(!O&&this._attributeContext)||(!O&&i.dataObjectType==="AO")||(!this._isFirstTokenUpdateOrAppendOperation()&&(i.dataObjectType==="S"||i.dataObjectType==="T"))){this._attributeContext=true;return true;}return false;},_uiModelToSpan:function(u){var t="";var H="";for(var i=0;i<u.length;i++){H+=this._createSpanItem(u[i])[0].outerHTML;}this._input.html(H);return t;},_closeAutoSuggestionPopup:function(){if(this._oAutoSuggestionPopUp)this._oAutoSuggestionPopUp.close();},_setUpEventHandlers:function(){var t=this,i=q(this._input),r=[16,17,18,93,13,9,35,36,45,34,33,40,37,38,39,27,44,145,19,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135];if(!this._focusedOut){t._setCurrentCursorPosition(t._cursorPostion);}this._input.on('keydown',function(e){if(e.keyCode===8||e.keyCode==46){t._selectedSpans=t._getSelectedSpans();t._handleBackSpaceAndDeleteKey(e);}else if(e.keyCode===40||e.keyCode===38){t._handleArrowNavigation(e);}else if(e.key==="Control"){t.ctrlPressed=true;}else if(t.ctrlPressed&&(e.keyCode===32||e.key===" ")){t._initializeCursorSpan();t.ctrlPressed=false;t._bCtrlSpacePressed=true;if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(!t.relString){t.relString="";}}else if(e.key==="Shift"){t.bShiftPressed=true;}else if(t.bShiftPressed&&r.indexOf(e.keyCode)===-1){t.shiftKey=e.key;t.bShiftPressed=false;}else if(e.key==="Tab"||e.keyCode===27){t._closeAutoSuggestionPopup();}else if(r.indexOf(e.keyCode)!==-1&&e.keyCode!==35&&e.keyCode!==36&&e.keyCode!==37&&e.keyCode!==39){e.preventDefault();}});this._input.on("click",function(s){t.ctrlPressed=false;t.forceFireChange=false;t._initializeCursorSpan();var u;if(!t.getEditable()){return;}if(t._selectedSpans&&t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(h.JSON)){t.functionClicked=true;var _=t._getSuggestionsForTheGivenInput(t._contextForPerviousSpans(t._selectedSpans));t.isDialogOpen=true;try{u=JSON.parse(t._selectedSpans[0].getAttribute(h.JSON));if(u.function===h.FOREACH){t.loopFunctionDialog._createLoopFunctionDialog(_.autoComplete.categories.functions,t.loopFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,u);}else if(u.function===h.TOP||u.function===h.BOTTOM||u.function===h.SELECT||u.function===h.FIRST){t.selectFunctionDialog._createSelectFunctionDialog(_.autoComplete.categories.functions,t.functionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,u);}else{u.selectExpression=typeof u.vocabulary==="object"||u.vocabulary instanceof Object?t._constructExpandedRelStringForSelect(u.vocabulary):"";t.aggregateFunctionDialog._createAggregationFunctionDialog(_.autoComplete.categories.functions,t.aggregateFunctionCallBack,t._oAstExpressionLanguage,t._isDialogOpenedCallbackReference,u);}}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}t._closeAutoSuggestionPopup();});this._input.on('keyup',function(e){var s=q(this);var u=false;if(e.keyCode==8||e.keyCode==46){t._updateUiModel();t._calculateStringAndIndexOfNewToken();}t._initializeCursorSpan();if(!t.dataObjectInfo){t.dataObjectInfo=t.getDataObjectInfo();}if(e.key==="Control"||e.keyCode===35||e.keyCode===36||e.keyCode===37||e.keyCode===39||e.keyCode===20||e.keyCode===144){return;}if(t.bEditInBetween){t.bTypingFlow=!t._bCtrlSpacePressed;t._getSuggestionsForEditedInput(true);}if(t._bCtrlSpacePressed){if(!t.bEditInBetween){t._suggestionsList=t._getSuggestionsForTheGivenInput(t.relString);var v=t._input.children()[t._input.children().length-1];if(v){t._selectedSpans=[];t._selectedSpans.push(v);}}if((t._selectedSpans[0]&&t._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.UNDEFINED&&t._selectedSpans[0].textContent.startsWith(h.SINGLE_QUOTE))||(t._selectedSpans[0].className==="sapAstLiteralClass")){t._suggestionsList.autoComplete.showLiteral=true;t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].textContent;if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute("reference")){t._suggestionsList.autoComplete.literalInput=t._selectedSpans[0].getAttribute("reference");}}t._showAutoSuggestion(t._suggestionsList);t._bCtrlSpacePressed=false;return;}var w=s.data('before');var x=this.textContent;if(x&&e.key!==" "){x=x.trim();}if(w){w=w.trim();}if(x!==w){t.bTypingFlow=true;if(((e.keyCode!==8&&e.keyCode!==46)&&r.indexOf(e.keyCode)===-1)||(e.key==="Shift"&&t.shiftKey!=="")){var y=e.key==="Shift"?t.shiftKey:e.key;t._updateUIModelForFreeFlow(y);if(y===" "&&((t._selectedSpans[0].className!=="sapAstLiteralClass"&&t._selectedSpans[0].className!=="sapAstAuxilaryNodeClass")||(t._selectedSpans[0].className==="sapAstLiteralClass"&&!(t.filterTextLength<t._selectedSpans[0].textContent.length)))){t.nIndexOfToken+=1;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:0});}u=true;t.shiftKey="";}t._handleKeyUpEvent(x,e,u);s.data('before',x);t._bCtrlSpacePressed=false;}});this._input.on('focusout',function(e){t._focusedOut=true;if(!t.isDialogOpen&&!t._oAutoSuggestionPopUp.isOpen()){t._validateControl();}t._handlePopupFocusOut(e);});this._input.on('focus',function(e){t._focusedOut=false;var s=q(this);s.data('before',s.context.textContent);});},_handleBackSpaceAndDeleteKey:function(e){var r=false;var t=this;if(e.keyCode==46){r=true;}t._calculateStringAndIndexOfNewToken();if(r&&t.bEditInBetween&&t._selectedSpans&&"className"in t._selectedSpans[0]&&(t._selectedSpans[0].className=="sapAstAuxilaryNodeClass"&&this._getFullTextContentLength()===this._cursorPostion)){var s=t._getSelectedSpanGivenIndex(this.nIndexOfToken+1);if(s&&s[0]&&s[0].className==="sapAstObjectClass"){t._selectedSpans=s;t._setCaretPosition({spanIndex:t.nIndexOfToken+1,position:0});t._calculateStringAndIndexOfNewToken();}}if(t._selectedSpans[0].className==="sapAstObjectClass"){var u=t._selectedSpans[0].textContent;var v=t._selectedSpans[0].getAttribute(h.REFERENCE).split("/");var w="";var x="";var y=u.split(h.DOT);var z="";var B="";var D;if((t.filterTextLength>0&&!r)||r){for(var i=1;i<v.length;i++){z=x;x+=y[i-1]+h.DOT;t._attributeContext=true;if(t.filterText.indexOf(x)>=0&&(!(t.filterText==x)||(r&&t.filterText==x))){w+="/"+v[i];continue;}else{break;}}var F=T.getInstance();B=w.replace(/\//,"");B=B.replace(/\//g,".");if(B){D=F.getTermByTermId(B);}if(D&&D._dataObjectType==="AO"&&(t._enableAggregateFunctionWhereClause||t.getIsAttributeContext())){w=v[0]===h.DOT?h.DOT+w:w;this.isDotRequired=false;}else if(D&&(D._dataObjectType==="T"||D._dataObjectType==="S")&&t._enableAggregateFunctionWhereClause&&!t.getIsAttributeContext()){this.isDotRequired=false;}else{this.isDotRequired=true;}var G=t._cursorPostion>0?z.length:t._cursorPostion-t._selectedSpans[0].textContent.length-z.length;t._selectedSpans[0].textContent=z;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:G});t._selectedSpans[0].setAttribute(h.REFERENCE,w);e.preventDefault();if(w===""){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._selectedSpans=t._getSelectedSpanGivenIndex(this.nIndexOfToken);var H=t._selectedSpans?t._selectedSpans[0].textContent.length:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:H});}}}else if(t._selectedSpans[0]&&t.filterTextLength!==0&&((t._selectedSpans[0].className==="sapAstFunctionClass"&&t._selectedSpans[0].getAttribute(h.JSON))||(t._selectedSpans[0].className==="sapAstLiteralClass"&&t._selectedSpans[0].textContent.startsWith("'")&&t.bEditInBetween&&t.filterTextLength===t._selectedSpans[0].textContent.length))){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:t._cursorPostion});e.preventDefault();}else if(t._selectedSpans[0]&&t._selectedSpans[0].getAttribute("class")==="sapAstLiteralClass"&&(t._selectedSpans[0].getAttribute("tokentype")==="D"||t._selectedSpans[0].getAttribute("tokentype")==="T"||t._selectedSpans[0].getAttribute("tokentype")==="U")){t._removeSpans();t.nIndexOfToken=t.nIndexOfToken>0?t.nIndexOfToken-1:0;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:t._cursorPostion});}},_handlePopupFocusOut:function(e){var i=e.currentTarget.id;var r=e.relatedTarget;if(r&&i!==r.id&&!this._isAutoSuggestionPopover(r)){if(this._oAutoSuggestionPopUp.isOpen()){this._closeAutoSuggestionPopup();}this._fireChange(this.textContent);}},_isAutoSuggestionPopover:function(e){var i=[];var I=false;while(e){if(e.id&&e.id.indexOf("autoCompletePopover")!==-1){I=true;break;}i.unshift(e);e=e.parentNode;}return I;},_initializeCursorSpan:function(){this._selectedSpans=this._getSelectedSpans();this._cursorPostion=this._getCaretPosition();if(this._cursorPostion===0){this.filterTextLength=0;}if(this._cursorPostion<this._input.text().length){this.bEditInBetween=true;this._calculateStringAndIndexOfNewToken();}else{this.bEditInBetween=false;this.filterTextLength=this._selectedSpans[0].textContent.length;this.nIndexOfToken=this._input.children().length-1;}},_handleArrowNavigation:function(e){e.preventDefault();this._bPopUpFocused=true;var s=this._oAutoSuggestionPopUp.getContent()[0];var i=s.getAggregation("mainLayout").getItems()[0];$(i).focus();},_handleKeyUpEvent:function(e,i,r){var t=this;var s;var u=this._oAstExpressionLanguage.getTokensForGivenStringInput(this._uiModeltoString());if(!this.bEditInBetween){s=this._getStringForFilterAndTempRelString(u);if(i.keyCode===8||i.keyCode===46){this.dataObjectInfo=this.getDataObjectInfo()+s.tempRelString;}}if(this._jsonArray.length>0){u=this._convertInputToUiModel(this.relString);}this._uiModel=t._oAstExpressionLanguage.convertTokensToUiModelForAutoSuggestion(u);this._uiModelToSpan(this._uiModel);this._uiModeltoString();this._getSelectedSpanFromIndex();if(!this._bCtrlSpacePressed&&r&&this.getDataObjectInfo()&&u[u.length-2].type!==this.astLibInstance.IDPParser.ALL_STRING){this.dataObjectInfo=this.getDataObjectInfo()+s.tempRelString;}var v=this.filterTextLength;if(this.bEditInBetween){if(i.keyCode===8||i.keyCode===46){v=this._cursorPostion===0&&this.nIndexOfToken===0&&this.filterTextLength>0?0:this.filterTextLength;}else if(!this._uiModel[this.nIndexOfToken].text.endsWith(i.key)&&(this._selectedSpans[0].className!=="sapAstLiteralClass")&&(this._selectedSpans[0].className!=="")){this.nIndexOfToken+=1;v=1;}else if(i.key==="'"){v=1;}this._getSelectedSpanFromIndex();if(i.key!=="'"&&this._selectedSpans[0]&&"className"in this._selectedSpans[0]&&this._selectedSpans[0].className==="sapAstLiteralClass"){v=this.filterTextLength;}}else{this.nIndexOfToken=this._input.children().length-1;v=this._cursorPostion;}var w=this._selectedSpans?this._selectedSpans[0]:null;if(this.bEditInBetween&&i.key==="'"&&w&&w.nextSibling&&'getAttribute'in w.nextSibling&&(w.nextSibling.getAttribute("tokenType")==='U'||w.nextSibling.getAttribute("tokenType")==='N')){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:v-1,});}else if(this.bEditInBetween&&i.key==="'"&&w&&w.nextSibling&&'getAttribute'in w.nextSibling&&w.nextSibling.className==='sapAstLiteralClass'){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:v,});}else{this._setCaretPosition({spanIndex:this.nIndexOfToken,position:v,keyCode:i.keyCode});}if(e!==""&&i.key!=='Backspace'){var x=i.key!==" ";if(!this.bEditInBetween){this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);this._suggestionsList=this._getSuggestionsForTheGivenInput(s.tempRelString);var y=s.filterText;var F=this._filterSuggestionList(y);if(F.hasSuggestions){this._suggestionsList=F;}if(!F.hasSuggestions&&s.filterText){var z=this._getTermIdForTheGivenText(s.filterText);if(z){var B=s.tempRelString+z;this._suggestionsList=this._getSuggestionsForTheGivenInput(B);}else{this._suggestionsList=F;}}if(!(i.keyCode===8||i.keyCode===46)){this._showAutoSuggestion(this._suggestionsList,x);}}if(this._selectedSpans[0]&&this._selectedSpans[0].className!==""&&this._selectedSpans[0].className!=="sapAstLiteralClass"||(this._selectedSpans[0]&&this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.UNDEFINED&&!t._selectedSpans[0].textContent.startsWith(h.SINGLE_QUOTE))){this._showAutoSuggestion(this._suggestionsList,x);}}else{this._closeAutoSuggestionPopup();}},_getTermIdForTheGivenText:function(t){var e=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var i=e.getTermByTermLabel(t);var r="";if(i){r="/"+i._termId;}else{var s=e.getTermByTermName(t);r=s?"/"+s._termId:"";}return r;},_setCaretPosition:function(e){var s=window.getSelection(),r=this.$("input"),t,u,I,F,v=0;var w=function(v){var x=r.children(),y,z,B=0;for(var i=0;i<x.length;i++){y=x[i];z=y.innerText||"";if(B+z.length>v){return{spanIndex:i,position:B+z.length-v};}B+=z.length;}return{spanIndex:Math.max(i-1,0),position:100};};if(typeof e==="number"){e=w(e);}I=e&&e.span;if(e){t=r[0];if(!I){I=t&&t.children&&t.children.length>e.spanIndex?t.childNodes[e.spanIndex]:null;}if(I){u=document.createRange();F=I.firstChild?I.firstChild:I;if(this.bEditInBetween&&this.bTypingFlow){if(e.spanIndex===0&&e.position===0){v=0;}else if(F&&F.length){v=Math.min(F.length,e.position);}}else if(F&&F.length){v=Math.min(F.length,e.position);}}if(!(typeof v==="number")||(F&&F.length&&v>F.length)||v<0){v=0;}if(F){u.setStart(F,v);u.collapse(true);s.removeAllRanges();s.addRange(u);}}},_getStringForFilterAndTempRelString:function(t){var s="";var i="";var e;var r;var u;var v;for(var w in t){e=t[w];v=t[w-1];r=e.type?e.type:e._type;u=v?(v.type?v.type:v._type):null;if(r===this.astLibInstance.IDPParser.EOF||r===this.astLibInstance.IDPParser.DOT){continue;}else if(r===this.astLibInstance.IDPParser.ALL_STRING||(u&&u===this.astLibInstance.IDPParser.ALL_STRING)){i+=e.text;}else{s+=e.text;}}return{tempRelString:s,filterText:i};},_isEmptySpace:function(s){return s===String.fromCharCode(160)||s===" ";},_bRequiredFilteredSuggestion:function(t){return!(this._isEmptySpace(t)||t===""||this._selectedSpans[0].className==="sapAstLiteralClass");},_updateUIModelForFreeFlow:function(s){var t=this;var e=this._selectedSpans[0];if(this._uiModel.length===0){var i={id:t._createUUID(),tokenType:h.UNDEFINED};if(e&&'textContent'in e){i['text']=e.textContent;}else{i['text']=s;}this._uiModel.push(i);this._uiModelToSpan(this._uiModel);}else if(e.className==="sapAstObjectClass"){if(s===h.DOT&&this.getOperationsContext()){this.dotInOperationsContext=true;this._attributeContext=true;}else{var r=e.getAttribute(h.REFERENCE);if(e.textContent.startsWith(s)){e.setAttribute(h.REFERENCE,s+" "+r);this._cursorPosition+=1;}else if(e.textContent.endsWith(s)){e.setAttribute(h.REFERENCE,r+s);}}}else if(s===h.SINGLE_QUOTE&&this.bEditInBetween&&e&&e.className!='sapAstLiteralClass'){e.textContent=e.textContent.replace(h.SINGLE_QUOTE,h.SINGLE_QUOTE+h.SINGLE_QUOTE);}else if(this.bEditInBetween&&e.nextSibling&&e.nextSibling.className&&e.nextSibling.className==="sapAstFunctionClass"&&((e.className!=="sapAstLiteralClass"&&e.className!=="sapAstAuxilaryNodeClass")||(s!==" "&&e.className==="sapAstAuxilaryNodeClass"&&e.textContent.endsWith(event.key)))){e.textContent+=" ";}this._updateUiModel();},_filterSuggestionList:function(t){var e=false;var F={autoComplete:{categories:{functions:{},operators:{},terms:[]},showLiteral:this._suggestionsList.autoComplete.showLiteral,businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList},businessDataTypeList:this._suggestionsList.autoComplete.businessDataTypeList};if(this._suggestionsList.autoComplete.valuehelp){F.autoComplete.valuehelp=this._suggestionsList.autoComplete.valuehelp;}var s=this._suggestionsList.autoComplete.categories;var r=function(y){var D=[];var z,B,N;for(var i=0;i<y.length;i++){z=(y[i].label).toLowerCase();N=(y[i].name).toLowerCase();B=t.toLowerCase();if(((" "+z).indexOf(" "+B)!==-1)||((" "+N).indexOf(" "+B)!==-1)){D.push(y[i]);e=true;}}return D;};var u=function(){if(s.terms){F.autoComplete.categories.terms=r(s.terms);}if(s.functions){var i=s.functions.advanced;if(i&&i.length>0){var y=r(i);if(y&&y.length>0){F.autoComplete.categories.functions.advanced=y;}}var z=s.functions.aggregate;if(z&&z.length>0){var y=r(z);if(y&&y.length>0){F.autoComplete.categories.functions.aggregate=y;}}var B=s.functions.selection;if(B&&B.length>0){var y=r(B);if(y&&y.length>0){F.autoComplete.categories.functions.selection=y;}}var D=s.functions.window;if(D&&D.length>0){var y=r(D);if(y&&y.length>0){F.autoComplete.categories.functions.window=y;}}var G=s.functions.time_duration;if(G&&G.length>0){var y=r(G);if(y&&y.length>0){F.autoComplete.categories.functions.time_duration=y;}}var H=s.functions.loop;if(H&&H.length>0){var y=r(H);if(y&&y.length>0){F.autoComplete.categories.functions.loop=y;}}var I=s.functions.operations;if(I&&I.length>0){var y=r(I);if(y&&y.length>0){F.autoComplete.categories.functions.operations=y;}}}if(s.operators){var K=s.operators.arithmetic;if(K&&K.length>0){var y=r(K);if(y&&y.length>0){F.autoComplete.categories.operators.arithmetic=y;}}var M=s.operators.comparision;if(M&&M.length>0){var y=r(M);if(y&&y.length>0){F.autoComplete.categories.operators.comparision=y;}}var N=s.operators.logical;if(N&&N.length>0){var y=r(N);if(y&&y.length>0){F.autoComplete.categories.operators.logical=y;}}var O=s.operators.array;if(O&&O.length>0){var y=r(O);if(y&&y.length>0){F.autoComplete.categories.operators.array=y;}}var Q=s.operators.range;if(Q&&Q.length>0){var y=r(Q);if(y&&y.length>0){F.autoComplete.categories.operators.range=y;}}var U=s.operators.miscellaneous;if(U&&U.length>0){var y=r(U);if(y&&y.length>0){F.autoComplete.categories.operators.miscellaneous=y;}}var V=s.operators.functional;if(V&&V.length>0){var y=r(V);if(y&&y.length>0){F.autoComplete.categories.operators.functional=y;}}}};if(s){u();}if(!e){var v;if(this.bEditInBetween){v=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.tempRelString)}else{v=this._oAstExpressionLanguage.getTokensForGivenStringInput(this.relString);}var w=v.length-2;t=v[w].text;v=v.slice(0,w);var x=this._getStringForFilterAndTempRelString(v);s=this._getSuggestionsForTheGivenInput(x.tempRelString).autoComplete.categories;u();}F.hasSuggestions=e;return F;},_fireChange:function(t){if(this.isDialogOpen&&!this.forceFireChange){return;}var e="";if(!this.relString&&t){this.relString=t;}if(!this.relString){this.relString="";}if(this.markerString){this.markerRelString=this.markerString+this.relString;e=this._oAstExpressionLanguage.getAstNodesString(this.markerRelString);}else{e=this._oAstExpressionLanguage.getAstNodesString(this.relString);}this.astresponseNodes=JSON.parse(e);if(this._getValueAfterReplacingSpace(this.getValue())!==this._getValueAfterReplacingSpace(this.relString)){this.setValue(this.relString);this.setJsonData(this._jsonArray);this.fireChange({newValue:this.relString,astNodes:this.astresponseNodes,displayText:this._input[0].textContent.trim()});}},_getValueAfterReplacingSpace:function(v){if(v){return v.replace(/([^']+)|('(?:[^'\\]|\\.)+')/g,function(e,i,r){if(i){return i.replace(/\s/g,"");}else{return r;}});}return"";},_contextForPerviousSpans:function(s){var i="";var r;var t=this.getDomRef("input").children;for(var u=0;u<t.length;u++){var v=$("#"+t[u].id);if(t[u].id!==s[0].id){if(v[0].getAttribute(h.JSON)){try{r=JSON.parse(v[0].getAttribute(h.JSON));if(r.expandedText){i+=r.expandedText;}}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}else if(v[0].getAttribute(h.REFERENCE)){i+=v[0].getAttribute(h.REFERENCE);}else{i+=v[0].textContent}}else{i+="";break;}}return i;},_updateSelectFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_updateLoopFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_updateAggregateFunction:function(e){this.isDialogOpen=false;this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(e.getSource().mProperties.jsonData));this._selectedSpans[0].textContent=e.getSource().mProperties.value;this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._input.empty();this._uiModelToSpan(this._uiModel);this._setCurrentCursorPosition(this._cursorPostion);},_getNewSpaceSpan:function(){var i={};i.id=this._createUUID();i.text=" ";i.tokenType=h.WS;i.cssClass="sapAstAuxilaryNodeClass";return this._createSpanItem(i);},_createSpaceSpanItem:function(){var e=this._getNewSpaceSpan();var s=this._selectedSpans[0]?this._selectedSpans[0].id:"";var i="#"+s;$(e[0]).insertAfter(i);this._updateUiModel();this._cursorPostion+=e[0].textContent.length;this._selectedSpans=$(e);this._uiModel=this._convertInputToUiModel(this.relString);this._hasTextContent=true;this.nIndexOfToken+=1;},_addSpace:function(){this._createSpaceSpanItem();if(this.bEditInBetween){this._getSuggestionsForEditedInput(false);}else{this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString);}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0].textContent.length});this._showAutoSuggestion(this._suggestionsList);},_removeSpans:function(){var e=false;if(this._uiModel.length===0||this._input.children().length===0){return e;}this._prevNodeofRemovedNode=null;for(var i=0;i<this._selectedSpans.length;i++){this._prevNodeofRemovedNode=$("#"+this._selectedSpans[i].id).prev()[0];if(this._selectedSpans[i]instanceof HTMLSpanElement){if(this._selectedSpans[i].textContent){this._cursorPostion-=this._selectedSpans[i].textContent.length;}$(this._selectedSpans[i]).remove();e=true;}if("getAttribute"in this._selectedSpans[i]&&this._selectedSpans[i].getAttribute("class")==="sapAstObjectClass"){this._attributeContext=false;}}if(this.getDomRef("input")&&this.getDomRef("input").textContent&&!this.getDomRef("input").textContent.length>0){this._hasTextContent=false;}return e;},_showAutoSuggestion:function(s,e){var i=q(this._selectedSpans);var x=0;if(this._cursorPostion!==0){if(i&&i[0]instanceof HTMLPreElement){x=12;}else{if("position"in i&&i.position()){x=parseInt(i.position().left,10);}x+=parseInt(i.width(),10);}}var y=3;x+=10;var t=this;setTimeout(function(){if(t._oAutoSuggestionPopUp&&!t._oAutoSuggestionPopUp.isOpen()){t._oAutoSuggestionPopUp.destroyContent();t._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);t._oAutoSuggestionPopUp.openBy(t.getDomRef("input"));}else{t._oAutoSuggestionPopUp.destroyContent();t._oAutoSuggestionPopUp.addContent(new sap.rules.ui.AutoCompleteSuggestionContent({content:s.autoComplete,reference:t._reference,enableAggregateFunctionVocabulary:t._enableAggregateFunctionVocabulary,enableAggregateFunctionWhereClause:t._enableAggregateFunctionWhereClause,dialogOpenedCallbackReference:t._isDialogOpenedCallbackReference,vocabularyInfo:t._oAstExpressionLanguage,expand:e}));t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);}if(!t._oAutoSuggestionPopUp.isOpen()){t._oAutoSuggestionPopUp.setOffsetX(x);t._oAutoSuggestionPopUp.setOffsetY(y);t._oAutoSuggestionPopUp.openBy(t.getDomRef("input"));}},600);},_isLastTokenSpaceItem:function(){var i=true;var e=[];if(this.bEditInBetween&&this.tempRelString!=""&&this.nIndexOfToken>=0){e=this._uiModel[this.nIndexOfToken];if(this._attributeContext||(this._selectedSpans[0].textContent!==this.filterText)){return true;}}else if(this._uiModel&&this._uiModel.length>0){e=this._uiModel[this._uiModel.length-1];}if(e&&(e.tokenType===h.WS||e.tokenType===h.UNDEFINED)){return true;}if(e&&e.tokenType!==h.WS&&e.dataObjectType&&e.dataObjectType!=="S"&&e.dataObjectType!=="T"&&e.dataObjectType!=="AO"&&(e.tokenType===h.TERM&&!e.getText().endsWith(h.DOT))){i=false;}else if(e&&e.tokenType!==h.WS&&e.tokenType!==h.TERM&&e.reference===undefined){i=false;}else if(e&&e.tokenType!==h.WS&&this._isFirstTokenUpdateOrAppendOperation()&&!this._attributeContext){i=false;}else if(e&&(e.tokenType==="D"||e.tokenType==="T")&&this._uiModel[0]&&"getText"in this._uiModel[0]){i=false;}else if(e&&e.tokenType==="ID"&&!e.dataObjectType){var r=e.getReference()?e.getReference().split("/")[1]:"";if(T.getInstance().getTermByTermId(r).isResultDataObjectElement){i=false;}}return i;},_addItemToEmptyInput:function(e,i,s,r){if(r.resultDataObjectId&&r.resultDataObjectId!==""&&r.tokenType===h.TERM){this.ruleContext=true;}i=this._createSpanItem(r);this._uiModel.push(r);this._uiModeltoString();this._uiModel=this._convertInputToUiModel(this.relString);this._cursorPostion=r.text.length;this._uiModelToSpan(this._uiModel);this._selectedSpans=i;if(this.getIsAttributeContext()&&!this.isAssociation&&!r.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}},_addAtBeginningForInBetween:function(e,s,i,r){$(e[0]).insertBefore(s);this._cursorPostion=r.text.length;this._selectedSpans=$(e);$(i[0]).insertBefore(s);r.bAddSpaceAutoMatically=false;if(!r.text.endsWith(h.DOT)){this._cursorPostion+=1;this._selectedSpans=$(i);this.nIndexOfToken+=1;}},_handleUndefinedForInBetween:function(e,i,r,s,t,u){if(e.textContent.startsWith(h.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=i.text;this._cursorPostion+=i.text.length;}else{var v=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=i.text;this._cursorPostion+=i.text.length-v;this._replacePreviousUndefinedTokens();if(r&&r.getAttribute(h.TOKEN_TYPE)===h.TERM&&r.textContent.endsWith(h.DOT)){this.nIndexOfToken-=1;}}if(s&&s.getAttribute(h.TOKEN_TYPE)!==h.WS){$(t[0]).insertAfter(u);i.bAddSpaceAutoMatically=false;}if(i.reference){this._selectedSpans[0].setAttribute(h.REFERENCE,i.reference);}if(i.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(i.json));}},_addInBetweenTermsForInBetween:function(e,i,s,r,t){if(this.filterText.indexOf(h.DOT)>-1){this._appendItemText(this.filterText,e,r);}else if(this.getOperationsContext()&&this.bEditInBetween&&e.getAttribute("tokentype")==="ID"&&e.textContent.endsWith(h.DOT)){this._appendItemText(e.textContent,e,r);}else{this._selectedSpans[0].textContent=r.text;this._selectedSpans[0].setAttribute("reference",r.reference);}this._cursorPostion=this._cursorPostion-this.filterText.length+this._selectedSpans[0].textContent.length;},_appendItemText:function(e,r,s){var t=e.split(h.DOT);var u=r.getAttribute("reference").split("/");var v="";var w="";for(var i=0;i<t.length-1;i++){w+=t[i]+h.DOT;v+="/"+u[i+1];}if(u[0]===h.DOT){v=h.DOT+v;}s.reference=s.reference.replace(".","");this._selectedSpans[0].textContent=w+s.text;this._selectedSpans[0].setAttribute("reference",v+s.reference);},_addItemInBetween:function(e,i,s,r,t){var u=i.previousSibling;var v=i.nextSibling;e=this._createSpanItem(r);var w=this._getNewSpaceSpan();if(this._cursorPostion===0&&this.nIndexOfToken===0&&!u){this._addAtBeginningForInBetween(e,s,w,r);}else if(i.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){this._handleUndefinedForInBetween(i,r,u,v,w,s);}else if(r.json){$(e[0]).insertAfter(s);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1;if(v.getAttribute(h.TOKEN_TYPE)!==h.WS){$(w[0]).insertAfter(s);r.bAddSpaceAutoMatically=false;this.nIndexOfToken+=1;}}else if((i.getAttribute(h.TOKEN_TYPE)===h.TERM&&!(i.textContent.endsWith(h.DOT)&&this.filterText===i.textContent))||(i.getAttribute(h.TOKEN_TYPE)===h.FUNCTION&&i.textContent.length===1)){if(this.getOperationsContext()&&this._attributeContext&&e[0].textContent===h.DOT){this._selectedSpans[0].textContent+=r.text;this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{this._addInBetweenTermsForInBetween(i,e,s,r,w);}}else if(i.getAttribute(h.TOKEN_TYPE)===h.TERM&&i.textContent.endsWith(h.DOT)){this._selectedSpans[0].textContent+=r.text;if(r.text===h.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{if(r.reference){var x=i.getAttribute(h.REFERENCE)?i.getAttribute(h.REFERENCE)+r.reference:r.reference;this._selectedSpans[0].setAttribute(h.REFERENCE,x);}if(r.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(r.json));}}this._cursorPostion+=r.text.length;}else if(i.className==="sapAstLiteralClass"){var y=this.filterTextLength;if(this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)==h.DATEBUSINESSDATATYPE||this._selectedSpans[0].getAttribute(h.TOKEN_TYPE)===h.TIMEBUSINESSDATATYPE){this._selectedSpans[0].setAttribute(h.REFERENCE,r.text);}this._selectedSpans[0].textContent=r.text;this._cursorPostion+=r.text.length-y;if(v&&v.getAttribute(h.TOKEN_TYPE)===h.WS){r.bAddSpaceAutoMatically=false;}}else if(t){var y=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=r.text;this._cursorPostion+=r.text.length-y;if(u&&u.getAttribute(h.TOKEN_TYPE)===h.TERM&&u.textContent.endsWith(h.DOT)){this.nIndexOfToken-=1;}if(r.reference){this._selectedSpans[0].setAttribute(h.REFERENCE,r.reference);}}else{$(e[0]).insertAfter(s);if(i.getAttribute(h.TOKEN_TYPE)!==h.WS){$(w[0]).insertAfter(s);this._cursorPostion+=1;this.nIndexOfToken+=1;}this._selectedSpans=$(e);this._cursorPostion+=e[0].textContent.length;if(!this._isLastTokenSpaceItem()){this._addSpace();}else{this.nIndexOfToken+=1;}if(v&&v.getAttribute(h.TOKEN_TYPE)!==h.WS){w=this._getNewSpaceSpan();$(w[0]).insertAfter($("#"+this._selectedSpans[0].id));r.bAddSpaceAutoMatically=false;}}if(r.text.endsWith(" (")){this.nIndexOfToken+=2;}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._getSelectedSpanFromIndex();this._getSuggestionsForEditedInput(false);},_addItemsToTheEnd:function(e,i,s,r,t){if(i.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){if(i.textContent.startsWith(h.SINGLE_QUOTE)){this._selectedSpans[0].textContent+=r.text;this._cursorPostion+=r.text.length;}else{var u=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=r.text;this._cursorPostion+=r.text.length-u;if(r.tokenType===h.TERM){this._cursorPostion+=1;}this._replacePreviousUndefinedTokens();}if(r.reference){this._selectedSpans[0].setAttribute(h.REFERENCE,r.reference);}if(r.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(r.json));}}else if(r.json||i.getAttribute(h.TOKEN_TYPE)===h.WS){e=this._createSpanItem(r);$(e[0]).insertAfter(s);this._selectedSpans=e;this._cursorPostion+=e[0].textContent.length;this.nIndexOfToken+=1;}else if(t){var u=this._selectedSpans[0].textContent.length;this._selectedSpans[0].textContent=r.text;this._cursorPostion+=r.text.length-u;if(r.tokenType===h.TERM){this._cursorPostion+=1;}if(r.reference){this._selectedSpans[0].setAttribute(h.REFERENCE,r.reference);}}else{this._selectedSpans[0].textContent+=r.text;if(r.text===h.DOT&&this._attributeContext){this.isAutoSuggestionRequired=true;this.dotInOperationsContext=true;this._cursorPostion=this._cursorPostion+1;}else{if(r.reference){var v=this._selectedSpans[0].getAttribute(h.REFERENCE)?this._selectedSpans[0].getAttribute(h.REFERENCE)+r.reference:r.reference;this._selectedSpans[0].setAttribute(h.REFERENCE,v);}if(r.json){this._selectedSpans[0].setAttribute(h.JSON,JSON.stringify(r.json));}this._cursorPostion+=r.text.length;}}this._updateUiModel();this._uiModel=this._convertInputToUiModel(this.relString);this._uiModelToSpan(this._uiModel);this._hasTextContent=true;if(this.getIsAttributeContext()&&!this.isAssociation&&!r.json&&this._oAutoSuggestionPopUp&&this._oAutoSuggestionPopUp.isOpen()){this.isAutoSuggestionRequired=false;this._oAutoSuggestionPopUp.close();}},_bReplaceFunctionWithSelectedItem:function(e,i){if(e&&e.className==="sapAstFunctionClass"){var r=i.text.toLowerCase();var s=i.label?i.label.toLowerCase():"";var t=e.textContent.toLowerCase();return(r.startsWith(t)||s.indexOf(t)>-1);}return false;},_resetCursorForRerendering:function(){var e=0;if(this.bEditInBetween){e=this._getFullTextContentLength();if(e!==this._cursorPostion&&this._cursorPostion!==0){this._cursorPostion=e;}}},_getFullTextContentLength:function(){var e=0;for(var i=0;i<=this.nIndexOfToken;i++){e+=this._getSelectedSpanGivenIndex(i)[0].textContent.length;}return e;},_setTextOnCursorPosition:function(e){this.dotInOperationsContext=false;this.bTypingFlow=false;var i;this._resetCursorForRerendering();var r=this._selectedSpans?this._selectedSpans[0]:{};var s="#"+r.id;var t=(r.getAttribute(h.TOKEN_TYPE)===h.WS||this._uiModel.length===0)?"":r.id;var u=this._getItemFromSuggestionModel(e,t);this.ruleContext=false;this.forceFireChange=false;var v=this._bReplaceFunctionWithSelectedItem(r,u);if(!this._selectedSpans[0].textContent.endsWith(".")&&!v&&!this._isLastTokenSpaceItem()&&e.getSource().mProperties&&e.getSource().mProperties.label&&e.getSource().mProperties.label!==h.DOT&&this._cursorPostion>0){this._createSpaceSpanItem();r=this._selectedSpans[0];s="#"+r.id;}if(e&&e.getSource()&&e.getSource().mProperties.forceFireChange){this.forceFireChange=true;}if(this._uiModel.length===0){this._addItemToEmptyInput(e,i,s,u);}else if(r&&this.bEditInBetween){this._addItemInBetween(i,r,s,u,v);}else if(r){this._addItemsToTheEnd(i,r,s,u,v);if(this.isAssociation){this._cursorPostion+=1;}}else{console.error("could not find the user selected span - currentSpan");}if(this._bPopUpFocused){this._input.focus();this._bPopUpFocused=false;}if(!this.bEditInBetween){this.nIndexOfToken=this._input.children().length-1;this._selectedSpans=[];this._selectedSpans.push(this._input.children()[this._input.children().length-1]);}this._setCaretPosition({spanIndex:this.nIndexOfToken,position:this._selectedSpans[0]?this._selectedSpans[0].textContent.length:this._cursorPostion});if(this.isAutoSuggestionRequired){if((u.bAddSpaceAutoMatically&&!this._isLastTokenSpaceItem())&&!(this.bEditInBetween&&this._uiModel[this.nIndexOfToken+1].tokenType===h.WS)){this._addSpace();}else{if(this.bEditInBetween&&!this._isLastTokenSpaceItem()){this._setCaretPosition({spanIndex:this.nIndexOfToken+1,position:1});}else if(!this.bEditInBetween){this._suggestionsList=this._getSuggestionsForTheGivenInput(this.relString);}this._showAutoSuggestion(this._suggestionsList);}}},_replacePreviousUndefinedTokens:function(){var e=this._selectedSpans[0];var i=e.previousSibling;var r;while(i&&i.previousSibling){if((i.getAttribute(h.TOKEN_TYPE)===h.WS&&i.previousSibling.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED)||i.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){r=i;i=i.previousSibling;r.remove();this.nIndexOfToken-=1;}else{break;}}if(i&&!i.previousSibling&&i.getAttribute(h.TOKEN_TYPE)===h.UNDEFINED){i.remove();this.nIndexOfToken-=1;}},_getItemFromSuggestionModel:function(e,i){this._attributeContext=false;this.isAssociation=false;var r={};var s=e.getSource();r.id=this._createUUID();if(s&&s.getBindingContext()){var B=s.getBindingContext().getObject();r.dataObjectType=B.type;if(B.ResultDataObjectId){r.resultDataObjectId=B.ResultDataObjectId;if(B.displayType&&B.displayType==="Rule"||r.resultDataObjectId){var t=this._oAstExpressionLanguage._astBunldeInstance.TermsProvider.TermsProvider;var u=t.getTermByTermId(B.ResultDataObjectId);if(u&&u.getIsDataObjectElement()){this.ruleWithElementDO=true;r.dataObjectType="ruleWithElementDO";r.cssClass="sapAstObjectClass";r.tokenType=h.TERM;r.text=(B.label!==null&&B.label!=="")?B.label:B.name;r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;r.id=B.id?"/"+B.id:"";r.reference=B.id?"/"+B.id:"";}else{var r=this._createObjectSpanItem(r,i,B);}}}else if(B.type===h.Element){r.tokenType=h.TERM;r.cssClass="sapAstObjectClass";r.id="";r.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(this.getDataObjectInfo()&&this.isDotRequired&&!B.isParentEntity){r.reference=B.id?"./"+B.id:"";}else{this.isDotRequired=true;r.reference=B.id?"/"+B.id:"";}r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;if(i&&i.indexOf("-")>0){i=i.substring(i.indexOf("-")+1)}r.id=i!==''?i+h.DOT+B.id:B.id;var v=T.getInstance();var w=v.getTermByTermId(r.id);if(w&&w._isDataObjectElement){r._isDataObjectElement=true;}}else if("type"in B){var r=this._createObjectSpanItem(r,i,B);}else{r.text=B.name;if(B&&"noOfMandatoryArgs"in B){if(B.noOfMandatoryArgs==="0"){r.text+=" ( )";}else{r.text+=" (";}}r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;}}else if(e.getParameter("tokens")){var V=e.getParameter("tokens")[0].data("row");;r.text=V.Value;r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;r.cssClass="sapAstLiteralClass";}else if(e.getSource().mProperties.jsonData){r.text=e.getSource().mProperties.value;r.json=e.getSource().mProperties.jsonData;r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;}else{r.text=e.getSource().mProperties.value.trim();r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=true;}if(this.getDataObjectInfo()&&!this.bEditInBetween){if(r.json){this.dataObjectInfo+=this._constructExpandedRelString(r.json);}else if(this.getIsAttributeContext()&&r.text=="."){this.dataObjectInfo+=r.reference?r.reference.replace(".",""):r.text;}else if(r.text!="."){this.dataObjectInfo+=r.reference?r.reference:r.text;}if(r&&r.dataObjectType==="E"){this.dataObjectInfo+=" ";}}if(e.getSource().mProperties.label===h.DOT){r.bAddDotAutomatically=false;r.bAddSpaceAutoMatically=false;this._attributeContext=true;}return r;},_createObjectSpanItem:function(i,e,B){i.tokenType=h.TERM;i.cssClass="sapAstObjectClass";i.id="";i.text=(B.label!==null&&B.label!=="")?B.label:B.name;if(B.type!==h.ASSOCIATIONDOTYPE){i.reference=B.id?"/"+B.id:"";if(e&&e.indexOf("-")>0){e=e.substring(e.indexOf("-")+1)}i.id=e!==''?e+h.DOT+B.id:B.id;}else{this.isAssociation=true;if(this.getDataObjectInfo()&&this.isDotRequired){i.reference=B.id?"./"+B.id:"";this.isDotRequired=false;}else{i.reference=B.id?"/"+B.id:"";}i.id+=B.id;}if(this.getDataObjectInfo()){this.isDotRequired=false;}this._attributeContext=true;i.bAddDotAutomatically=true;i.bAddSpaceAutoMatically=false;if(this._isFirstTokenUpdateOrAppendOperation()&&this.getOperationsContext()&&!this.getConditionContext()){this._attributeContext=false;i.bAddDotAutomatically=false;i.bAddSpaceAutoMatically=false;this.isDotRequired=false;}return i;},_createPopver:function(){var t=this;if(!this._oAutoSuggestionPopUp){this._oAutoSuggestionPopUp=new R("autoCompletePopover_"+this._createUUID(),{content:new sap.rules.ui.AutoCompleteSuggestionContent(),showArrow:false,placement:P.Vertical,horizontalScrolling:true,showHeader:true,contentWidth:"400px",title:this.oBundle.getText("astSuggestionDialogTitle"),initialFocus:t,afterOpen:function(){var e;if(t.bEditInBetween){e=t.filterTextLength;}else{e=t._selectedSpans[0].textContent.length;}var i=t._cursorPostion===0?0:e;t._setCaretPosition({spanIndex:t.nIndexOfToken,position:i});}});}},_getCaretPosition:function(I,s){var r,t,u,v=0;var w=function(N){return(I&&N===I)||(!I&&(N===t.anchorNode||N===t.anchorNode.parentNode));};var x=function(N){var y;if(w(N)){return false;}if(N.nodeType===3){v+=N.textContent.length;}else{for(var i=0;i<N.childNodes.length;i++){y=N.childNodes[i];if(w(y)){return false;}v+=y.textContent.length;}}return true;};try{if(window.getSelection&&window.getSelection().getRangeAt){r=window.getSelection().getRangeAt(0);t=window.getSelection();u=this._input[0].childNodes;for(var i=0;i<u.length;i++){if(!x(u[i])){break;}}return(s||r.startOffset)+v;}}catch(e){return this._cursorPostion;}return 0;},_getSelectedSpans:function(){var s=window.getSelection();var e=new Array();if("getRangeAt"in s){var r=s.getRangeAt(0);if(r.startContainer==r.endContainer){e.push(r.startContainer.parentNode);}else{var i=$(r.startContainer.parentNode);var t=$(r.endContainer.parentNode);e.push(i);$(r.startContainer.parentNode).nextAll().each(function(){var u=$(this).attr('id');if(u!=$(t).attr('id')){e.push($(this));}else{e.push(t);return false;}});}}else{e.push(s.anchorNode.parentNode);}return e;},_createRange:function(e,i,r){if(!r){r=document.createRange();r.selectNode(e);r.setStart(e,0);}if(i.count===0){r.setEnd(e,i.count);}else if(e&&i.count>0){if(e.nodeType===Node.TEXT_NODE){if(e.textContent!=undefined&&e.textContent.length<i.count){i.count-=e.textContent.length;}else{r.setEnd(e,i.count);i.count=0;}}else{for(var s=0;s<e.childNodes.length;s++){r=this._createRange(e.childNodes[s],i,r);if(i.count===0){break;}}}}return r;},_setCurrentCursorPosition:function(e){if(e>=0){var s=window.getSelection();var r=this._createRange($("#"+this.getDomRef("input").id)[0],{count:e});if(r){r.collapse(false);s.removeAllRanges();s.addRange(r);}}},_updateUiModel:function(){var t=this;if(this.getDomRef("input")){var i=this.getDomRef("input").children;t._uiModel=[];for(var r=0;r<i.length;r++){var s=i[r].getAttribute(h.TOKEN_TYPE)!==h.GEOBUSINESSDATATYPE?i[r].getAttribute(h.REFERENCE):undefined;var u=i[r].getAttribute(h.JSON);var v={"id":i[r].id,"cssClass":i[r].className,"reference":s,"tokenType":i[r].getAttribute(h.TOKEN_TYPE),"text":i[r].textContent};if(u){try{v.json=JSON.parse(u);}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}this._uiModel.push(v);}t._uiModeltoString();}},_uiModeltoString:function(){var t=this;t.relString="";t._jsonArray=[];this._uiModel.forEach(function(i,e){if(i.reference){t.relString+=i.reference;}else if(i.json){t.relString+=t._constructExpandedRelString(i.json);t._jsonArray.push(i.json);}else{t.relString+=i.text;}});return t.relString;},_calculateStringAndIndexOfNewToken:function(){var t=this;var i="";var r="";if(this.getDomRef("input")){var s=this.getDomRef("input").children;var u=this._selectedSpans?this._selectedSpans[0].id:"";for(var v=0;v<s.length;v++){var w=s[v].getAttribute(h.TOKEN_TYPE)!==h.GEOBUSINESSDATATYPE?s[v].getAttribute(h.REFERENCE):undefined;var x=s[v].getAttribute(h.JSON);if(x){try{x=JSON.parse(x);}catch(e){q.sap.log.error("Error in parsing string to JSON: "+e.message);}}if(s[v].id===u){this.nIndexOfToken=v;var y=r+s[v].textContent;var z=s[v].textContent;var B=y.length-this._cursorPostion;this.filterTextLength=B>=0?z.length-B:z.length;var D=this.filterTextLength<0?z:z.slice(0,this.filterTextLength);this.filterText=D;if(w){i+=this._constructReferenceForFilter(D,w,B);}else if(x){i+=t._constructExpandedRelString(x);}else{i+=D;}break;}r+=s[v].textContent;if(w){i+=w;}else if(x){i+=t._constructExpandedRelString(x);}else{i+=s[v].textContent;}}}return i;},_constructReferenceForFilter:function(e,r,s){var t=e.split(".");var u=r.split("/");var v="";if((s<=0&&t.length===0)||(this._enableAggregateFunctionWhereClause&&r&&s<=0)){return r;}if(t.length>1){if(s<=0){if(this.bTypingFlow){return r+t[t.length-1];}else{return r;}}for(var i=1;i<t.length;i++){v+="/"+u[i];}v+=t[t.length-1];this._attributeContext=true;}else{v=e;this._attributeContext=false;}return v;},_getSelectedSpanFromIndex:function(){if(this.getDomRef("input")){var e=this.getDomRef("input").children;this._selectedSpans=$(e[this.nIndexOfToken]);}},_getSelectedSpanGivenIndex:function(i){if(this.getDomRef("input")){var e=this.getDomRef("input").children;if(e[i]){return $(e[i]);}else{return null;}}},_isChildOf:function(e,i){while(e!==null){if(e.id===i){return true;}e=e.parentNode;}return false;},_getCurrentCursorPosition:function(){var e=this.getDomRef("input").id;var s=window.getSelection(),i=-1,r;if(s.focusNode){if(this._isChildOf(s.focusNode,e)){r=s.focusNode;i=s.focusOffset;while(r){if(r.id===e){break;}if(r.previousSibling){r=r.previousSibling;i+=r.textContent.length;}else{r=r.parentNode;if(r===null){break}}}}}return i;},_hiddenAccessModeSelected:function(e,D,i){if(this._input&&this._input[0].id===i.expId){this.expId=i.expId}},_validateControl:function(){var v=this.getValueState();var e=this.getValueStateText();if((this.astresponseNodes&&this.astresponseNodes.length===1&&this.astresponseNodes[0].Type==="I")&&this.astresponseNodes[0].Value!==""||(this.astresponseNodes&&v==="Error")){this._input[0].classList.add("sapAstExpressionInputError");if(e){this._input[0].title=e;}else{this._input[0].title=this.oBundle.getText("invalidExpression");}}else if(this.oBundle.getText("PredefinedResultsValueStateText")===e){this._input[0].classList.add("sapAstExpressionInputError");if(e){this._input[0].title=e;}else{this._input[0].title=this.oBundle.getText("invalidExpression");}}else if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.add("sapAstExpressionInputError");this._input[0].title=this.oBundle.getText("PredefinedResultsValueStateText");this.expId="";}else if(this._input[0].id===this.expId&&this._input[0].textContent!==""){this.expId="";}else{if(this._input[0].classList.contains("sapAstExpressionInputError")){this._input[0].classList.remove("sapAstExpressionInputError");}}}});return p;},true);
