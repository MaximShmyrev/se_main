// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/GenericTile","sap/m/ImageContent","sap/m/library","sap/m/NumericContent","sap/m/TileContent","sap/f/GridContainerItemLayoutData","sap/ui/core/message/Message","sap/ui/core/MessageType","sap/ui/events/KeyCodes","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/library"],function(G,I,m,N,T,a,M,b,K,J,C,u){"use strict";var c=m.GenericTileMode;var d=m.GenericTileScope;var F=m.FrameType;var L=m.LoadState;var D=u.DisplayFormat;var p,P,r={},v=new J({sizeBehavior:C.last("/core/home/sizeBehavior")}),_=C.on("/core/home/sizeBehavior").do(function(s){v.setProperty("/sizeBehavior",s);});function e(k,l){if(k&&k.isA&&k.isA(l)){return k;}else if(k&&k.getParent){return e(k.getParent(),l);}return null;}function f(k,s,l,n){var o=!!s.length;if(o&&(l.indexOf(k)===-1)){return L.Failed;}else if(o&&(n.indexOf(k)===-1)){return L.Failed;}return L.Loaded;}function g(k,l,t){if(k===D.Compact){return c.LineMode;}if(t!=="DYNAMIC"&&!l){return c.HeaderMode;}return c.ContentMode;}function h(k){switch(k){case D.Standard:case D.Default:return F.OneByOne;case D.Flat:return F.OneByHalf;case D.FlatWide:return F.TwoByHalf;case D.StandardWide:return F.TwoByOne;default:return F.Auto;}}function i(t){return new T({footer:t.tileType!=="STATIC"&&t.tileType!=="DYNAMIC"&&!t.info?"["+r.i18n.getText("Title.CustomTile")+"]":t.info,content:t.tileType==="DYNAMIC"?new N({truncateValueTo:5,icon:t.iconUrl,width:"100%",withMargin:false}):new I({src:t.iconUrl}).addStyleClass("sapUshellFullWidth")});}function j(k){return new a({rows:(k===D.Flat||k===D.FlatWide)?1:2,columns:k===D.FlatWide?4:2});}return{init:function(o){p=o;r.i18n=p.getResourceBundle();P=p.getView().byId("page");P.setModel(p.getModel());P.setModel(v,"viewSettings");},exit:function(){_.off();},visualizationFactory:function(s,B,k){var V=B.getProperty();function l(E){if(E.getParameter("context")===B){V=B.getProperty();var n=B.getPath().split("/"),S=n[3],o=n[5],q=P.getSections()[S],t=q.getVisualizations()[o];switch(E.getParameter("path")){case"title":t.setHeader(V.title);break;case"subTitle":t.setSubHeader(V.subheader);break;case"catalogTileId":var R=P.getModel("roles"),w=R.getProperty("/selected"),A=R.getProperty("/allVisualizations"),x=R.getProperty("/availableVisualizations");t.setState(f(V.catalogTileId,w,A,x));break;case"displayFormatHint":t.setFrameType(h(V.displayFormatHint));t.setLayoutData(j(V.displayFormatHint));t.setMode(g(V.displayFormatHint,V.iconUrl,V.tileType));t.setTileContent(i(V));break;case"iconUrl":case"tileType":t.setMode(g(V.displayFormatHint,V.iconUrl,V.tileType));t.setTileContent(i(V));break;case"info":t.setTileContent(i(V));break;default:return;}}}B.getModel().attachPropertyChange(l);return new G({header:"{title}",subheader:"{subTitle}",failedText:r.i18n.getText("Message.OutOfRoleContext"),frameType:{path:"displayFormatHint",formatter:h},mode:{parts:["displayFormatHint","iconUrl","tileType"],formatter:g},scope:"{= (${/editMode} && !"+k+") ? '"+d.Actions+"' : '"+d.Display+"'}",sizeBehavior:"{viewSettings>/sizeBehavior}",state:{parts:["catalogTileId","roles>/selected","roles>/allVisualizations","roles>/availableVisualizations"],formatter:f},layoutData:j(V.displayFormatHint),tileContent:i(V),press:function(E){var o=E.getSource();switch(E.getParameter("action")){case"Remove":var S=e(o,"sap.ushell.ui.launchpad.Section"),n=P.indexOfSection(S),q=S.indexOfVisualization(o);p.removeVisualizationInSection(q,n);B.getModel().detachPropertyChange(l);break;case"Press":default:p._openTileInfoPopover(o,o.getBindingContext());break;}}});},previewVisualizationFactory:function(s,B){return this.visualizationFactory(s,B,true);},collectMessages:function(){var E=[],w=[],k=[],R=p.getModel("roles"),s=R.getProperty("/selected")||[],A=R.getProperty("/allVisualizations"),l=R.getProperty("/availableVisualizations"),n=!!s.length,o=sap.ui.getCore().getMessageManager(),q=o.getMessageModel().getProperty("/")||[];q.forEach(function(t){if((t.code!=="LanguageTranslationTool.UploadSuccess")&&(t.code!=="LanguageTranslationTool.UploadFileError")){return;}switch(t.type){case b.Error:t.type=b.Warning;case b.Warning:w.push(t);break;default:k.push(t);break;}});P.getSections().forEach(function(S,t){var x=S.byId("title-edit");if(S.getTitle()===""){x.setValueState("Warning");x.setValueStateText(r.i18n.getText("Message.InvalidSectionTitle"));w.push(new M({type:b.Warning,message:r.i18n.getText("Title.NoSectionTitle",t+1),description:r.i18n.getText("Message.NoSectionTitle",t+1)}));}else{x.setValueState("None");}var V=S.getBindingContext().getProperty("viz")||[];V.forEach(function(y,z){var B=y.tileType&&!y.deviceDesktop&&!y.devicePhone&&!y.deviceTablet;if(B){w.push(new M({type:b.Warning,message:r.i18n.getText("Title.NoFormFactor"),description:r.i18n.getText("Message.NoFormFactor",[y.title,(z+1),S.getTitle()])}));}if(n&&(A.indexOf(y.catalogTileId)===-1)){k.push(new M({type:b.Information,message:r.i18n.getText("Title.InsufficientRoles"),description:r.i18n.getText("Message.InsufficientRoles",[(z+1),S.getTitle(),y.catalogDisplayId])}));}else if(n&&(l.indexOf(y.catalogTileId)===-1)){k.push(new M({type:b.Information,message:r.i18n.getText("Title.NotAvailableInRoleContext"),description:r.i18n.getText("Message.NotAvailableInRoleContext",[y.title,(z+1),S.getTitle()])}));}});});return{errors:E,warnings:w,infos:k};},refreshRoleContext:function(){p.getModel().getBindings().forEach(function(B){if(B.sInternalType==="sap.ushell.VisualizationLoadState"){B.refresh(true);}});},onAreaDragEnter:function(E){var s=E.getParameter("sourceArea");var t=E.getParameter("targetArea");if(s===t){return;}var o=E.getParameter("dragControl");var k=o.getBindingContext().getProperty("");var S=this.getSupportedDisplayFormats(k.tileType);var l=S.some(function(n){return(n.value===t);});if(!l){E.getParameter("originalEvent").preventDefault();}},addSection:function(E){var s=E?E.getParameter("index"):0;p.addSectionAt(s);},deleteSection:function(E){var s=E.getSource(),t=s.getTitle(),k=t?r.i18n.getText("Message.Section.Delete",t):r.i18n.getText("Message.Section.DeleteNoTitle");sap.ui.require(["sap/m/MessageBox"],function(l){l.confirm(k,{icon:l.Icon.WARNING,title:r.i18n.getText("Button.Delete"),actions:[l.Action.DELETE,l.Action.CANCEL],emphasizedAction:l.Action.DELETE,initialFocus:l.Action.CANCEL,onClose:function(A){if(A===l.Action.DELETE){p.deleteSection(P.indexOfSection(s));}}});});},moveSection:function(o){var k=o.getParameter("draggedControl"),l=o.getParameter("droppedControl"),s=o.getParameter("dropPosition"),n=P.indexOfSection(k),q=P.indexOfSection(l);if(s==="After"){if(q<n){q++;}}else if(q>n){q--;}p.moveSection(n,q);},moveVisualization:function(o){var k=o.getParameter("draggedControl"),l=o.getParameter("droppedControl"),s=o.getParameter("dropPosition"),B=o.getParameter("browserEvent"),n=B&&B.keyCode,q=e(k,"sap.ushell.ui.launchpad.Section"),t=P.indexOfSection(q),w=q&&q.indexOfVisualization(k),x=q&&q.getVisualizations()[w],y=q?q.getItemPosition(x):{},z,A,E,H,O;if(!l){var U=n===K.ARROW_UP;A=U?t-1:t+1;z=P.getSections()[A];if(z){E=z.getClosestCompactItemIndex(k.getDomRef(),U);H=z.getVisualizations()[E];O=z.getItemPosition(H);if(O.area!==y.area){O=y;}}else{x.invalidate();return;}}else{z=e(l,"sap.ushell.ui.launchpad.Section");A=P.indexOfSection(z);E=z.indexOfVisualization(l);H=z.getVisualizations()[E];O=z.getItemPosition(H);if(t===A){if(s==="Before"&&w<E){E--;}else if(s==="After"&&w>E){E++;}if(w===E&&O.area===y.area){x.invalidate();return;}}else if(s==="After"){E++;}}if((t!==A)&&(n===K.ARROW_UP||n===K.ARROW_DOWN)&&(y.index>O.index)){E++;}if(k.isA("sap.m.ListItemBase")){var Q=o.getParameter("dragSession").getComplexData("callback");if(s==="After"){E++;}Q(E,A,O.area);}else if(p.moveVisualizationInSection(w,E,t,A,O.area)){var V=z.getVisualizations()[E];if(V){z.focusVisualization(V);V.invalidate();}}},addVisualization:function(o){var k=o.getParameter("draggedControl"),l=o.getParameter("droppedControl"),n=l.getVisualizations().length,q=P.indexOfSection(l);if(k.isA("sap.m.ListItemBase")){o.getParameter("dragSession").getComplexData("callback")(n,q);return;}var s=e(k,"sap.ushell.ui.launchpad.Section"),t=s.indexOfVisualization(k),w=P.indexOfSection(s);if(w===q){return;}p.moveVisualizationInSection(t,n,w,q);}};});
