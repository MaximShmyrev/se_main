// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["../util/Transport","sap/base/Log","sap/m/library","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/core/routing/History","sap/ui/core/UIComponent","sap/ui/model/json/JSONModel","sap/ushell/library","sap/ui/core/SortOrder"],function(T,L,m,M,F,C,H,U,J,u,S){"use strict";var D=u.DisplayFormat;var a=m.LoadState;var V=u.VisualizationLoadState;return C.extend("sap.ushell.applications.PageComposer.controller.BaseController",{getPageRepository:function(){return this.getOwnerComponent().getPageRepository();},getRouter:function(){return U.getRouterFor(this);},getModel:function(n){return this.getView().getModel(n);},setModel:function(o,n){return this.getView().setModel(o,n);},getRootView:function(){return this.getOwnerComponent().getRootControl();},getResourceBundle:function(){return this.getOwnerComponent().getModel("i18n").getResourceBundle();},getTransportHelper:function(){if(!this.oTransportHelper){this.oTransportHelper=new T();}return this.oTransportHelper;},_createEditDialog:function(o,b){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/EditDialog.controller"],function(E){if(!this.oEditPageDialogController){this.oEditPageDialogController=new E(this.getRootView(),this.getResourceBundle());}else{this.oEditPageDialogController._resetModel();}this.oEditPageDialogController.attachCancel(b);this.oEditPageDialogController.attachConfirm(o);this.oEditPageDialogController.load().then(function(){r(this.oEditPageDialogController);}.bind(this));}.bind(this));}.bind(this));},showCreateDialog:function(o,b){return new Promise(function(r,c){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CreatePageDialog.controller"],function(d){if(!this.oCreatePageDialogController){this.oCreatePageDialogController=new d(this.getRootView(),this.getResourceBundle());}else{this.oCreatePageDialogController._resetModel();}this.oCreatePageDialogController.attachConfirm(o);this.oCreatePageDialogController.attachCancel(b);this.oCreatePageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCreatePageDialogController,t,o);}.bind(this));}return this.oCreatePageDialogController;}.bind(this)).then(function(e){if(e){e.open();}r();}).catch(function(e){this.oCreatePageDialogController.destroy();this.handleBackendError(e);c();}.bind(this));}.bind(this));}.bind(this));},_createDeleteDialog:function(o,b){return new Promise(function(r){sap.ui.require(["sap/ushell/applications/PageComposer/controller/DeleteDialog.controller"],function(c){if(!this.oDeletePageDialogController){this.oDeletePageDialogController=new c(this.getRootView(),this.getResourceBundle());}else{this.oDeletePageDialogController._resetModel();}this.oDeletePageDialogController.attachCancel(b);this.oDeletePageDialogController.attachConfirm(o);this.oDeletePageDialogController.load().then(function(){r(this.oDeletePageDialogController);}.bind(this));}.bind(this));}.bind(this));},checkShowEditDialog:function(p,o,b){var e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return Promise.resolve();}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p,"Page",true),t.showLockedMessage(p)]).then(function(r){var s=r[0],l=r[1];if(l){this.showMessageBoxError(this.getResourceBundle().getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else if(s){this._createEditDialog(o,b).then(function(d){d.getModel().setProperty("/message",this.getResourceBundle().getText("EditDialog.TransportRequired"));var E=this.getTransportHelper().enhanceDialogWithTransport(d,t,o,p);E.open();}.bind(this)).catch(e);}else{o(t.decorateResultWithTransportInformation());}}.bind(this)).catch(e);}.bind(this)).catch(e);},checkShowDeleteDialog:function(p,o,b){var r=this.getResourceBundle(),e=this.handleBackendError.bind(this);if(!this.getOwnerComponent().isTransportSupported()){return this._createDeleteDialog(o,b).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));d.open();});}return this.getOwnerComponent().createTransportComponent(p.devclass).then(function(t){return Promise.all([t.showTransport(p,"Page"),t.showLockedMessage(p)]).then(function(R){var s=R[0],l=R[1];if(l){this.showMessageBoxError(r.getText("Dialog.LockedText",[p.transportId,l.foreignOwner]),true);}else{this._createDeleteDialog(o,b).then(function(d){d.getModel().setProperty("/message",r.getText("DeleteDialog.Text"));if(s){d.getModel().setProperty("/message",r.getText("DeleteDialog.TransportRequired"));d=this.getTransportHelper().enhanceDialogWithTransport(d,t,o,p);}else{d.getModel().setProperty("/validation/transportValid",true);this.getTransportHelper().attachConfirmHandler(d,t,o);}d.open();}.bind(this)).catch(e);}}.bind(this)).catch(e);}.bind(this)).catch(e);},showCopyDialog:function(p,o,b){return new Promise(function(r,c){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CopyPageDialog.controller"],function(d){if(!this.oCopyPageDialogController){this.oCopyPageDialogController=new d(this.getRootView(),this.getResourceBundle());}else{this.oCopyPageDialogController._resetModel();}this.oCopyPageDialogController.attachConfirm(o);this.oCopyPageDialogController.attachCancel(b);return this.oCopyPageDialogController.load().then(function(){if(this.getOwnerComponent().isTransportSupported()){return this.getOwnerComponent().createTransportComponent().then(function(t){return this.getTransportHelper().enhanceDialogWithTransport(this.oCopyPageDialogController,t,o);}.bind(this));}return this.oCopyPageDialogController;}.bind(this)).then(function(e){if(e){e.getModel().setProperty("/sourceId",p.id);e.getModel().setProperty("/sourceTitle",p.title);e.getModel().setProperty("/sourceDescription",p.description);e.getModel().setProperty("/title",p.title);e.getModel().setProperty("/description",p.description);e.open();}r();}).catch(function(e){this.oCopyPageDialogController.destroy();this.handleBackendError(e);c(e);}.bind(this));}.bind(this));}.bind(this));},getSupportedDisplayFormats:function(t){var i=this.getResourceBundle();var p=this.getModel("PageRepository");var d=p.getObject("/tileTypeSet('"+encodeURIComponent(t)+"')/vizOptions/displayFormats",{expand:"supported"});var s=(d&&d.supported)||[];s=s.map(function(o){if(o.id===D.Default){o.id=D.Standard;}var l=i.getText("DisplayFormat."+o.id);var P=(d.preferred===o.id);return{value:o.id,label:(P?i.getText("PreferredFormatter",[l]):l),preferred:P};});return s;},_openTileInfoPopover:function(o,b){var r=this.getRootView();if(!r.oTileInfoPopover){var f=r.createId("tileInfoPopover");F.load({id:f,name:"sap.ushell.applications.PageComposer.view.TileInfoPopover",controller:this}).then(function(d){r.oTileInfoPopover=d;r.oTileInfoPopover.displayFormatHint=F.byId(f,"displayFormatHint");r.addDependent(r.oTileInfoPopover);this._openTileInfoPopover(o,b);}.bind(this));}else{var t=b.getProperty("");var s=this.getSupportedDisplayFormats(t.tileType);var e=new J({displayFormats:s,supportedDisplayFormats:s.map(function(d){return d.label;}).join(", ")});if(o.isA("sap.m.GenericTile")){e.setProperty("/scope",o.getScope());if(o.getState()===a.Failed){var A=this.getModel("roles").getProperty("/allVisualizations");var c=this.getModel("roles").getProperty("/availableVisualizations");if(A&&A.indexOf(t.catalogTileId)===-1){e.setProperty("/state",V.InsufficientRoles);}else if(c&&c.indexOf(t.catalogTileId)===-1){e.setProperty("/state",V.OutOfRoleContext);}}}r.oTileInfoPopover.setModel(e,"extraData");r.oTileInfoPopover.setModel(b.getModel());r.oTileInfoPopover.bindObject({path:b.getPath()});r.oTileInfoPopover.openBy(o);}},showMessageBoxError:function(e,n){if(n){M.error(e,{onClose:this.navigateBack.bind(this)});}else{M.error(e);}},showMessageBoxWarning:function(w,W,n){if(n){M.warning(w,{onClose:this.navigateBack.bind(this),details:W});}else{M.warning(w,{details:W});}},navigateBack:function(){var h=H.getInstance();this.getPageRepository().abortPendingBackendRequests();if(h.getPreviousHash()!==undefined){window.history.go(-1);}else{this.getRouter().navTo("overview",{},true);}},navigateToErrorPage:function(p){this.getRouter().navTo("error",{pageId:encodeURIComponent(p)},null,true);},navigateToUnsupportedPage:function(p){this.getRouter().navTo("unsupported",{pageId:encodeURIComponent(p)},null,true);},navigateToEdit:function(p){var s=this.getOwnerComponent().getModel("settings");s.setProperty("/editMode",true);s.setProperty("/deepLink",false);this.getRouter().navTo("view",{pageId:encodeURIComponent(p)});},preview:function(){var p=this.getView();if(this.oPagePreviewDialogController){this.oPagePreviewDialogController.open(p);return;}sap.ui.require(["sap/ushell/applications/PageComposer/controller/PagePreviewDialog.controller"],function(P){this.oPagePreviewDialogController=P;this.oPagePreviewDialogController.open(p);}.bind(this));},onExit:function(){if(this.oPagePreviewDialogController){this.oPagePreviewDialogController.close();this.oPagePreviewDialogController.onAfterClose();delete this.oPagePreviewDialogController;}},checkMasterLanguageMismatch:function(p){var c=this.getOwnerComponent().getMetadata().getConfig().checkLanguageMismatch,s=sap.ui.getCore().getConfiguration().getSAPLogonLanguage().toUpperCase(),P=p.masterLanguage.toUpperCase();if(c&&s!==P){this.showMessageBoxError(this.getResourceBundle().getText("EditDialog.LanguageMismatch",[P,s]),true);return true;}return false;},handleBackendError:function(e){if(e.responseText){this.getOwnerComponent().showErrorDialog(e);}else if(e instanceof Error){L.error(e);}else{L.error(((e&&e.message)?e.message:"Unexpected error"),"PageComposer/controller/BaseController.js");}},_resetRolesModel:function(r){var A;var s;var R=this.getModel("roles");if(!R){R=new J();this.setModel(R,"roles");}if((typeof r==="undefined")||(!r.available&&!r.selected)){A=[];s=[];R.setProperty("/allVisualizations",[]);}else{A=(r.available||R.getProperty("/available")||[]);s=(r.selected||A);if(r.available){R.setProperty("/allVisualizations",this.getPageRepository().getVizIds(r.available));}}var c=s.length.toString();if(!s.length){c=this.getResourceBundle().getText("Message.NoRolesSelected");}else if(s.length===A.length){c=this.getResourceBundle().getText("Message.AllRolesSelected");}R.setProperty("/available",A);R.setProperty("/selected",s);R.setProperty("/selectedCountText",c);R.setProperty("/availableVisualizations",this.getPageRepository().getVizIds(s));},formatAssignmentDetailsMessage:function(c){var s=this.getPageRepository().getMissingAssignment(c);if(s==="space"){return this.getResourceBundle().getText("Message.NotAssignedToSpaceInformationDetails");}else if(s==="role"){return this.getResourceBundle().getText("Message.NotAssignedToRoleInformationDetails");}return"";},_formatTileType:function(v){var i=this.getResourceBundle();switch(v){case"STATIC":return i.getText("Title.StaticTile");case"DYNAMIC":return i.getText("Title.DynamicTile");case"CUSTOM":default:return i.getText("Title.CustomTile");}},setTitle:function(t){this.getOwnerComponent().getService("ShellUIService").then(function(s){s.setTitle(t);},function(e){L.error("Cannot get ShellUIService",e,"sap.ushell.applications.PageComposer");});},updateSortIndicators:function(s,b,c,d){var o=this.getView().byId(c[s]),e=o.getId();for(var i=0;i<d.length;++i){if(d[i].getId()===e){o.setSortIndicator(b?S.Descending:S.Ascending);}else{d[i].setSortIndicator(S.None);}}}});});
