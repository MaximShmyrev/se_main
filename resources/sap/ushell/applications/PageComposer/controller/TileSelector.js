// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/m/Button","sap/m/library","sap/m/List","sap/base/strings/formatMessage","sap/m/OverflowToolbar","sap/m/ResponsivePopover","sap/m/StandardListItem","sap/m/Text","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ui/model/Sorter","sap/ushell/library","sap/ushell/utils/clone","sap/ushell/services/Container"],function(B,m,L,f,O,R,S,T,F,a,b,J,c,u,C){"use strict";var d=m.ButtonType;var P=m.PlacementType;var e=m.ListMode;var g=m.ListSeparators;var D=u.DisplayFormat;return function(){var o,v,h,s,i,r,j,A,M,k,l={},I,n,p,q,t,w,V,x;function _(){return(i.getSelectedKey()==="roles")?r:j;}function y(){var b1=((i.getSelectedKey()==="roles")?j:r);b1.removeSelections(true);E();z();}function z(){N();W(M.getProperty("/catalogsDescending"),M.getProperty("/vizDescending"));}function E(){var b1=X();A.setEnabled(!!b1.length);if(b1.length){var c1=b1.map(function(d1){return o.getSupportedDisplayFormats(d1.tileType).map(function(e1){return e1.value;});}).reduce(function(d1,e1){return d1.filter(function(f1){return(e1.indexOf(f1)!==-1);});});M.setProperty("/enabledAddButtonMenuItems",c1);}else{M.setProperty("/enabledAddButtonMenuItems",[]);}G();}function G(){var b1=_();var c1=M.getProperty("/enabledAddButtonMenuItems");var d1=A.getMenu().getItems();if(A.getEnabled()&&(c1.length<d1.length)){I.getContent()[0].setText(l.i18n.getText("SelectedTiles.LimitedVisualizationOptions"));I.setActive(false);I.setVisible(true);I.detachPress(x);b1.setInfoToolbar(I);}else if((i.getSelectedKey()==="roles")&&(k.getProperty("/selected").length!==k.getProperty("/available").length)){I.getContent()[0].setText(l.i18n.getText("SelectedRoles.RestrictedRoleContext"));I.setActive(true);I.setVisible(true);I.detachPress(x);I.attachPress(x);b1.setInfoToolbar(I);}else if(I.getParent()===b1){I.setVisible(false);}}this.init=function(b1){if(i){i.detachSelect(y);}if(I){I.detachPress(x);}if(r){r.detachSelectionChange(E);}if(j){j.detachSelectionChange(E);}o=b1;v=o.getView();h=v.byId("tileSelector");s=v.getId();i=v.byId("contextSwitch");r=v.byId("rolesTilesList");j=v.byId("catalogsTilesList");A=v.byId("tileSelectorAddButton");k=v.getModel("roles");l.i18n=o.getResourceBundle();x=o.onOpenContextSelector.bind(o);if(!M){M=new J({catalogsDescending:false,enabledAddButtonMenuItems:[],showSwitchViewButton:false,vizDescending:false});M.setSizeLimit(Infinity);}h.setModel(M);if(!I||I.bIsDestroyed){I=new O({id:F.createId(s,"infoToolbar"),visible:false,content:new T({id:F.createId(s,"infoToolbarText")})});r.setInfoToolbar(I);}if(!n||n.bIsDestroyed){n=new L({id:F.createId(s,"sectionList"),mode:e.MultiSelect,showSeparators:g.None,includeItemInSelection:true,selectionChange:function(){p.getBeginButton().setEnabled(!!n.getSelectedItem());},items:{path:"/page/sections",template:new S({title:"{title}"})},noDataText:l.i18n.getText("Message.NoSections")});h.addDependent(n);}n.setModel(v.getModel());if(V){V.fireReset();}y();i.attachSelect(y);r.attachSelectionChange(E);j.attachSelectionChange(E);};function H(){var b1={};b1.parameters={expand:"vizReferences"};b1.path="/vizReferenceHierarchySet";b1.factory=function(c1,d1){switch(d1.getProperty("type")){case"catalog":return v.byId("tileSelectorGroupHeader").clone();case"visualization":var e1=d1.getProperty("vizReferences/tileType");var f1=v.byId("tileSelectorCustomListItem").clone().bindObject({path:d1.getPath()+"/vizReferences"});f1.getContent()[0].getItems()[2].getMenu().bindItems({path:"PageRepository>/tileTypeSet('"+encodeURIComponent(e1)+"')/vizOptions/displayFormats/supported",template:v.byId("tileSelectorAddMenuItem").clone(),templateShareable:false});return f1;default:return null;}};return b1;}function K(b1){if(b1&&b1.length){var c1=H();var d1=b1.map(function(e1){return new a("catalogId",b.EQ,e1);});c1.filters=d1;j.setModel(v.getModel("PageRepository"));j.bindItems(c1);}else{j.unbindItems();}i.setSelectedKey("catalogs");y();}this.initTiles=function(){i.setSelectedKey("roles");A.setEnabled(false);r.setModel(v.getModel("PageRepository"));if(k.getProperty("/available").length){var b1=new Promise(function(c1){var d1=function(){r.detachUpdateFinished(d1);c1();};r.attachUpdateFinished(d1);});r.bindItems(H());y();return b1;}r.unbindItems();return Promise.resolve();};this.refreshRoleContext=function(){G();N();};this.onSearchTiles=function(b1){w=b1.getParameter("query");N();};function N(){var b1=_().getBinding("items");var c1=Q();if(b1&&(JSON.stringify(b1.aLastFiltersArray)!==JSON.stringify(c1))){b1.aLastFiltersArray=c1;b1.filter(c1);}}this.onAddTiles=function(b1){var c1=n.getItems();var d1=b1.getParameter("item");t=(d1&&d1.getKey());var e1=b1.getSource().getBindingContext();if(e1){var f1=e1.getPath();b1.oAddSingleTileItem=_().getItems().filter(function(g1){return(g1.getBindingContextPath()===f1);})[0];}else{delete b1.oAddSingleTileItem;}if(c1.length===1){c1[0].setSelected(true);a1(b1.oAddSingleTileItem);}else{Y(b1);}};this.onAddCatalogs=function(){sap.ui.require(["sap/ushell/applications/PageComposer/controller/CatalogSelector.controller"],function(b1){b1.selectCatalogs(v,K);});};this.showViewSettingsDialog=function(){if(V){V.getModel().setProperty("/catalogsDescending",M.getProperty("/catalogsDescending"));V.getModel().setProperty("/vizDescending",M.getProperty("/vizDescending"));V.open();return;}sap.ui.require(["sap/ushell/applications/PageComposer/controller/ViewSettingsTileSelector.controller"],function(b1){F.load({id:F.createId(s,"tileSelectorViewSettings"),name:"sap.ushell.applications.PageComposer.view.ViewSettingsTileSelector",type:"XML",controller:new b1(v)}).then(function(c1){V=c1;c1.setModel(new J({catalogsDescending:false,vizDescending:false}));c1.setModel(v.getModel("i18n"),"i18n");c1.open();c1.attachConfirm(function(d1){var e1=d1.getSource().getModel();W(e1.getProperty("/catalogsDescending"),e1.getProperty("/vizDescending"));});h.addDependent(c1);});});};this.setAddTileHandler=function(b1){q=function(c1,d1,e1){delete c1.id;b1(c1,d1,e1);};};this.onDragStart=function(b1){if(typeof q!=="function"){throw new Error("Impossible to add Tile as no \"fnAddTileHandler\" was set via \"setAddTileHandler\"");}var c1=b1.getParameter("target").getBindingContext().getProperty("");if(c1.type==="catalog"){b1.preventDefault();return;}b1.getParameter("dragSession").setComplexData("callback",function(d1,e1,f1){var g1=C(c1);g1.displayFormatHint=f1||D.Standard;q(g1,[e1],d1);sap.ushell.Container.getServiceAsync("Message").then(function(h1){if(g1.displayFormatHint===D.Compact){h1.info(l.i18n.getText("Message.LinkAdded"));}else{h1.info(l.i18n.getText("Message.TileAdded"));}});});};this.setEnableDnD=function(b1){if(r&&r.getDragDropConfig().length===1){r.getDragDropConfig()[0].setEnabled(b1);}if(j&&j.getDragDropConfig().length===1){j.getDragDropConfig()[0].setEnabled(b1);}};this.showSwitchViewButton=function(b1){if(M){M.setProperty("/showSwitchViewButton",b1);}};this.visualizationOptionFormatter=function(b1,c1,d1){if(!b1||!c1){return"";}if(c1===D.Default){c1=D.Standard;}if(d1){var e1=o.getSupportedDisplayFormats(d1);var f1=e1.filter(function(i1){return(i1.value===c1);})[0];return f(b1,[f1.label]);}var g1=this.getView().getModel("i18n");var h1=g1.getProperty("DisplayFormat."+c1);return f(b1,[h1]);};function Q(){var b1=[];if(_()===r){var c1=k.getProperty("/selected");if(!c1.length){c1=k.getProperty("/available");}c1.forEach(function(d1){b1.push(new a("roleId",b.EQ,d1));});}if(w){b1.push(new a([new a("vizReferences/id",b.Contains,w),new a("vizReferences/catalogTileId",b.Contains,w),new a("vizReferences/targetMappingId",b.Contains,w),new a("vizReferences/fioriId",b.Contains,w),new a("vizReferences/title",b.Contains,w),new a("vizReferences/subTitle",b.Contains,w)],false));}return b1;}function U(b1,c1){return[new c("title",b1),new c("vizReferences/title",c1)];}function W(b1,c1){var d1=U(b1,c1);var e1=_().getBinding("items");if(e1&&(JSON.stringify(e1.aLastSorterArray)!==JSON.stringify(d1))){e1.aLastSorterArray=d1;e1.sort(d1);}M.setProperty("/catalogsDescending",b1);M.setProperty("/vizDescending",c1);}function X(){var b1=_();var c1=b1.getModel();return b1.getSelectedContextPaths().map(function(d1){return c1.getContext(d1).getProperty("");});}function Y(b1){if(!p||p.bIsDestroyed){$();}n.removeSelections(true);p.getBeginButton().setEnabled(false).oEvent=b1;p.getEndButton().setEnabled(true);var c1=b1.getSource();if(c1.isA("sap.m.Menu")){c1=c1.getParent();}if(Z(c1)){c1=c1.getParent()._getOverflowButton();}p.openBy(c1);}function Z(b1){var c1=b1.getParent();return!!(c1&&c1.isA("sap.m.OverflowToolbar")&&(c1._getVisibleContent().indexOf(b1)===-1));}function $(){p=new R({id:F.createId(s,"sectionSelectionPopover"),placement:P.Auto,title:l.i18n.getText("Tooltip.AddToSections"),beginButton:new B({type:d.Emphasized,text:l.i18n.getText("Button.Add"),press:function(){this.setEnabled(false);p.close();a1(this.oEvent.oAddSingleTileItem);}}),endButton:new B({text:l.i18n.getText("Button.Cancel"),press:function(){this.setEnabled(false);p.close();}}),content:n,initialFocus:n});h.addDependent(p);}function a1(b1){if(typeof q!=="function"){throw new Error("Impossible to add Tile as no \"fnAddTileHandler\" was set via \"setAddTileHandler\"");}var c1=n.getSelectedItems().map(function(e1){return n.indexOfItem(e1);});var d1;if(b1){d1=[b1.getBindingContext().getProperty("")];b1.setSelected(false);}else{d1=X();_().removeSelections(true);}E();d1.forEach(function(e1){var f1=C(e1);if(t){f1.displayFormatHint=t;}else{var g1=o.getSupportedDisplayFormats(f1.tileType);var h1=g1.filter(function(i1){return i1.preferred;})[0].value;f1.displayFormatHint=h1;}q(f1,c1);});if(d1.length){sap.ushell.Container.getServiceAsync("Message").then(function(e1){var f1;if(t===D.Compact){f1=l.i18n.getText(d1.length>1?"Message.LinksAdded":"Message.LinkAdded");}else{f1=l.i18n.getText(d1.length>1?"Message.TilesAdded":"Message.TileAdded");}e1.info(f1);});}if(M&&M.getProperty("/showSwitchViewButton")){o.switchDynamicSideContentView();}}};});
