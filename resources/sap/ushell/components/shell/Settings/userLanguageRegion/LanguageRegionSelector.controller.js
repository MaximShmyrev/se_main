// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/performance/Measurement","sap/base/util/UriParameters","sap/base/Log","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/model/json/JSONModel"],function(C,M,U,L,a,b,J){"use strict";return C.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.userInfoService=sap.ushell.Container.getService("UserInfo");this.oUser=sap.ushell.Container.getUser();var l=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();var o=b.getInstance(l);var d,t,T,n;var i=sap.ushell.Container.getRenderer("fiori2").getShellConfig().enableSetLanguage||false;var I=this.oUser.isLanguagePersonalized();var c=this.userInfoService.getUserSettingListEditSupported();var u=[];if(c){var f=sap.ui.getCore().getConfiguration().getFormatSettings();d=f.getLegacyDateFormat();T=f.getLegacyTimeFormat();n=f.getLegacyNumberFormat();u.push(this._loadUserSettingList());}else{d=o.getDatePattern("medium");t=o.getTimePattern("medium");T=(t.indexOf("H")===-1)?"12h":"24h";}var m=new J({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:d,selectedTimeFormat:T,selectedNumberformat:n,selectedTimeZone:this.oUser.getTimeZone(),isSettingsLoaded:true,isLanguagePersonalized:I,isEnableSetLanguage:i,isEnableUserProfileSetting:c});if(i){u.push(this._loadLanguagesList());}if(u.length>0){this.getView().setBusy(true);Promise.all(u).then(function(r){var e=c?r[0]:null;var g=null;if(i){g=r.length===1?r[0]:r[1];}if(g&&g.length>1){m.setProperty("/languageList",g);var h=g.some(function(j){return j.key==="default";});if(!I&&h){m.setProperty("/selectedLanguage","default");}}if(e&&e.TIME_FORMAT&&e.TIME_FORMAT.length>0){m.setProperty("/TimeFormatList",e.TIME_FORMAT);}if(e&&e.DATE_FORMAT&&e.DATE_FORMAT.length>0){m.setProperty("/DateFormatList",e.DATE_FORMAT);}if(e&&e.TIME_ZONE&&e.TIME_ZONE.length>0){m.setProperty("/TimeZoneList",e.TIME_ZONE);}if(e&&e.NUMBER_FORMAT&&e.NUMBER_FORMAT.length>0){m.setProperty("/NumberFormatList",e.NUMBER_FORMAT);}this.oView.setModel(m);this.getView().setBusy(false);}.bind(this));}else{this.oView.setModel(m);}},_loadLanguagesList:function(){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return new Promise(function(r){M.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");this.userInfoService.getLanguageList().done(function(d){M.end("FLP:LanguageRegionSelector._getLanguagesList");r(d);}).fail(function(e){M.end("FLP:LanguageRegionSelector._getLanguagesList");L.error("Failed to load language list.",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null);});}.bind(this));},_loadUserSettingList:function(){M.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return new Promise(function(r){M.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");this.userInfoService.getUserSettingList().then(function(d){M.end("FLP:LanguageRegionSelector._loadUserSettingList");r(d);});}.bind(this));},onCancel:function(){var m=this.getView().getModel(),o=m.getData(),l=o.languageList,i=o.isEnableSetLanguage;if(i&&l){var u=this.oUser.getLanguage();var s=o.isLanguagePersonalized?u:"default";m.setProperty("/selectedLanguage",s);this._updateTextFields(u);}if(o.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues();}},onSave:function(){var u=this.oUser,m=this.getView().getModel().getData(),s=m.selectedLanguage,o=u.getLanguage(),l=s!==(m.isLanguagePersonalized?o:"default"),i=m.isEnableUserProfileSetting,c=m.isEnableSetLanguage&&m.languageList&&l;if(c||i){return new Promise(function(r,d){if(c){u.setLanguage(s);}if(i){var f=sap.ui.getCore().getConfiguration().getFormatSettings();if(f.getLegacyDateFormat()!==m.selectedDatePattern){u.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},f.getLegacyDateFormat(),m.selectedDatePattern);}if(f.getLegacyTimeFormat()!==m.selectedTimeFormat){u.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},f.getLegacyTimeFormat(),m.selectedTimeFormat);}if(f.getLegacyNumberFormat()!==m.selectedNumberformat){u.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},f.getLegacyNumberFormat(),m.selectedNumberformat);}if(this.oUser.getTimeZone()!==m.selectedTimeZone){u.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),m.selectedTimeZone);}}this.userInfoService.updateUserPreferences(u).done(function(){var R={refresh:true};if(c){u.resetChangedProperty("language");var e=U.fromQuery(window.location.search).get("sap-language");if(e&&s!=="default"){R.urlParams=[{"sap-language":s}];}this._removeLanguageFromUserContextCookie();}r(R);}.bind(this)).fail(function(e){if(c){u.setLanguage(o);u.resetChangedProperty("language");this._updateTextFields(o);}if(m.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues();}L.error("Failed to save Language and Region Settings",e,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");d(e);}.bind(this));}.bind(this));}return Promise.resolve();},_restoreUserSettingPreferenceValues:function(){var m=this.getView().getModel();var f=sap.ui.getCore().getConfiguration().getFormatSettings();m.setProperty("/selectedDatePattern",f.getLegacyDateFormat());m.setProperty("/selectedTimeFormat",f.getLegacyTimeFormat());m.setProperty("/selectedNumberformat",f.getLegacyNumberFormat());m.setProperty("/selectedTimeZone",this.oUser.getTimeZone());},_removeLanguageFromUserContextCookie:function(){var u=document.cookie.split(";").find(function(d){return d.indexOf("sap-usercontext")!==-1;});if(!u){return;}var c=u.replace("sap-usercontext=","").split("&");c=c.filter(function(v){return v.indexOf("sap-language")===-1;});document.cookie="sap-usercontext="+c.join("&")+";path=/";},_handleSelectChange:function(e){var s=e.getParameters().selectedItem.getKey();this._updateTextFields(s);},_updateTextFields:function(l){var o;if(l===this.oUser.getLanguage()){o=sap.ui.getCore().getConfiguration().getFormatSettings().getFormatLocale();}else{o=new a(l);}var m=this.getView().getModel(),c=b.getInstance(o),d=c.getDatePattern("medium"),t=c.getTimePattern("medium"),T=(t.indexOf("H")===-1)?"12h":"24h";if(!m.getData().isEnableUserProfileSetting){m.setProperty("/selectedDatePattern",d);m.setProperty("/selectedTimeFormat",T);}}});});
