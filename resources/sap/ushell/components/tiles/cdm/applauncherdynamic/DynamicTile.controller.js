// Copyright (c) 2009-2020 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/mvc/Controller","sap/ushell/components/tiles/utils","sap/ui/core/format/NumberFormat","sap/ushell/Config","sap/ushell/services/AppType","sap/ushell/utils/WindowUtils","sap/ui/thirdparty/datajs","sap/ui/thirdparty/URI","sap/ui/model/json/JSONModel","sap/m/library","sap/ushell/library","sap/base/Log","sap/base/util/UriParameters","sap/base/util/merge"],function(C,u,N,a,A,W,O,U,J,m,b,L,c,d){"use strict";var G=m.GenericTileScope;var D=b.DisplayFormat;return C.extend("sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile",{timer:null,_aDoableObject:{},oDataRequest:null,_getConfiguration:function(v){var o={};var e;var h;o.configuration=v.configuration;o.properties=v.properties;o.properties.info=o.properties.info||"";o.properties.number_value="...";o.properties.number_value_state="Neutral";o.properties.number_state_arrow="None";o.properties.number_factor="";o.properties.number_unit=o.properties.numberUnit||"";var s=o.configuration["sap-system"];var t=o.properties.targetURL;if(t&&s){e=sap.ushell.Container.getService("URLParsing");if(e.isIntentUrl(t)){h=e.parseShellHash(t);if(!h.params){h.params={};}h.params["sap-system"]=s;t="#"+e.constructShellHash(h);}else{t+=((t.indexOf("?")<0)?"?":"&")+"sap-system="+s;}o.properties.targetURL=t;}o.properties.sizeBehavior=a.last("/core/home/sizeBehavior");o.properties.wrappingType=a.last("/core/home/wrappingType");return o;},onInit:function(){var v=this.getView();var M=new J();var V=v.getViewData();var o=V.properties;M.setData(this._getConfiguration(V));var s=o.contentProviderId;if(a.last("/core/contentProviders/providerInfo/show")){sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext(s);}).then(function(S){M.setProperty("/properties/contentProviderLabel",S.label);}).catch(function(e){L.error("StaticTile.controller threw an error:",e);});}switch(o.displayFormat){case D.Flat:M.setProperty("/properties/frameType","OneByHalf");break;case D.FlatWide:M.setProperty("/properties/frameType","TwoByHalf");break;case D.StandardWide:M.setProperty("/properties/frameType","TwoByOne");break;default:{M.setProperty("/properties/frameType","OneByOne");}}v.setModel(M);this._aDoableObject=a.on("/core/home/sizeBehavior").do(function(S){M.setProperty("/properties/sizeBehavior",S);});},refreshHandler:function(){this.loadData(0);},visibleHandler:function(i){if(i){if(!this.oDataRequest){this.refreshHandler(this);}}else{this.stopRequests();}},updateVisualPropertiesHandler:function(n){var p=this.getView().getModel().getProperty("/properties");var e=false;if(typeof n.title!=="undefined"){p.title=n.title;e=true;}if(typeof n.subtitle!=="undefined"){p.subtitle=n.subtitle;e=true;}if(typeof n.icon!=="undefined"){p.icon=n.icon;e=true;}if(typeof n.targetURL!=="undefined"){p.targetURL=n.targetURL;e=true;}if(typeof n.info!=="undefined"){p.info=n.info;e=true;}if(e){this.getView().getModel().setProperty("/properties",p);}},stopRequests:function(){if(this.timer){clearTimeout(this.timer);}if(this.oDataRequest){try{this.oDataRequest.abort();}catch(e){L.warning(e.name,e.message);}}},onPress:function(e){if(e.getSource().getScope&&e.getSource().getScope()===G.Display){var t=this.getView().getModel().getProperty("/properties/targetURL"),T=this.getView().getModel().getProperty("/properties/title");if(!t){return;}else if(t[0]==="#"){hasher.setHash(t);}else{var l=a.last("/core/shell/enableRecentActivity")&&a.last("/core/shell/enableRecentActivityLogging");if(l){var r={title:T,appType:A.URL,url:t,appId:t};sap.ushell.Container.getRenderer("fiori2").logRecentActivity(r);}W.openURL(t,"_blank");}}},initUpdateDynamicData:function(){var v=this.getView(),s=v.getModel().getProperty("/configuration/serviceUrl"),S=v.getModel().getProperty("/configuration/serviceRefreshInterval");if(!S){S=0;}else if(S<10){L.warning("Refresh Interval "+S+" seconds for service URL "+s+" is less than 10 seconds, which is not supported. Increased to 10 seconds automatically.",null,"sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile.controller");S=10;}if(s){this.loadData(S);}},extractData:function(o){var n,k=["results","icon","title","number","numberUnit","info","infoState","infoStatus","targetParams","subtitle","stateArrow","numberState","numberDigits","numberFactor"];if(typeof o==="object"&&Object.keys(o).length===1){n=Object.keys(o)[0];if(Array.prototype.indexOf.call(k,n)===-1){return o[n];}}return o;},successHandleFn:function(r){var o=this.getView().getModel().getProperty("/configuration");var e=r;this.oDataRequest=undefined;if(typeof r==="object"){var f=new c(o.serviceUrl).get("$inlinecount");if(f&&f==="allpages"){e={number:r.__count};}else{e=this.extractData(e);}}else if(typeof r==="string"){e={number:r};}this.updatePropertiesHandler(e);},errorHandlerFn:function(M){var s=M&&M.message?M.message:M,r=u.getResourceBundleModel().getResourceBundle(),e=this.getView().getModel().getProperty("/configuration/serviceUrl");this.oDataRequest=undefined;if(s==="Request aborted"){jQuery.sap.log.info("Data request from service "+e+" was aborted",null,"sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile");}else{if(M.response){s+=" - "+M.response.statusCode+" "+M.response.statusText;}L.error("Failed to update data via service "+e+": "+s,null,"sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile");this.updatePropertiesHandler({number:"???",info:r.getText("dynamic_data.error")});}},loadData:function(s){return new Promise(function(r,e){var S,f,R,o,M=this.getView().getModel(),g=M.getProperty("/configuration/serviceUrl"),h=M.getProperty("/properties/contentProviderId");if(!g){r();return;}sap.ushell.Container.getServiceAsync("ClientSideTargetResolution").then(function(i){return Promise.all([i.getSystemContext(h),sap.ushell.Container.getServiceAsync("ReferenceResolver")]);}).then(function(i){var j=i[0],k=i[1];return k.resolveUserDefaultParameters(g,j);}).then(function(i){if(i.defaultsWithoutValue&&i.defaultsWithoutValue.length>0){this.errorHandlerFn("The service URL contains User Default(s) with no set value: "+i.defaultsWithoutValue.join(", "),true);r();return;}if(i.ignoredReferences&&i.ignoredReferences.length>0){this.errorHandlerFn("The service URL contains invalid Reference(s): "+i.ignoredReferences.join(", "),false);r();return;}R={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":(sap.ui&&sap.ui.getCore().getConfiguration().getLanguage())||""};if(s>0){L.info("Wait "+s+" seconds before calling "+i.url+" again",null,"sap.ushell.components.tiles.cdm.applauncherdynamic.DynamicTile.controller");this.timer=window.setTimeout(this.loadData.bind(this,s,false),(s*1000));}if(!this.oDataRequest){if(sap.ushell.Container){S=sap.ui.getCore().getConfiguration().getSAPLogonLanguage();if(S){R["sap-language"]=S;}f=sap.ushell.Container.getLogonSystem()?sap.ushell.Container.getLogonSystem().getClient():"";o=new U(i.url);if(f&&!o.protocol()){R["sap-client"]=f;}}if((S)&&(i.url.indexOf("sap-language=")===-1)){i.url=i.url+(i.url.indexOf("?")>=0?"&":"?")+"sap-language="+S;}M.setProperty("/configuration/serviceUrl",i.url);this.oDataRequest=O.read({requestUri:i.url,headers:R},this.successHandleFn.bind(this),this.errorHandlerFn.bind(this));}r();}.bind(this));}.bind(this));},onExit:function(){this.stopRequests();this._aDoableObject.off();},addParamsToUrl:function(s,t){var p="",e=s.indexOf("?")!==-1,i;if(t&&t.length>0){for(i=0;i<t.length;i=i+1){p+=t[i];if(i<t.length-1){p+="&";}}}if(p.length>0){if(!e){s+="?";}else{s+="&";}s+=p;}return s;},_normalizeNumber:function(n,e,f,i){var g;if(isNaN(n)){g=n;}else{var o=N.getFloatInstance({maxFractionDigits:i});if(!f){var h=Math.abs(n);if(h>=1000000000){f="B";n/=1000000000;}else if(h>=1000000){f="M";n/=1000000;}else if(h>=1000){f="K";n/=1000;}}g=o.format(n);}var j=g;var k=j[e-1];e-=(k==="."||k===",")?1:0;j=j.substring(0,e);return{displayNumber:j,numberFactor:f};},updatePropertiesHandler:function(o){var e=u.getResourceBundleModel().getResourceBundle().getText("dynamic_data.error");var f=0,i,n,g,s,p=this.getView().getModel().getProperty("/properties"),h={title:o.title||p.title||"",subtitle:o.subtitle||p.subtitle||"",icon:o.icon||p.icon||"",targetURL:o.targetURL||p.targetURL||"",number_value:!isNaN(o.number)?o.number:"...",number_digits:o.numberDigits>=0?o.numberDigits:4,info:p.info==e?o.info||"":o.info||p.info||"",number_unit:o.numberUnit||p.number_unit||"",number_state_arrow:o.stateArrow||p.number_state_arrow||"None",number_value_state:o.numberState||p.number_value_state||"Neutral",number_factor:o.numberFactor||p.number_factor||""};var t=[];if(o.targetParams){t.push(o.targetParams);}if(o.results){for(i=0,n=o.results.length;i<n;i=i+1){g=o.results[i].number||0;if(typeof g==="string"){g=parseInt(g,10);}f=f+g;s=o.results[i].targetParams;if(s){t.push(s);}}h.number_value=f;}if(t.length>0){h.targetURL=this.addParamsToUrl(h.targetURL,t);}if(!isNaN(o.number)){if(typeof o.number==="string"){o.number=o.number.trim();}var S=this._shouldProcessDigits(o.number,o.numberDigits),j=h.icon?4:5;if(o.number&&o.number.length>=j||S){var k=this._normalizeNumber(o.number,j,o.numberFactor,o.numberDigits);h.number_factor=k.numberFactor;h.number_value=k.displayNumber;}else{var l=N.getFloatInstance({maxFractionDigits:j});h.number_value=l.format(o.number);}}if(h.number_value_state){switch(h.number_value_state){case"Positive":h.number_value_state="Good";break;case"Negative":h.number_value_state="Error";break;default:}}h.sizeBehavior=a.last("/core/home/sizeBehavior");d(p,h);this.getView().getModel().refresh();},_shouldProcessDigits:function(s,i){var n;s=typeof(s)!=="string"?s.toString():s;if(s.indexOf(".")!==-1){n=s.split(".")[1].length;if(n>i){return true;}}return false;},formatters:{leanURL:W.getLeanURL}});},true);
