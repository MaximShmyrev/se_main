/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BindingResolver","../library","sap/base/Log","sap/m/library","sap/ui/util/openWindow","sap/ui/base/ManagedObject"],function(B,l,L,m,o,M){"use strict";function _(s){if(s&&typeof s==="object"){return s.name;}return s;}var A=l.AreaType,C=l.CardActionType,a=m.ListType;var b=M.extend("sap.ui.integration.util.CardActions",{metadata:{library:"sap.ui.integration",properties:{card:{type:"object"},areaType:{type:"sap.ui.integration.AreaType",defaultValue:A.None}}}});b.prototype.exit=function(){this._oAreaControl=null;};b.prototype.attach=function(i,c){this._oAreaControl=c;if(!i.actions){this._fireActionReady();return;}var d=i.actions[0];if(d&&d.type){this._attachAction(i,d);}else{this._fireActionReady();}};b.prototype._setItemTemplateTypeFormatter=function(c){var t=this,d=t._oAreaControl,i=d._oItemTemplate;var e=M.bindingParser("{path:''}");e.formatter=function(v){var f=this.getBindingContext(),p,P;if(f){p=f.getPath();}P=B.resolveValue(c.parameters,d,p);if(v.__resolved){if(!v.__enabled||v.__enabled==="false"){return a.Inactive;}return a.Navigation;}if(!v.__promise){v.__promise=true;d._oServiceManager.getService(_(c.service)).then(function(n){if(n){n.enabled({parameters:P}).then(function(E){v.__resolved=true;v.__enabled=E;d.getModel().checkUpdate(true);}).catch(function(){v.__resolved=true;v.__enabled=false;});}else{v.__resolved=true;v.__enabled=false;}});}return a.Inactive;};i.bindProperty("type",e);};b.prototype._setSingleActionEnabledState=function(i,c){var d=this._oAreaControl,e=d.getBindingContext(),p,P;if(e){P=e.getPath();}p=B.resolveValue(c.parameters,d,P);return new Promise(function(r){d._oServiceManager.getService(_(c.service)).then(function(n){if(n){n.enabled({parameters:p}).then(function(E){r(E);}).catch(function(){r(false);});}else{r(false);}}).catch(function(){r(false);});});};b.prototype._setItemTemplateEnabledState=function(c){var d,t,i=this._oAreaControl._oItemTemplate;if(typeof c.enabled==="object"){d=c.enabled;d.formatter=function(v){if(!v||v==="false"){return a.Inactive;}return a.Navigation;};}if(d){i.bindProperty("type",d);}else{t=(c.enabled===false||c.enabled==="false")?a.Inactive:a.Navigation;i.setProperty("type",t);}};b.prototype._fireActionReady=function(){var h=this.getAreaType()===A.Header;var e=h?"_actionHeaderReady":"_actionContentReady";this._oAreaControl.fireEvent(e);};b.prototype._handleServiceAction=function(s,c){var d=s.getBindingContext(),p;if(d){p=d.getPath();}this._oAreaControl._oServiceManager.getService(_(c.service)).then(function(S){if(S){S.navigate({parameters:B.resolveValue(c.parameters,s,p)});}}).catch(function(e){L.error("Navigation service unavailable",e);}).finally(function(){this._processAction(s,c,p);}.bind(this));};b.prototype._handleAction=function(s,c){var d=s.getBindingContext(),p;if(d){p=d.getPath();}this._processAction(s,c,p);};b.prototype._attachPressEvent=function(c,d,s){c.attachPress(function(e){var S=e.getSource();if(d.service){this._handleServiceAction(S,d);}else{this._handleAction(S,d);}}.bind(this));};b.prototype._attachAction=function(i,c){var d=this.getAreaType()===A.ContentItem?this._oAreaControl._oItemTemplate:this._oAreaControl,e=true,s=this.getAreaType(),S=s===A.Header||s===A.Content,f=s===A.ContentItem,g=true;if(c.service){if(this.getAreaType()===A.ContentItem){this._setItemTemplateTypeFormatter(c);}e=false;}else if(f){this._setItemTemplateEnabledState(c);e=false;}if(S&&c.service){this._setSingleActionEnabledState(i,c).then(function(E){if(E){this._attachPressEvent(d,c,S);}this._fireActionReady();}.bind(this));}else{if(e){g=c.enabled!==false&&c.enabled!=="false";}if(g){this._attachPressEvent(d,c,S);}this._fireActionReady();}};b.prototype._processAction=function(s,c,p){var h=this._getHostInstance(),d=this.getCard(),u=c.url;if(u){u=B.resolveValue(u,s,p);}b.fireAction({card:d,host:h,action:c,parameters:B.resolveValue(c.parameters,s,p),source:s,url:u});};b.prototype._getHostInstance=function(){var c=this.getCard();if(c){return c.getHostInstance();}return null;};b.prototype.fireAction=function(s,t,p){var h=this._getHostInstance(),c=this.getCard(),d=this._extractActionConfigurations(c,p),e={card:c,host:h,action:{type:t},parameters:d,source:s};b.fireAction(e);};b.fireAction=function(c){var h=c.host,d=c.card,e=d.getAggregation("_extension"),f=c.action,p=c.parameters||{},g={type:f.type,card:d,actionSource:c.source,parameters:p},i=Object.assign({},g,{manifestParameters:p}),j=d.fireAction(i);if(!j){return false;}if(h){j=h.fireAction(g);}if(!j){return false;}if(e){j=e.fireAction(g);}if(j){b._doPredefinedAction(c);}return j;};b._doPredefinedAction=function(c){var d=c.action,p=c.parameters,t=d.type,u,T,P,s;if(p){P=p.url;s=p.target;}switch(t){case C.Navigation:if(d.service){break;}u=c.url||P;T=d.target||s||"_blank";if(u){b.openUrl(u,T);}break;case C.Custom:if(typeof d.action==="function"){d.action(c.card,c.source);}break;case C.Submit:if(c.source&&c.source.isA("sap.ui.integration.cards.BaseContent")){b.handleSubmitAction(c);}break;default:break;}};b.openUrl=function(u,t){o(u,t);};b.handleSubmitAction=function(c){var d,e=c.card,D=e._oDataProviderFactory,f=c.source,g=c.parameters;if(!g.configuration){return;}f.onActionSubmitStart(g);d=D.create({request:g.configuration});d.getData().then(function(r){f.onActionSubmitEnd(r,null);},function(E){L.error(E);f.onActionSubmitEnd(null,{error:E});}).finally(function(){D.remove(d);});};b.prototype._extractActionConfigurations=function(c,p){var r=c&&c.getManifestEntry("/sap.card/configuration/actionHandlers/submit"),d=p.data||{};if(!r){return p;}return{data:d,configuration:{"mode":r.mode||"cors","url":r.url,"method":r.method||"POST","parameters":Object.assign({},d,r.parameters),"headers":r.headers,"xhrFields":{"withCredentials":!!r.withCredentials}}};};return b;});
