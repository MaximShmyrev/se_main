/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/mdc/filterbar/p13n/GroupContainer","sap/ui/mdc/filterbar/p13n/FilterGroupLayout","sap/ui/mdc/filterbar/p13n/TableContainer","sap/ui/mdc/filterbar/p13n/FilterColumnLayout","sap/ui/mdc/filterbar/FilterBarBase","sap/ui/mdc/filterbar/FilterBarBaseRenderer","sap/ui/fl/apply/api/FlexRuntimeInfoAPI","sap/m/Toolbar","sap/m/ToolbarSpacer"],function(G,F,T,a,b,c,d,e,f){"use strict";var A=b.extend("sap.ui.mdc.filterbar.p13n.AdaptationFilterBar",{metadata:{library:"sap.ui.mdc",properties:{adaptationControl:{type:"object"}},events:{change:{}}},renderer:c});A.prototype.init=function(){b.prototype.init.apply(this,arguments);this._bPersistValues=true;};A.prototype.setLiveMode=function(l,s){b.prototype.setLiveMode.apply(this,arguments);if(l){this._createGoToolbar();}else{this._oConditionModel.detachPropertyChange(this._handleConditionModelPropertyChange,this);}var g=this.getAdaptationControl();var O=function(E){var C=E.getParameter("container");C.removeAllContent();if(!l){this._handleModal(E.getParameter("reason"));}if(this._checkAdvancedParent(g)){this._executeRequestedRemoves();}this.getAdaptationController().detachAfterP13nContainerCloses(O);}.bind(this);this.getAdaptationControl()._oAdaptationController.attachEvent("afterP13nContainerCloses",O);this._oConditionModel.attachPropertyChange(function(E){var k=E.getParameter("path").substring(12);if(this.oAdaptationModel){var i=this.oAdaptationModel.getProperty("/items");var I=i.find(function(o){return o.name==k;});if(I){I.isFiltered=this._getConditionModel().getConditions(k).length>0?true:false;this.oAdaptationModel.setProperty("/items",i);}}}.bind(this));return this;};A.prototype.switchViewMode=function(v){this._oFilterBarLayout.getInner().switchViewMode(v);};A.prototype.getViewMode=function(v){return this._oFilterBarLayout.getInner().getViewMode();};A.prototype._handleModal=function(C){var g=C==="Ok";if(g){var m=this._getModelConditions(this._getConditionModel(),false,true);if(this._bPersistValues){this.getAdaptationController().createConditionChanges(m);}else{this.getAdaptationControl()._setXConditions(m,true);}}else{this._setXConditions(this.getAdaptationControl().getFilterConditions(),true);}};A.prototype._createGoToolbar=function(){if(!this._btnSearch){var s=this._getSearchButton();s.attachPress(function(){this.getAdaptationControl().triggerSearch();}.bind(this));this._oFilterBarLayout.getInner().setFooterToolbar(new e({content:[new f(),this._getSearchButton()]}));}};A.prototype.setP13nModel=function(p){this.oAdaptationModel=p;};A.prototype._getWaitForChangesPromise=function(){return d.waitForChanges({element:this.getAdaptationControl()});};A.prototype.getAdaptationController=function(){return this.getAdaptationControl().getAdaptationController();};A.prototype.retrieveAdaptationController=function(){return this.getAdaptationControl().retrieveAdaptationController();};A.prototype.applyConditionsAfterChangesApplied=function(){b.prototype.applyConditionsAfterChangesApplied.apply(this,arguments);this.triggerSearch();};A.prototype.initialized=function(){var p=this.getAdaptationControl().awaitControlDelegate().then(function(P){return P.fetchProperties(this.getAdaptationControl()).then(function(g){return g;});}.bind(this));return Promise.all([p,b.prototype.initialized.apply(this,arguments)]).then(function(r){var P=r[0];this._aProperties=P;}.bind(this));};A.prototype.createFilterFields=function(){return this.initialized().then(function(){var C=this._bPersistValues?this.getAdaptationControl().getFilterConditions():this.getAdaptationControl()._getXConditions();this._setXConditions(C,true);if(this._bFilterFieldsCreated){return this;}var o=this.getAdaptationControl();var D=o.getControlDelegate();var g=this._checkAdvancedParent(o)?D:D.getFilterDelegate();this._mOriginalsForClone={};var h=[];this.oAdaptationModel.getProperty("/items").forEach(function(i,I){var j;j=this._checkExisting(i,g);j.then(function(k){var l;if(this._checkAdvancedParent(o)){if(k._bTemporaryOriginal){delete j._bTemporaryOriginal;this._mOriginalsForClone[k.getFieldPath()]=k;}l=k.clone();}else{l=k;}this.addAggregation("filterItems",l);}.bind(this));h.push(j);}.bind(this));return Promise.all(h).then(function(){if(this._oFilterBarLayout.getInner().setP13nModel){this._oFilterBarLayout.getInner().setP13nModel(this.oAdaptationModel);}this._bFilterFieldsCreated=true;return this;}.bind(this));}.bind(this));};A.prototype._checkExisting=function(i,o){var g;var h=this.getAdaptationControl();var E=this._checkAdvancedParent(h)?h.getFilterItems():[];var m=E.reduce(function(M,j){M[j.getFieldPath()]=j;return M;},{});if(m[i.name]){g=Promise.resolve(m[i.name]);}else{g=o.addItem(i.name,this.getAdaptationControl());g=g.then(function(j){if(!j){throw new Error("No FilterField could be created for property: '"+i.name+"'.");}j._bTemporaryOriginal=true;return j;});}return g;};A.prototype._executeRequestedRemoves=function(){var E=this._oFilterBarLayout.getInner().getSelectedFields();var o=[];Object.keys(this._mOriginalsForClone).forEach(function(k){var D=this.getAdaptationControl().getControlDelegate();if(E.indexOf(k)<0){var r=D.removeItem.call(D,k,this.getAdaptationControl()).then(function(C){if(C&&this._mOriginalsForClone[k]){this._mOriginalsForClone[k].destroy();delete this._mOriginalsForClone[k];}}.bind(this));o.push(r);}else{delete this._mOriginalsForClone[k];}}.bind(this));return Promise.all(o);};A.prototype._checkAdvancedParent=function(C){if(!C.isA("sap.ui.mdc.IFilterSource")&&!C.isA("sap.ui.mdc.IFilter")){throw new Error("The 'adaptationControl' needs to implement the IFilterSource or IFilter interface");}return C.isA("sap.ui.mdc.IFilter");};A.prototype.setAdaptationControl=function(C,s){this.setProperty("adaptationControl",C,s);this._checkAdvancedParent(C);this._cLayoutItem=this._checkAdvancedParent(C)?F:a;this._oFilterBarLayout=this._checkAdvancedParent(C)?new G():new T();this._oFilterBarLayout.getInner().setParent(this);this.setAggregation("layout",this._oFilterBarLayout,true);this.addStyleClass("sapUIAdaptationFilterBar");if(this._oFilterBarLayout.getInner().attachChange){this._oFilterBarLayout.getInner().attachChange(function(){this.fireChange();}.bind(this));}return this;};A.prototype.exit=function(){b.prototype.exit.apply(this,arguments);this.oAdaptationModel=null;this._mOriginalsForClone=null;};return A;});
