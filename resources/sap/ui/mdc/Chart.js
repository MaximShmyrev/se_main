/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/core/Core","sap/ui/mdc/Control","./chart/ChartSettings","sap/ui/base/SyncPromise","sap/ui/mdc/util/loadModules","./ChartRenderer","sap/ui/base/ManagedObjectObserver","sap/ui/model/json/JSONModel","sap/ui/mdc/library","sap/ui/model/base/ManagedObjectModel","sap/ui/model/Sorter","sap/base/Log","sap/base/util/deepEqual","sap/ui/Device","sap/ui/mdc/chart/ToolbarHandler","sap/ui/mdc/mixin/FilterIntegrationMixin","sap/m/VBox","sap/m/Text"],function(C,a,b,S,l,c,M,J,d,e,f,L,g,D,T,F,V,h){"use strict";var m,n,o,p,q,r,s="sap.ui.mdc.IFilter";var t=a.extend("sap.ui.mdc.Chart",{metadata:{library:"sap.ui.mdc",interfaces:["sap.ui.mdc.IxState"],defaultAggregation:"items",properties:{width:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},height:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"100%",invalidate:true},delegate:{type:"object",group:"Data",defaultValue:{name:"sap/ui/mdc/ChartDelegate"}},header:{type:"string",group:"Misc",defaultValue:null},noDataText:{type:"string"},chartType:{type:"string",group:"Misc",defaultValue:"column"},selectionMode:{type:"string",group:"Misc",defaultValue:"MULTIPLE"},p13nMode:{type:"sap.ui.mdc.ChartP13nMode[]"},legendVisible:{type:"boolean",group:"Misc",defaultValue:true},vizProperties:{type:"object",group:"Misc"},_colorings:{type:"object",visibility:"_hidden",byValue:true},ignoreToolbarActions:{type:"sap.ui.mdc.ChartToolbarActionType[]",defaultValue:[]},minWidth:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"240px",invalidate:true},minHeight:{type:"sap.ui.core.CSSSize",group:"Dimension",defaultValue:"400px",invalidate:true},sortConditions:{type:"object"},showChartTooltip:{type:"boolean",group:"Misc",defaultValue:true},autoBindOnInit:{type:"boolean",group:"Misc",defaultValue:true}},aggregations:{data:{multiple:true},items:{type:"sap.ui.mdc.chart.Item",multiple:true},actions:{type:"sap.ui.core.Control",multiple:true,forwarding:{idSuffix:"--toolbar",aggregation:"actions"}},_chart:{type:"sap.chart.Chart",multiple:false},_toolbar:{type:"sap.ui.mdc.ActionToolbar",multiple:false},_breadcrumbs:{type:"sap.m.Breadcrumbs",multiple:false},_noDataStruct:{type:"sap.m.VBox",multiple:false},selectionDetailsActions:{type:"sap.ui.mdc.chart.SelectionDetailsActions",multiple:false}},associations:{filter:{type:s,multiple:false}},events:{selectionDetailsActionPressed:{parameters:{action:{type:"sap.ui.core.Item"},itemContexts:{type:"sap.ui.model.Context"},level:{type:"sap.m.SelectionDetailsActionLevel"}}},dataPointsSelected:{parameters:{dataContext:{type:"object"}}}}}});var _=function(i){if(!this.oChartPromise){return;}this.oChartPromise.then(function(j){if(this.bIsDestroyed){return;}i=i||this.getSelectionMode();j.setSelectionMode(i);if(i!=="NONE"){this._prepareSelection();}}.bind(this));};F.call(t.prototype);t.prototype.init=function(){this._oObserver=new M(this.update.bind(this));this._oAdaptationController=null;this._oObserver.observe(this,{aggregations:["items","_chart"],properties:["ignoreToolbarActions","p13nMode"]});this._oManagedObjectModel=new e(this);this.setModel(this._oManagedObjectModel,"$mdcChart");a.prototype.init.apply(this,arguments);var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");this.setProperty("adaptationConfig",{itemConfig:{changeOperations:{add:"addItem",remove:"removeItem",move:"moveItem"},containerSettings:{title:R.getText("chart.PERSONALIZATION_DIALOG_TITLE")},adaptationUI:"sap/ui/mdc/p13n/panels/ChartItemPanel",additionalDeltaAttributes:["role"]}});};t.prototype.initModules=function(i){this.initControlDelegate(i[0]);m=i[1];p=i[2];q=i[3];r=i[4];};function u(){return["sap/chart/Chart","sap/ui/mdc/chart/ChartTypeButton","sap/ui/mdc/chart/MeasureItem","sap/viz/ui5/controls/VizTooltip"];}t.prototype.applySettings=function(i,j){var A;if(i){A=i.actions;delete i.actions;}var k=a.prototype.applySettings.apply(this,arguments);this._tempResolve;this._tempReject;this.oChartPromise=new S(function(x,y){this._tempResolve=x;this._tempReject=y;}.bind(this));if(this.getAutoBindOnInit()){this._createChart(i,A);}else{this._mStoredSettings=i;this._mStoredActions=A;T.createToolbar(this,A,true);this._createTempNoData();}return k;};t.prototype._createTempNoData=function(){var N=new h({text:this.getProperty("noDataText")});var i=new V({items:[N],justifyContent:"Center",alignItems:"Center",height:"100%"});this.setAggregation("_noDataStruct",i);};t.prototype._createChart=function(i,A){var j=(i&&i.delegate)||this.getDelegate();var k=j&&j.name;var x=[k].concat(u());this.setBusyIndicatorDelay(0);this.setBusy(true);l(x).then(function z(y){this.initModules(y);if(this.bIsDestroyed){return S.reject();}return this.getControlDelegate().fetchProperties(this);}.bind(this)).then(function y(P){return this.retrieveAdaptationController().then(function(){return P;});}.bind(this)).then(function y(P){if(this.bIsDestroyed){return S.reject();}var I={};P.forEach(function(z){I[z.name]=z;});if(this.getAggregation("_noDataStruct")){this.getAggregation("_noDataStruct").destroy();this.setAggregation("_noDataStruct",null);}return this._createInnerChart(i,I);}.bind(this)).then(function y(I){if(this.getAutoBindOnInit()){T.createToolbar(this,A);}else{T.updateToolbar(this);}this._createDrillBreadcrumbs();this._toggleChartTooltipVisibility(this.getShowChartTooltip());this._tempResolve(I);return I;}.bind(this)).catch(function y(E){this._tempReject();if(E){L.error("The control could not be initialized.",E,this.getMetadata().getName());}}.bind(this));if(!i||i.selectionMode===undefined){_.apply(this);}if(i&&i.data){this._addBindingListener(i.data,"change",this._onDataLoadComplete.bind(this));}this._bInnerChartInitialized=true;this.bindAggregation("data",this.oDataInfo);};t.prototype.bindAggregation=function(N,B,i){if(N=="data"){this.oDataInfo=B;var j=this.getAggregation("_chart");if(j&&this.bDelegateInitialized){this.getControlDelegate().rebindChart(this,B,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){this.getControlDelegate().rebindChart(this,B,i);}.bind(this));}return this;}return a.prototype.bindAggregation.apply(this,arguments);};t.prototype._onDataLoadComplete=function(E){if(E.mParameters.reason==="change"&&!E.mParameters.detailedReason){this.setBusy(false);}};t.prototype._addBindingListener=function(B,E,H){if(!B.events){B.events={};}if(!B.events[E]){B.events[E]=H;}else{var O=B.events[E];B.events[E]=function(){H.apply(this,arguments);O.apply(this,arguments);};}};t.prototype.getBindingInfo=function(N){if(N=="data"){return this.oDataInfo;}return a.prototype.getBindingInfo.apply(this,arguments);};t.prototype.setLegendVisible=function(i){this.setVizProperties({'legend':{'visible':i},'sizeLegend':{'visible':i}});return this.setProperty("legendVisible",i);};t.prototype._createInnerChart=function(k,I){k=k||{};var x={},y,z=[],A=[],B=[],E={};x.chartType='{$mdcChart>/chartType}';x.dimensions=[];x.measures=[];x.id=this.getId()+"--innerChart";x.height='100%';x.width='100%';x.vizProperties='{$mdcChart>/vizProperties}';k.items=k.items||[];function G(j){if(this&&this.getVizItemType()=="Dimension"){x.dimensions.push(j);}else{x.measures.push(j);}}function H(y,O){if(y.getCriticality()){O._addCriticality(y);}B.push(y.getKey());if(y.getAdditionalColoringMeasures){for(var j=0;j<y.getAdditionalColoringMeasures().length;j++){if(A.indexOf(y.getAdditionalColoringMeasures()[j])==-1){A.push(y.getAdditionalColoringMeasures()[j]);}}}}function K(){var j,O;for(var i=0;i<A.length;i++){j=A[i];if(B.indexOf(j)==-1){O=this.getControlDelegate().retrieveAggregationItem("items",I[j]);O=q.getVizItemSettings(O.settings);z.push(q.createVizChartItem(O).then(G));}}}for(var i=0;i<k.items.length;i++){y=k.items[i];H(y,this);if(I[y.getKey()]){E=this.getControlDelegate().retrieveAggregationItem("items",I[y.getKey()]).settings;}else{E=undefined;}z.push(y.toVizChartItem(E).then(G.bind(y)));}K();var N=function(j){this.fireDataPointsSelected({dataContext:j.getParameters()});};return Promise.all(z).then(function(){var j=new m(x);j.setVisibleDimensions([]);j.setVisibleMeasures([]);j.setInResultDimensions([]);j.attachSelectData(function(O){N.call(this,O);}.bind(this));j.attachDeselectData(function(O){N.call(this,O);}.bind(this));this._oObserver.observe(j,{bindings:["data"],aggregations:["dimensions","measures"]});this.setAggregation("_chart",j);return j;}.bind(this));};t.prototype.setSelectionMode=function(i){this.setProperty("selectionMode",i,true);i=this.getSelectionMode();_.call(this,i);return this;};t.prototype.addItem=function(i,j){var k=this.getAggregation("_chart");if(k){i.toChart(k);}else if(this.oChartPromise){this.oChartPromise.then(function(k){if(k){this.toChart(k);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.addAggregation("items",i,j);};t.prototype.insertItem=function(i,I,j){if(i.getCriticality()){this._addCriticality(i);}var k=this.getAggregation("_chart");if(k){i.toChart(k);}else if(this.oChartPromise){this.oChartPromise.then(function(k){if(k){this.toChart(k);}}.bind(i));}this._oObserver.observe(i,{properties:["visible","inResult","role"]});return this.insertAggregation("items",i,I,j);};t.prototype.removeItem=function(i,j){this._oObserver.unobserve(i);return this.removeAggregation("items",i,j);};t.prototype.exit=function(){a.prototype.exit.apply(this,arguments);this.oChartPromise=null;this._oSelectionHandlerPromise=null;var i=this.getAggregation("_chart");if(i){i.destroy();}};t.prototype.getItemsByKeys=function(I){var j=[],k=this.getItems();I.forEach(function(x){for(var i=k.length-1;i>=0;i--){if(k[i].getKey()==x){j.push(k[i]);break;}}});return j;};t.prototype._showDrillDown=function(){if(o){if(!this._oDrillDownPopover){o.createDrillDownPopover(this);}return o.showDrillDownPopover(this);}return new Promise(function(i,j){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(k){o=k;o.createDrillDownPopover(this);o.showDrillDownPopover(this).then(function(x){i(x);});}.bind(this));}.bind(this));};t.prototype._createDrillBreadcrumbs=function(){if(o){if(!this._oDrillBreadcrumbs){return o.createDrillBreadcrumbs(this);}return Promise.resolve(this._oDrillBreadcrumbs);}return new Promise(function(i,j){sap.ui.require(["sap/ui/mdc/chart/DrillStackHandler"],function(k){o=k;o.createDrillBreadcrumbs(this).then(function(x){i(x);});}.bind(this));}.bind(this));};t.prototype._getPropertyData=function(){return new Promise(function(i,j){if(!this.aFetchedProperties){return this.oChartPromise.then(function(){return this.getControlDelegate().fetchProperties(this);}.bind(this)).then(function(k){this.aFetchedProperties=k;i(k);}.bind(this));}else{i(this.aFetchedProperties);}}.bind(this));};t.prototype.getAvailableChartTypes=function(){var j=[];var k=this.getAggregation("_chart");if(k){var A=k.getAvailableChartTypes().available;if(j){var x=C.getLibraryResourceBundle("sap.chart.messages");for(var i=0;i<A.length;i++){var y=A[i].chart;j.push({key:y,icon:p.mMatchingIcon[y],text:x.getText("info/"+y),selected:(y==this.getChartType())});}}}return j;};t.prototype.getTypeInfo=function(){var i=this.getChartType(),j=C.getLibraryResourceBundle("sap.ui.mdc");var I={icon:p.mMatchingIcon[i],text:j.getText("chart.CHART_TYPE_TOOLTIP",[i])};return I;};t.prototype.getManagedObjectModel=function(){return this._oManagedObjectModel;};t.prototype.update=function(i){var j=this.getAggregation("_chart");if(j){this._update(j,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){if(j){this._update(j,i);}}.bind(this));}};t.prototype._update=function(j,k){var I=this.getItems(),x,y,z=[],A=[],B=[],E={};if(k.name==="ignoreToolbarActions"||k.name==="p13nMode"){return;}if(k.name==="data"&&k.type==="binding"&&k.mutation==="prepare"&&k.object.isA("sap.chart.Chart")){k.bindingInfo.sorter=this._getSorters();}this._aInResultProperties=[];for(var i=0;i<I.length;i++){y=I[i];x=y.getVizItemType()=="Measure"?j.getMeasureByName(y.getKey()):j.getDimensionByName(y.getKey());if(!x){continue;}if(y.getVisible()){if(y.getVizItemType()=="Measure"){z.push(x.getName());if(y.getDataPoint()){E[x.getName()]=y.getDataPoint();}}else{A.push(x.getName());}this._aInResultProperties.push(x.getName());}if(y.getVizItemType()=="Dimension"){if(y.getInResult()){B.push(x.getName());this._aInResultProperties.push(x.getName());}}}var R=false;if(!g(A,j.getVisibleDimensions())){j.setVisibleDimensions(A);R=true;}if(!g(z,j.getVisibleMeasures())){j.setVisibleMeasures(z);R=true;}if(!g(B,j.getInResultDimensions())){j.setInResultDimensions(B);R=true;}if(R){this.rebind();this._updateSemanticalPattern(j,z,E);this._updateColoring(j,A,z);}if(o&&this.getAggregation("_breadcrumbs")){o._updateDrillBreadcrumbs(this,this.getAggregation("_breadcrumbs"));}};t.prototype._updateSemanticalPattern=function(i,j,x){for(var k=0;k<j.length;k++){var y=x[j[k]];if(y){if(y.targetValue||y.foreCastValue){var A=i.getMeasureByName(j[k]);A.setSemantics("actual");if(y.targetValue!=null){var R=i.getMeasureByName(y.targetValue);if(R){R.setSemantics("reference");}else{L.error("sap.ui.mdc.Chart: "+y.targetValue+" is not a valid measure");}}if(y.foreCastValue){var P=i.getMeasureByName(y.foreCastValue);if(P){P.setSemantics("projected");}else{L.error("sap.ui.comp.SmartChart: "+y.ForecastValue.Path+" is not a valid measure");}}A.setSemanticallyRelatedMeasures({referenceValueMeasure:y.targetValue,projectedValueMeasure:y.foreCastValue});}}}};t.prototype._updateColoring=function(i,j,x,y){var z=this.getProperty("_colorings"),k;if(z&&z.Criticality){var A;for(k=0;k<j.length;k++){if(z.Criticality.DimensionValues[j[k]]){A={coloring:"Criticality",parameters:{dimension:j[k]}};delete z.Criticality.MeasureValues;break;}}if(!A){delete z.Criticality.DimensionValues;for(var B in z.Criticality.MeasureValues){if(x.indexOf(B)==-1){delete z.Criticality.MeasureValues[B];}}A={coloring:"Criticality",parameters:{measure:x}};}if(A){i.setColorings(z);i.setActiveColoring(A);}}};t.prototype._prepareSelection=function(){if(n){n.prepareChart(this);}else{this._oSelectionHandlerPromise=l(["sap/ui/mdc/chart/SelectionHandler"]).then(function(i){n=i[0];if(this.bIsDestroyed){return;}n.prepareChart(this);}.bind(this));}};t.prototype._getSorters=function(){var i;var j=this.getSortConditions()?this.getSortConditions().sorters:[];j.forEach(function(k){if(this._aInResultProperties.indexOf(k.name)!=-1){var x=new f(k.name,k.descending);if(i){i.push(x);}else{i=[x];}}}.bind(this));return i;};t.prototype.rebind=function(){this.setBusy(true);if(!this._bInnerChartInitialized){this._createChart(this._mStoredSettings,this._mStoredActions);return;}if(!this.bDelegateInitialized){return;}var B=this.oDataInfo,i=this.getControlDelegate();if(i){i.updateBindingInfo(this,B);}if(!this.isInnerChartBound()){return;}if(B){B.sorter=this._getSorters();B.binding.bHasAnalyticalInfo=true;}this.bindAggregation("data",B);this._updateInnerChartNoDataText();this._renderOverlay(false);};t.prototype.isInnerChartBound=function(){return this.getAggregation("_chart")?this.getAggregation("_chart").isBound("data"):false;};t.prototype._onFiltersChanged=function(E){if(this.isInnerChartBound()&&E.getParameter("conditionsBased")){this._renderOverlay(true);}};t.prototype._renderOverlay=function(i){if(this.getAggregation("_chart")){var $=this.getAggregation("_chart").$(),j=$.find(".sapUiMdcChartOverlay");if(i&&j.length===0){j=jQuery("<div>").addClass("sapUiOverlay sapUiMdcChartOverlay").css("z-index","1");$.append(j);}else if(!i){j.remove();}}};t.prototype.setNoDataText=function(N){this.setProperty("noDataText",N,true);this._updateInnerChartNoDataText();return this;};t.prototype._onFilterProvided=function(){this._updateInnerChartNoDataText();};t.prototype._onFilterRemoved=function(){this._updateInnerChartNoDataText();};t.prototype._updateInnerChartNoDataText=function(){var i=this.getAggregation("_chart");if(!i){return;}i.setCustomMessages({'NO_DATA':this._getNoDataText()});};t.prototype._getNoDataText=function(){var N=this.getNoDataText();if(N){return N;}var R=C.getLibraryResourceBundle("sap.ui.mdc");if(!this.isInnerChartBound()){if(this.getFilter()){return R.getText("chart.NO_DATA_WITH_FILTERBAR");}return R.getText("chart.NO_DATA");}return R.getText("chart.NO_RESULTS");};t.prototype._addCriticality=function(i){var j=this.getProperty("_colorings");j=j||{Criticality:{DimensionValues:{},MeasureValues:{}}};var k=i.getCriticality(),x={};if(i.getVizItemType()=="Dimension"){for(var K in k){x[K]={Values:k[K]};}j.Criticality.DimensionValues[i.getKey()]=x;}else{for(var K in k){x[K]=k[K];}j.Criticality.MeasureValues[i.getKey()]=x;}this.setProperty("_colorings",j);};t.prototype.getCollectionModel=function(){var B=this.getBindingInfo("data");return B?this.getModel(B.model):null;};t.prototype.getCollectionPath=function(){var B=this.getBindingInfo("data");return B?B.path:null;};t.prototype.done=function(){return this.oChartPromise;};t.prototype.initialized=function(){return this.oChartPromise;};var v=function(i){var P=[];if(i){i.getItems().forEach(function(j,I){P.push({name:j.getKey(),role:j.getRole()});});}return P;};var w=function(i){return i.getSortConditions()?i.getSortConditions().sorters:[];};t.prototype.isFilteringEnabled=function(){var P=this.getP13nMode()||[];return P.indexOf("Filter");};t.prototype.getCurrentState=function(){var i={};var P=this.getP13nMode();if(P){if(P.indexOf("Item")>-1){i.items=v(this);}if(P.indexOf("Sort")>-1){i.sorters=w(this);}}return i;};t.prototype.setShowChartTooltip=function(i){this.setProperty("showChartTooltip",i);this._toggleChartTooltipVisibility(i);return this;};t.prototype._toggleChartTooltipVisibility=function(i){var j=this.getAggregation("_chart");if(j){this._setChartTooltipVisiblity(j,i);}else if(this.oChartPromise){this.oChartPromise.then(function(j){this._setChartTooltipVisiblity(j,i);}.bind(this));}};t.prototype._setChartTooltipVisiblity=function(i,j){if(j){if(!this._vizTooltip){this._vizTooltip=new r();}this._vizTooltip.connect(i.getVizUid());}else{if(this._vizTooltip){this._vizTooltip.destroy();}}};return t;},true);
