/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/UriParameters","sap/ui/base/ManagedObject","sap/ui/mdc/p13n/FlexUtil","sap/ui/model/json/JSONModel","sap/base/util/merge","sap/base/Log","./P13nBuilder","sap/ui/mdc/util/PropertyHelper"],function(S,M,F,J,m,L,P,a){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var u=new S(window.location.search);var A=M.extend("sap.ui.mdc.AdaptationController",{metadata:{properties:{adaptationControl:{type:"object"},liveMode:{type:"boolean",defaultValue:false},itemConfig:{type:"object"},sortConfig:{type:"object",defaultValue:{changeOperations:{add:"addSort",remove:"removeSort",move:"moveSort"},adaptationUI:"sap/ui/mdc/p13n/panels/SortPanel",containerSettings:{title:r.getText("sort.PERSONALIZATION_DIALOG_TITLE")}}},filterConfig:{type:"object",defaultValue:{adaptationUI:null,initializeControl:null,containerSettings:{title:r.getText("filter.PERSONALIZATION_DIALOG_TITLE")}}},stateRetriever:{type:"function"},retrievePropertyInfo:{type:"function"},afterChangesCreated:{type:"function"},onReset:{type:"function"}},events:{beforeP13nContainerOpens:{container:{type:"object"}},afterP13nContainerCloses:{container:{type:"object"},reason:{type:"string"}}}}});A.prototype.init=function(){this.oAdaptationModel=new J();this.oAdaptationModel.setSizeLimit(10000);this.oState={};this.bIsDialogOpen=false;};A.prototype.showP13n=function(s,p){if(u.getAll("sap-ui-xx-p13nLiveMode")[0]==="true"){this.setLiveMode(true);L.warning("Please note that the p13n liveMode is experimental");}if(!this.bIsDialogOpen){this.bIsDialogOpen=true;return this.createP13n(p).then(function(o){var v=u.getAll("sap-ui-xx-filterView")[0];if(v==="list"&&o&&o.getContent()[0]&&o.getContent()[0]._oFilterBarLayout&&o.getContent()[0]._oFilterBarLayout.getInner().isA("sap.ui.mdc.p13n.panels.GroupPanelBase")){o.getContent()[0]._oFilterBarLayout.getInner().switchViewMode("list");}this._openP13nControl(o,s);return o;}.bind(this),function(e){this.bIsDialogOpen=false;L.error("P13n container creation failed: "+e);}.bind(this));}};A.prototype.createP13n=function(p,b){var t=this;return t._retrieveControl(t.getAdaptationControl().getDelegate().name).then(function(d){t.oAdaptationControlDelegate=d;return t._retrievePropertyHelper(b);}).then(function(o){t.sP13nType=p;return t._retrieveP13nContainer().then(function(c){var d=c.getContent()[0];var e=t._prepareAdaptationData(o);t._setP13nModelData(e);d.setP13nModel(t.oAdaptationModel);if(d.setLiveMode){d.setLiveMode(t.getLiveMode());}var f=t.getTypeConfig(p).initializeControl;return f.call(d).then(function(){t.getAdaptationControl().addDependent(c);return c;});});});};A.prototype.createSortChanges=function(n,b){return this._executeAfterAsyncActions(function(){var c=m({},this.getStateRetriever().call(this.getAdaptationControl(),this.oAdaptationControlDelegate));var p=c.sorters||[];var s=this.getSortConfig();var f=function(o){return o.name+o.descending;};var d=function(i){return i.hasOwnProperty("sorted")&&i.sorted===false?false:true;};var N=b?n:this._getFilledArray(p,n,"sorted").filter(d);var e=F.getArrayDeltaChanges(p,N,f,this.getAdaptationControl(),s.changeOperations);if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,e,"Sort");}return e;}.bind(this));};A.prototype.createItemChanges=function(n){return this._executeAfterAsyncActions(function(){var b=this.getAdaptationControl();var c=m({},this.getStateRetriever().call(b,this.oAdaptationControlDelegate));var p=c.items;var i=this.getItemConfig();var s=function(o){var d=o.name;if(i&&i.additionalDeltaAttributes&&i.additionalDeltaAttributes instanceof Array){i.additionalDeltaAttributes.forEach(function(e){d+=o[e];});}return d;};var f=function(o){return o.hasOwnProperty("visible")&&o.visible===false?false:true;};var N=this._getFilledArray(p,n,"visible").filter(f);var I=F.getArrayDeltaChanges(p,N,s,this.getAdaptationControl(),i.changeOperations);if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,I,"Item");}return I;}.bind(this));};A.prototype.createConditionChanges=function(n){return this._executeAfterAsyncActions(function(){var c=[];var C=m({},this.getStateRetriever().call(this.getAdaptationControl(),this.oAdaptationControlDelegate));var p=C.filter;var o=this.getAdaptationControl();for(var f in n){var v=this._hasProperty(f).valid;if(!v){L.warning("property '"+f+"' not supported");continue;}c=c.concat(F.getConditionDeltaChanges(f,n[f],p[f],o));}if(this.getAfterChangesCreated()){this.getAfterChangesCreated()(this,c,"Value");}return c;}.bind(this));};A.prototype._retrievePropertyHelper=function(c){if(this.oPropertyHelper){this.oPropertyHelper.destroy();}if(c){this.oPropertyHelper=new a(c);return Promise.resolve(this.oPropertyHelper);}if(this.getRetrievePropertyInfo()){this.oPropertyHelper=new a(this.getRetrievePropertyInfo().call(this.getAdaptationControl()));return Promise.resolve(this.oPropertyHelper);}return this.getAdaptationControl().initPropertyHelper();};A.prototype._executeAfterAsyncActions=function(c){return this._retrievePropertyHelper().then(function(p){return c();});};A.prototype.getTypeConfig=function(p){var o=this["get"+p+"Config"]?this["get"+p+"Config"]():undefined;return{changeOperations:o?o.changeOperations:{},ignoreIndex:o?o.ignoreIndex:false,adaptationUI:o?o.adaptationUI:undefined,initializeControl:o&&o.initializeControl?o.initializeControl:function(){return Promise.resolve();},containerSettings:o&&o.containerSettings?o.containerSettings:{},sortData:o&&o.hasOwnProperty("sortData")?o.sortData:true};};A.prototype._openP13nControl=function(p,s){this.fireBeforeP13nContainerOpens({container:p});if(this.getLiveMode()){p.openBy(s);}else{p.open();}};A.prototype._getFilledArray=function(p,n,R){var N=m([],p);var b=m([],n);var e=P.arrayToMap(p);b.forEach(function(i){var E=e[i.name];if(!i.hasOwnProperty(R)||i[R]){var c=i.position;if(E){c=c>-1?c:E.position;var o=E.position;N.splice(c,0,N.splice(o,1)[0]);}else{c=c>-1?c:N.length;N.splice(c,0,i);}N[c]=i;}else if(E){N[E.position][R]=false;}});return N;};A.prototype._prepareAdaptationData=function(){var o=this.getAdaptationControl();var p=this.oPropertyHelper||o.getPropertyHelper();var c=m({},this.getStateRetriever().call(o,this.oAdaptationControlDelegate));var i=this._getTypeIgnoreValues(this.sP13nType);var s=this.getTypeConfig(this.sP13nType).sortData;return P.prepareP13nData(c,p,i,s?this.sP13nType:"generic");};A.prototype._getTypeIgnoreValues=function(p){var i;if(this.sP13nType=="Sort"){i=[{ignoreKey:"sortable",ignoreValue:false}];}if(this.sP13nType=="Filter"){i=[{ignoreKey:"filterable",ignoreValue:false}];}if(this.sP13nType=="Item"){i=[{ignoreKey:"visible",ignoreValue:false}];}return i;};A.prototype._setP13nModelData=function(p){this.oAdaptationModel.setProperty("/items",p.items);this.oAdaptationModel.setProperty("/itemsGrouped",p.itemsGrouped);this.oState=m({},p);};A.prototype.resetP13n=function(){return F.discardChanges({selector:this.getAdaptationControl()}).then(function(){var p=this._prepareAdaptationData();this.oState=m({},p);this.oAdaptationModel.setProperty("/items",p.items);this.oAdaptationModel.setProperty("/itemsGrouped",p.itemsGrouped);}.bind(this));};A.prototype._retrieveP13nContainer=function(){return new Promise(function(b,c){var l=this.getLiveMode();var v=this.getTypeConfig(this.sP13nType).adaptationUI;var p=function(o){if(l&&!this.bInitialized&&o.attachChange){o.attachChange(function(){this._handleChange();}.bind(this));}this._createP13nContainer(o).then(function(d){b(d);});}.bind(this);if(typeof v==="string"){var s=v;this._retrieveControl(s).then(function(d){var e=new d();p(e);});}else if(v instanceof Function){var C=v.call(this.getAdaptationControl());if(C instanceof Promise){C.then(function(o){p(o);});}else{p(C);}}else if(v.isA("sap.ui.core.Control")){var o=v;p(o);}else{c(new Error("Please provide either a BasePanel derivation or a custom Control as personalization UI for AdaptationController"));}}.bind(this));};A.prototype._retrieveControl=function(p){return new Promise(function(b,c){sap.ui.require([p],function(C){b(C);},c);});};A.prototype._createP13nContainer=function(p){var c;if(this.getLiveMode()){c=this._createPopover(p);}else{c=this._createModalDialog(p);}return c.then(function(C){C.addStyleClass("sapUiMdcPersonalizationDialog");if(!this.getLiveMode()){C.setEscapeHandler(function(d){this._closeDialog(C,"Cancel");d.resolve();}.bind(this));}C.toggleStyleClass("sapUiSizeCompact",!!jQuery(this.getAdaptationControl()).closest(".sapUiSizeCompact").length);return C;}.bind(this));};A.prototype._addResetInfo=function(s){if(this.getOnReset()){s.reset={title:s.title,onExecute:this.getOnReset().bind(this.getAdaptationControl())};}};A.prototype._createPopover=function(p){var f=function(e){var o=e.getSource();this.fireAfterP13nContainerCloses({reason:"autoclose",container:o});o.destroy();this.bIsDialogOpen=false;}.bind(this);var s=Object.assign({verticalScrolling:true,afterClose:f},this.getTypeConfig(this.sP13nType).containerSettings);this._addResetInfo(s);return P.createP13nPopover(p,s);};A.prototype._createModalDialog=function(p){var d=function(e){var o=e.getSource().getParent();this._handleChange();this._closeDialog(o,"Ok");}.bind(this);var D=function(e){var c=e.getSource().getParent();this._closeDialog(c,"Cancel");}.bind(this);var s=Object.assign({verticalScrolling:true,confirm:{handler:d},cancel:D},this.getTypeConfig(this.sP13nType).containerSettings);this._addResetInfo(s);return P.createP13nDialog(p,s);};A.prototype._closeDialog=function(c,R){c.close();this.bIsDialogOpen=false;this.fireAfterP13nContainerCloses({reason:R,container:c});c.destroy();};A.prototype._handleChange=function(){var c=[],i=[],C=[];var f=function(o){return this.sP13nType=="Sort"?o.isSorted:o.selected;}.bind(this);i=this.oState.items.filter(f);C=this.oAdaptationModel.getData().items.filter(f);var s=function(o){var d=o.name;if(o.hasOwnProperty("descending")){d=d+o.descending;}if(o.role){d=d+o.role;}return d;};var b=this.getTypeConfig(this.sP13nType).changeOperations;var I=this.getTypeConfig(this.sP13nType).ignoreIndex;if(b){c=F.getArrayDeltaChanges(i,C,s,this.getAdaptationControl(),b,I);}else{c=[];}this.oState=m({},this.oAdaptationModel.getData());this.getAfterChangesCreated()(this,c,"Item");};A.prototype._hasProperty=function(n){var i={valid:false,property:undefined};var p=this.oPropertyHelper||this.getAdaptationControl().getPropertyHelper();p.getProperties().some(function(o){var v=o.getName()===n||n=="$search";if(v){i.valid=true;i.property=o;}return v;});return i;};A.prototype.destroy=function(s){M.prototype.destroy.apply(this,arguments);if(this.oAdaptationModel){this.oAdaptationModel.destroy();this.oAdaptationModel=null;}if(this.oPropertyHelper){this.oPropertyHelper.destroy();this.oPropertyHelper=null;}this.oState=null;this.bIsDialogOpen=null;this.sP13nType=null;this.oAdaptationControlDelegate=null;this.mChangeOperations=null;};return A;});
