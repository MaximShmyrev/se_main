/*
* ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
*/
sap.ui.define(["./PropertyHelper","sap/m/Button","sap/m/Bar","sap/m/Title","sap/base/util/merge","sap/m/MessageBox"],function(P,B,a,T,m,M){"use strict";var r=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var b={createP13nPopover:function(p,d){return new Promise(function(c,e){sap.ui.require(["sap/m/ResponsivePopover"],function(R){b["_checkSettings"](p,d,e);var o=new R({title:d.title,horizontalScrolling:d.hasOwnProperty("horizontalScrolling")?d.horizontalScrolling:false,verticalScrolling:d.hasOwnProperty("verticalScrolling")?d.verticalScrolling:false,contentWidth:d.contentWidth?d.contentWidth:"24rem",resizable:d.hasOwnProperty("resizable")?d.resizable:true,contentHeight:d.contentHeight?d.contentHeight:"35rem",placement:d.placement?d.placement:"Bottom",content:p,afterClose:d.afterClose?d.afterClose:function(){}});if(d.reset){var C=this._createResetHeader({title:d.title,reset:d.reset.onExecute,idResetButton:d.reset.idButton,warningText:d.reset.warningText});o.setCustomHeader(C);}c(o);},e);});},createP13nDialog:function(p,d){return new Promise(function(c,e){b["_checkSettings"](p,d,e);var i=d.id;sap.ui.require(["sap/m/Dialog","sap/m/Button"],function(D,B){var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");var C=new D(i,{title:d.title,horizontalScrolling:d.hasOwnProperty("horizontalScrolling")?d.horizontalScrolling:false,verticalScrolling:d.hasOwnProperty("verticalScrolling")?d.verticalScrolling:true,contentWidth:d.contentWidth?d.contentWidth:"40rem",contentHeight:d.contentHeight?d.contentHeight:"55rem",draggable:true,resizable:true,stretch:"{device>/system/phone}",content:p,buttons:[new B(i?i+"-confirmBtn":undefined,{text:d.confirm&&d.confirm.text?d.confirm.text:R.getText("p13nDialog.OK"),type:"Emphasized",press:function(){if(d.confirm&&d.confirm.handler){d.confirm.handler.apply(C,arguments);}}}),new B(i?i+"-cancelBtn":undefined,{text:R.getText("p13nDialog.CANCEL"),press:function(){d.cancel.apply(C,arguments);}})]});if(d.reset){var o=b._createResetHeader({title:d.title,idResetButton:d.reset.idButton,reset:d.reset.onExecute,warningText:d.reset.warningText});C.setCustomHeader(o);}var A=d.additionalButtons;if(A instanceof Array){A.forEach(function(f){if(!f.isA("sap.m.Button")){e("Please only provide sap.m.Button instances as 'additionalButtons'");}C.addButton(f);});}c(C);},e);});},_createResetHeader:function(s){var o=new a({contentLeft:[new T({text:s.title})]});if(s.reset){var i=s.idResetButton;o.addContentRight(new B(i,{text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("p13nDialog.RESET"),press:function(){var R=s.warningText?s.warningText:sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc").getText("filterbar.ADAPT_RESET_WARNING");M.warning(R,{actions:[M.Action.OK,M.Action.CANCEL],emphasizedAction:M.Action.OK,onClose:function(A){if(A===M.Action.OK){s.reset();}}});}}));}return o;},prepareP13nData:function(c,p,i,s){var o=p.isA&&p.isA("sap.ui.mdc.util.PropertyHelper")?p:new P(p);i=i?i:[];var I=[],d={};var e=c.items||[];var S=c.sorters||[];var E=this.arrayToMap(e);var f=this.arrayToMap(S);var g=c.filter||{};o.getProperties().forEach(function(h){var R=m({},o.getRawProperty(h.getName()),{sortable:h.isSortable(),filterable:h.isFilterable(),visible:h.isVisible()});var j={};if(b._isExcludeProperty(R,i)){return;}var k=h.getName();var l=E[k];j.selected=l?true:false;j.position=l?l.position:-1;j=m(j,R,l);j.label=h.getLabel()||h.getName();j.tooltip=R.tooltip?R.tooltip:h.getLabel();j.visibleInDialog=R.hasOwnProperty("visibleInDialog")?R.visibleInDialog:true;if(s=="Sort"){j.isSorted=f[k]?true:false;j.sortPosition=f[k]?f[k].position:-1;j.descending=f[k]?f[k].descending:false;}if(c.filter){var n=g[k];j.isFiltered=n&&n.length>0?true:false;}j.group=j.group?j.group:"BASIC";d[j.group]=d[j.group]?d[j.group]:[];d[j.group].push(j);I.push(j);});if(s){this._sortP13nData(s,I);}return{items:I,itemsGrouped:this._builtGroupStructure(d)};},_sortP13nData:function(p,i){var c=this._getSortAttributes()[p];var s=c.position;var S=c.visible;var l=sap.ui.getCore().getConfiguration().getLocale().toString();var C=window.Intl.Collator(l,{});i.sort(function(f,F){if(f[S]&&F[S]){return(f[s]||0)-(F[s]||0);}else if(f[S]){return-1;}else if(F[S]){return 1;}else if(!f[S]&&!F[S]){return C.compare(f.label,F.label);}});},_getSortAttributes:function(){return{Item:{position:"position",visible:"selected"},Sort:{position:"sortPosition",visible:"isSorted"},Filter:{position:"position",visible:"selected"},generic:{position:undefined,visible:undefined}};},_builtGroupStructure:function(i){var g=[];Object.keys(i).forEach(function(G){this._sortP13nData("generic",i[G]);g.push({group:G,groupLabel:i[G][0].groupLabel||r.getText("p13nDialog.FILTER_DEFAULT_GROUP"),groupVisible:true,items:i[G]});}.bind(this));return g;},_isExcludeProperty:function(p,i){return i.some(function(k){var I=k.ignoreKey;var v=k.ignoreValue;return p[I]===v;});},_checkSettings:function(p,d,o){if(!d){o("Please provide a settings object for p13n creation");}if(!d.title&&!d.customHeader){o("Please provide a title or customHeader in the settings object for p13n creation");}},arrayToMap:function(A){return A.reduce(function(c,p,i){c[p.name]=p;c[p.name].position=i;return c;},{});}};return b;});
