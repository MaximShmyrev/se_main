/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./BasePanel","sap/m/Label","sap/base/util/deepEqual","sap/m/CustomListItem","sap/m/List","sap/m/Panel","sap/m/Toolbar","sap/m/Table","sap/m/Text","sap/m/ColumnListItem","sap/m/Column","sap/ui/core/Icon","sap/m/HBox"],function(B,L,d,C,a,P,T,b,c,e,f,I,H){"use strict";var G=B.extend("sap.ui.mdc.p13n.panels.GroupView",{metadata:{library:"sap.ui.mdc"},renderer:{}});G.prototype.init=function(){B.prototype.init.apply(this,arguments);var g=new e({visible:"{"+this.P13N_MODEL+">groupVisible}",cells:[this._createGroupPanelTemplate(this._createGroupListTemplate())]});this.setShowFactory(true);this.displayColumns();this._aInitializedLists=[];this.setTemplate(g);this._setMoveButtonVisibility(true);};G.prototype.getShowFactory=function(){return this._bShowFactory;};G.prototype.setShowFactory=function(s){this._bShowFactory=s;};G.prototype.getPanels=function(){var p=[];this._oListControl.getItems().forEach(function(i){p.push(i.getCells()[0]);});return p;};G.prototype._createGroupListTemplate=function(){return new a({selectionChange:function(o){var p=o.getParameter("listItem").getBindingContext(this.P13N_MODEL).sPath;var i=this.getP13nModel().getProperty(p);this.fireChange({reason:i.selected?"Add":"Remove",item:i});}.bind(this),showSeparators:"None",items:this._getItemsBinding(false),mode:"MultiSelect"});};G.prototype._createGroupPanelTemplate=function(i){var g=this.P13N_MODEL;return new P({expandable:true,expanded:{path:this.P13N_MODEL+">group",formatter:function(){if(this.getBindingContext(g)){var E=this.getBindingContext(g).sPath.split("/")[2]==="0";return E;}else{return false;}}},expand:function(E){var s=E.getSource();var o=s.getContent()[0];this._addInitializedList(o);if(this.getShowFactory()){this._addFactoryControl(o);this.filterWithoutDestroy(this._aCurrentFilters);}}.bind(this),width:"100%",headerToolbar:[new T({content:[new L({text:"{"+this.P13N_MODEL+">groupLabel}",design:"Bold"})]})],content:[i]});};G.prototype._addFactoryControl=function(l){if(l.getItems().length==0||l.getItems()[0].getContent().length<2){l.getItems().forEach(function(i){var o=i.getBindingContext(this.P13N_MODEL);var F=this.getItemFactory().call(this,o);i.addContent(F);if(i.getContent()[0].getItems().length>1){i.getContent()[0].removeItem(1);}}.bind(this));}this.addStyleClass("sapUiMDCAFLabelMarking");};G.prototype._createInnerListControl=function(){var l=new b(this.getId()+"-innerGroupViewTable",Object.assign(this._getListControlConfig(),{mode:"None",updateStarted:function(E){this._checkAllPanels();}.bind(this)}));return l;};G.prototype._getItemsBinding=function(A){var g=function(i,o){var h=[new H({width:"100%",justifyContent:"SpaceBetween",items:[new L({required:"{"+this.P13N_MODEL+">required}",text:"{"+this.P13N_MODEL+">label}"})]})];return new C({visible:"{"+this.P13N_MODEL+">visibleInDialog}",selected:"{"+this.P13N_MODEL+">selected}",tooltip:"{"+this.P13N_MODEL+">tooltip}",content:h});}.bind(this);return{path:this.P13N_MODEL+">items",key:"name",templateShareable:false,template:g()};};G.prototype._getIconTemplate=function(){return new I({src:"sap-icon://circle-task-2",size:"0.5rem",color:sap.ui.core.IconColor.Neutral,visible:{path:this.P13N_MODEL+">isFiltered",formatter:function(i){if(i){return true;}else{return false;}}}});};G.prototype._loopGroupList=function(g){this._oListControl.getItems().forEach(function(o){var p=o.getCells()[0];var i=p.getContent()[0];this._loopItems(i,function(h,k){g(h,k);});}.bind(this));};G.prototype._loopItems=function(l,i){l.getItems().forEach(function(o){var p=o.getBindingContextPath();var k=this.getP13nModel().getProperty(p).name;i.call(this,o,k);}.bind(this));};G.prototype._removeFactoryControl=function(){this._loopGroupList(function(i,k){if(i.getContent()[1]){i.removeContent(i.getContent()[1]);var l=i.getParent();this._addInitializedList(l);var o=this._getIconTemplate();i.getContent()[0].addItem(o);}}.bind(this));this.removeStyleClass("sapUiMDCAFLabelMarking");return this._aInitializedLists||[];};G.prototype._addInitializedList=function(l){var s=l.getId();if(this._aInitializedLists.indexOf(s)<0){this._aInitializedLists.push(s);}};G.prototype._getInitializedLists=function(){var l=[];this._aInitializedLists.forEach(function(s){var o=sap.ui.getCore().byId(s);if(o){l.push(o);}});return l;};G.prototype.getSelectedFields=function(){var s=[];this._oListControl.getItems().forEach(function(o){var p=o.getCells()[0];var i=p.getContent()[0];this._loopItems(i,function(g,k){if(g.getSelected()){s.push(k);}});}.bind(this));return s;};G.prototype.filterWithoutDestroy=function(F){if(d(F,this._aCurrentFilters)){return;}var i=this._removeFactoryControl();this._oListControl.getItems().forEach(function(o){var p=o.getCells()[0];var g=p.getContent()[0];if(g.getBinding("items")){g.getBinding("items").filter(F,true);this._togglePanelVisibility(p);}if(this.getShowFactory()&&i.indexOf(g.getId())>-1){this._addFactoryControl(g);}}.bind(this));this._aCurrentFilters=F;};G.prototype.showFactory=function(s){this.displayColumns();if(s){this._getInitializedLists().forEach(function(i){this._addFactoryControl(i);}.bind(this));}else{this._removeFactoryControl();}};G.prototype._checkAllPanels=function(){this._oListControl.getItems().forEach(function(o){var p=o.getCells()[0];this._togglePanelVisibility(p);}.bind(this));};G.prototype.setGroupExpanded=function(g,E){this._oListControl.getItems().forEach(function(o){var p=o.getCells()[0];var s=p.getBindingContext(this.P13N_MODEL).sPath;var i=this.getP13nModel().getProperty(s);if(i.group===g){p.setExpanded(E);}},this);};G.prototype._togglePanelVisibility=function(p){var i=p.getContent()[0];var o=p.getBindingContext(this.P13N_MODEL);if(o){var s=o.sPath;var g=this.getP13nModel().getProperty(s);g.groupVisible=i.getVisibleItems().length<1?false:true;this.getP13nModel().setProperty(s,g);}};G.prototype._checkFirstGroup=function(){if(!this._bInitialized&&this._oListControl&&this._oListControl.getItems().length>0){this._bInitialized=true;var F=this._oListControl.getItems()[0].getCells()[0].getContent()[0];this._addFactoryControl(F);this._addInitializedList(F);}};G.prototype.displayColumns=function(){var h=new H({width:"100%",justifyContent:"SpaceBetween",items:[new H({items:[new c({text:this.getResourceText("p13nDialog.LIST_VIEW_COLUMN")})]}).addStyleClass("sapUiMDCPaddingPanelLeft")]});if(!this.getShowFactory()){h.addItem(new H({width:"23.25%",justifyContent:"Center",items:[new c({text:this.getResourceText("p13nDialog.LIST_VIEW_ACTIVE")})]}));}var o=new f({header:h});this.setPanelColumns(o);};G.prototype.setP13nModel=function(m){this.setModel(m,this.P13N_MODEL);this._bindListItems();this._checkFirstGroup();this._checkAllPanels();};G.prototype._bindListItems=function(){this._oListControl.bindItems(Object.assign({path:this.P13N_MODEL+">/itemsGrouped",key:"name",templateShareable:false,template:this.getTemplate().clone()}));};G.prototype.exit=function(){B.prototype.exit.apply(this,arguments);this._aInitializedLists=null;this._bShowFactory=false;this._bInitialized=false;};return G;});
