/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../util/loadModules","../../library","sap/m/ColumnPopoverSelectListItem","sap/ui/core/Item","sap/ui/core/Core","sap/m/MessageBox"],function(T,l,a,C,I,b,M){"use strict";var c=a.TableType;var d=new window.WeakMap();var D=Object.assign({},T);D.initPropertyHelper=function(t){return Promise.all([this.fetchProperties(t),l("sap/ui/mdc/table/V4AnalyticsPropertyHelper")]).then(function(r){return Promise.all(r.concat(this.fetchPropertyExtensions(t,r[0])));}.bind(this)).then(function(r){var p=r[0];var P=r[1][0];var e=r[2];var m=0;var g=[];for(var i=0;i<p.length;i++){g.push(Object.assign({},p[i],{extension:e[p[i].name]||{}}));if(p[i].name in e){m++;}}if(m!==Object.keys(e).length){throw new Error("At least one property extension does not point to an existing property");}return new P(g,t);});};D.fetchPropertyExtensions=function(t,p){return Promise.resolve({});};D.preInit=function(t){var e=this;if(t._getStringType()===c.ResponsiveTable){throw new Error("This delegate does not support the table type '"+T.ResponsiveTable+"'.");}return f(t,e);};D.addColumnMenuItems=function(t,m){var p=t.getPropertyHelper();var g=p.getGroupableProperties(m.getDataProperty());var A=p.getAggregatableProperties(m.getDataProperty());var r=b.getLibraryResourceBundle("sap.ui.mdc");var P=t._oPopover;P&&P.getItems().forEach(function(i,e,h){if(i.getLabel()===r.getText("table.SETTINGS_GROUP")||i.getLabel()===r.getText("table.SETTINGS_AGGREGATE")){h[e].destroy();}if(h.length==0){P.destroy();}});var o,G;if(g&&g.length){G=this._onGroup(t,g,m);}if(A&&A.length){o=this._onAggregate(t,A,m);}return[G,o];};D._onGroup=function(t,g,m){var G,e=[];var A=d.get(t)["aggregate"]||[];var r=b.getLibraryResourceBundle("sap.ui.mdc");g.forEach(function(h){G=new I({text:h.getLabel(),key:h.getName()});e.push(G);});if(e.length>0){var o=new C({items:e,label:r.getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",aAnalytics:A,oMDCColumn:m},this._checkForPreviousAnalytics,this]});return o;}};D._onAggregate=function(t,A,m){var o,e=[];var g=d.get(t)["group"]||[];var r=b.getLibraryResourceBundle("sap.ui.mdc");A.forEach(function(i){o=new I({text:i.getLabel(),key:i.getName()});e.push(o);});if(e.length>0){var h=new C({items:e,label:r.getText("table.SETTINGS_AGGREGATE"),icon:"sap-icon://collections-management",action:[{sName:"Aggregate",aAnalytics:g,oMDCColumn:m},this._checkForPreviousAnalytics,this]});return h;}};D._checkForPreviousAnalytics=function(e,o){var n=o.sName,A=o.aAnalytics,m=o.oMDCColumn,t=m.getParent(),F=false,p=e.getParameter("property");if(A.includes(p)){var r=b.getLibraryResourceBundle("sap.ui.mdc");F=true;M.warning(r.getText("table.SETTINGS_MESSAGE")+"\n"+r.getText("table.SETTINGS_MESSAGE2")+" "+n+"?",{title:"Add "+n,actions:[M.Action.YES,M.Action.NO],onClose:function(g){if(g===sap.m.MessageBox.Action.YES){this._forceAnalytics(n,t,p);return;}}.bind(this)});}if(n==="Aggregate"&&!F){this._onAction(n,t,p);}else if(n==="Group"&&!F){this._onAction(n,t,p);}};D._onAction=function(A,t,p){var m=d.get(t);var g=m["group"]||[];var e=m["aggregate"]||[];if(A==="Group"){if(g.indexOf(p)>-1){g.splice(g.indexOf(p),1);}else{g.push(p);}}else if(e.indexOf(p)>-1){e.splice(e.indexOf(p),1);}else{e.push(p);}this._setAggregation(t,g,e);};D._forceAnalytics=function(n,t,p){var g=d.get(t)["group"]||[];var A=d.get(t)["aggregate"]||[];if(n==="Aggregate"){g.splice(A.indexOf(p),1);A.push(p);}else if(n==="Group"){A.splice(A.indexOf(p),1);g.push(p);}this._setAggregation(t,g,A);};D._setAggregation=function(t,g,A){var m=d.get(t);var p=m["plugin"];var o={visible:this._getVisibleProperties(t),groupLevels:g,grandTotal:A,subtotals:A};p&&p.setAggregationInfo(o);d.set(t,{plugin:p,group:g,aggregate:A});};D._getVisibleProperties=function(t){var v=[];var p=t.getPropertyHelper();t.getColumns().forEach(function(i){var P=i.getDataProperty();if(p.isComplex(P)){p.getReferencedProperties(P).forEach(function(e){if(v.indexOf(e.getName())==-1){v.push(e.getName());}});}else if(v.indexOf(p.getName(P))==-1){v.push(p.getName(P));}});return v;};D._onColumnChange=function(t){if(!d.get(t)){return;}var g=d.get(t)["group"]||[];var A=d.get(t)["aggregate"]||[];this._setAggregation(t,g,A);};function f(t,e){return Promise.all([t.awaitPropertyHelper(),l("sap/ui/table/plugins/V4Aggregation")]).then(function(r){var p=t.getPropertyHelper(),V=r[1][0],i=t._oTable,P=new V();i.addDependent(P);d.set(t,{plugin:P});P.setPropertyInfos(p.getRawPropertyInfos());e._setAggregation(t,[],[]);});}return D;});
