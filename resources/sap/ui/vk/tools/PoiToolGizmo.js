/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../thirdparty/three","./Gizmo","./PoiToolGizmoRenderer","./GizmoPlacementMode"],function(q,t,G,P,a){"use strict";var b=G.extend("sap.ui.vk.tools.PoiToolGizmo",{metadata:{library:"sap.ui.vk"}});b.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._viewport=null;this._tool=null;this._placementMode=a.ObjectCenter;this._nodes=[];this._poiIndex=-1;this._moveDelta=new THREE.Vector3();};b.prototype.hasDomElement=function(){return true;};b.prototype.show=function(v,c){this._viewport=v;this._tool=c;this._nodes.length=0;this._updateSelection(v._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);};b.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._poiIndex=-1;};b.prototype.getPOICount=function(){return this._nodes.length;};b.prototype.getPOI=function(i){return i<this._nodes.length?this._nodes[i].node:null;};b.prototype.selectPOI=function(p){this._poiIndex=p;this._viewport.setShouldRenderFrame();};b.prototype.beginGesture=function(){this._moveDelta.setScalar(0);this._nodes.forEach(function(n){var c=n.node;n.origin=new THREE.Vector3().setFromMatrixPosition(c.matrixWorld);n.matParentInv=new THREE.Matrix4();if(c.parent){n.matParentInv.getInverse(c.parent.matrixWorld);}});};b.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(c){n.push({node:c.node});});return n;};b.prototype.endGesture=function(){this._tool.fireMoved({x:this._moveDelta.x,y:this._moveDelta.y,z:this._moveDelta.z,nodesProperties:this._getNodesProperties()});};b.prototype._setOffset=function(o){if(this._tool.fireEvent("moving",{x:o.x,y:o.y,z:o.z,nodesProperties:this._getNodesProperties()},true)){this._move(o);}};b.prototype._move=function(o){this._moveDelta.copy(o);var i=this._viewport._isPanoramicActivated();var c=new THREE.Vector3().setFromMatrixPosition(this._viewport.getCamera().getCameraRef().matrixWorld);this._nodes.forEach(function(n){var d=n.node;var p=n.origin.clone();if(i){var e=p.distanceTo(c);p.add(o).sub(c).setLength(e).add(c);}else{p.add(o);}d.matrixWorld.setPosition(p);d.matrix.multiplyMatrices(n.matParentInv,d.matrixWorld);d.position.setFromMatrixPosition(d.matrix);d.matrixWorldNeedsUpdate=true;});this._viewport.setShouldRenderFrame();};b.prototype.move=function(x,y,z){this.beginGesture();this._move(new THREE.Vector3(x,y,z||0));};b.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);this._poiIndex=-1;}};b.prototype._getSelectionCenter=function(c){G.prototype._getSelectionCenter.apply(this,arguments);var d=new THREE.Vector3();if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(d);}else{var e=new THREE.Box3();e.expandByObject(this._nodes[0].node);e.getCenter(d);}c.copy(d.applyMatrix4(this._nodes[0].node.matrixWorld));};b.prototype._updatePoiButtons=function(){this._tool.updateButtons();};b.prototype.render=function(){this._updatePoiButtons();};return b;});
