/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["./_Helper","./_Parser","sap/ui/model/Filter"],function(_,a,F){"use strict";var A={grandTotal:"boolean",max:"boolean",min:"boolean",name:"string",subtotals:"boolean",unit:"string","with":"string"},m={aggregate:"object",grandTotalAtBottomOnly:"boolean",group:"object",groupLevels:"array",subtotalsAtBottomOnly:"boolean"},r=/,|%2C|%2c/,b=new RegExp(a.sWhitespace+"+"),c=new RegExp("^"+a.sODataIdentifier+"(?:"+a.sWhitespace+"+(?:asc|desc))?$"),d;function e(o,G,h,j,i,k){var D=o.aggregate[j],l=D.name||j,u=D.unit,w=D.with;if(w){l+=" with "+w+" as "+j;}else if(D.name){l+=" as "+j;}h.push(l);if(u&&h.indexOf(u)<0&&k.indexOf(u,i+1)<0&&G.indexOf(u)<0){h.push(u);}}function f(D,h,n){var k;function i(M){if(n){M+=" at property: "+n;}throw new Error(M);}function t(v){return Array.isArray(v)?"array":typeof v;}for(k in D){if(!(h&&k in h)){i("Unsupported '"+k+"'");}else if(t(D[k])!==h[k]){i("Not a "+h[k]+" value for '"+k+"'");}}}function g(M,h){var n;for(n in M){f(M[n],h,n);}}function s(q){var t=[];if(q.$skip){t.push("skip("+q.$skip+")");}delete q.$skip;if(q.$top<Infinity){t.push("top("+q.$top+")");}delete q.$top;return t.join("/");}d={buildApply:function(o,q,l,h,i){var j,k="",G=[],n,I,M=[],S,p=[];function t(N,u){var v,D=o.aggregate[N];if(D[u]){v="UI5"+u+"__"+N;M.push(N+" with "+u+" as "+v);if(i){i[v]={measure:N,method:u};}}}q=Object.assign({},q);l=l||1;f(o,m);o.groupLevels=o.groupLevels||[];I=l>o.groupLevels.length;o.group=o.group||{};g(o.group);o.groupLevels.forEach(function(u){o.group[u]=o.group[u]||{};});n=I?Object.keys(o.group).sort().filter(function(u){return o.groupLevels.indexOf(u)<0;}):[o.groupLevels[l-1]];o.aggregate=o.aggregate||{};g(o.aggregate,A);j=Object.keys(o.aggregate).sort();if(l<=1&&!h){j.filter(function(u){return o.aggregate[u].grandTotal;}).forEach(e.bind(null,o,[],G));}if(!h){j.forEach(function(u){t(u,"min");t(u,"max");});}j.filter(function(u){return I||o.aggregate[u].subtotals;}).forEach(e.bind(null,o,n,p));if(p.length){k="aggregate("+p.join(",")+")";}if(n.length){k="groupby(("+n.join(",")+(k?"),"+k+")":"))");}if(h){delete q.$count;}else if(q.$count){M.push("$count as UI5__count");delete q.$count;}if(q.$filter){k+="/filter("+q.$filter+")";delete q.$filter;}if(q.$orderby){k+="/orderby("+q.$orderby+")";delete q.$orderby;}S=s(q);if(M.length){k+="/concat(aggregate("+M.join(",")+"),"+(S||"identity")+")";}else if(S){k+="/"+S;}if(G.length){k="concat(aggregate("+G.join(",")+"),"+k+")";}if(q.$$filterBeforeAggregate){k="filter("+q.$$filterBeforeAggregate+")/"+k;delete q.$$filterBeforeAggregate;}if(k){q.$apply=k;}return q;},createPlaceholder:function(l,i,p){var P={"@$ui5.node.level":l};_.setPrivateAnnotation(P,"index",i);_.setPrivateAnnotation(P,"parent",p);return P;},extractSubtotals:function(o,G,C,E){var l=G["@$ui5.node.level"];Object.keys(o.aggregate).forEach(function(h){var i,u;C[h]=G[h];if(E){E[h]=null;}u=o.aggregate[h].unit;if(u){C[u]=G[u];if(E){i=o.groupLevels.indexOf(u);if(i<0||i>=l){E[u]=null;}}}});},filterOrderby:function(o,h,l){var i=l>h.groupLevels.length;if(o){return o.split(r).filter(function(O){var n;if(c.test(O)){n=O.split(b)[0];return n in h.aggregate&&(i||h.aggregate[n].subtotals)||i&&n in h.group&&h.groupLevels.indexOf(n)<0||!i&&h.groupLevels[l-1]===n;}return true;}).join(",");}},getAllProperties:function(o){var h=Object.keys(o.aggregate).concat(Object.keys(o.group));Object.keys(o.aggregate).forEach(function(i){var u=o.aggregate[i].unit;if(u){h.push(u);}});return h;},getOrCreateExpandedOject:function(o,G){var C,E=_.getPrivateAnnotation(G,"expanded");if(!E){C={"@$ui5.node.isExpanded":false};_.setPrivateAnnotation(G,"collapsed",C);E={"@$ui5.node.isExpanded":true};_.setPrivateAnnotation(G,"expanded",E);if(o.subtotalsAtBottomOnly!==undefined){d.extractSubtotals(o,G,C,o.subtotalsAtBottomOnly?E:null);}}return E;},hasGrandTotal:function(h){return Object.keys(h).some(function(i){return h[i].grandTotal;});},hasMinOrMax:function(h){return Object.keys(h).some(function(i){var D=h[i];return D.min||D.max;});},isAffected:function(o,h,S){function i(k,p){if(k.endsWith("/*")){k=k.slice(0,-2);}return _.hasPathPrefix(p,k)||_.hasPathPrefix(k,p);}function j(k,l){return l.some(function(n){return n.aFilters?j(k,n.aFilters):i(k,n.sPath);});}return S.some(function(k){var l=i.bind(null,k);return k===""||k==="*"||Object.keys(o.aggregate).some(function(n){var D=o.aggregate[n];return i(k,D.name||n);})||Object.keys(o.group).some(l)||o.groupLevels.some(l)||j(k,h);});},setAnnotations:function(E,i,I,l,h){E["@$ui5.node.isExpanded"]=i;E["@$ui5.node.isTotal"]=I;E["@$ui5.node.level"]=l;h.forEach(function(p){if(!(p in E)){E[p]=null;}});},splitFilter:function(o,h){var i=[],j=[];function k(o){return o.aFilters?o.aFilters.some(k):o.sPath in h.aggregate;}function l(o){if(o.aFilters&&o.bAnd){o.aFilters.forEach(l);}else{(k(o)?i:j).push(o);}}function w(n){return n.length>1?new F(n,true):n[0];}if(!h||!h.aggregate){return[o];}l(o);return[w(i),w(j)];}};return d;},false);
